<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>悦听音乐播放器</title>
  <!-- 外部资源引入 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <!-- Tailwind 配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3b82f6',
            secondary: '#10b981',
            dark: '#1e293b',
            light: '#f8fafc'
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
          keyframes: {
            spin: {
              '0%': { transform: 'rotate(0deg)' },
              '100%': { transform: 'rotate(360deg)' }
            }
          },
          animation: {
            spin: 'spin 10s linear infinite'
          }
        },
      }
    }
  </script>
  
  <!-- 自定义工具类 -->
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .player-shadow {
        box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.1);
      }
      .btn-hover {
        @apply transition-all duration-300 hover:scale-110 hover:shadow-lg;
      }
      .progress-bar {
        @apply h-1.5 rounded-full appearance-none cursor-pointer bg-gray-200 dark:bg-gray-700;
      }
      .progress-bar::-webkit-slider-thumb {
        @apply appearance-none w-3 h-3 rounded-full bg-primary transition-all duration-200 hover:scale-125;
      }
      .custom-scrollbar::-webkit-scrollbar {
        @apply w-1.5;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        @apply bg-gray-100 dark:bg-gray-700 rounded-full;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        @apply bg-gray-300 dark:bg-gray-500 rounded-full hover:bg-gray-400 dark:hover:bg-gray-400;
      }
    }
  </style>
</head>
<body class="font-inter bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-900 dark:to-gray-800 min-h-screen text-gray-800 dark:text-gray-200 transition-colors duration-300">

  <!-- 顶部导航栏 -->
  <header class="sticky top-0 z-50 bg-white/80 dark:bg-gray-900/80 backdrop-blur-md shadow-sm">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center gap-2">
        <i class="fa fa-music text-primary text-2xl"></i>
        <h1 class="text-xl font-bold">悦听音乐</h1>
      </div>
      
      <div class="flex items-center gap-4">
        <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
          <i class="fa fa-moon-o dark:hidden text-lg"></i>
          <i class="fa fa-sun-o hidden dark:block text-lg"></i>
        </button>
        
        <div class="flex gap-2">
          <label for="music-upload" class="flex items-center gap-1 px-4 py-2 bg-primary/10 dark:bg-primary/20 text-primary rounded-lg cursor-pointer hover:bg-primary/20 dark:hover:bg-primary/30 transition-colors">
            <i class="fa fa-upload"></i>
            <span class="hidden sm:inline">导入本地</span>
          </label>
          <input type="file" id="music-upload" accept="audio/*" multiple class="hidden">
          
          <button id="add-link-btn" class="flex items-center gap-1 px-4 py-2 bg-secondary/10 dark:bg-secondary/20 text-secondary rounded-lg hover:bg-secondary/20 dark:hover:bg-secondary/30 transition-colors">
            <i class="fa fa-link"></i>
            <span class="hidden sm:inline">添加链接</span>
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- 主内容区 -->
  <main class="container mx-auto px-4 py-8 flex flex-col lg:flex-row gap-8">
    <!-- 播放列表区域 -->
    <section class="lg:w-1/3 bg-white dark:bg-gray-800 rounded-xl shadow-md p-4 lg:p-6 h-[calc(100vh-220px)] lg:h-[calc(100vh-180px)] overflow-hidden flex flex-col">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold flex items-center gap-2">
          <i class="fa fa-list text-primary"></i>
          播放列表
        </h2>
        <div class="flex gap-2">
          <button id="clear-playlist" class="text-gray-500 dark:text-gray-400 hover:text-red-500 dark:hover:text-red-400 transition-colors">
            <i class="fa fa-trash-o"></i>
          </button>
          <button id="shuffle-btn" class="text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-primary transition-colors">
            <i class="fa fa-random"></i>
          </button>
        </div>
      </div>
      
      <div id="playlist-container" class="flex-1 overflow-y-auto pr-2 custom-scrollbar">
        <div id="empty-playlist" class="h-full flex flex-col items-center justify-center text-gray-400 dark:text-gray-500">
          <i class="fa fa-music text-5xl mb-4 opacity-50"></i>
          <p class="text-center">播放列表为空</p>
          <p class="text-sm mt-2">请导入本地音乐或添加音乐链接</p>
        </div>
        <ul id="playlist" class="hidden space-y-2">
          <!-- 播放列表项由JS动态添加 -->
        </ul>
      </div>
    </section>

    <!-- 播放器主体区域 -->
    <section class="lg:w-2/3 flex flex-col items-center justify-center">
      <div class="w-full max-w-md mx-auto">
        <!-- 音乐封面 -->
        <div class="relative mb-8 aspect-square rounded-full overflow-hidden shadow-xl player-shadow group">
          <img id="album-art" src="https://picsum.photos/400/400?music" alt="音乐封面" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105">
          <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-end justify-center p-6">
            <p id="cover-info" class="text-white text-center">点击播放音乐</p>
          </div>
          <div id="spin-animation" class="absolute inset-0 rounded-full border-4 border-white/20 border-t-primary hidden animate-spin"></div>
        </div>
        
        <!-- 音乐信息 -->
        <div class="text-center mb-6">
          <h3 id="track-title" class="text-xl font-bold mb-2 truncate">未选择音乐</h3>
          <p id="track-artist" class="text-gray-500 dark:text-gray-400 text-sm">未知艺术家</p>
        </div>
        
        <!-- 进度条 -->
        <div class="mb-6">
          <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mb-1">
            <span id="current-time">00:00</span>
            <span id="total-time">00:00</span>
          </div>
          <input type="range" id="progress-slider" class="progress-bar w-full" min="0" max="100" value="0">
        </div>
        
        <!-- 播放控制 -->
        <div class="flex justify-between items-center mb-8">
          <button id="prev-btn" class="text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-primary btn-hover">
            <i class="fa fa-step-backward text-xl"></i>
          </button>
          
          <div class="flex items-center gap-4">
            <button id="repeat-btn" class="text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-primary btn-hover relative">
              <i class="fa fa-repeat text-lg"></i>
            </button>
            
            <button id="play-pause-btn" class="w-14 h-14 rounded-full bg-primary text-white flex items-center justify-center shadow-lg btn-hover">
              <i id="play-icon" class="fa fa-play text-xl"></i>
              <i id="pause-icon" class="fa fa-pause text-xl hidden"></i>
            </button>
            
            <button id="next-btn" class="text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-primary btn-hover">
              <i class="fa fa-step-forward text-xl"></i>
            </button>
          </div>
          
          <div class="flex items-center gap-2">
            <i class="fa fa-volume-up text-gray-500 dark:text-gray-400"></i>
            <input type="range" id="volume-slider" class="progress-bar w-20" min="0" max="100" value="80">
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- 添加链接模态框 -->
  <div id="link-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-full max-w-md mx-4 shadow-2xl transform transition-all duration-300 scale-95 opacity-0" id="modal-content">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold">添加音乐链接</h3>
        <button id="close-modal" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
          <i class="fa fa-times"></i>
        </button>
      </div>
      
      <form id="link-form" class="space-y-4">
        <div>
          <label for="music-link" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">音乐链接</label>
          <input type="url" id="music-link" name="music-link" placeholder="https://example.com/music.mp3" 
                 class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary dark:focus:ring-primary/50"
                 value="https://flaredrive.baoge.wang/webdav/mp3/%E5%87%A4%E5%87%B0%E4%BC%A0%E5%A5%87-%E9%AB%98%E5%B1%B1%E6%A7%90%E8%8A%B1%E5%BC%80.mp3"
                 required>
        </div>
        
        <div>
          <label for="track-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">歌曲名称（可选）</label>
          <input type="text" id="track-name" name="track-name" placeholder="输入歌曲名称"
                 class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary dark:focus:ring-primary/50">
        </div>
        
        <div>
          <label for="artist-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">艺术家（可选）</label>
          <input type="text" id="artist-name" name="artist-name" placeholder="输入艺术家名称"
                 class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary dark:focus:ring-primary/50">
        </div>
        
        <div class="flex justify-end gap-3 pt-2">
          <button type="button" id="cancel-link" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
            取消
          </button>
          <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
            添加到播放列表
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- 通知组件 -->
  <div id="notification" class="fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50"></div>

  <script>
    // ==============================
    // 1. DOM元素与状态初始化
    // ==============================
    const audio = new Audio();
    // 播放控制按钮
    const playPauseBtn = document.getElementById('play-pause-btn');
    const playIcon = document.getElementById('play-icon');
    const pauseIcon = document.getElementById('pause-icon');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const repeatBtn = document.getElementById('repeat-btn');
    const shuffleBtn = document.getElementById('shuffle-btn');
    // 进度与音量
    const progressSlider = document.getElementById('progress-slider');
    const currentTimeDisplay = document.getElementById('current-time');
    const totalTimeDisplay = document.getElementById('total-time');
    const volumeSlider = document.getElementById('volume-slider');
    // 音乐信息
    const trackTitle = document.getElementById('track-title');
    const trackArtist = document.getElementById('track-artist');
    const albumArt = document.getElementById('album-art');
    const spinAnimation = document.getElementById('spin-animation');
    const coverInfo = document.getElementById('cover-info');
    // 播放列表
    const playlist = document.getElementById('playlist');
    const emptyPlaylist = document.getElementById('empty-playlist');
    const musicUpload = document.getElementById('music-upload');
    const clearPlaylist = document.getElementById('clear-playlist');
    // 模态框
    const linkModal = document.getElementById('link-modal');
    const modalContent = document.getElementById('modal-content');
    const closeModal = document.getElementById('close-modal');
    const cancelLink = document.getElementById('cancel-link');
    const linkForm = document.getElementById('link-form');
    const musicLink = document.getElementById('music-link');
    const trackName = document.getElementById('track-name');
    const artistName = document.getElementById('artist-name');
    // 其他
    const themeToggle = document.getElementById('theme-toggle');
    const notification = document.getElementById('notification');
    const addLinkBtn = document.getElementById('add-link-btn');

       // 播放器状态
    let playlistItems = [];          // 播放列表数组
    let currentTrackIndex = 0;       // 当前播放曲目索引
    let isPlaying = false;           // 播放状态标记（true=播放中，false=暂停/停止）
    let isShuffling = false;         // 随机播放状态标记
    let repeatMode = 'none';         // 重复模式：'none'（不重复）、'all'（列表循环）、'one'（单曲循环）
    let progressInterval = null;     // 进度条更新定时器（控制秒级刷新）

    // ==============================
    // 2. 页面初始化（加载时执行）
    // ==============================
    function init() {
      // 2.1 主题初始化（本地存储记忆+系统偏好 fallback）
      if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }

      // 2.2 加载本地存储的播放列表（持久化数据恢复）
      loadPlaylistFromLocalStorage();

      // 2.3 绑定所有交互事件
      bindEventListeners();

      // 2.4 初始化播放列表UI显示
      updatePlaylistDisplay();

      // 2.5 若有历史播放列表，自动加载第一个曲目
      if (playlistItems.length > 0) {
        loadTrack(0);
      }

      // 2.6 初始化音量（默认80%）
      audio.volume = volumeSlider.value / 100;
    }

    // ==============================
    // 3. 事件绑定（统一管理交互逻辑）
    // ==============================
    function bindEventListeners() {
      // 3.1 播放控制按钮事件
      playPauseBtn.addEventListener('click', togglePlayPause);
      prevBtn.addEventListener('click', playPreviousTrack);
      nextBtn.addEventListener('click', playNextTrack);
      repeatBtn.addEventListener('click', toggleRepeatMode);
      shuffleBtn.addEventListener('click', toggleShuffle);

      // 3.2 进度条与音量控制事件
      progressSlider.addEventListener('input', seekTo); // 拖动进度条跳转
      volumeSlider.addEventListener('input', adjustVolume); // 调整音量

      // 3.3 音频原生事件（监听播放状态变化）
      audio.addEventListener('loadedmetadata', updateTrackInfo); // 元数据加载完成（更新时长/标题）
      audio.addEventListener('ended', handleTrackEnd);           // 曲目播放结束（处理下一曲）
      audio.addEventListener('error', handleAudioError);         // 音频加载/播放错误
      audio.addEventListener('timeupdate', updateProgress);      // 播放进度变化（实时更新进度条）

      // 3.4 本地音乐上传事件
      musicUpload.addEventListener('change', handleFileUpload);

      // 3.5 远程链接模态框事件
      addLinkBtn.addEventListener('click', openLinkModal);       // 打开模态框
      closeModal.addEventListener('click', closeLinkModal);     // 关闭模态框（右上角X）
      cancelLink.addEventListener('click', closeLinkModal);     // 取消按钮
      linkForm.addEventListener('submit', (e) => {              // 表单提交（添加链接）
        e.preventDefault();
        addLinkToPlaylist();
      });
      linkModal.addEventListener('click', (e) => {              // 点击模态框外部关闭
        if (e.target === linkModal) closeLinkModal();
      });

      // 3.6 播放列表操作事件
      clearPlaylist.addEventListener('click', confirmClearPlaylist); // 清空列表（需确认）

      // 3.7 主题切换事件
      themeToggle.addEventListener('click', toggleTheme);

      // 3.8 封面点击播放事件（补充交互入口）
      albumArt.parentElement.addEventListener('click', () => {
        if (playlistItems.length > 0) togglePlayPause();
      });

      // 3.9 窗口失焦暂停（优化用户体验，避免后台无声播放）
      window.addEventListener('blur', () => {
        if (isPlaying) {
          audio.pause();
          isPlaying = false;
          updatePlayPauseUI();
        }
      });
    }

    // ==============================
    // 4. 本地音乐处理（文件导入与解析）
    // ==============================
    function handleFileUpload(e) {
      const files = e.target.files;
      if (!files.length) return; // 未选择文件则退出

      // 遍历所有选中的音频文件
      Array.from(files).forEach(file => {
        // 仅处理MIME类型为音频的文件
        if (file.type.startsWith('audio/')) {
          // 解析文件名：支持 "艺术家 - 歌曲名.mp3" 格式，自动拆分艺术家和标题
          const fileName = file.name.replace(/\.[^/.]+$/, ""); // 移除文件扩展名（如.mp3/.wav）
          let [title, artist] = fileName.split(' - ').reverse(); // 拆分后反转（应对"歌曲名 - 艺术家"的反向格式）

          // 处理非标准格式文件名（无" - "分隔的情况）
          if (!artist) {
            artist = '未知艺术家';
            title = fileName;
          }

          // 构建曲目对象（包含必要信息）
          const track = {
            id: Date.now() + Math.random(),  // 唯一ID（时间戳+随机数，避免重复）
            title: title.trim(),             // 歌曲标题（去空格）
            artist: artist.trim(),           // 艺术家（去空格）
            url: URL.createObjectURL(file),  // 本地文件临时URL（浏览器生成）
            type: 'local',                   // 标记为本地文件（区分远程链接）
            fileSize: formatFileSize(file.size) // 格式化文件大小（如"3.2 MB"）
          };

          // 添加到播放列表
          addTrackToPlaylist(track);
        }
      });

      // 重置文件输入框（允许重复选择同一文件）
      musicUpload.value = '';

      // 显示操作成功通知
      showNotification(`成功添加 ${files.length} 首音乐到播放列表`, 'success');
    }

    // 格式化文件大小（B → KB → MB 单位转换）
    function formatFileSize(bytes) {
      if (bytes < 1024) return `${bytes} B`;
      if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
      return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
    }

    // ==============================
    // 5. 远程链接处理（添加网络音乐）
    // ==============================
    // 打开"添加链接"模态框（带动画过渡）
    function openLinkModal() {
      linkModal.classList.remove('hidden');
      // 延迟添加动画类（确保CSS过渡效果生效）
      setTimeout(() => {
        modalContent.classList.remove('scale-95', 'opacity-0');
        modalContent.classList.add('scale-100', 'opacity-100');
      }, 10);
      // 自动聚焦输入框并选中内容（方便用户直接修改链接）
      musicLink.focus();
      musicLink.select();
    }

    // 关闭"添加链接"模态框（带动画过渡）
    function closeLinkModal() {
      // 先执行"缩小+淡出"动画
      modalContent.classList.remove('scale-100', 'opacity-100');
      modalContent.classList.add('scale-95', 'opacity-0');
      // 动画结束后隐藏模态框（与CSS过渡时长保持一致：300ms）
      setTimeout(() => {
        linkModal.classList.add('hidden');
      }, 300);
    }

    // 解析链接并添加到播放列表
    function addLinkToPlaylist() {
      const url = musicLink.value.trim();
      // 标题优先级：用户输入 > 从URL提取（无输入时自动解析文件名）
      let title = trackName.value.trim() || extractFileNameFromUrl(url);
      // 艺术家优先级：用户输入 > 默认"未知艺术家"
      const artist = artistName.value.trim() || '未知艺术家';

      // 验证链接有效性（简单校验：非空且包含http/https）
      if (!url || !url.startsWith('http')) {
        showNotification('请输入有效的音乐链接（需以http/https开头）', 'warning');
        return;
      }

      // 构建远程曲目对象
      const track = {
        id: Date.now() + Math.random(),
        title: title.trim(),
        artist: artist.trim(),
        url: url,
        type: 'remote' // 标记为远程链接（区分本地文件）
      };

      // 添加到播放列表
      addTrackToPlaylist(track);

      // 重置表单并关闭模态框
      linkForm.reset();
      closeLinkModal();

      // 显示操作成功通知
      showNotification(`成功添加歌曲：《${title}》`, 'success');
    }

    // 从URL中提取文件名（作为默认标题）
    function extractFileNameFromUrl(url) {
      try {
        const urlObj = new URL(url);
        const pathname = urlObj.pathname; // 获取URL路径（如"/music/abc.mp3"）
        const fileName = pathname.substring(pathname.lastIndexOf('/') + 1); // 截取最后一段（如"abc.mp3"）
        // 解码URL编码（处理中文/特殊字符，如"%E6%B5%8B%E8%AF%95.mp3" → "测试.mp3"）
        return decodeURIComponent(fileName).replace(/\.[^/.]+$/, "");
      } catch (e) {
        // URL解析失败（如格式错误），返回默认标题
        return '未知歌曲';
      }
    }

    // ==============================
    // 6. 播放列表管理（添加/加载/清空）
    // ==============================
    // 通用：添加曲目到播放列表（本地/远程通用）
    function addTrackToPlaylist(track) {
      playlistItems.push(track);
      // 保存到本地存储（持久化，刷新页面不丢失）
      savePlaylistToLocalStorage();
      // 更新UI显示（刷新列表）
      updatePlaylistDisplay();
      // 若为第一个曲目，自动加载（无需用户手动点击）
      if (playlistItems.length === 1) {
        loadTrack(0);
      }
    }

    // 加载指定索引的曲目（核心播放逻辑）
    function loadTrack(index) {
      // 列表为空时直接退出
      if (playlistItems.length === 0) return;

      // 处理索引边界（循环逻辑：小于0 → 最后一首，大于最大索引 → 第一首）
      if (index < 0) index = playlistItems.length - 1;
      if (index >= playlistItems.length) index = 0;

      // 更新当前播放索引
      currentTrackIndex = index;
      const track = playlistItems[currentTrackIndex];

      // 停止之前的进度更新定时器（避免多曲目同时更新）
      stopProgressInterval();

      // 更新音频源并加载
      audio.src = track.url;
      audio.load();

      // 保持播放状态：若之前正在播放，加载后继续播放
      if (isPlaying) {
        audio.play().catch(handlePlayError); // 捕获播放错误（如跨域、格式不支持）
      }

      // 更新UI：曲目信息、列表选中状态
      updateTrackInfo();
      updatePlaylistDisplay();
    }

    // 清空播放列表（需二次确认，防止误操作）
    function confirmClearPlaylist() {
      if (playlistItems.length === 0) {
        showNotification('播放列表已为空，无需清空', 'info');
        return;
      }

      // 确认弹窗（使用浏览器原生弹窗，简化逻辑）
      if (confirm('确定要清空整个播放列表吗？此操作不可恢复')) {
        // 停止当前播放
        audio.pause();
        isPlaying = false;
        updatePlayPauseUI();
        stopProgressInterval();

        // 清空列表数组
        playlistItems = [];
        // 更新本地存储（同步清空）
        savePlaylistToLocalStorage();
        // 更新UI（显示空列表状态）
        updatePlaylistDisplay();
        // 重置曲目信息显示
        trackTitle.textContent = '未选择音乐';
        trackArtist.textContent = '未知艺术家';
        albumArt.src = 'https://picsum.photos/400/400?music'; // 恢复默认封面

        showNotification('播放列表已清空', 'success');
      }
    }

    // ==============================
    // 7. 播放控制逻辑（播放/暂停/切歌）
    // ==============================
    // 切换播放/暂停状态
    function togglePlayPause() {
      // 列表为空时提示用户添加音乐
      if (playlistItems.length === 0) {
        showNotification('请先添加音乐到播放列表（本地文件或远程链接）', 'warning');
        return;
      }

      if (isPlaying) {
        // 当前播放中 → 暂停
        audio.pause();
        stopProgressInterval(); // 停止进度条更新
      } else {
        // 当前暂停 → 播放（捕获可能的错误）
        audio.play().then(() => {
          startProgressInterval(); // 启动进度条更新
        }).catch(handlePlayError);
      }

      // 切换播放状态标记并更新UI
      isPlaying = !isPlaying;
      updatePlayPauseUI();
    }

    // 更新播放/暂停按钮UI（图标切换+封面动画）
    function updatePlayPauseUI() {
      if (isPlaying) {
        // 播放中：显示暂停图标、启动封面旋转动画
        playIcon.classList.add('hidden');
        pauseIcon.classList.remove('hidden');
        spinAnimation.classList.remove('hidden');
        coverInfo.textContent = '点击暂停';
      } else {
        // 暂停中：显示播放图标、停止封面旋转动画
        playIcon.classList.remove('hidden');
        pauseIcon.classList.add('hidden');
        spinAnimation.classList.add('hidden');
        coverInfo.textContent = '点击播放音乐';
      }
    }

    // 播放上一曲
    function playPreviousTrack() {
      if (playlistItems.length === 0) return;

      let newIndex = currentTrackIndex - 1;
      // 随机播放模式：上一曲也随机（避免重复当前曲目）
      if (isShuffling) {
        newIndex = getRandomTrackIndex();
      }

      loadTrack(newIndex);
    }

    // 播放下一曲
    function playNextTrack() {
      if (playlistItems.length === 0) return;

      let newIndex = currentTrackIndex + 1;
      // 随机播放模式：下一曲随机（避免重复当前曲目）
      if (isShuffling) {
        newIndex = getRandomTrackIndex();
      }

      loadTrack(newIndex);
    }

    // 处理曲目播放结束（根据重复模式决定下一曲逻辑）
    function handleTrackEnd() {
      stopProgressInterval(); // 停止当前进度更新

      switch (repeatMode) {
        case 'one':
          // 单曲循环：重新播放当前曲目
          audio.currentTime = 0;
          audio.play().catch(handlePlayError);
          startProgressInterval();
          break;
        case 'all':
          // 列表循环：播放下一曲（自动循环到第一首）
          playNextTrack();
          break;
        case 'none':
          // 不重复：播放下一曲（最后一首结束后暂停）
          if (currentTrackIndex < playlistItems.length - 1) {
            playNextTrack();
          } else {
            // 最后一首结束：重置状态
            isPlaying = false;
            updatePlayPauseUI();
          }
          break;
      }
    }

    // ==============================
    // 8. 特殊播放模式（重复/随机）
    // ==============================
    // 切换重复模式（循环切换：none → all → one）
    function toggleRepeatMode() {
      const modes = ['none', 'all', 'one'];
      const currentModeIndex = modes.indexOf(repeatMode);
      // 切换到下一个模式（循环）
      repeatMode = modes[(currentModeIndex + 1) % modes.length];

      // 更新重复按钮UI（区分不同模式的样式）
      switch (repeatMode) {
        case 'none':
          // 不重复：默认灰色
          repeatBtn.classList.remove('text-primary', 'text-red-500');
          repeatBtn.classList.add('text-gray-500', 'dark:text-gray-400');
          // 移除单曲循环标记（小数字"1"）
          const oneMarker = repeatBtn.querySelector('.fa-one');
          if (oneMarker) oneMarker.remove();
          break;
        case 'all':
          // 列表循环：蓝色
          repeatBtn.classList.remove('text-gray-500', 'dark:text-gray-400', 'text-red-500');
          repeatBtn.classList.add('text-primary');
          // 移除单曲循环标记
          const oneMarker2 = repeatBtn.querySelector('.fa-one');
          if (oneMarker2) oneMarker2.remove();
          break;
                 case 'one':
          // 单曲循环：红色 + 显示"1"标记
          repeatBtn.classList.remove('text-gray-500', 'dark:text-gray-400', 'text-primary');
          repeatBtn.classList.add('text-red-500');
          // 检查是否已存在"1"标记，避免重复添加
          if (!repeatBtn.querySelector('.fa-one')) {
            const oneSpan = document.createElement('span');
            oneSpan.className = 'fa fa-one absolute -top-1 -right-1 text-xs';
            repeatBtn.appendChild(oneSpan);
          }
          break;
      }

      // 显示当前重复模式的通知（提升用户感知）
      const modeTextMap = {
        'none': '已关闭重复播放',
        'all': '已开启列表循环',
        'one': '已开启单曲循环'
      };
      showNotification(modeTextMap[repeatMode], 'info');
    }

    // 切换随机播放模式（开启/关闭）
    function toggleShuffle() {
      isShuffling = !isShuffling;

      // 更新随机按钮UI（区分开启/关闭状态）
      if (isShuffling) {
        shuffleBtn.classList.remove('text-gray-500', 'dark:text-gray-400');
        shuffleBtn.classList.add('text-primary');
        showNotification('已开启随机播放', 'info');
      } else {
        shuffleBtn.classList.remove('text-primary');
        shuffleBtn.classList.add('text-gray-500', 'dark:text-gray-400');
        showNotification('已关闭随机播放', 'info');
      }
    }

    // 获取随机曲目索引（避免与当前曲目重复，确保随机性）
    function getRandomTrackIndex() {
      // 若列表只有1首歌，直接返回0（无需随机）
      if (playlistItems.length <= 1) return 0;

      let randomIndex;
      // 循环生成随机数，直到与当前索引不同
      do {
        randomIndex = Math.floor(Math.random() * playlistItems.length);
      } while (randomIndex === currentTrackIndex && playlistItems.length > 1);

      return randomIndex;
    }

    // ==============================
    // 9. 进度与音量控制（用户交互）
    // ==============================
    // 进度条跳转（用户拖动进度条时触发）
    function seekTo() {
      // 计算目标时间（进度条百分比 × 总时长）
      const targetTime = (progressSlider.value / 100) * audio.duration;
      // 更新音频播放位置
      audio.currentTime = targetTime;
      // 若当前未播放，拖动后自动播放（优化用户体验）
      if (!isPlaying) {
        audio.play().then(() => {
          isPlaying = true;
          updatePlayPauseUI();
          startProgressInterval();
        }).catch(handlePlayError);
      }
    }

    // 更新进度条与时间显示（实时同步播放进度）
    function updateProgress() {
      if (isNaN(audio.duration)) return; // 总时长未加载时跳过

      // 计算播放进度百分比
      const progressPercent = (audio.currentTime / audio.duration) * 100;
      // 更新进度条值（避免拖动时的循环触发）
      progressSlider.value = progressPercent;

      // 格式化时间（秒 → 分:秒，如 125秒 → 02:05）
      currentTimeDisplay.textContent = formatTime(audio.currentTime);
      totalTimeDisplay.textContent = formatTime(audio.duration);
    }

    // 时间格式化工具函数（秒数转 "MM:SS" 格式）
    function formatTime(seconds) {
      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = Math.floor(seconds % 60);
      // 补零（确保单位数显示为两位数，如 5 → 05）
      return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
    }

    // 启动进度更新定时器（1秒刷新一次，确保实时性）
    function startProgressInterval() {
      // 先清除已有定时器，避免重复创建
      stopProgressInterval();
      progressInterval = setInterval(updateProgress, 1000);
      // 立即执行一次，避免1秒延迟
      updateProgress();
    }

    // 停止进度更新定时器（播放暂停/结束时调用）
    function stopProgressInterval() {
      if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
      }
    }

    // 调整音量（用户拖动音量条时触发）
    function adjustVolume() {
      // 音量条值（0-100）转音频对象所需的 0-1 范围
      audio.volume = volumeSlider.value / 100;
      // 显示当前音量状态（静音/低/中/高）
      let volumeText;
      if (volumeSlider.value == 0) {
        volumeText = '已静音';
      } else if (volumeSlider.value < 30) {
        volumeText = '音量：低';
      } else if (volumeSlider.value < 70) {
        volumeText = '音量：中';
      } else {
        volumeText = '音量：高';
      }
      showNotification(volumeText, 'info');
    }

    // ==============================
    // 10. UI更新与状态同步（视觉反馈）
    // ==============================
    // 更新曲目信息显示（标题、艺术家、封面）
    function updateTrackInfo() {
      if (playlistItems.length === 0) return;

      const currentTrack = playlistItems[currentTrackIndex];
      // 更新标题和艺术家
      trackTitle.textContent = currentTrack.title;
      trackArtist.textContent = currentTrack.artist;

      // 优化：远程链接尝试提取封面（这里用随机封面占位，实际可对接音乐API）
      // 本地文件暂不支持封面提取（需额外解析ID3标签，此处简化）
      albumArt.src = `https://picsum.photos/400/400?music=${currentTrack.id}`;
      // 封面加载失败时显示默认图
      albumArt.onerror = () => {
        albumArt.src = 'https://picsum.photos/400/400?music';
      };

      // 更新总时长显示（需等待元数据加载完成）
      if (!isNaN(audio.duration)) {
        totalTimeDisplay.textContent = formatTime(audio.duration);
      }
    }

    // 更新播放列表UI（动态生成列表项，标记当前播放曲目）
    function updatePlaylistDisplay() {
      // 列表为空时显示"空状态"，隐藏列表
      if (playlistItems.length === 0) {
        playlist.classList.add('hidden');
        emptyPlaylist.classList.remove('hidden');
        return;
      }

      // 列表非空时，隐藏"空状态"，显示列表
      playlist.classList.remove('hidden');
      emptyPlaylist.classList.add('hidden');

      // 清空现有列表项（避免重复生成）
      playlist.innerHTML = '';

      // 遍历播放列表，生成每一项的HTML
      playlistItems.forEach((track, index) => {
        const li = document.createElement('li');
        // 为当前播放的曲目添加特殊样式（蓝色背景+高亮文本）
        li.className = `p-3 rounded-lg cursor-pointer transition-colors flex justify-between items-center ${
          index === currentTrackIndex 
            ? 'bg-primary/10 dark:bg-primary/20 text-primary' 
            : 'hover:bg-gray-100 dark:hover:bg-gray-700'
        }`;

        // 列表项内容：左侧（标题+艺术家）、右侧（操作按钮/文件大小）
        li.innerHTML = `
          <div class="flex-1 min-w-0">
            <p class="font-medium truncate">${track.title}</p>
            <p class="text-xs text-gray-500 dark:text-gray-400 truncate">${track.artist} ${track.fileSize ? `· ${track.fileSize}` : ''}</p>
          </div>
          <button class="delete-track text-gray-400 hover:text-red-500 p-1" data-id="${track.id}">
            <i class="fa fa-trash-o"></i>
          </button>
        `;

        // 点击列表项播放对应曲目
        li.addEventListener('click', (e) => {
          // 点击删除按钮时不触发播放（避免事件冒泡）
          if (!e.target.closest('.delete-track')) {
            loadTrack(index);
            // 自动播放（优化用户体验）
            if (!isPlaying) {
              togglePlayPause();
            }
          }
        });

        // 删除单个曲目（点击垃圾桶按钮）
        const deleteBtn = li.querySelector('.delete-track');
        deleteBtn.addEventListener('click', (e) => {
          e.stopPropagation(); // 阻止事件冒泡到li（避免触发播放）
          // 从数组中删除当前曲目
          playlistItems = playlistItems.filter(item => item.id !== track.id);
          // 同步更新本地存储
          savePlaylistToLocalStorage();
          // 更新UI显示
          updatePlaylistDisplay();

          // 若删除的是当前播放的曲目，处理播放状态
          if (index === currentTrackIndex) {
            // 若列表还有其他曲目，加载下一首
            if (playlistItems.length > 0) {
              loadTrack(Math.min(index, playlistItems.length - 1));
            } else {
              // 列表为空，重置状态
              audio.pause();
              isPlaying = false;
              updatePlayPauseUI();
              trackTitle.textContent = '未选择音乐';
              trackArtist.textContent = '未知艺术家';
              albumArt.src = 'https://picsum.photos/400/400?music';
            }
          }

          showNotification(`已删除歌曲：《${track.title}》`, 'success');
        });

        // 将列表项添加到UL中
        playlist.appendChild(li);
      });
    }

    // ==============================
    // 11. 本地存储（持久化播放列表）
    // ==============================
    // 保存播放列表到localStorage（需先转为JSON字符串）
    function savePlaylistToLocalStorage() {
      // 过滤本地文件的临时URL（避免存储无效链接，刷新后失效）
      const persistableItems = playlistItems.map(track => {
        if (track.type === 'local') {
          // 本地文件：不存储临时URL（刷新后失效），仅保留基础信息
          return { ...track, url: '' };
        }
        // 远程链接：完整存储所有信息
        return track;
      });
      // 存储到localStorage
      localStorage.setItem('musicPlayerPlaylist', JSON.stringify(persistableItems));
    }

    // 从localStorage加载播放列表
    function loadPlaylistFromLocalStorage() {
      const savedPlaylist = localStorage.getItem('musicPlayerPlaylist');
      if (savedPlaylist) {
        // 解析JSON字符串为数组
        const parsedItems = JSON.parse(savedPlaylist);
        // 过滤本地文件（因URL失效，仅保留远程链接）
        playlistItems = parsedItems.filter(track => track.type === 'remote');
        // 若有本地文件，提示用户重新导入
        const localTrackCount = parsedItems.filter(track => track.type === 'local').length;
        if (localTrackCount > 0) {
          showNotification(`检测到${localTrackCount}首本地音乐（已失效），请重新导入`, 'warning');
        }
      }
    }

    // ==============================
    // 12. 主题切换（深色/浅色模式）
    // ==============================
    function toggleTheme() {
      // 切换HTML根元素的dark类（控制Tailwind主题）
      document.documentElement.classList.toggle('dark');
      // 保存主题到localStorage（记忆用户偏好）
      if (document.documentElement.classList.contains('dark')) {
        localStorage.theme = 'dark';
        showNotification('已切换为深色模式', 'info');
      } else {
        localStorage.theme = 'light';
        showNotification('已切换为浅色模式', 'info');
      }
    }

    // ==============================
    // 13. 错误处理与通知（用户反馈）
    // ==============================
    // 处理音频播放错误（如格式不支持、跨域、链接失效）
    function handlePlayError(error) {
      console.error('播放失败：', error);
      // 重置播放状态
      isPlaying = false;
      updatePlayPauseUI();
      // 根据错误类型显示不同提示
      let errorMsg;
      if (error.name === 'NotAllowedError') {
        errorMsg = '播放被浏览器阻止，请先点击页面后重试（自动播放限制）';
      } else if (error.name === 'MediaError') {
        errorMsg = '音乐文件格式不支持或链接已失效，请检查后重新添加';
      } else {
        errorMsg = '播放失败，请稍后重试';
      }
      showNotification(errorMsg, 'error');
    }

    // 处理音频加载错误（如远程链接无法访问）
    function handleAudioError() {
      console.error('音频加载失败：', audio.error);
      showNotification('音频加载失败，请检查链接是否有效', 'error');
      // 尝试播放下一首（避免卡住）
      if (playlistItems.length > 1) {
        playNextTrack();
      }
    }

    // 显示全局通知（右下角弹出，自动消失）
    function showNotification(message, type = 'info') {
      // 设置通知样式（根据类型区分颜色）
      const typeStyles = {
        success: 'bg-green-500 text-white',
        warning: 'bg-yellow-500 text-white',
        error: 'bg-red-500 text-white',
        info: 'bg-primary text-white'
      };

      // 更新通知内容与样式
      notification.textContent = message;
      notification.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 z-50 ${typeStyles[type]}`;

      // 显示通知（通过CSS过渡）
      notification.classList.remove('translate-y-20', 'opacity-0');
      notification.classList.add('translate-y-0', 'opacity-100');

      // 3秒后自动隐藏通知
      setTimeout(() => {
        notification.classList.remove('translate-y-0', 'opacity-100');
        notification.classList.add('translate-y-20', 'opacity-0');
      }, 3000);
    }

    // ==============================
    // 14. 页面加载完成后初始化
    // ==============================
    // 确保DOM完全加载后执行初始化逻辑
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>