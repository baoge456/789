<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>书签导航</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: green;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .container {
            width: 90%;
            max-width: 800px;
            background-color: #FFFFBB;
            border: 1px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            padding: 20px;
            position: relative;
            margin-bottom: 20px;
        }
        #bookmark-title {
            text-align: center;
            margin-bottom: 10px;
            cursor: pointer;
            user-select: none;
        }
        #group-selector {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
        }
        #group-select {
            padding: 7px 30px 7px 12px;
            border-radius: 18px;
            border: 2px solid #4B006E;
            background: linear-gradient(90deg, #f3eaff 60%, #e6e6fa 100%);
            color: #4B006E;
            font-size: 1em;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(75,0,110,0.08);
            appearance: none;
            outline: none;
            position: relative;
            min-width: 110px;
            margin-right: 8px;
        }
        #group-selector .arrow {
            pointer-events: none;
            margin-left: -28px;
            color: #4B006E;
            font-size: 1.1em;
            z-index: 2;
        }
        #bookmark-list {
            overflow-y: auto;
            max-height: 80vh;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            padding-right: 10px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        #bookmark-list::-webkit-scrollbar { display: none; }
        .bookmark {
            padding: 10px 10px 10px 10px;
            margin: 5px 0;
            background-color: #FFFFDD;
            border: 1px solid #ddd;
            border-radius: 50px;
            position: relative;
            cursor: pointer;
            text-align: center;
            transition: background-color 0.3s, color 0.3s;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            flex-direction: row;
        }
        .bookmark .bookmark-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            margin-right: 12px;
            background: #eee;
            object-fit: contain;
            flex-shrink: 0;
        }
        .bookmark h2 {
            margin: 0;
            font-size: 1.2em;
            color: #5CAF50;
            word-wrap: break-word;
            flex: 1;
            text-align: center;
            display: flex;
            align-items: center;
            height: 32px;
        }
        .bookmark h2 a { text-decoration: none; color: #5CAF50; width: 100%; }
        .bookmark h2 a:hover { color: #388E3C; }
        .bookmark:hover, .bookmark.selected { background-color: purple; color: white; }
        .bookmark:hover h2 a, .bookmark.selected h2 a { color: white; }
        .bookmark-menu {
            display: none;
            flex-direction: row;
            gap: 4px;
            margin-left: 10px;
        }
        .bookmark.show-menu .bookmark-menu {
            display: flex;
        }
        .bookmark-menu button {
            padding: 2px 8px;
            border: none;
            border-radius: 5px;
            background-color: #7c3aed;
            color: #fff;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }
        .bookmark-menu button:hover { background: #4B006E; }
        footer { text-align: center; padding: 10px; font-size: 0.8em; color: #555; }
        #file-input { display: none; }
        #current-user { text-align: center; margin-top: 10px; font-style: italic; color: #333; }
        #group-add-modal, #bookmark-edit-modal {
            display: none;
            position: fixed;
            z-index: 3000;
            left: 0; top: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.25);
            align-items: center;
            justify-content: center;
        }
        #group-add-modal .modal-content, #bookmark-edit-modal .modal-content {
            background: #fff;
            border-radius: 10px;
            padding: 24px 20px 20px 20px;
            min-width: 260px;
            box-shadow: 0 4px 16px rgba(75,0,110,0.18);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        #group-add-modal label, #bookmark-edit-modal label { font-weight: bold; color: #4B006E; }
        #group-add-modal input, #bookmark-edit-modal input {
            padding: 7px 10px;
            border-radius: 6px;
            border: 1.5px solid #4B006E;
            font-size: 1em;
        }
        #group-add-modal .modal-actions, #bookmark-edit-modal .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        #group-add-modal button, #bookmark-edit-modal button {
            padding: 6px 18px;
            border-radius: 6px;
            border: none;
            background: #7c3aed;
            color: #fff;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.2s;
        }
        #group-add-modal button.cancel, #bookmark-edit-modal button.cancel { background: #aaa; }
        #group-add-modal button:hover:not(.cancel), #bookmark-edit-modal button:hover:not(.cancel) { background: #4B006E; }
        @media (max-width: 600px) {
            #bookmark-list {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 6px;
                padding-right: 0;
            }
            .bookmark {
                padding: 6px 6px 6px 6px;
                border-radius: 18px;
                font-size: 0.95em;
                min-width: 0;
                margin: 2px 0;
            }
            .bookmark .bookmark-icon {
                width: 24px;
                height: 24px;
                border-radius: 5px;
                margin-right: 6px;
            }
            .bookmark h2 {
                font-size: 1em;
                height: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="bookmark-title" style="text-align:center; margin-bottom:20px;">书签导航</h1>
        <div id="group-selector">
            <select id="group-select" onchange="onGroupChange()"></select>
            <span class="arrow">&#9660;</span>
        </div>
        <div id="bookmark-list"></div>
        <div id="current-user"></div>
        <!-- 分组添加弹窗 -->
        <div id="group-add-modal">
            <div class="modal-content">
                <label for="new-group-name">新分组名称</label>
                <input id="new-group-name" type="text" placeholder="请输入分组名称">
                <div class="modal-actions">
                    <button class="cancel" onclick="hideAddGroupModal()">取消</button>
                    <button onclick="addGroupWithPosition()">确定</button>
                </div>
            </div>
        </div>
        <!-- 书签编辑弹窗 -->
        <div id="bookmark-edit-modal">
            <div class="modal-content">
                <label for="edit-bookmark-name">书签名称</label>
                <input id="edit-bookmark-name" type="text" placeholder="请输入书签名称">
                <label for="edit-bookmark-url">书签链接</label>
                <input id="edit-bookmark-url" type="text" placeholder="请输入书签链接">
                <label for="edit-bookmark-icon">缩略图链接</label>
                <input id="edit-bookmark-icon" type="text" placeholder="留空自动获取favicon">
                <div class="modal-actions">
                    <button class="cancel" onclick="hideBookmarkEditModal()">取消</button>
                    <button onclick="saveBookmarkEdit()">确定</button>
                </div>
            </div>
        </div>
        <footer></footer>
    </div>
    <script>
        // 默认书签和分组
        const defaultBookmark = {
            name: "默认书签",
            url: "https://bookmark.baoge.rr.nu/",
            icon: getFavicon("https://bookmark.baoge.rr.nu/")[0]
        };
        const defaultBookmarks = {
            "默认分组": [defaultBookmark]
        };
        const bookmarksKey = 'bookmarks';
        const groupKey = 'selectedGroup';
        const groupOrderKey = 'bookmarks_order';

        function getBookmarkData() {
            let bookmarks = JSON.parse(localStorage.getItem(bookmarksKey));
            let groupOrder = JSON.parse(localStorage.getItem(groupOrderKey));
            if (!bookmarks) {
                bookmarks = defaultBookmarks;
                localStorage.setItem(bookmarksKey, JSON.stringify(bookmarks));
            }
            const bookmarkKeys = Object.keys(bookmarks);
            if (!groupOrder || groupOrder.length !== bookmarkKeys.length || !groupOrder.every(key => bookmarks.hasOwnProperty(key)) || !bookmarkKeys.every(key => groupOrder.includes(key))) {
                groupOrder = bookmarkKeys;
                localStorage.setItem(groupOrderKey, JSON.stringify(groupOrder));
            }
            return { bookmarks, groupOrder };
        }

        function getFavicon(url) {
            try {
                const u = new URL(url);
                const domain = u.hostname;
                return [
                    `https://www.google.com/s2/favicons?domain=${domain}`,
                    `https://favicon.cccyun.cc/${u.origin}`,
                    `https://favicon.im/${domain}`
                ];
            } catch {
                return [''];
            }
        }

        function onGroupChange() {
            const groupSelect = document.getElementById('group-select');
            const selectedGroup = groupSelect.value;
            localStorage.setItem(groupKey, selectedGroup);
            loadBookmarks();
        }

        function loadBookmarks() {
            let { bookmarks } = getBookmarkData();
            const groupSelect = document.getElementById('group-select');
            const selectedGroup = groupSelect.value;
            const bookmarkList = document.getElementById('bookmark-list');
            bookmarkList.innerHTML = '';
            if (bookmarks[selectedGroup]) {
                bookmarks[selectedGroup].forEach((bookmark, idx) => {
                    createBookmark(bookmark.name, bookmark.url, idx, bookmark.icon);
                });
            }
        }

      function createBookmark(name, url, idx, icon) {
    const bookmarkList = document.getElementById('bookmark-list');
    const bookmark = document.createElement('div');
    bookmark.className = 'bookmark';
    bookmark.setAttribute('data-title', name);
    bookmark.setAttribute('data-url', url);
    bookmark.setAttribute('data-index', idx);
    bookmark.setAttribute('data-icon', icon || '');
    let iconUrls = icon ? [icon] : getFavicon(url);
    let imgHtml = `<img class="bookmark-icon" src="${iconUrls[0]}" alt="icon" onerror="this.onerror=null;this.src='${iconUrls[1] || iconUrls[0]}';setTimeout(()=>{if(this.src!=='${iconUrls[2] || iconUrls[0]}'){this.src='${iconUrls[2] || iconUrls[0]}'}},100)">`;
    bookmark.innerHTML = `
        ${imgHtml}
        <h2><a href="${url}" target="_blank">${name}</a></h2>
        <div class="bookmark-menu">
            <button onclick="addBookmarkFromMenu(this)">添加</button>
            <button onclick="editBookmarkFromMenu(this)">修改</button>
            <button onclick="deleteBookmarkFromMenu(this)">删除</button>
        </div>
    `;
    // 绑定长按和右键菜单
    let pressTimer = null;
    let menuVisible = false;
    let longPressTriggered = false;

    function toggleMenu() {
        if (menuVisible) {
            bookmark.classList.remove('show-menu');
            menuVisible = false;
        } else {
            hideAllBookmarkMenus();
            bookmark.classList.add('show-menu');
            menuVisible = true;
        }
    }

    // 移动端长按
    bookmark.addEventListener('touchstart', function(e) {
        if (e.touches.length === 1) {
            longPressTriggered = false;
            pressTimer = setTimeout(() => {
                toggleMenu();
                longPressTriggered = true;
            }, 500);
        }
    }, {passive: false});
    bookmark.addEventListener('touchend', function(e) {
        clearTimeout(pressTimer);
        if (longPressTriggered) {
            e.preventDefault();
            e.stopPropagation();
        }
    });
    bookmark.addEventListener('touchmove', function() {
        clearTimeout(pressTimer);
    });
    bookmark.addEventListener('touchcancel', function() {
        clearTimeout(pressTimer);
    });

    // PC端长按
    bookmark.addEventListener('mousedown', function(e) {
        if (e.button === 2) return; // 右键单独处理
        pressTimer = setTimeout(() => {
            toggleMenu();
        }, 500);
    });
    bookmark.addEventListener('mouseup', function() {
        clearTimeout(pressTimer);
    });
    bookmark.addEventListener('mouseleave', function() {
        clearTimeout(pressTimer);
    });
    // 右键菜单
    bookmark.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        toggleMenu();
    });
    // 点击其它地方关闭菜单
    document.addEventListener('touchstart', function(event) {
        if (!bookmark.contains(event.target)) {
            bookmark.classList.remove('show-menu');
            menuVisible = false;
        }
    });
    document.addEventListener('mousedown', function(event) {
        if (!bookmark.contains(event.target)) {
            bookmark.classList.remove('show-menu');
            menuVisible = false;
        }
    });
    bookmarkList.appendChild(bookmark);
}
        function hideAllBookmarkMenus() {
            document.querySelectorAll('.bookmark').forEach(b => b.classList.remove('show-menu'));
        }
        function addBookmarkFromMenu(btn) {
            const bookmark = btn.closest('.bookmark');
            const groupName = document.getElementById('group-select').value;
            const name = prompt('输入书签名称');
            const url = prompt('输入书签链接');
            let icon = '';
            if (url) icon = getFavicon(url)[0];
            if (name && url) {
                let bookmarks = JSON.parse(localStorage.getItem(bookmarksKey)) || defaultBookmarks;
                if (!bookmarks[groupName]) {
                    bookmarks[groupName] = [];
                }
                const newBookmark = { name: name, url: url, icon: icon };
                if (!isDuplicateBookmark(bookmarks[groupName], newBookmark)) {
                    const idx = parseInt(bookmark.getAttribute('data-index'));
                    bookmarks[groupName].splice(idx + 1, 0, newBookmark);
                    localStorage.setItem(bookmarksKey, JSON.stringify(bookmarks));
                    loadBookmarks();
                } else {
                    alert("该书签已存在!");
                }
            }
            hideAllBookmarkMenus();
        }
        let editingBookmarkIndex = null;
        function editBookmarkFromMenu(btn) {
            const bookmark = btn.closest('.bookmark');
            const groupName = document.getElementById('group-select').value;
            editingBookmarkIndex = parseInt(bookmark.getAttribute('data-index'));
            let bookmarks = JSON.parse(localStorage.getItem(bookmarksKey)) || defaultBookmarks;
            const b = bookmarks[groupName][editingBookmarkIndex];
            document.getElementById('edit-bookmark-name').value = b.name;
            document.getElementById('edit-bookmark-url').value = b.url;
            document.getElementById('edit-bookmark-icon').value = b.icon || '';
            document.getElementById('bookmark-edit-modal').style.display = 'flex';
        }
        function hideBookmarkEditModal() {
            document.getElementById('bookmark-edit-modal').style.display = 'none';
        }
        function saveBookmarkEdit() {
            const name = document.getElementById('edit-bookmark-name').value.trim();
            const url = document.getElementById('edit-bookmark-url').value.trim();
            let icon = document.getElementById('edit-bookmark-icon').value.trim();
            if (!name || !url) {
                alert('书签名称和链接不能为空');
                return;
            }
            if (!icon) icon = getFavicon(url)[0];
            const groupName = document.getElementById('group-select').value;
            let bookmarks = JSON.parse(localStorage.getItem(bookmarksKey)) || defaultBookmarks;
            const idx = editingBookmarkIndex;
            if (idx !== -1) {
                const newBookmark = { name: name, url: url, icon: icon };
                if (!isDuplicateBookmark(bookmarks[groupName], newBookmark) ||
                    (bookmarks[groupName][idx].name === name && bookmarks[groupName][idx].url === url)) {
                    bookmarks[groupName][idx] = newBookmark;
                    localStorage.setItem(bookmarksKey, JSON.stringify(bookmarks));
                    loadBookmarks();
                    hideBookmarkEditModal();
                } else {
                    alert("该书签已存在!");
                }
            }
        }
        function deleteBookmarkFromMenu(btn) {
            const bookmark = btn.closest('.bookmark');
            const groupName = document.getElementById('group-select').value;
            const idx = parseInt(bookmark.getAttribute('data-index'));
            let bookmarks = JSON.parse(localStorage.getItem(bookmarksKey)) || defaultBookmarks;
            if (confirm(`确定要删除书签 "${bookmarks[groupName][idx].name}" 吗？`)) {
                bookmarks[groupName].splice(idx, 1);
                localStorage.setItem(bookmarksKey, JSON.stringify(bookmarks));
                loadBookmarks();
            }
            hideAllBookmarkMenus();
        }
        function isDuplicateBookmark(bookmarks, newBookmark) {
            return bookmarks.some(bookmark => bookmark.name === newBookmark.name && bookmark.url === newBookmark.url);
        }
        function showAddGroupModal() {
            document.getElementById('new-group-name').value = '';
            document.getElementById('group-add-modal').style.display = 'flex';
        }
        function hideAddGroupModal() {
            document.getElementById('group-add-modal').style.display = 'none';
        }
        function addGroupWithPosition() {
            const newGroupName = document.getElementById('new-group-name').value.trim();
            if (!newGroupName) {
                alert('请输入分组名称');
                return;
            }
            let { bookmarks, groupOrder } = getBookmarkData();
            if (bookmarks[newGroupName]) {
                alert('分组已存在!');
                return;
            }
            bookmarks[newGroupName] = [Object.assign({}, defaultBookmark)];
            const currentGroup = document.getElementById('group-select').value;
            const currentIndex = groupOrder.indexOf(currentGroup);
            if (currentIndex > -1) {
                groupOrder.splice(currentIndex + 1, 0, newGroupName);
            } else {
                groupOrder.push(newGroupName);
            }
            localStorage.setItem(bookmarksKey, JSON.stringify(bookmarks));
            localStorage.setItem(groupOrderKey, JSON.stringify(groupOrder));
            localStorage.setItem(groupKey, newGroupName);
            hideAddGroupModal();
            loadGroups();
        }
        function loadGroups() {
            const { bookmarks, groupOrder } = getBookmarkData();
            const groupSelect = document.getElementById('group-select');
            groupSelect.innerHTML = '';
            groupOrder.forEach(group => {
                const option = document.createElement('option');
                option.value = group;
                option.textContent = group;
                groupSelect.appendChild(option);
            });
            let remembered = localStorage.getItem(groupKey);
            if (remembered && bookmarks[remembered]) {
                groupSelect.value = remembered;
            }
            loadBookmarks();
        }
        // 初始化
        loadGroups();
    </script>
</body>
</html>