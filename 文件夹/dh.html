<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>网址导航</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
    /* 新增搜索结果的样式 */
    .search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      margin-top: 5px;
      display: none;
    }
    .search-result-item {
      padding: 10px 15px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      display: flex;
      align-items: center;
    }
    .search-result-item:hover {
      background-color: #f8f9fa;
    }
    .search-result-icon {
      width: 20px;
      height: 20px;
      margin-right: 10px;
      object-fit: contain;
    }
    .search-result-content {
      flex: 1;
      min-width: 0;
    }
    .search-result-name {
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .search-result-url {
      font-size: 0.8rem;
      color: #666;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .search-result-group {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 10px;
      background: #e9ecef;
      color: #495057;
      margin-left: 10px;
      white-space: nowrap;
    }
    
    /* 新增：有图/无图切换按钮样式 */
    #toggleThumbnailsBtn {
      border-radius: 8px;
      border: 1px solid #ddd;
      padding: 10px 16px;
      font-size: 1rem;
      background: #4B0082;
      color: white;
      cursor: pointer;
      margin-right: 8px;
      transition: all 0.2s;
    }
    #toggleThumbnailsBtn:hover {
      background: #6A0DAD;
      box-shadow: 0 2px 8px rgba(75, 0, 130, 0.3);
    }
    
    /* 新增：进入后台按钮样式 */
    #adminLoginBtn {
      color: #4B0082;
      font-weight: 600;
      text-decoration: none;
      background: #f5f5f5;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px 16px;
      transition: all 0.2s;
    }
    #adminLoginBtn:hover {
      background: #e9ecef;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    /* 新增：书签图标样式 */
    .site-card-icon {
      width: 24px;
      height: 24px;
      margin-right: 0;
      object-fit: contain;
    }
    
    /* 新增：图标按钮样式 */
    .admin-group-item button,
    .admin-table button {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      transition: all 0.2s;
    }
    .admin-group-item button:hover,
    .admin-table button:hover {
      opacity: 0.8;
    }
    .admin-group-item button.btn-add,
    .admin-table button.btn-add {
      color: #28a745;
    }
    .admin-group-item button.btn-edit,
    .admin-table button.btn-edit {
      color: #ffc107;
    }
    .admin-group-item button.btn-delete,
    .admin-table button.btn-delete {
      color: #dc3545;
    }
    .admin-group-item button.btn-arrow,
    .admin-table button.btn-arrow {
      color: #3498db;
    }
    
    /* 新增：后台登录样式 */
    .login-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    .login-box {
      background: white;
      padding: 20px 30px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      max-width: 400px;
      width: 90%;
    }
    .login-box h3 {
      margin-bottom: 15px;
      text-align: center;
    }
    .login-box input {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
    }
    .login-box .buttons {
      display: flex;
      justify-content: space-between;
    }
    .login-box button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .login-box button#loginBtn {
      background: #4B0082;
      color: white;
    }
    .login-box button#cancelBtn {
      background: #f5f5f5;
      color: #333;
      border: 1px solid #ddd;
    }
    .login-box button:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    
    /* 调整后的书签卡片样式 */
    .site-card {
      background: var(--group-bg-color);
      background-image: linear-gradient(45deg, rgba(255,255,255,0.05) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.05) 50%, rgba(255,255,255,0.05) 75%, transparent 75%, transparent);
      background-size: 20px 20px;
      border-radius: 25px;
      height: 50px;
      padding: 8px 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.2s ease-in-out;
      text-decoration: none;
      position: relative;
      overflow: hidden;
      cursor: pointer;
    }
    .site-card:hover, .site-card:active {
      box-shadow: 0 8px 24px rgba(75, 0, 130, 0.3);
      transform: translateY(-3px);
      background: #4B0082;
      background-image: linear-gradient(45deg, rgba(255,255,255,0.08) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.08) 50%, rgba(255,255,255,0.08) 75%, transparent 75%, transparent);
      background-size: 20px 20px;
    }
    .site-card-content {
      flex: 1;
      display: flex;
      align-items: center;
      min-width: 0;
      margin-bottom: 0;
    }
    .site-card .title {
      font-weight: 700;
      font-size: 0.95rem;
      margin-bottom: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--group-text-color);
      line-height: 1.2;
      margin-left: 8px;
    }
    
    /* 其他原有样式保持不变 */
    html, body { height: 100%; margin: 0; }
    body {
      background: #f5f6fa;
      font-family: 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;
      display: flex; flex-direction: column; min-height: 100vh;
    }
    .container-main { max-width: 1200px; width: 90%; margin: 40px auto; background: #fff; border-radius: 16px; box-shadow: 0 4px 24px rgba(0,0,0,0.08); display: flex; flex-grow: 1; }
    .sidebar { width: 220px; background: #22223b; color: #fff; padding: 32px 0 0 0; flex-shrink: 0; }
    .sidebar h2 { font-size: 1.5rem; text-align: center; margin-bottom: 2rem; letter-spacing: 2px; padding: 10px 0; background-color: rgba(123, 104, 238, 0.3); border-radius: 8px; margin: 0 15px 2rem 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .sidebar ul { list-style: none; padding: 0; }
    .sidebar li { padding: 12px 32px; cursor: pointer; transition: background 0.2s; }
    .sidebar li:hover, .sidebar li.active { background: #7B68EE; }
    .main-content { flex: 1; padding: 40px 48px; overflow-y: auto; }
    .search-bar { display: flex; margin-bottom: 32px; gap: 8px; position: relative; }
    .search-bar input { flex: 1; border-radius: 8px; border: 1px solid #ddd; padding: 10px 16px; font-size: 1rem; }
    .search-bar select { border-radius: 8px; border: 1px solid #ddd; padding: 10px 16px; font-size: 1rem; background: #fff; }
    .card-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; }
    .footer { padding: 15px; background: #fff; border-top: 1px solid #eee; z-index: 10; width: 100%; flex-shrink: 0; }
    .admin-container { display: flex; flex-direction: column; height: 80vh; overflow-y: auto; }
    .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; flex-wrap: wrap; }
    .admin-header h2 { margin-bottom: 0; }
    .admin-actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .admin-section { margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
    .admin-section h3 { font-size: 1.2rem; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed #eee; }
    .admin-group-list { display: flex; gap: 10px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 10px; }
    .admin-group-item { white-space: nowrap; padding: 8px 15px; border: 1px solid #007bff; border-radius: 20px; cursor: pointer; background-color: #e9f5ff; color: #007bff; transition: all 0.2s; display: flex; align-items: center; gap: 5px; flex-shrink: 0; }
    .admin-group-item.active { background-color: #007bff; color: #fff; }
    .admin-group-item button { background: none; border: none; color: inherit; font-size: 0.9em; margin-left: 5px; cursor: pointer; }
    .admin-group-item button.btn-add-group { background-color: #28a745; color: white; border-radius: 5px; padding: 3px 8px; }
    .admin-group-item button.btn-edit-group { background-color: #ffc107; color: black; border-radius: 5px; padding: 3px 8px; }
    .admin-group-item button.btn-delete-group { background-color: #dc3545; color: white; border-radius: 5px; padding: 3px 8px; }
    .admin-group-item button:hover { opacity: 0.8; }
    .admin-table-container { flex: 1; overflow-x: auto; }
    .admin-table { min-width: 800px; }
    .admin-table th, .admin-table td { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; vertical-align: middle; }
    .form-group label { font-weight: 600; margin-bottom: 5px; }
    .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
    /* 新增：后台分组和书签上下箭头样式 */
    .admin-group-item .btn-arrow {
      font-size: 1.3em;
      padding: 2px 10px;
      margin-left: 2px;
      border-radius: 5px;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
    }
    .admin-group-item .btn-arrow.up { background: #3498db; color: #fff; }
    .admin-group-item .btn-arrow.down { background: #ff9800; color: #fff; }
    .admin-group-item .btn-arrow:hover { filter: brightness(0.9); }
    .admin-table .btn-arrow {
      font-size: 1.2em;
      padding: 2px 8px;
      margin-left: 2px;
      border-radius: 5px;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
    }
    .admin-table .btn-arrow.up { background: #3498db; color: #fff; }
    .admin-table .btn-arrow.down { background: #ff9800; color: #fff; }
    .admin-table .btn-arrow:hover { filter: brightness(0.9); }
    @media (max-width: 992px) {
      .card-list { grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); }
      .sidebar { width: 180px; padding: 20px 0 0 0; }
      .main-content { padding: 30px 30px; }
    }
    @media (max-width: 768px) {
      .container-main { flex-direction: column; margin: 20px auto; border-radius: 8px; }
      .sidebar { width: 100%; display: flex; flex-direction: row; overflow-x: auto; padding: 15px 0; border-radius: 8px 8px 0 0; }
      .sidebar h2 { display: none; }
      .sidebar ul { display: flex; margin: 0; padding: 0 10px; }
      .sidebar li { padding: 8px 15px; white-space: nowrap; }
      .main-content { padding: 20px; }
      .site-card { height: 45px; border-radius: 22.5px; padding: 6px 12px; }
      .site-card .title { font-size: 0.9rem; }
      .admin-header { flex-direction: column; align-items: flex-start; gap: 15px; }
      .admin-actions { width: 100%; justify-content: center; }
      .admin-group-list { flex-wrap: wrap; justify-content: center; }
      .search-bar { flex-wrap: wrap; }
      .search-bar input { flex: 1 1 100%; }
      .search-bar button, .search-bar .btn-link { flex: 1; margin-top: 8px; }
    }
    @media (max-width: 480px) {
      .card-list { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
      .admin-section { padding: 15px; }
    }
  </style>
</head>
<body>
  <div class="container-main" id="app">
    <nav class="sidebar" id="sidebar">
      <h2>书签导航</h2>
      <ul id="categoryList"></ul>
    </nav>
    <main class="main-content" id="mainContent">
      <div class="search-bar">
        <input type="text" id="searchInput" placeholder="输入关键词搜索所有书签...">
        <button type="button" id="toggleThumbnailsBtn">无图</button>
        <div class="search-results" id="searchResults"></div>
      </div>
      <div id="bookmarkList" class="card-list"></div>
    </main>
  </div>
  <div class="main-content d-none" id="adminPanel">
    <div class="admin-container">
      <div class="admin-header">
        <h2>书签管理后台</h2>
        <div class="admin-actions">
          <button class="btn btn-primary" onclick="handleExport()"><i class="fas fa-download"></i> 导出书签</button>
          <input type="file" id="importBookmarksFile" accept=".json" class="d-none" onchange="importBookmarks(event)">
          <button class="btn btn-info" onclick="document.getElementById('importBookmarksFile').click()"><i class="fas fa-upload"></i> 导入书签</button>
          <button class="btn btn-danger" onclick="clearAllBookmarks()"><i class="fas fa-trash"></i> 清空所有书签</button>
          <button class="btn btn-success" onclick="location.hash = ''"><i class="fas fa-arrow-left"></i> 返回前台</button>
        </div>
      </div>
      <div class="admin-section">
        <h3>分组管理</h3>
        <div class="admin-group-list" id="adminGroupList"></div>
        <form id="bookmarkForm" class="row g-3 mb-4 d-none" onsubmit="handleSaveBookmark(event)">
          <input type="hidden" id="bookmarkId">
          <input type="hidden" id="bookmarkAfterId">
          <div class="col-md-6">
            <label for="bookmarkName" class="form-label">名称</label>
            <input type="text" class="form-control" id="bookmarkName" required>
          </div>
          <div class="col-md-6">
            <label for="bookmarkUrl" class="form-label">URL</label>
            <input type="url" class="form-control" id="bookmarkUrl" onblur="fetchFavicon()" required>
          </div>
          <div class="col-md-6">
            <label for="bookmarkFavicon" class="form-label">图标URL</label>
            <input type="url" class="form-control" id="bookmarkFavicon">
          </div>
          <div class="col-md-6">
            <label for="bookmarkGroup" class="form-label">分组</label>
            <select class="form-select" id="bookmarkGroup" required></select>
          </div>
          <div class="col-12">
            <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> 保存书签</button>
            <button type="button" class="btn btn-secondary" onclick="resetBookmarkForm()"><i class="fas fa-times"></i> 取消</button>
          </div>
        </form>
        <div class="admin-table-container">
          <table class="table table-bordered table-striped admin-table">
            <thead>
              <tr>
                <th style="width: 150px;">名称</th>
                <th style="width: 250px;">URL</th>
                <th style="width: 100px;">分组</th>
                <th style="width: 220px;">操作</th>
              </tr>
            </thead>
            <tbody id="adminBookmarkTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <div class="footer text-center text-muted mt-4" id="frontendFooter">
<p><button type="button" id="adminLoginBtn">进入后台管理</button></p>
    <p>已稳定运行 <span id="runtime">0 天 0 小时 0 分 0 秒</span></p>
    
    <p>&copy; 2020 &copy;   宝哥制作    All Rights Reserved </p>
  </div>
  
  <!-- 登录模态框 -->
  <div class="login-overlay d-none" id="loginOverlay">
    <div class="login-box">
      <h3>请输入管理密码</h3>
      <input type="password" id="adminPassword" placeholder="输入密码...">
      <div class="buttons">
        <button id="loginBtn">确认</button>
        <button id="cancelBtn">取消</button>
      </div>
    </div>
  </div>

<script>
    // 书签数据结构和初始化
    const DEFAULT_BOOKMARKS_DATA = [
      { name: "常用推荐", bookmarks: [
        { id: Date.now() + 1, name: "宝哥导航站", url: "https://dhz.baoge.wang/", favicon: "https://favicon.im/https://dhz.baoge.wang/" },
        { id: Date.now() + 2, name: "泰安本地宝", url: "https://m.ta.bendibao.com/", favicon: "https://favicon.im/https://m.ta.bendibao.com/" },
      ]},
      { name: "新闻资讯", bookmarks: [
        { id: Date.now() + 3, name: "全网热点", url: "https://hot.ailake.cn/hot/1", favicon: "https://favicon.im/https://hot.ailake.cn/hot/1" },
        { id: Date.now() + 4, name: "今日热榜", url: "https://tophub.today/", favicon: "https://tophub.today/favicon.ico" },
      ]},
      { name: "搜索引擎", bookmarks: [
        { id: Date.now() + 5, name: "百度", url: "https://www.baidu.com/", favicon: "https://www.baidu.com/favicon.ico" },
        { id: Date.now() + 6, name: "谷歌", url: "https://www.google.com/", favicon: "https://www.google.com/favicon.ico" },
      ]}
    ];

    let bookmarksData = JSON.parse(JSON.stringify(DEFAULT_BOOKMARKS_DATA));
    let currentCategory = localStorage.getItem('currentCategory') || (bookmarksData.length > 0 ? bookmarksData[0].name : "");
    let adminSelectedGroup = currentCategory;
    const ADMIN_PASSWORD = "baoge";
    let isThumbnailsVisible = true; // 控制缩略图显示状态

    const groupColors = [
        { main: '#FF6347', hover: '#4B0082', text: '#fff' },
        { main: '#3CB371', hover: '#4B0082', text: '#fff' },
        { main: '#4169E1', hover: '#4B0082', text: '#fff' },
        { main: '#FFA500', hover: '#4B0082', text: '#333' },
        { main: '#8A2BE2', hover: '#4B0082', text: '#fff' },
        { main: '#FF69B4', hover: '#4B0082', text: '#fff' },
        { main: '#00CED1', hover: '#4B0082', text: '#333' },
        { main: '#ADFF2F', hover: '#4B0082', text: '#333' },
        { main: '#FFD700', hover: '#4B0082', text: '#333' },
        { main: '#DAA520', hover: '#4B0082', text: '#fff' },
        { main: '#CD5C5C', hover: '#4B0082', text: '#fff' },
        { main: '#6495ED', hover: '#4B0082', text: '#fff' },
    ];
    let colorMap = {};

    function loadBookmarks() {
      const storedData = localStorage.getItem('bookmarksData');
      if (storedData) {
        try {
          const parsedData = JSON.parse(storedData);
          if (!Array.isArray(parsedData) && typeof parsedData === 'object' && parsedData !== null) {
            bookmarksData = Object.keys(parsedData).map(groupName => ({
              name: groupName,
              bookmarks: parsedData[groupName] || []
            }));
          } else if (Array.isArray(parsedData)) {
            bookmarksData = parsedData;
          }
        } catch (e) {
          bookmarksData = JSON.parse(JSON.stringify(DEFAULT_BOOKMARKS_DATA));
        }
      } else {
          bookmarksData = JSON.parse(JSON.stringify(DEFAULT_BOOKMARKS_DATA));
      }
      bookmarksData.forEach(group => {
        group.bookmarks = group.bookmarks.map(bookmark => {
          if (!bookmark.id) {
            bookmark.id = Date.now() + Math.random();
          }
          if (bookmark.hasOwnProperty('desc')) {
            delete bookmark.desc;
          }
          return bookmark;
        });
      });
    }

    function saveBookmarks() {
      localStorage.setItem('bookmarksData', JSON.stringify(bookmarksData));
    }

    function saveCurrentCategory() {
      localStorage.setItem('currentCategory', currentCategory);
    }

    function renderCategories() {
      const categoryList = document.getElementById('categoryList');
      categoryList.innerHTML = '';
      const categories = bookmarksData.map(group => group.name);

      if (!categories.includes(currentCategory) && categories.length > 0) {
        currentCategory = categories[0];
        saveCurrentCategory();
      } else if (categories.length === 0) {
        currentCategory = "";
        saveCurrentCategory();
      }

      categories.forEach(category => {
        const li = document.createElement('li');
        li.textContent = category;
        li.dataset.category = category;
        if (category === currentCategory) {
          li.classList.add('active');
        }
        li.addEventListener('click', () => {
          currentCategory = category;
          saveCurrentCategory();
          renderCategories();
          renderBookmarks(currentCategory);
          window.scrollTo({ top: 0, behavior: 'auto' });
          const mainContent = document.querySelector('.main-content');
          if (mainContent) mainContent.scrollTop = 0;
        });
        categoryList.appendChild(li);
      });
    }

    function renderBookmarks(categoryName) {
      const bookmarkList = document.getElementById('bookmarkList');
      bookmarkList.innerHTML = '';

      const group = bookmarksData.find(g => g.name === categoryName);
      const bookmarks = group ? group.bookmarks : [];

      if (bookmarks.length === 0) {
        bookmarkList.innerHTML = `<p class="text-center text-muted">该分类下暂无书签。</p>`;
        return;
      }

      if (!colorMap[categoryName]) {
        const existingColors = Object.values(colorMap).map(c => c.main);
        let availableColor = groupColors.find(color => !existingColors.includes(color.main));
        if (!availableColor) {
            availableColor = groupColors[Object.keys(colorMap).length % groupColors.length];
        }
        colorMap[categoryName] = availableColor;
      }
      const categoryColor = colorMap[categoryName];

      bookmarks.forEach(bookmark => {
        const card = document.createElement('div');
        card.classList.add('site-card');
        card.setAttribute('data-group', categoryName);
        card.style.setProperty('--group-bg-color', categoryColor.main);
        card.style.setProperty('--group-hover-color', categoryColor.hover);
        card.style.setProperty('--group-text-color', categoryColor.text);
        
        let cardContent = `<div class="site-card-content">`;
        if (isThumbnailsVisible) {
          cardContent += `<img src="${bookmark.favicon}" alt="favicon" class="site-card-icon" onerror="this.src='https://www.google.com/s2/favicons?domain=default';">`;
        }
        cardContent += `<div class="title">${bookmark.name}</div></div>`;
        
        card.innerHTML = cardContent;
        card.addEventListener('click', () => {
          window.open(bookmark.url, '_blank');
        });
        bookmarkList.appendChild(card);
      });
    }

    // 搜索书签功能
    function searchBookmarks() {
      const searchInput = document.getElementById('searchInput');
      const query = searchInput.value.trim().toLowerCase();
      const searchResults = document.getElementById('searchResults');
      
      if (!query) {
        searchResults.style.display = 'none';
        renderBookmarks(currentCategory);
        return;
      }
      
      const results = [];
      bookmarksData.forEach(group => {
        group.bookmarks.forEach(bookmark => {
          if (bookmark.name.toLowerCase().includes(query) || 
              bookmark.url.toLowerCase().includes(query) ||
              group.name.toLowerCase().includes(query)) {
            results.push({ bookmark, groupName: group.name });
          }
        });
      });
      
      if (results.length === 0) {
        searchResults.innerHTML = `<div class="search-result-item">没有找到匹配的书签</div>`;
        searchResults.style.display = 'block';
      } else {
        searchResults.innerHTML = '';
        results.forEach(result => {
          const item = document.createElement('div');
          item.classList.add('search-result-item');
          item.innerHTML = `
            <img src="${result.bookmark.favicon}" alt="favicon" class="search-result-icon" onerror="this.src='https://www.google.com/s2/favicons?domain=default';">
            <div class="search-result-content">
              <div class="search-result-name">${result.bookmark.name}</div>
              <div class="search-result-url">${result.bookmark.url}</div>
            </div>
            <div class="search-result-group">${result.groupName}</div>
          `;
          item.addEventListener('click', () => {
            window.open(result.bookmark.url, '_blank');
          });
          searchResults.appendChild(item);
        });
        searchResults.style.display = 'block';
      }
    }

    // 隐藏搜索结果
    function hideSearchResults() {
      const searchResults = document.getElementById('searchResults');
      searchResults.style.display = 'none';
    }

    // 切换缩略图显示状态
    function toggleThumbnails() {
      isThumbnailsVisible = !isThumbnailsVisible;
      document.getElementById('toggleThumbnailsBtn').textContent = isThumbnailsVisible ? '无图' : '有图';
      renderBookmarks(currentCategory);
    }

    function updateRunTime() {
      const startTime = new Date('2020-06-13T00:00:00');
      const now = new Date();
      const diff = now.getTime() - startTime.getTime();

      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((diff % (1000 * 60)) / 1000);

      document.getElementById('runtime').textContent = `${days} 天 ${hours} 小时 ${minutes} 分 ${seconds} 秒`;
    }

    // 登录相关函数
    function showLoginModal() {
      document.getElementById('loginOverlay').classList.remove('d-none');
      document.getElementById('adminPassword').focus();
    }

    function hideLoginModal() {
      document.getElementById('loginOverlay').classList.add('d-none');
      document.getElementById('adminPassword').value = '';
    }

    function handleLogin() {
      const password = document.getElementById('adminPassword').value;
      if (password === ADMIN_PASSWORD) {
        sessionStorage.setItem('adminLoggedIn', 'true');
        hideLoginModal();
        window.location.hash = '#admin';
      } else {
        alert('密码错误，请重试！');
        document.getElementById('adminPassword').value = '';
        document.getElementById('adminPassword').focus();
      }
    }

    // 只用prompt弹窗登录后台
    function handleHashChange() {
      const mainContent = document.getElementById('mainContent');
      const adminPanel = document.getElementById('adminPanel');
      const appContainer = document.getElementById('app');
      const frontendFooter = document.getElementById('frontendFooter');

      if (window.location.hash === '#admin') {
        if (sessionStorage.getItem('adminLoggedIn') === 'true') {
          appContainer.classList.add('d-none');
          frontendFooter.classList.add('d-none');
          adminPanel.classList.remove('d-none');
          renderAdminPanel();
        } else {
          showLoginModal();
        }
      } else {
        appContainer.classList.remove('d-none');
        frontendFooter.classList.remove('d-none');
        adminPanel.classList.add('d-none');
        renderCategories();
        renderBookmarks(currentCategory);
        window.scrollTo({ top: 0, behavior: 'auto' });
        const mainContent = document.querySelector('.main-content');
        if (mainContent) mainContent.scrollTop = 0;
      }
    }

    // --- 管理后台渲染函数 ---
    function renderAdminPanel() {
        const adminGroupList = document.getElementById('adminGroupList');
        adminGroupList.innerHTML = '';

        if (!bookmarksData.some(g => g.name === adminSelectedGroup) && bookmarksData.length > 0) {
            adminSelectedGroup = bookmarksData[0].name;
        } else if (bookmarksData.length === 0) {
            adminSelectedGroup = "";
        }

        bookmarksData.forEach((group, idx) => {
            const groupItem = document.createElement('div');
            groupItem.classList.add('admin-group-item');
            if (group.name === adminSelectedGroup) {
                groupItem.classList.add('active');
            }
            groupItem.innerHTML = `
                <span>${group.name}</span>
                <button class="btn-add" onclick="addNewGroupAfter('${group.name}')"><i class="fas fa-plus"></i></button>
                <button class="btn-edit" onclick="editGroup('${group.name}')"><i class="fas fa-pencil-alt"></i></button>
                <button class="btn-delete" onclick="deleteGroup('${group.name}')"><i class="fas fa-trash-alt"></i></button>
                <button class="btn-arrow up" onclick="moveGroup('${group.name}', -1); event.stopPropagation();" title="上移">↑</button>
                <button class="btn-arrow down" onclick="moveGroup('${group.name}', 1); event.stopPropagation();" title="下移">↓</button>
            `;
            groupItem.addEventListener('click', (e) => {
                if (!e.target.closest('button')) {
                    adminSelectedGroup = group.name;
                    renderAdminPanel();
                }
            });
            adminGroupList.appendChild(groupItem);
        });

        renderAdminBookmarksTable(adminSelectedGroup);
        populateGroupSelect();
        resetBookmarkForm();
    }

    function moveGroup(groupName, direction) {
      const idx = bookmarksData.findIndex(g => g.name === groupName);
      if (idx < 0) return;
      const newIdx = idx + direction;
      if (newIdx < 0 || newIdx >= bookmarksData.length) return;
      [bookmarksData[idx], bookmarksData[newIdx]] = [bookmarksData[newIdx], bookmarksData[idx]];
      saveBookmarks();
      renderAdminPanel();
      renderCategories();
      renderBookmarks(currentCategory);
    }

    function renderAdminBookmarksTable(groupName) {
        const adminBookmarkTableBody = document.getElementById('adminBookmarkTableBody');
        adminBookmarkTableBody.innerHTML = '';

        const group = bookmarksData.find(g => g.name === groupName);
        const bookmarks = group ? group.bookmarks : [];

        if (bookmarks.length === 0) {
            adminBookmarkTableBody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">该分组下暂无书签。</td></tr>`;
            return;
        }

        bookmarks.forEach((bookmark, idx) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><a href="#" onclick="editBookmark('${bookmark.id}', '${groupName}'); event.preventDefault();">${bookmark.name}</a></td>
                <td><a href="${bookmark.url}" target="_blank">${bookmark.url}</a></td>
                <td>${groupName}</td>
                <td>
                    <button class="btn-add" onclick="prepareAddBookmarkAfter('${bookmark.id}', '${groupName}')"><i class="fas fa-plus"></i></button>
                    <button class="btn-edit" onclick="editBookmark('${bookmark.id}', '${groupName}')"><i class="fas fa-pencil-alt"></i></button>
                    <button class="btn-delete" onclick="deleteBookmark('${bookmark.id}', '${groupName}')"><i class="fas fa-trash-alt"></i></button>
                    <button class="btn-arrow up" onclick="moveBookmark('${bookmark.id}', '${groupName}', -1)">↑</button>
                    <button class="btn-arrow down" onclick="moveBookmark('${bookmark.id}', '${groupName}', 1)">↓</button>
                </td>
            `;
            adminBookmarkTableBody.appendChild(tr);
        });
    }

    function moveBookmark(bookmarkId, groupName, direction) {
      const group = bookmarksData.find(g => g.name === groupName);
      if (!group) return;
      const idx = group.bookmarks.findIndex(b => b.id == bookmarkId);
      if (idx < 0) return;
      const newIdx = idx + direction;
      if (newIdx < 0 || newIdx >= group.bookmarks.length) return;
      [group.bookmarks[idx], group.bookmarks[newIdx]] = [group.bookmarks[newIdx], group.bookmarks[idx]];
      saveBookmarks();
      renderAdminPanel();
      renderBookmarks(currentCategory);
    }

    function populateGroupSelect() {
        const bookmarkGroupSelect = document.getElementById('bookmarkGroup');
        bookmarkGroupSelect.innerHTML = '';
        bookmarksData.forEach(group => {
            const option = document.createElement('option');
            option.value = group.name;
            option.textContent = group.name;
            bookmarkGroupSelect.appendChild(option);
        });
    }

    function addNewGroupAfter(targetGroupName) {
        const newGroupName = prompt(`请输入新的分组名称（将在 \"${targetGroupName}\" 后面添加）:`);
        if (newGroupName && newGroupName.trim() !== "") {
            const trimmedNewName = newGroupName.trim();
            if (bookmarksData.some(g => g.name === trimmedNewName)) {
                alert('分组名称已存在！');
                return;
            }
            const defaultBookmark = {
                id: Date.now() + Math.random(),
                name: "默认书签",
                url: "https://www.example.com",
                favicon: "https://www.google.com/s2/favicons?domain=example.com"
            };
            const targetIndex = bookmarksData.findIndex(group => group.name === targetGroupName);
            if (targetIndex !== -1) {
                bookmarksData.splice(targetIndex + 1, 0, { name: trimmedNewName, bookmarks: [defaultBookmark] });
            } else {
                bookmarksData.push({ name: trimmedNewName, bookmarks: [defaultBookmark] });
            }
            saveBookmarks();
            adminSelectedGroup = trimmedNewName;
            renderAdminPanel();
            renderCategories();
        } else if (newGroupName !== null && newGroupName.trim() === "") {
            alert('分组名称不能为空！');
        }
    }

    function editGroup(oldGroupName) {
        const newGroupName = prompt(`请输入新的分组名称（原名称: ${oldGroupName}）:`);
        if (newGroupName && newGroupName.trim() !== oldGroupName) {
            const trimmedNewName = newGroupName.trim();
            if (bookmarksData.some(g => g.name === trimmedNewName)) {
                alert('新的分组名称已存在！');
                return;
            }
            const groupToEdit = bookmarksData.find(g => g.name === oldGroupName);
            if (groupToEdit) {
                groupToEdit.name = trimmedNewName;
            }
            if (currentCategory === oldGroupName) {
                currentCategory = trimmedNewName;
                saveCurrentCategory();
            }
            if (adminSelectedGroup === oldGroupName) {
                adminSelectedGroup = trimmedNewName;
            }
            saveBookmarks();
            renderAdminPanel();
            renderCategories();
            renderBookmarks(currentCategory);
        }
    }

    function deleteGroup(groupToDelete) {
        if (bookmarksData.length === 1) {
            alert('不能删除最后一个分组！');
            return;
        }
        if (confirm(`确定要删除分组 \"${groupToDelete}\" 吗？该分组下的所有书签将被一同删除。`)) {
            bookmarksData = bookmarksData.filter(group => group.name !== groupToDelete);
            saveBookmarks();
            let newSelectedGroup = "";
            if (bookmarksData.length > 0) {
                newSelectedGroup = bookmarksData[0].name;
            }
            if (currentCategory === groupToDelete || !bookmarksData.some(g => g.name === currentCategory)) {
                currentCategory = newSelectedGroup;
                saveCurrentCategory();
            }
            adminSelectedGroup = newSelectedGroup;
            renderAdminPanel();
            renderCategories();
            renderBookmarks(currentCategory);
        }
    }

    function fetchFavicon() {
        const bookmarkUrlInput = document.getElementById('bookmarkUrl');
        const bookmarkFaviconInput = document.getElementById('bookmarkFavicon');
        const url = bookmarkUrlInput.value.trim();
        if (url) {
            const faviconServiceUrl = `https://favicon.im/${url}`;
            bookmarkFaviconInput.value = faviconServiceUrl;
            const img = new Image();
            img.src = faviconServiceUrl;
            img.onerror = () => {
                bookmarkFaviconInput.value = 'https://www.google.com/s2/favicons?domain=default';
            };
        }
    }

    function prepareAddBookmarkAfter(id, groupName) {
        resetBookmarkForm();
        document.getElementById('bookmarkForm').classList.remove('d-none');
        document.getElementById('bookmarkAfterId').value = id;
        document.getElementById('bookmarkGroup').value = groupName;
    }

    function handleSaveBookmark(event) {
        event.preventDefault();
        const id = document.getElementById('bookmarkId').value;
        const bookmarkAfterId = document.getElementById('bookmarkAfterId').value;
        const name = document.getElementById('bookmarkName').value.trim();
        const url = document.getElementById('bookmarkUrl').value.trim();
        const favicon = document.getElementById('bookmarkFavicon').value.trim();
        const groupName = document.getElementById('bookmarkGroup').value;

        if (!name || !url || !groupName) {
            alert('名称、URL 和分组是必填项！');
            return;
        }

        const targetGroup = bookmarksData.find(g => g.name === groupName);
        if (!targetGroup) {
            alert('选择的分组不存在！');
            return;
        }

        const newBookmark = { id: Date.now() + Math.random(), name, url, favicon };

        if (id) {
          let originalGroupName = null;
          let originalIndex = -1;
          bookmarksData.forEach(group => {
            group.bookmarks.forEach((b, idx) => {
              if (b.id == id) {
                originalGroupName = group.name;
                originalIndex = idx;
              }
            });
          });
          if (targetGroup.name === originalGroupName && originalIndex !== -1) {
            targetGroup.bookmarks[originalIndex] = { id: parseFloat(id), name, url, favicon };
          } else {
            bookmarksData.forEach(group => {
              group.bookmarks = group.bookmarks.filter(b => b.id != id);
            });
            targetGroup.bookmarks.push({ id: parseFloat(id), name, url, favicon });
          }
        } else if (bookmarkAfterId) {
            const targetIndex = targetGroup.bookmarks.findIndex(b => b.id == bookmarkAfterId);
            if (targetIndex !== -1) {
                targetGroup.bookmarks.splice(targetIndex + 1, 0, newBookmark);
            } else {
                targetGroup.bookmarks.push(newBookmark);
            }
        } else {
            targetGroup.bookmarks.push(newBookmark);
        }

        saveBookmarks();
        resetBookmarkForm();
        renderAdminPanel();
        renderBookmarks(currentCategory);
        renderCategories();
    }

    function editBookmark(id, groupName) {
        resetBookmarkForm();
        document.getElementById('bookmarkForm').classList.remove('d-none');
        document.getElementById('bookmarkAfterId').value = '';

        const group = bookmarksData.find(g => g.name === groupName);
        if (!group) return;

        const bookmarkToEdit = group.bookmarks.find(b => b.id == id);

        if (bookmarkToEdit) {
            document.getElementById('bookmarkId').value = bookmarkToEdit.id;
            document.getElementById('bookmarkName').value = bookmarkToEdit.name;
            document.getElementById('bookmarkUrl').value = bookmarkToEdit.url;
            document.getElementById('bookmarkFavicon').value = bookmarkToEdit.favicon;
            document.getElementById('bookmarkGroup').value = groupName;
        }
    }

    function deleteBookmark(id, groupName) {
        if (confirm('确定要删除此书签吗？')) {
            const group = bookmarksData.find(g => g.name === groupName);
            if (group) {
                group.bookmarks = group.bookmarks.filter(bookmark => bookmark.id != id);
                saveBookmarks();
                renderAdminPanel();
                renderBookmarks(currentCategory);
            }
        }
    }

    function resetBookmarkForm() {
        document.getElementById('bookmarkForm').reset();
        document.getElementById('bookmarkId').value = '';
        document.getElementById('bookmarkAfterId').value = '';
        document.getElementById('bookmarkGroup').value = adminSelectedGroup || (bookmarksData.length > 0 ? bookmarksData[0].name : "");
        document.getElementById('bookmarkForm').classList.add('d-none');
    }

    function handleExport() {
        const exportOption = prompt("选择导出方式：\n1. 导出全部书签 (输入 '1')\n2. 导出当前分组书签 (输入 '2')", "1");

        if (exportOption === '1') {
            exportBookmarks(true);
        } else if (exportOption === '2') {
            exportBookmarks(false);
        } else {
            alert('导出操作已取消。');
        }
    }

    function exportBookmarks(exportAll) {
        let dataToExport = {};
        let filename;

        if (exportAll) {
            bookmarksData.forEach(group => {
                dataToExport[group.name] = group.bookmarks.map(bookmark => ({
                    name: bookmark.name,
                    url: bookmark.url,
                    favicon: bookmark.favicon
                }));
            });
            filename = "all_bookmarks.json";
        } else {
            const selectedGroupData = bookmarksData.find(group => group.name === adminSelectedGroup);
            if (selectedGroupData) {
                dataToExport[selectedGroupData.name] = selectedGroupData.bookmarks.map(bookmark => ({
                    name: bookmark.name,
                    url: bookmark.url,
                    favicon: bookmark.favicon
                }));
                filename = `${adminSelectedGroup}_bookmarks.json`;
            } else {
                alert("请选择一个分组或该分组下没有书签可导出。");
                return;
            }
        }

        const dataStr = JSON.stringify(dataToExport, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function importBookmarks(event) {
        const file = event.target.files[0];
        if (!file) {
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedRawData = JSON.parse(e.target.result);
                let processedImportedData = [];

                if (Array.isArray(importedRawData)) {
                    processedImportedData = importedRawData.map(group => ({
                        name: group.name,
                        bookmarks: (group.bookmarks || []).map(item => ({
                            id: item.id || Date.now() + Math.random(),
                            name: item.name || item.title || '未知名称',
                            url: item.url || item.link || 'http://unknown.com',
                            favicon: item.favicon || `https://favicon.im/${item.url || item.link || 'http://unknown.com'}`,
                        })).filter(b => b.name && b.url)
                    }));
                } else if (typeof importedRawData === 'object' && importedRawData !== null) {
                    for (const groupName in importedRawData) {
                        if (Array.isArray(importedRawData[groupName])) {
                            processedImportedData.push({
                                name: groupName,
                                bookmarks: importedRawData[groupName].map(item => ({
                                    id: item.id || Date.now() + Math.random(),
                                    name: item.name || item.title || '未知名称',
                                    url: item.url || item.link || 'http://unknown.com',
                                    favicon: item.favicon || `https://favicon.im/${item.url || item.link || 'http://unknown.com'}`,
                                })).filter(b => b.name && b.url)
                            });
                        } else if (typeof importedRawData[groupName] === 'object' && importedRawData[groupName] !== null) {
                            if (importedRawData[groupName].name && importedRawData[groupName].url) {
                                processedImportedData.push({
                                    name: groupName,
                                    bookmarks: [{
                                        id: importedRawData[groupName].id || Date.now() + Math.random(),
                                        name: importedRawData[groupName].name || importedRawData[groupName].title || '未知名称',
                                        url: importedRawData[groupName].url || importedRawData[groupName].link || 'http://unknown.com',
                                        favicon: importedRawData[groupName].favicon || `https://favicon.im/${importedRawData[groupName].url || importedRawData[groupName].link || 'http://unknown.com'}`,
                                    }]
                                });
                            }
                        }
                    }
                }

                if (processedImportedData.length === 0) {
                    alert('导入的JSON文件不包含有效的书签数据。请确保文件包含书签名称和URL。');
                    return;
                }

                const importOption = prompt("选择导入方式：\n1. 覆盖现有书签 (输入 '1')\n2. 添加到现有书签 (输入 '2')", "2");

                if (importOption === '1') {
                    if (confirm('确定要覆盖现有书签数据吗？此操作不可撤销！')) {
                        bookmarksData = processedImportedData;
                        saveBookmarks();
                        colorMap = {};
                        currentCategory = bookmarksData.length > 0 ? bookmarksData[0].name : "";
                        saveCurrentCategory();
                        renderCategories();
                        renderBookmarks(currentCategory);
                        renderAdminPanel();
                    }
                } else if (importOption === '2') {
                    processedImportedData.forEach(importedGroup => {
                        const existingGroup = bookmarksData.find(g => g.name === importedGroup.name);
                        if (existingGroup) {
                            importedGroup.bookmarks.forEach(importedBookmark => {
                                const existingBookmarkIndex = existingGroup.bookmarks.findIndex(b => b.url === importedBookmark.url);
                                if (existingBookmarkIndex !== -1) {
                                    existingGroup.bookmarks[existingBookmarkIndex] = importedBookmark;
                                } else {
                                    existingGroup.bookmarks.push(importedBookmark);
                                }
                            });
                        } else {
                            bookmarksData.push(importedGroup);
                        }
                    });
                    saveBookmarks();
                    renderCategories();
                    renderBookmarks(currentCategory);
                    renderAdminPanel();
                }
            } catch (e) {
                alert('导入文件时出错：' + e.message);
            }
        };
        reader.readAsText(file);
    }

    function clearAllBookmarks() {
        if (confirm('确定要清空所有书签数据吗？此操作不可撤销！')) {
            bookmarksData = [];
            saveBookmarks();
            colorMap = {};
            currentCategory = "";
            saveCurrentCategory();
            renderCategories();
            renderBookmarks(currentCategory);
            renderAdminPanel();
        }
    }

    // 初始化函数
    function init() {
        loadBookmarks();
        renderCategories();
        renderBookmarks(currentCategory);
        updateRunTime();
        setInterval(updateRunTime, 1000);
        
        // 添加事件监听器
        document.getElementById('searchInput').addEventListener('input', searchBookmarks);
        document.getElementById('toggleThumbnailsBtn').addEventListener('click', toggleThumbnails);
        document.getElementById('adminLoginBtn').addEventListener('click', showLoginModal);
        document.getElementById('loginBtn').addEventListener('click', handleLogin);
        document.getElementById('cancelBtn').addEventListener('click', hideLoginModal);
        document.getElementById('adminPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                handleLogin();
            }
        });
        window.addEventListener('hashchange', handleHashChange);
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-bar')) {
                hideSearchResults();
            }
        });
    }

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>    