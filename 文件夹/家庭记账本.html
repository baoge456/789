<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶åº­è®°è´¦æœ¬</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .tab-btn {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #6c757d;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: white;
            color: #007bff;
            border-bottom: 2px solid #007bff;
        }

        .tab-content {
            display: none;
            padding: 20px;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .type-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .type-option {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .type-option.income {
            color: #28a745;
        }

        .type-option.expense {
            color: #dc3545;
        }

        .type-option.selected {
            border-color: currentColor;
            background-color: rgba(0, 123, 255, 0.1);
        }

        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #545b62;
        }

        .category-tabs {
            display: flex;
            margin-bottom: 20px;
            background: #f8f9fa;
            border-radius: 5px;
            overflow: hidden;
        }

        .category-tab {
            flex: 1;
            padding: 10px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: #6c757d;
            transition: all 0.3s;
        }

        .category-tab.active {
            background: #007bff;
            color: white;
        }

        .icon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 10px;
            margin: 15px 0;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
        }

        .icon-option {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s;
        }

        .icon-option:hover {
            border-color: #007bff;
            transform: scale(1.05);
        }

        .icon-option.selected {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
            transform: scale(1.1);
        }

        .records-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .record-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.3s;
        }

        .record-item:hover {
            background-color: #f8f9fa;
        }

        .record-info {
            flex: 1;
        }

        .record-category {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .record-date {
            font-size: 12px;
            color: #6c757d;
        }

        .record-amount {
            font-weight: bold;
            font-size: 18px;
        }

        .record-amount.income {
            color: #28a745;
        }

        .record-amount.expense {
            color: #dc3545;
        }

        .record-actions {
            display: flex;
            gap: 5px;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .btn-edit {
            background-color: #ffc107;
            color: #212529;
        }

        .btn-delete {
            background-color: #dc3545;
            color: white;
        }

        .category-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .category-item {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            text-align: center;
            background: white;
            transition: all 0.3s;
        }

        .category-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .category-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .category-name {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .category-actions {
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .filter-group {
            flex: 1;
        }

        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
            color: #6c757d;
        }

        .filter-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 14px;
        }

        .summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-item {
            padding: 15px;
            background: white;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .summary-label {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .summary-amount {
            font-size: 18px;
            font-weight: bold;
        }

        .summary-amount.income {
            color: #28a745;
        }

        .summary-amount.expense {
            color: #dc3545;
        }

        .summary-amount.balance {
            color: #007bff;
        }

        .backup-section {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .backup-buttons {
            display: flex;
            gap: 10px;
        }

        #restore-input {
            display: none;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        @media (max-width: 600px) {
            .container {
                margin: 0;
            }

            .summary {
                grid-template-columns: 1fr;
            }

            .category-list {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }

            .filters {
                flex-direction: column;
            }

            .form-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ’° å®¶åº­è®°è´¦æœ¬</h1>
            <p>è½»æ¾ç®¡ç†æ‚¨çš„æ”¶æ”¯</p>
        </div>

        <div class="tabs">
            <button class="tab-btn active" data-tab="records">è®°è´¦</button>
            <button class="tab-btn" data-tab="categories">åˆ†ç±»</button>
            <button class="tab-btn" data-tab="accounts">è´¦æˆ·</button>
            <button class="tab-btn" data-tab="reports">æŠ¥è¡¨</button>
            <button class="tab-btn" data-tab="settings">è®¾ç½®</button>
        </div>

        <!-- è®°è´¦é¡µé¢ -->
        <div id="records" class="tab-content active">
            <form id="record-form">
                <div class="type-selector">
                    <label class="type-option expense selected">
                        <input type="radio" name="type" value="expense" checked style="display: none;">
                        <div>ğŸ’¸ æ”¯å‡º</div>
                    </label>
                    <label class="type-option income">
                        <input type="radio" name="type" value="income" style="display: none;">
                        <div>ğŸ’° æ”¶å…¥</div>
                    </label>
                </div>

                <div class="form-group">
                    <label>é‡‘é¢</label>
                    <input type="number" id="amount" step="0.01" placeholder="0.00" required>
                </div>

                <div class="form-group">
                    <label>åˆ†ç±»</label>
                    <select id="category" required>
                        <option value="">è¯·é€‰æ‹©åˆ†ç±»</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>è´¦æˆ·</label>
                    <select id="account" required>
                        <option value="">è¯·é€‰æ‹©è´¦æˆ·</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>å¤‡æ³¨</label>
                    <input type="text" id="note" placeholder="å¤‡æ³¨ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰">
                </div>

                <div class="form-group">
                    <label>æ—¥æœŸ</label>
                    <input type="date" id="date" required>
                </div>

                <button type="submit" class="btn btn-primary">æ·»åŠ è®°å½•</button>
            </form>

            <div class="filters">
                <div class="filter-group">
                    <label>æœˆä»½</label>
                    <select id="filter-month">
                        <option value="">å…¨éƒ¨æœˆä»½</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>ç±»å‹</label>
                    <select id="filter-type">
                        <option value="">å…¨éƒ¨ç±»å‹</option>
                        <option value="income">æ”¶å…¥</option>
                        <option value="expense">æ”¯å‡º</option>
                    </select>
                </div>
            </div>

            <div class="summary">
                <div class="summary-item">
                    <div class="summary-label">æ€»æ”¶å…¥</div>
                    <div class="summary-amount income" id="total-income">Â¥0.00</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">æ€»æ”¯å‡º</div>
                    <div class="summary-amount expense" id="total-expense">Â¥0.00</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">ä½™é¢</div>
                    <div class="summary-amount balance" id="balance">Â¥0.00</div>
                </div>
            </div>

            <div class="records-list" id="records-list"></div>
        </div>

        <!-- åˆ†ç±»ç®¡ç†é¡µé¢ -->
        <div id="categories" class="tab-content">
            <div class="category-tabs">
                <button class="category-tab active" data-type="expense">æ”¯å‡ºåˆ†ç±»</button>
                <button class="category-tab" data-type="income">æ”¶å…¥åˆ†ç±»</button>
            </div>

            <form id="category-form">
                <div class="form-group">
                    <label>åˆ†ç±»åç§°</label>
                    <input type="text" id="category-name" placeholder="è¾“å…¥åˆ†ç±»åç§°" required>
                </div>

                <div class="form-group">
                    <label>é€‰æ‹©å›¾æ ‡</label>
                    <div class="icon-grid" id="icon-grid"></div>
                </div>

                <div class="form-buttons">
                    <button type="submit" class="btn btn-primary">æ·»åŠ åˆ†ç±»</button>
                    <button type="button" class="btn btn-secondary" onclick="app.cancelCategoryEdit()">å–æ¶ˆ</button>
                </div>
            </form>

            <div class="category-list" id="category-list"></div>
        </div>

        <!-- è´¦æˆ·ç®¡ç†é¡µé¢ -->
        <div id="accounts" class="tab-content">
            <form id="account-form">
                <div class="form-group">
                    <label>è´¦æˆ·åç§°</label>
                    <input type="text" id="account-name" placeholder="å¦‚ï¼šç°é‡‘ã€é“¶è¡Œå¡" required>
                </div>

                <div class="form-group">
                    <label>åˆå§‹ä½™é¢</label>
                    <input type="number" id="initial-balance" step="0.01" placeholder="0.00" required>
                </div>

                <button type="submit" class="btn btn-primary">æ·»åŠ è´¦æˆ·</button>
            </form>

            <div class="category-list" id="account-list"></div>
        </div>

        <!-- æŠ¥è¡¨é¡µé¢ -->
        <div id="reports" class="tab-content">
            <div class="summary">
                <div class="summary-item">
                    <div class="summary-label">æœ¬æœˆæ”¶å…¥</div>
                    <div class="summary-amount income" id="month-income">Â¥0.00</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">æœ¬æœˆæ”¯å‡º</div>
                    <div class="summary-amount expense" id="month-expense">Â¥0.00</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">æœ¬æœˆç»“ä½™</div>
                    <div class="summary-amount balance" id="month-balance">Â¥0.00</div>
                </div>
            </div>

            <div id="charts-container">
                <p style="text-align: center; color: #6c757d; padding: 40px;">
                    ğŸ“Š å›¾è¡¨åŠŸèƒ½å¼€å‘ä¸­...
                </p>
            </div>
        </div>

        <!-- è®¾ç½®é¡µé¢ -->
        <div id="settings" class="tab-content">
            <div class="backup-section">
                <h3>æ•°æ®å¤‡ä»½ä¸æ¢å¤</h3>
                <p style="margin: 10px 0; color: #6c757d;">å®šæœŸå¤‡ä»½æ‚¨çš„æ•°æ®ï¼Œé¿å…æ•°æ®ä¸¢å¤±</p>
                
                <div class="backup-buttons">
                    <button id="backup-btn" class="btn btn-primary">å¤‡ä»½æ•°æ®</button>
                    <button id="restore-btn" class="btn btn-secondary">æ¢å¤æ•°æ®</button>
                </div>
                
                <input type="file" id="restore-input" accept=".json">
            </div>
        </div>
    </div>

    <script>
        class AccountingApp {
            constructor() {
                this.records = JSON.parse(localStorage.getItem('accounting_records') || '[]');
                this.categories = JSON.parse(localStorage.getItem('accounting_categories') || '[]');
                this.accounts = JSON.parse(localStorage.getItem('accounting_accounts') || '[]');
                this.currentTab = 'records';
                this.currentCategoryType = 'expense';
                this.editingItem = null;
                
                this.icons = [
                    'ğŸ”', 'ğŸ•', 'ğŸœ', 'â˜•', 'ğŸš—', 'â›½', 'ğŸ ', 'ğŸ’¡', 'ğŸ“±', 'ğŸ‘•',
                    'ğŸ¬', 'ğŸ®', 'ğŸ“š', 'ğŸ’Š', 'ğŸ¥', 'âœˆï¸', 'ğŸšŒ', 'ğŸ›’', 'ğŸ’°', 'ğŸ’³',
                    'ğŸ', 'ğŸ‰', 'ğŸ’¼', 'ğŸ“Š', 'ğŸ†', 'ğŸ¯', 'âš½', 'ğŸ¸', 'ğŸ¨', 'ğŸŒŸ'
                ];

                this.initializeDefaultData();
                this.bindEvents();
                this.renderAll();
                this.setDefaultDate();
            }

            initializeDefaultData() {
                if (this.categories.length === 0) {
                    this.categories = [
                        { id: 1, name: 'é¤é¥®', type: 'expense', icon: 'ğŸ”' },
                        { id: 2, name: 'äº¤é€š', type: 'expense', icon: 'ğŸš—' },
                        { id: 3, name: 'è´­ç‰©', type: 'expense', icon: 'ğŸ›’' },
                        { id: 4, name: 'å¨±ä¹', type: 'expense', icon: 'ğŸ¬' },
                        { id: 5, name: 'å·¥èµ„', type: 'income', icon: 'ğŸ’°' },
                        { id: 6, name: 'å¥–é‡‘', type: 'income', icon: 'ğŸ' }
                    ];
                    this.saveCategories();
                }

                if (this.accounts.length === 0) {
                    this.accounts = [
                        { id: 1, name: 'ç°é‡‘', balance: 1000 },
                        { id: 2, name: 'é“¶è¡Œå¡', balance: 5000 }
                    ];
                    this.saveAccounts();
                }
            }

            bindEvents() {
                // æ ‡ç­¾é¡µåˆ‡æ¢
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.switchTab(e.target.dataset.tab);
                    });
                });

                // è¡¨å•æäº¤
                document.getElementById('record-form').addEventListener('submit', (e) => this.handleRecordSubmit(e));
                document.getElementById('category-form').addEventListener('submit', (e) => this.handleCategorySubmit(e));
                document.getElementById('account-form').addEventListener('submit', (e) => this.handleAccountSubmit(e));

                // ç±»å‹é€‰æ‹©å™¨
                document.querySelectorAll('input[name="type"]').forEach(radio => {
                    radio.addEventListener('change', () => this.updateCategoryOptions());
                });

                // ç±»å‹é€‰æ‹©å™¨ç‚¹å‡»
                document.querySelectorAll('.type-option').forEach(option => {
                    option.addEventListener('click', (e) => {
                        e.preventDefault();
                        const radio = option.querySelector('input[type="radio"]');
                        if (radio) {
                            radio.checked = true;
                            this.updateTypeSelection();
                            this.updateCategoryOptions();
                        }
                    });
                });

                // åˆ†ç±»æ ‡ç­¾é¡µ
                this.bindCategoryTabs();

                // å¤‡ä»½æ¢å¤
                document.getElementById('backup-btn').addEventListener('click', () => this.backupData());
                document.getElementById('restore-btn').addEventListener('click', () => this.showRestoreDialog());
                document.getElementById('restore-input').addEventListener('change', (e) => this.restoreData(e));

                // ç­›é€‰å™¨
                document.getElementById('filter-month').addEventListener('change', () => this.filterRecords());
                document.getElementById('filter-type').addEventListener('change', () => this.filterRecords());
            }

            bindCategoryTabs() {
                document.querySelectorAll('.category-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.switchCategoryTab(e.target.dataset.type);
                    });
                });
            }

            bindIconEvents() {
                document.querySelectorAll('.icon-option').forEach(icon => {
                    icon.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.selectIcon(e.target.dataset.icon);
                    });
                });
            }

            updateTypeSelection() {
                document.querySelectorAll('.type-option').forEach(option => {
                    option.classList.remove('selected');
                });
                
                const checkedRadio = document.querySelector('input[name="type"]:checked');
                if (checkedRadio) {
                    checkedRadio.closest('.type-option').classList.add('selected');
                }
            }

            switchTab(tab) {
                this.currentTab = tab;
                
                // æ›´æ–°æ ‡ç­¾æŒ‰é’®çŠ¶æ€
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-tab="${tab}"]`).classList.add('active');

                // æ›´æ–°å†…å®¹åŒºåŸŸ
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(tab).classList.add('active');

                // æ ¹æ®æ ‡ç­¾é¡µæ¸²æŸ“ç›¸åº”å†…å®¹
                if (tab === 'categories') {
                    this.renderIconGrid();
                    this.renderCategories();
                } else if (tab === 'accounts') {
                    this.renderAccounts();
                } else if (tab === 'records') {
                    this.renderRecords();
                    this.updateSummary();
                } else if (tab === 'reports') {
                    this.updateMonthlyReport();
                }
            }

            switchCategoryTab(type) {
                this.currentCategoryType = type;
                
                // æ›´æ–°æ ‡ç­¾é¡µæ ·å¼
                document.querySelectorAll('.category-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                const activeTab = document.querySelector(`[data-type="${type}"]`);
                if (activeTab) {
                    activeTab.classList.add('active');
                }
                
                // é‡æ–°æ¸²æŸ“åˆ†ç±»åˆ—è¡¨
                this.renderCategories();
                
                // å¦‚æœä¸æ˜¯ç¼–è¾‘çŠ¶æ€ï¼Œæ¸…ç©ºè¡¨å•
                if (!this.editingItem) {
                    this.resetCategoryForm();
                }
            }

            renderIconGrid() {
                const container = document.getElementById('icon-grid');
                container.innerHTML = '';
                
                this.icons.forEach(icon => {
                    const div = document.createElement('div');
                    div.className = 'icon-option';
                    div.dataset.icon = icon;
                    div.textContent = icon;
                    container.appendChild(div);
                });
                
                // é‡æ–°ç»‘å®šå›¾æ ‡ç‚¹å‡»äº‹ä»¶
                this.bindIconEvents();
            }

            selectIcon(icon) {
                // æ¸…é™¤æ‰€æœ‰å›¾æ ‡çš„é€‰ä¸­çŠ¶æ€
                document.querySelectorAll('.icon-option').forEach(el => {
                    el.classList.remove('selected');
                });
                
                // é€‰ä¸­æŒ‡å®šå›¾æ ‡
                const iconEl = document.querySelector(`[data-icon="${icon}"]`);
                if (iconEl) {
                    iconEl.classList.add('selected');
                    // æ»šåŠ¨åˆ°é€‰ä¸­çš„å›¾æ ‡
                    iconEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }

            clearIconSelection() {
                document.querySelectorAll('.icon-option').forEach(el => {
                    el.classList.remove('selected');
                });
            }

            setDefaultDate() {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('date').value = today;
            }

            updateCategoryOptions() {
                const type = document.querySelector('input[name="type"]:checked').value;
                const categorySelect = document.getElementById('category');
                const categories = this.categories.filter(c => c.type === type);
                
                categorySelect.innerHTML = '<option value="">è¯·é€‰æ‹©åˆ†ç±»</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = `${category.icon} ${category.name}`;
                    categorySelect.appendChild(option);
                });
            }

            updateAccountOptions() {
                const accountSelect = document.getElementById('account');
                accountSelect.innerHTML = '<option value="">è¯·é€‰æ‹©è´¦æˆ·</option>';
                
                this.accounts.forEach(account => {
                    const option = document.createElement('option');
                    option.value = account.id;
                    option.textContent = `${account.name} (Â¥${account.balance.toFixed(2)})`;
                    accountSelect.appendChild(option);
                });
            }

            handleRecordSubmit(e) {
                e.preventDefault();
                
                const formData = new FormData(e.target);
                const type = formData.get('type');
                const amount = parseFloat(formData.get('amount') || document.getElementById('amount').value);
                const categoryId = parseInt(document.getElementById('category').value);
                const accountId = parseInt(document.getElementById('account').value);
                const note = document.getElementById('note').value;
                const date = document.getElementById('date').value;

                if (!amount || !categoryId || !accountId || !date) {
                    alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
                    return;
                }

                const category = this.categories.find(c => c.id === categoryId);
                const account = this.accounts.find(a => a.id === accountId);

                if (!category || !account) {
                    alert('åˆ†ç±»æˆ–è´¦æˆ·ä¸å­˜åœ¨');
                    return;
                }

                const record = {
                    id: Date.now(),
                    type,
                    amount,
                    categoryId,
                    categoryName: category.name,
                    categoryIcon: category.icon,
                    accountId,
                    accountName: account.name,
                    note,
                    date,
                    timestamp: new Date().toISOString()
                };

                // æ›´æ–°è´¦æˆ·ä½™é¢
                if (type === 'expense') {
                    account.balance -= amount;
                } else {
                    account.balance += amount;
                }

                this.records.push(record);
                this.saveRecords();
                this.saveAccounts();
                
                // é‡ç½®è¡¨å•
                e.target.reset();
                this.setDefaultDate();
                this.updateTypeSelection();
                
                // æ›´æ–°ç•Œé¢
                this.renderRecords();
                this.updateSummary();
                this.updateAccountOptions();
                
                alert('è®°å½•æ·»åŠ æˆåŠŸï¼');
            }

            handleCategorySubmit(e) {
                e.preventDefault();
                
                const nameInput = document.getElementById('category-name');
                const name = nameInput.value.trim();
                const selectedIcon = document.querySelector('.icon-option.selected');
                
                // éªŒè¯è¾“å…¥
                if (!name) {
                    alert('è¯·è¾“å…¥åˆ†ç±»åç§°');
                    nameInput.focus();
                    return;
                }
                
                if (!selectedIcon) {
                    alert('è¯·é€‰æ‹©ä¸€ä¸ªå›¾æ ‡');
                    return;
                }

                const categoryData = {
                    name: name,
                    type: this.currentCategoryType,
                    icon: selectedIcon.dataset.icon
                };

                if (this.editingItem) {
                    // ç¼–è¾‘æ¨¡å¼ï¼šæ›´æ–°ç°æœ‰åˆ†ç±»
                    const index = this.categories.findIndex(c => c.id === this.editingItem.id);
                    if (index !== -1) {
                        this.categories[index] = {
                            ...this.editingItem,
                            ...categoryData
                        };
                    }
                    
                    alert('åˆ†ç±»æ›´æ–°æˆåŠŸï¼');
                    this.editingItem = null;
                    
                    // æ¢å¤æŒ‰é’®æ–‡æœ¬
                    const submitBtn = document.querySelector('#category-form button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.textContent = 'æ·»åŠ åˆ†ç±»';
                    }
                } else {
                    // æ–°å¢æ¨¡å¼ï¼šåˆ›å»ºæ–°åˆ†ç±»
                    const newCategory = {
                        id: Date.now(),
                        ...categoryData
                    };
                    this.categories.push(newCategory);
                    alert('åˆ†ç±»æ·»åŠ æˆåŠŸï¼');
                }

                // ä¿å­˜æ•°æ®å¹¶æ›´æ–°ç•Œé¢
                this.saveCategories();
                this.renderCategories();
                this.updateCategoryOptions();
                
                // æ¸…ç©ºè¡¨å•
                this.resetCategoryForm();
            }

            handleAccountSubmit(e) {
                e.preventDefault();
                
                const name = document.getElementById('account-name').value.trim();
                const balance = parseFloat(document.getElementById('initial-balance').value);

                if (!name || isNaN(balance)) {
                    alert('è¯·å¡«å†™æ‰€æœ‰å­—æ®µ');
                    return;
                }

                const account = {
                    id: Date.now(),
                    name,
                    balance
                };

                this.accounts.push(account);
                this.saveAccounts();
                this.renderAccounts();
                this.updateAccountOptions();
                
                e.target.reset();
                alert('è´¦æˆ·æ·»åŠ æˆåŠŸï¼');
            }

            editCategory(id) {
                const category = this.categories.find(c => c.id === id);
                if (!category) return;
                
                this.editingItem = category;
                this.currentCategoryType = category.type;
                
                // åˆ‡æ¢åˆ°åˆ†ç±»é¡µé¢
                this.switchTab('categories');
                
                // åˆ‡æ¢åˆ°å¯¹åº”çš„åˆ†ç±»æ ‡ç­¾é¡µ
                this.switchCategoryTab(category.type);
                
                // å»¶è¿Ÿå¡«å……è¡¨å•ï¼Œç¡®ä¿DOMå·²æ›´æ–°
                setTimeout(() => {
                    // å¡«å……åˆ†ç±»åç§°
                    const nameInput = document.getElementById('category-name');
                    if (nameInput) {
                        nameInput.value = category.name;
                    }
                    
                    // é€‰ä¸­å¯¹åº”å›¾æ ‡
                    this.selectIcon(category.icon);
                    
                    // æ›´æ–°æäº¤æŒ‰é’®æ–‡æœ¬
                    const submitBtn = document.querySelector('#category-form button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.textContent = 'æ›´æ–°åˆ†ç±»';
                    }
                    
                    // æ»šåŠ¨åˆ°è¡¨å•åŒºåŸŸ
                    document.getElementById('category-form').scrollIntoView({ behavior: 'smooth' });
                }, 150);
            }

            deleteCategory(id) {
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåˆ†ç±»å—ï¼Ÿ')) {
                    this.categories = this.categories.filter(c => c.id !== id);
                    this.saveCategories();
                    this.renderCategories();
                    this.updateCategoryOptions();
                }
            }

            deleteAccount(id) {
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè´¦æˆ·å—ï¼Ÿ')) {
                    this.accounts = this.accounts.filter(a => a.id !== id);
                    this.saveAccounts();
                    this.renderAccounts();
                    this.updateAccountOptions();
                }
            }

            deleteRecord(id) {
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
                    const record = this.records.find(r => r.id === id);
                    if (record) {
                        // æ¢å¤è´¦æˆ·ä½™é¢
                        const account = this.accounts.find(a => a.id === record.accountId);
                        if (account) {
                            if (record.type === 'expense') {
                                account.balance += record.amount;
                            } else {
                                account.balance -= record.amount;
                            }
                            this.saveAccounts();
                        }
                    }
                    
                    this.records = this.records.filter(r => r.id !== id);
                    this.saveRecords();
                    this.renderRecords();
                    this.updateSummary();
                    this.updateAccountOptions();
                }
            }

            resetCategoryForm() {
                const form = document.getElementById('category-form');
                if (form) {
                    form.reset();
                }
                
                this.clearIconSelection();
                this.editingItem = null;
                
                // æ¢å¤æŒ‰é’®æ–‡æœ¬
                const submitBtn = document.querySelector('#category-form button[type="submit"]');
                if (submitBtn) {
                    submitBtn.textContent = 'æ·»åŠ åˆ†ç±»';
                }
            }

            cancelCategoryEdit() {
                this.resetCategoryForm();
                alert('å·²å–æ¶ˆç¼–è¾‘');
            }

            renderCategories() {
                const container = document.getElementById('category-list');
                const categories = this.categories.filter(c => c.type === this.currentCategoryType);
                
                if (categories.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“‚</div>
                            <p>æš‚æ— ${this.currentCategoryType === 'expense' ? 'æ”¯å‡º' : 'æ”¶å…¥'}åˆ†ç±»</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = categories.map(category => `
                    <div class="category-item">
                        <div class="category-icon">${category.icon}</div>
                        <div class="category-name">${category.name}</div>
                        <div class="category-actions">
                            <button class="btn-sm btn-edit" onclick="app.editCategory(${category.id})">ç¼–è¾‘</button>
                            <button class="btn-sm btn-delete" onclick="app.deleteCategory(${category.id})">åˆ é™¤</button>
                        </div>
                    </div>
                `).join('');
            }

            renderAccounts() {
                const container = document.getElementById('account-list');
                
                if (this.accounts.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ’³</div>
                            <p>æš‚æ— è´¦æˆ·</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.accounts.map(account => `
                    <div class="category-item">
                        <div class="category-icon">ğŸ’³</div>
                        <div class="category-name">${account.name}</div>
                        <div style="font-size: 14px; color: #007bff; margin: 5px 0;">Â¥${account.balance.toFixed(2)}</div>
                        <div class="category-actions">
                            <button class="btn-sm btn-delete" onclick="app.deleteAccount(${account.id})">åˆ é™¤</button>
                        </div>
                    </div>
                `).join('');
            }

            renderRecords() {
                const container = document.getElementById('records-list');
                let records = [...this.records].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // åº”ç”¨ç­›é€‰
                const filterMonth = document.getElementById('filter-month').value;
                const filterType = document.getElementById('filter-type').value;
                
                if (filterMonth) {
                    records = records.filter(r => r.date.startsWith(filterMonth));
                }
                
                if (filterType) {
                    records = records.filter(r => r.type === filterType);
                }
                
                if (records.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“</div>
                            <p>æš‚æ— è®°å½•</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = records.map(record => `
                    <div class="record-item">
                        <div class="record-info">
                            <div class="record-category">${record.categoryIcon} ${record.categoryName}</div>
                            <div class="record-date">${record.date} â€¢ ${record.accountName}</div>
                            ${record.note ? `<div style="font-size: 12px; color: #6c757d;">${record.note}</div>` : ''}
                        </div>
                        <div class="record-amount ${record.type}">
                            ${record.type === 'expense' ? '-' : '+'}Â¥${record.amount.toFixed(2)}
                        </div>
                        <div class="record-actions">
                            <button class="btn-sm btn-delete" onclick="app.deleteRecord(${record.id})">åˆ é™¤</button>
                        </div>
                    </div>
                `).join('');
            }

            updateSummary() {
                const totalIncome = this.records
                    .filter(r => r.type === 'income')
                    .reduce((sum, r) => sum + r.amount, 0);
                
                const totalExpense = this.records
                    .filter(r => r.type === 'expense')
                    .reduce((sum, r) => sum + r.amount, 0);
                
                const balance = totalIncome - totalExpense;

                document.getElementById('total-income').textContent = `Â¥${totalIncome.toFixed(2)}`;
                document.getElementById('total-expense').textContent = `Â¥${totalExpense.toFixed(2)}`;
                document.getElementById('balance').textContent = `Â¥${balance.toFixed(2)}`;
            }

            updateMonthlyReport() {
                const currentMonth = new Date().toISOString().slice(0, 7);
                const monthRecords = this.records.filter(r => r.date.startsWith(currentMonth));
                
                const monthIncome = monthRecords
                    .filter(r => r.type === 'income')
                    .reduce((sum, r) => sum + r.amount, 0);
                
                const monthExpense = monthRecords
                    .filter(r => r.type === 'expense')
                    .reduce((sum, r) => sum + r.amount, 0);
                
                const monthBalance = monthIncome - monthExpense;

                document.getElementById('month-income').textContent = `Â¥${monthIncome.toFixed(2)}`;
                document.getElementById('month-expense').textContent = `Â¥${monthExpense.toFixed(2)}`;
                document.getElementById('month-balance').textContent = `Â¥${monthBalance.toFixed(2)}`;
            }

            filterRecords() {
                this.renderRecords();
            }

            initializeFilters() {
                const monthSelect = document.getElementById('filter-month');
                const months = [...new Set(this.records.map(r => r.date.slice(0, 7)))].sort().reverse();
                
                monthSelect.innerHTML = '<option value="">å…¨éƒ¨æœˆä»½</option>';
                months.forEach(month => {
                    const option = document.createElement('option');
                    option.value = month;
                    option.textContent = month;
                    monthSelect.appendChild(option);
                });
            }

            backupData() {
                const data = {
                    records: this.records,
                    categories: this.categories,
                    accounts: this.accounts,
                    timestamp: new Date().toISOString()
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `accounting_backup_${new Date().toISOString().slice(0, 10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                alert('æ•°æ®å¤‡ä»½æˆåŠŸï¼');
            }

            showRestoreDialog() {
                document.getElementById('restore-input').click();
            }

            restoreData(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (data.records && data.categories && data.accounts) {
                            if (confirm('ç¡®å®šè¦æ¢å¤æ•°æ®å—ï¼Ÿè¿™å°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ï¼')) {
                                this.records = data.records;
                                this.categories = data.categories;
                                this.accounts = data.accounts;
                                
                                this.saveRecords();
                                this.saveCategories();
                                this.saveAccounts();
                                
                                this.renderAll();
                                alert('æ•°æ®æ¢å¤æˆåŠŸï¼');
                            }
                        } else {
                            alert('å¤‡ä»½æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼');
                        }
                    } catch (error) {
                        alert('å¤‡ä»½æ–‡ä»¶è§£æå¤±è´¥ï¼');
                    }
                };
                reader.readAsText(file);
                
                // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
                e.target.value = '';
            }

            saveRecords() {
                localStorage.setItem('accounting_records', JSON.stringify(this.records));
            }

            saveCategories() {
                localStorage.setItem('accounting_categories', JSON.stringify(this.categories));
            }

            saveAccounts() {
                localStorage.setItem('accounting_accounts', JSON.stringify(this.accounts));
            }

            renderAll() {
                this.updateCategoryOptions();
                this.updateAccountOptions();
                this.renderRecords();
                this.updateSummary();
                this.initializeFilters();
                this.renderIconGrid();
                this.renderCategories();
                this.renderAccounts();
                this.updateMonthlyReport();
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        const app = new AccountingApp();
    </script>
</body>
</html>