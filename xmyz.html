<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTMLå¯†ç ä¿æŠ¤å·¥å…·ï¼ˆç†ŠçŒ«è£…é¥°+ç›´æ¥è¾“å¯†ç ï¼‰</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;}
        body{font-family:Arial,sans-serif;background:#f5f7fa;padding:20px;color:#333;}
        .container{max-width:800px;margin:0 auto;background:white;border-radius:12px;padding:30px;box-shadow:0 2px 15px rgba(0,0,0,0.1);}
        h1{color:#667eea;text-align:center;margin-bottom:30px;font-size:24px;}
        .section{margin-bottom:25px;padding-bottom:20px;border-bottom:1px solid #eee;}
        h2{color:#444;font-size:18px;margin-bottom:15px;display:flex;align-items:center;gap:8px;}
        h2::before{content:'';width:4px;height:18px;background:#667eea;border-radius:2px;}
        .form-group{margin-bottom:15px;}
        label{display:block;margin-bottom:8px;color:#555;font-weight:600;}
        input[type="text"],input[type="file"],select{width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:6px;font-size:14px;}
        button{padding:10px 20px;border:none;border-radius:6px;font-size:14px;font-weight:600;cursor:pointer;}
        button.primary{background:#667eea;color:white;}
        button.secondary{background:#eee;color:#333;margin-right:10px;}
        button:disabled{background:#ccc;cursor:not-allowed;}
        .file-area{border:2px dashed #ddd;border-radius:6px;padding:25px;text-align:center;margin-bottom:15px;cursor:pointer;transition:border-color 0.3s;}
        .file-area:hover{border-color:#667eea;}
        #fileInfo,#testResult{margin-top:10px;padding:10px;background:#f9faff;border-radius:6px;font-size:14px;display:none;}
        .password-list{margin-top:15px;max-height:300px;overflow-y:auto;}
        .password-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid #eee;}
        .password-type{padding:3px 8px;border-radius:4px;font-size:12px;}
        .type-normal{background:#e8f4f8;color:#4299e1;}
        .type-remember{background:#f0f8fb;color:#38b2ac;}
        .type-temporary{background:#fdf2f8;color:#9f7aea;}
        .status-expired{color:#e53e3e;}
        .status-normal{color:#48bb78;}
        .notification{position:fixed;top:20px;right:20px;padding:12px 20px;border-radius:6px;color:white;font-size:14px;z-index:9999;transform:translateX(120%);transition:transform 0.3s ease;}
        .success{background:#48bb78;}
        .error{background:#e53e3e;}
        .warning{background:#f59e0b;}
        .show{transform:translateX(0);}
        .password-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
        select#passwordType{width:150px;flex-shrink:0;}
        @media (max-width: 600px) {
            .password-row{flex-direction:column;align-items:stretch;}
            select#passwordType{width:100%;}
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” HTMLå¯†ç ä¿æŠ¤å·¥å…·</h1>
        <div class="section">
            <h2>WorkeråŸŸåé…ç½®</h2>
            <div class="form-group">
                <label for="workerUrl">WorkeråŸŸåï¼ˆå·²å›ºå®šï¼‰</label>
                <input type="text" id="workerUrl" placeholder="https://xxx.yourname.workers.dev" value="https://xmyz.baoge666.dpdns.org/" readonly>
            </div>
            <button class="secondary" onclick="testWorker()">æµ‹è¯•è¿æ¥</button>
            <div id="testResult"></div>
        </div>
        <div class="section">
            <h2>ä¸Šä¼ HTMLæ–‡ä»¶</h2>
            <div class="file-area" onclick="document.getElementById('fileInput').click()">
                <div>ğŸ“‚ ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </div>
                <div style="font-size:12px;color:#666;margin-top:8px;">æ”¯æŒ .html / .htm æ ¼å¼</div>
                <input type="file" id="fileInput" accept=".html,.htm" style="display:none;" onchange="handleFileUpload(event)">
            </div>
            <div id="fileInfo"></div>
        </div>
        <div class="section">
            <h2>å¯†ç è®¾ç½®ï¼ˆä¸‰ç§ç±»å‹ï¼‰</h2>
            <div class="form-group password-row">
                <input type="text" id="passwordInput" placeholder="è¾“å…¥å¯†ç " style="flex:1;">
                <select id="passwordType">
                    <option value="normal">æ™®é€šå¯†ç ï¼ˆæ°¸ä¹…ï¼‰</option>
                    <option value="remember">è®°ä½å¯†ç ï¼ˆè‡ªåŠ¨ç™»å½•ï¼‰</option>
                    <option value="temporary">ä¸´æ—¶å¯†ç ï¼ˆ7å¤©è¿‡æœŸï¼‰</option>
                </select>
                <button class="primary" onclick="addPassword()">æ·»åŠ å¯†ç </button>
            </div>
            <div class="password-list" id="passwordList">
                <div style="text-align:center;padding:10px;color:#666;">æš‚æ— å¯†ç ï¼Œè¯·æ·»åŠ </div>
            </div>
        </div>
        <div class="section">
            <h2>å¯¼å‡ºåŠ å¯†æ–‡ä»¶</h2>
            <div class="form-group">
                <label for="exportName">å¯¼å‡ºæ–‡ä»¶å</label>
                <input type="text" id="exportName" placeholder="ä¾‹å¦‚ï¼šåŠ å¯†æ–‡ä»¶" value="åŠ å¯†æ–‡ä»¶">
            </div>
            <button class="primary" id="exportBtn" onclick="exportEncryptedHTML()" disabled>å¯¼å‡ºæ–‡ä»¶</button>
        </div>
    </div>
    <div class="notification" id="notification"></div>

    <script>
        // å…¨å±€å˜é‡
        let targetFileContent = '', targetFileName = '', passwords = [], fileId = 'f' + Date.now();
        const workerUrl = document.getElementById('workerUrl').value;
        const exportBtn = document.getElementById('exportBtn');

        // é€šçŸ¥å‡½æ•°
        function showNotice(message, type = 'error') {
            const n = document.getElementById('notification');
            n.textContent = message;
            n.className = 'notification ' + type;
            n.classList.add('show');
            setTimeout(() => n.classList.remove('show'), 3000);
        }

        // æµ‹è¯•Workerè¿æ¥ï¼ˆå¸¦è·¨åŸŸå‚æ•°ï¼‰
        function testWorker() {
            const tr = document.getElementById('testResult');
            tr.style.display = 'block';
            tr.textContent = 'æµ‹è¯•è¿æ¥ä¸­...';
            fetch(workerUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'test' }),
                mode: 'cors',
                credentials: 'omit'
            })
            .then(r => r.json().catch(() => ({ success: false, message: 'å“åº”æ ¼å¼é”™è¯¯' })))
            .then(d => {
                if (d.success) {
                    tr.textContent = 'âœ… è¿æ¥æˆåŠŸï¼' + d.message;
                    tr.style.color = '#48bb78';
                    showNotice('è¿æ¥æˆåŠŸ', 'success');
                } else {
                    tr.textContent = 'âŒ å¤±è´¥ï¼š' + d.message;
                    tr.style.color = '#e53e3e';
                }
            })
            .catch(e => {
                tr.textContent = 'âŒ å¤±è´¥ï¼š' + e.message;
                tr.style.color = '#e53e3e';
            });
        }

        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        function handleFileUpload(e) {
            const f = e.target.files[0];
            if (!f) return;
            targetFileName = f.name.replace(/\.(html|htm)$/i, '');
            document.getElementById('exportName').value = targetFileName + '_åŠ å¯†';
            const fi = document.getElementById('fileInfo');
            fi.style.display = 'block';
            fi.textContent = 'å·²é€‰æ–‡ä»¶ï¼š' + f.name + 'ï¼ˆå¤§å°ï¼š' + (f.size / 1024).toFixed(2) + 'KBï¼‰';
            const r = new FileReader();
            r.onload = () => {
                targetFileContent = r.result;
                exportBtn.disabled = false; // ä¸Šä¼ æˆåŠŸå¯ç”¨å¯¼å‡º
                showNotice('æ–‡ä»¶ä¸Šä¼ æˆåŠŸ', 'success');
            };
            r.onerror = () => showNotice('æ–‡ä»¶ä¸Šä¼ å¤±è´¥');
            r.readAsText(f);
        }

        // å¯†ç ç±»å‹é…ç½®
        const passwordTypeConfig = {
            normal: { text: 'æ™®é€šå¯†ç ', className: 'type-normal' },
            remember: { text: 'è®°ä½å¯†ç ', className: 'type-remember' },
            temporary: { text: 'ä¸´æ—¶å¯†ç ', className: 'type-temporary' }
        };

        // è®¡ç®—ä¸´æ—¶å¯†ç è¿‡æœŸæ—¶é—´ï¼ˆ7å¤©ï¼‰
        function getExpireTime() {
            const now = new Date();
            now.setDate(now.getDate() + 7);
            return now.toLocaleString('zh-CN');
        }

        // æ·»åŠ å¯†ç ï¼ˆåŒæ­¥åˆ°Workerçš„HTML_PASSWORD_HASHESï¼‰
        async function addPassword() {
            const pwd = document.getElementById('passwordInput').value.trim();
            const type = document.getElementById('passwordType').value;
            if (!pwd) return showNotice('è¯·è¾“å…¥å¯†ç ');
            
            // SHA256åŠ å¯†å¯†ç ï¼ˆå’ŒWorkerç«¯ä¸€è‡´ï¼‰
            const encoder = new TextEncoder();
            const hashBuffer = await crypto.subtle.digest('SHA-256', encoder.encode(pwd));
            const passwordHash = Array.from(new Uint8Array(hashBuffer))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
            
            // é¿å…é‡å¤å¯†ç 
            if (passwords.some(item => item.hash === passwordHash)) {
                return showNotice('è¯¥å¯†ç å·²å­˜åœ¨', 'warning');
            }
            
            // è®°å½•å¯†ç ä¿¡æ¯
            const passwordItem = {
                hash: passwordHash,
                type: type,
                expireTime: type === 'temporary' ? getExpireTime() : 'æ°¸ä¹…'
            };
            passwords.push(passwordItem);
            
            // æ›´æ–°å¯†ç åˆ—è¡¨æ˜¾ç¤º
            updatePasswordList();
            document.getElementById('passwordInput').value = '';
            showNotice('å¯†ç æ·»åŠ æˆåŠŸ', 'success');
            
            // åŒæ­¥åˆ°Workerï¼ˆå­˜å…¥HTML_PASSWORD_HASHESï¼‰
            try {
                await fetch(workerUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'sync', 
                        fileId, 
                        passwords: passwords.map(item => ({ 
                            hash: item.hash, 
                            type: item.type, 
                            expireTime: item.expireTime 
                        }))
                    }),
                    mode: 'cors',
                    credentials: 'omit'
                });
            } catch (err) {
                showNotice('å¯†ç åŒæ­¥Workerå¤±è´¥', 'warning');
            }
        }

        // æ›´æ–°å¯†ç åˆ—è¡¨
        function updatePasswordList() {
            const pl = document.getElementById('passwordList');
            if (passwords.length === 0) {
                pl.innerHTML = '<div style="text-align:center;padding:10px;color:#666;">æš‚æ— å¯†ç ï¼Œè¯·æ·»åŠ </div>';
                return;
            }
            pl.innerHTML = passwords.map((item, i) => {
                const config = passwordTypeConfig[item.type];
                const isExpired = item.type === 'temporary' && new Date(item.expireTime) < new Date();
                const statusText = isExpired 
                    ? '<span class="status-expired">å·²è¿‡æœŸ</span>' 
                    : '<span class="status-normal">æœ‰æ•ˆ</span>';
                return `
                    <div class="password-item">
                        <span>å¯†ç  ${i+1}</span>
                        <span class="password-type ${config.className}">${config.text}</span>
                        <span>${item.expireTime}</span>
                        ${statusText}
                        <button class="secondary" style="padding:3px 8px;" onclick="removePassword(${i})">åˆ é™¤</button>
                    </div>
                `;
            }).join('');
        }

        // åˆ é™¤å¯†ç ï¼ˆåŒæ­¥åˆ°Workerï¼‰
        function removePassword(i) {
            passwords.splice(i, 1);
            updatePasswordList();
            showNotice('å¯†ç å·²åˆ é™¤', 'success');
            // åŒæ­¥åˆ°Worker
            if (workerUrl) {
                fetch(workerUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'sync', 
                        fileId, 
                        passwords: passwords.map(item => ({ 
                            hash: item.hash, 
                            type: item.type, 
                            expireTime: item.expireTime 
                        }))
                    }),
                    mode: 'cors',
                    credentials: 'omit'
                }).catch(() => {});
            }
        }

        // ç”Ÿæˆ16å­—èŠ‚Counterï¼ˆAES-CTRè¦æ±‚ï¼‰
        function generate16ByteCounter() {
            const counter = new Uint8Array(16);
            crypto.getRandomValues(counter);
            return btoa(String.fromCharCode(...counter));
        }

        // ç†ŠçŒ«çº¯è£…é¥°ç•Œé¢ï¼ˆæ— ç‚¹å‡»äº¤äº’ï¼‰
        function createPandaUI() {
            return `
                <div id="pandaUI" style="text-align:center;margin-bottom:25px;">
                    <h3>ğŸ¼ åŠ å¯†å†…å®¹ä¿æŠ¤</h3>
                    <div style="margin:15px auto;width:180px;height:180px;background:#f8f8f8;border-radius:50%;position:relative;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                        <!-- ç†ŠçŒ«è€³æœµ -->
                        <div style="position:absolute;top:15px;left:30px;width:40px;height:40px;background:#000;border-radius:50%;"></div>
                        <div style="position:absolute;top:15px;right:30px;width:40px;height:40px;background:#000;border-radius:50%;"></div>
                        <!-- ç†ŠçŒ«çœ¼ç› -->
                        <div style="position:absolute;top:60px;left:45px;width:25px;height:25px;background:#000;border-radius:50%;"></div>
                        <div style="position:absolute;top:60px;right:45px;width:25px;height:25px;background:#000;border-radius:50%;"></div>
                        <!-- ç†ŠçŒ«çœ¼ç  -->
                        <div style="position:absolute;top:65px;left:50px;width:8px;height:8px;background:#fff;border-radius:50%;"></div>
                        <div style="position:absolute;top:65px;right:50px;width:8px;height:8px;background:#fff;border-radius:50%;"></div>
                        <!-- ç†ŠçŒ«é¼»å­ -->
                        <div style="position:absolute;top:95px;left:80px;width:20px;height:15px;background:#000;border-radius:8px;"></div>
                        <!-- ç†ŠçŒ«å˜´å·´ -->
                        <div style="position:absolute;top:110px;left:75px;width:30px;height:10px;border-bottom:3px solid #000;border-radius:0 0 15px 15px;"></div>
                        <div style="position:absolute;bottom:25px;left:50%;transform:translateX(-50%);color:#666;font-size:12px;">è¾“å…¥å¯†ç è§£é”å†…å®¹</div>
                    </div>
                </div>
            `;
        }

        // ç”Ÿæˆå¯¼å‡ºçš„åŠ å¯†HTMLæ–‡ä»¶ï¼ˆç†ŠçŒ«+ç›´æ¥è¾“å¯†ç ï¼‰
        function createEncryptedDOM(workerUrl, fileId, decryptKey, encryptedBase64, counterBase64) {
            const html = document.createElement('html');
            html.setAttribute('lang', 'zh-CN');

            // head
            const head = document.createElement('head');
            const meta = document.createElement('meta');
            meta.setAttribute('charset', 'UTF-8');
            const viewport = document.createElement('meta');
            viewport.setAttribute('name', 'viewport');
            viewport.setAttribute('content', 'width=device-width, initial-scale=1.0');
            const title = document.createElement('title');
            title.textContent = 'åŠ å¯†å†…å®¹ï¼ˆéœ€å¯†ç è§£é”ï¼‰';
            const style = document.createElement('style');
            style.textContent = `
                body{margin:0;padding:20px;font-family:Arial,sans-serif;background:#f5f7fa;}
                .box{max-width:400px;margin:50px auto;background:white;padding:40px;border-radius:12px;box-shadow:0 2px 15px rgba(0,0,0,0.1);}
                h1{color:#667eea;text-align:center;margin-bottom:20px;font-size:22px;}
                .form-group{margin-bottom:20px;}
                label{display:block;margin-bottom:8px;color:#555;font-weight:600;font-size:14px;}
                input[type="password"]{width:100%;padding:12px;border:1px solid #ddd;border-radius:6px;font-size:14px;box-sizing:border-box;outline:none;}
                input[type="password"]:focus{border-color:#667eea;box-shadow:0 0 0 2px rgba(102,126,234,0.2);}
                button{width:100%;padding:12px;border:none;border-radius:6px;background:#667eea;color:white;font-size:14px;font-weight:600;cursor:pointer;transition:background 0.3s;}
                button:hover{background:#5a6edb;}
                button:disabled{background:#ccc;cursor:not-allowed;}
                .error{margin-top:15px;padding:10px;background:#fef2f2;color:#dc2626;border-radius:6px;font-size:13px;display:none;text-align:center;}
                .loading{margin-top:15px;padding:10px;background:#f0f9ff;color:#3b82f6;border-radius:6px;font-size:13px;text-align:center;display:none;}
            `;
            head.appendChild(meta);
            head.appendChild(viewport);
            head.appendChild(title);
            head.appendChild(style);
            html.appendChild(head);

            // body
            const body = document.createElement('body');
            const box = document.createElement('div');
            box.className = 'box';
            const h1 = document.createElement('h1');
            h1.textContent = 'ğŸ” è¯·è¾“å…¥è§£é”å¯†ç ';

            // ç†ŠçŒ«è£…é¥°ç•Œé¢
            const pandaUI = document.createElement('div');
            pandaUI.innerHTML = createPandaUI();
            box.appendChild(h1);
            box.appendChild(pandaUI);

            // å¯†ç è¾“å…¥ç»„
            const formGroup = document.createElement('div');
            formGroup.className = 'form-group';
            const label = document.createElement('label');
            label.setAttribute('for', 'pwd');
            label.textContent = 'è¾“å…¥è®¾å®šçš„å¯†ç ';
            const input = document.createElement('input');
            input.setAttribute('type', 'password');
            input.setAttribute('id', 'pwd');
            input.setAttribute('placeholder', 'è¯·è¾“å…¥å¯†ç ...');
            input.setAttribute('autocomplete', 'off');

            // è§£é”æŒ‰é’®
            const button = document.createElement('button');
            button.textContent = 'è§£é”å†…å®¹';

            // åŠ è½½å’Œé”™è¯¯æç¤º
            const loading = document.createElement('div');
            loading.className = 'loading';
            loading.setAttribute('id', 'loading');
            loading.textContent = 'è§£é”ä¸­...';
            const error = document.createElement('div');
            error.className = 'error';
            error.setAttribute('id', 'err');

            // ç»„è£…DOM
            formGroup.appendChild(label);
            formGroup.appendChild(input);
            box.appendChild(formGroup);
            box.appendChild(button);
            box.appendChild(loading);
            box.appendChild(error);
            body.appendChild(box);

            // æ ¸å¿ƒè„šæœ¬ï¼šéªŒè¯å¯†ç +è§£å¯†+æ¸²æŸ“
            const script = document.createElement('script');
            script.textContent = `
                const config = {
                    workerUrl: "${workerUrl}",
                    fileId: "${fileId}",
                    decryptKey: "${decryptKey}",
                    encryptedBase64: "${encryptedBase64}",
                    counterBase64: "${counterBase64}"
                };

                // é¡µé¢åŠ è½½å®Œæˆåç»‘å®šäº‹ä»¶ï¼ˆç¡®ä¿DOMå·²æ¸²æŸ“ï¼‰
                document.addEventListener('DOMContentLoaded', function() {
                    const btn = document.querySelector('button');
                    const pwdInput = document.getElementById('pwd');

                    // ç»‘å®šæŒ‰é’®ç‚¹å‡»äº‹ä»¶
                    btn.addEventListener('click', checkPassword);

                    // ç»‘å®šå›è½¦æäº¤
                    pwdInput.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter') {
                            checkPassword();
                        }
                    });
                });

                // éªŒè¯å¯†ç +è§£å¯†+æ¸²æŸ“åŸHTML
                async function checkPassword() {
                    const pwd = document.getElementById('pwd').value.trim();
                    const errEl = document.getElementById('err');
                    const loadingEl = document.getElementById('loading');
                    const btn = document.querySelector('button');

                    // ç©ºå¯†ç æ ¡éªŒ
                    if (!pwd) {
                        errEl.textContent = 'è¯·è¾“å…¥å¯†ç ';
                        errEl.style.display = 'block';
                        return;
                    }

                    // æ˜¾ç¤ºåŠ è½½+ç¦ç”¨æŒ‰é’®
                    errEl.style.display = 'none';
                    loadingEl.style.display = 'block';
                    btn.disabled = true;
                    btn.textContent = 'è§£é”ä¸­...';

                    try {
                        // 1. åŠ å¯†è¾“å…¥å¯†ç ï¼ˆå’Œå·¥å…·ç«¯/Workerç«¯ä¸€è‡´çš„SHA256ï¼‰
                        const encoder = new TextEncoder();
                        const hashBuffer = await crypto.subtle.digest('SHA-256', encoder.encode(pwd));
                        const pwdHash = Array.from(new Uint8Array(hashBuffer))
                            .map(b => b.toString(16).padStart(2, '0'))
                            .join('');

                        // 2. å‘WorkeréªŒè¯å¯†ç 
                        const res = await fetch(config.workerUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                action: 'verify',
                                fileId: config.fileId,
                                passwordHash: pwdHash
                            }),
                            mode: 'cors',
                            credentials: 'omit'
                        });

                        // 3. å¤„ç†Workerå“åº”
                        if (!res.ok) throw new Error('Workerå“åº”å¤±è´¥ï¼š' + res.status);
                        const data = await res.json();
                        if (!data.success) throw new Error(data.message || 'å¯†ç é”™è¯¯');
                        if (data.decryptKey !== config.decryptKey) throw new Error('å¯†é’¥ä¸åŒ¹é…');

                        // 4. è§£å¯†åŸHTMLå†…å®¹
                        const counter = new Uint8Array(
                            atob(config.counterBase64).split('').map(c => c.charCodeAt(0))
                        );
                        const key = await crypto.subtle.importKey(
                            'raw',
                            encoder.encode(config.decryptKey),
                            { name: 'AES-CTR' },
                            true,
                            ['decrypt']
                        );
                        const encryptedData = new Uint8Array(
                            atob(config.encryptedBase64).split('').map(c => c.charCodeAt(0))
                        );
                        const decryptedData = await crypto.subtle.decrypt(
                            { name: 'AES-CTR', counter: counter, length: 128 },
                            key,
                            encryptedData
                        );
                        const decryptedContent = new TextDecoder('utf-8').decode(decryptedData);

                        // 5. æ¸²æŸ“åŸHTMLï¼ˆæ›¿æ¢å½“å‰é¡µé¢ï¼‰
                        document.open('text/html', 'replace');
                        document.write(decryptedContent);
                        document.close();

                    } catch (err) {
                        // é”™è¯¯åé¦ˆ
                        console.error('è§£é”å¤±è´¥ï¼š', err);
                        errEl.textContent = 'è§£é”å¤±è´¥ï¼š' + err.message;
                        errEl.style.display = 'block';
                    } finally {
                        // æ¢å¤çŠ¶æ€
                        loadingEl.style.display = 'none';
                        btn.disabled = false;
                        btn.textContent = 'è§£é”å†…å®¹';
                    }
                }
            `;
            body.appendChild(script);
            html.appendChild(body);

            return new XMLSerializer().serializeToString(html);
        }

        // å¯¼å‡ºåŠ å¯†æ–‡ä»¶ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰
        async function exportEncryptedHTML() {
            // å‰ç½®æ ¡éªŒ
            if (!targetFileContent) return showNotice('è¯·å…ˆä¸Šä¼ æ–‡ä»¶');
            if (!passwords.length) return showNotice('è¯·æ·»åŠ å¯†ç ');
            if (!workerUrl) return showNotice('WorkeråŸŸåæœªé…ç½®');

            const exportName = document.getElementById('exportName').value.trim() || 'åŠ å¯†æ–‡ä»¶';
            const decryptKey = Math.random().toString(36).substring(2, 34); // 32å­—ç¬¦AES-256å¯†é’¥
            const counterBase64 = generate16ByteCounter(); // 16å­—èŠ‚Counter
            const encoder = new TextEncoder();
            const contentData = encoder.encode(targetFileContent);
            const counter = new Uint8Array(atob(counterBase64).split('').map(c => c.charCodeAt(0)));

            // æ˜¾ç¤ºåŠ è½½æç¤º
            showNotice('å¯¼å‡ºä¸­...', 'warning');
            exportBtn.disabled = true;

            try {
                // 1. ç”ŸæˆAES-256å¯†é’¥å¹¶åŠ å¯†åŸæ–‡ä»¶
                const encryptionKey = await crypto.subtle.generateKey(
                    { name: 'AES-CTR', length: 256 },
                    true,
                    ['encrypt', 'decrypt']
                );
                const encryptedData = await crypto.subtle.encrypt(
                    { name: 'AES-CTR', counter: counter, length: 128 },
                    encryptionKey,
                    contentData
                );

                // 2. åŠ å¯†åå†…å®¹è½¬ä¸ºBase64
                const encryptedBase64 = btoa(String.fromCharCode(...new Uint8Array(encryptedData)));
                
                // 3. ç”Ÿæˆæœ€ç»ˆå¯¼å‡ºçš„HTML
                const encryptedHTML = createEncryptedDOM(workerUrl, fileId, decryptKey, encryptedBase64, counterBase64);
                
                // 4. åŒæ­¥å¯†é’¥åˆ°Workerï¼ˆå­˜å…¥HTML_DECRYPT_KEYSï¼‰
                await fetch(workerUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'sync-key', 
                        fileId, 
                        decryptKey,
                        counterBase64
                    }),
                    mode: 'cors',
                    credentials: 'omit'
                });

                // 5. ä¸‹è½½æ–‡ä»¶
                const blob = new Blob([encryptedHTML], { type: 'text/html; charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = exportName + '.html';
                document.body.appendChild(a);
                a.click();

                // æ¸…ç†+æç¤º
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showNotice('å¯¼å‡ºæˆåŠŸï¼', 'success');
                    exportBtn.disabled = false;
                }, 100);
            } catch (err) {
                showNotice('å¯¼å‡ºå¤±è´¥ï¼š' + err.message);
                exportBtn.disabled = false;
            }
        }
    </script>
</body>
</html>