<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTMLå¯†ç ä¿æŠ¤å·¥å…·ï¼ˆç»ˆææ— æ³„æ¼ç‰ˆï¼‰</title>
    <style>*{margin:0;padding:0;box-sizing:border-box;}body{font-family:Arial,sans-serif;background:#f5f7fa;padding:20px;color:#333;}.container{max-width:800px;margin:0 auto;background:white;border-radius:12px;padding:30px;box-shadow:0 2px 15px rgba(0,0,0,0.1);}h1{color:#667eea;text-align:center;margin-bottom:30px;font-size:24px;}.section{margin-bottom:25px;padding-bottom:20px;border-bottom:1px solid #eee;}h2{color:#444;font-size:18px;margin-bottom:15px;display:flex;align-items:center;gap:8px;}h2::before{content:'';width:4px;height:18px;background:#667eea;border-radius:2px;}.form-group{margin-bottom:15px;}label{display:block;margin-bottom:8px;color:#555;font-weight:600;}input[type="text"],input[type="file"]{width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:6px;font-size:14px;}button{padding:10px 20px;border:none;border-radius:6px;font-size:14px;font-weight:600;cursor:pointer;}button.primary{background:#667eea;color:white;}button.secondary{background:#eee;color:#333;margin-right:10px;}.file-area{border:2px dashed #ddd;border-radius:6px;padding:25px;text-align:center;margin-bottom:15px;cursor:pointer;}#fileInfo,#testResult{margin-top:10px;padding:10px;background:#f9faff;border-radius:6px;font-size:14px;display:none;}.password-list{margin-top:15px;}.password-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid #eee;}.status-normal{color:#48bb78;}.notification{position:fixed;top:20px;right:20px;padding:12px 20px;border-radius:6px;color:white;font-size:14px;z-index:9999;transform:translateX(120%);transition:transform 0.3s ease;}.success{background:#48bb78;}.error{background:#e53e3e;}.show{transform:translateX(0);}</style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” HTMLå¯†ç ä¿æŠ¤å·¥å…·</h1>
        <div class="section">
            <h2>WorkeråŸŸåé…ç½®</h2>
            <div class="form-group">
                <label for="workerUrl">WorkeråŸŸåï¼ˆå¿…å¡«ï¼‰</label>
                <input type="text" id="workerUrl" placeholder="https://xxx.yourname.workers.dev" value="https://">
            </div>
            <button class="secondary" onclick="testWorker()">æµ‹è¯•è¿æ¥</button>
            <div id="testResult"></div>
        </div>
        <div class="section">
            <h2>ä¸Šä¼ HTMLæ–‡ä»¶</h2>
            <div class="file-area" onclick="document.getElementById('fileInput').click()">
                <div>ğŸ“‚ ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </div>
                <input type="file" id="fileInput" accept=".html,.htm" style="display:none;" onchange="handleFileUpload(event)">
            </div>
            <div id="fileInfo"></div>
        </div>
        <div class="section">
            <h2>å¯†ç è®¾ç½®</h2>
            <div class="form-group" style="display:flex;gap:10px;align-items:center;">
                <input type="text" id="passwordInput" placeholder="è¾“å…¥å¯†ç " style="flex:1;">
                <button class="primary" onclick="addPassword()">æ·»åŠ å¯†ç </button>
            </div>
            <div class="password-list" id="passwordList">
                <div style="text-align:center;padding:10px;color:#666;">æš‚æ— å¯†ç ï¼Œè¯·æ·»åŠ </div>
            </div>
        </div>
        <div class="section">
            <h2>å¯¼å‡ºåŠ å¯†æ–‡ä»¶</h2>
            <div class="form-group">
                <label for="exportName">å¯¼å‡ºæ–‡ä»¶å</label>
                <input type="text" id="exportName" placeholder="ä¾‹å¦‚ï¼šåŠ å¯†æ–‡ä»¶" value="åŠ å¯†æ–‡ä»¶">
            </div>
            <button class="primary" onclick="exportEncryptedHTML()">å¯¼å‡ºæ–‡ä»¶</button>
        </div>
    </div>
    <div class="notification" id="notification"></div>

    <script>
        // å…¨å±€å˜é‡ï¼ˆæç®€ï¼‰
        let targetFileContent = '', targetFileName = '', passwords = [], fileId = 'f' + Date.now(), workerUrl = '';

        // é€šçŸ¥å‡½æ•°
        function showNotice(message, type = 'error') {
            const n = document.getElementById('notification');
            n.textContent = message;
            n.className = 'notification ' + type;
            n.classList.add('show');
            setTimeout(() => n.classList.remove('show'), 3000);
        }

        // æµ‹è¯•Workerè¿æ¥
        function testWorker() {
            workerUrl = document.getElementById('workerUrl').value.trim();
            if (!workerUrl || workerUrl === 'https://') {
                showNotice('è¯·è¾“å…¥æœ‰æ•ˆWorkeråŸŸå');
                return;
            }
            const tr = document.getElementById('testResult');
            tr.style.display = 'block';
            tr.textContent = 'æµ‹è¯•è¿æ¥ä¸­...';
            fetch(workerUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'test' })
            })
            .then(r => r.json().catch(() => ({ success: false, message: 'å“åº”æ ¼å¼é”™è¯¯' })))
            .then(d => {
                d.success 
                    ? (tr.textContent = 'âœ… è¿æ¥æˆåŠŸ', tr.style.color = '#48bb78', showNotice('è¿æ¥æˆåŠŸ', 'success'))
                    : (tr.textContent = 'âŒ å¤±è´¥ï¼š' + d.message, tr.style.color = '#e53e3e');
            })
            .catch(e => {
                tr.textContent = 'âŒ å¤±è´¥ï¼š' + e.message;
                tr.style.color = '#e53e3e';
            });
        }

        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        function handleFileUpload(e) {
            const f = e.target.files[0];
            if (!f) return;
            targetFileName = f.name.replace(/\.(html|htm)$/i, '');
            document.getElementById('exportName').value = targetFileName + '_åŠ å¯†';
            const fi = document.getElementById('fileInfo');
            fi.style.display = 'block';
            fi.textContent = 'å·²é€‰æ–‡ä»¶ï¼š' + f.name;
            const r = new FileReader();
            r.onload = () => {
                targetFileContent = r.result;
                showNotice('ä¸Šä¼ æˆåŠŸ', 'success');
            };
            r.readAsText(f);
        }

        // æ·»åŠ å¯†ç 
        async function addPassword() {
            const p = document.getElementById('passwordInput').value.trim();
            if (!p) return showNotice('è¯·è¾“å…¥å¯†ç ');
            
            // SHA256åŠ å¯†
            const encoder = new TextEncoder();
            const hashBuffer = await crypto.subtle.digest('SHA-256', encoder.encode(p));
            const passwordHash = Array.from(new Uint8Array(hashBuffer))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
            
            if (passwords.includes(passwordHash)) return showNotice('å¯†ç å·²å­˜åœ¨');
            
            passwords.push(passwordHash);
            // æ›´æ–°å¯†ç åˆ—è¡¨
            document.getElementById('passwordList').innerHTML = passwords.map((_, i) => 
                `<div class="password-item">
                    <span>å¯†ç  ${i+1}</span>
                    <span class="status-normal">æœ‰æ•ˆ</span>
                    <button class="secondary" style="padding:3px 8px;" onclick="removePassword(${i})">åˆ é™¤</button>
                </div>`
            ).join('');
            document.getElementById('passwordInput').value = '';
            showNotice('æ·»åŠ æˆåŠŸ', 'success');
            // åŒæ­¥åˆ°Worker
            workerUrl && fetch(workerUrl + '/sync', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'sync', fileId, passwords })
            }).catch(() => {});
        }

        // åˆ é™¤å¯†ç 
        function removePassword(i) {
            passwords.splice(i, 1);
            document.getElementById('passwordList').innerHTML = passwords.length 
                ? passwords.map((_, i) => `<div class="password-item"><span>å¯†ç  ${i+1}</span><span class="status-normal">æœ‰æ•ˆ</span><button class="secondary" style="padding:3px 8px;" onclick="removePassword(${i})">åˆ é™¤</button></div>`).join('')
                : '<div style="text-align:center;padding:10px;color:#666;">æš‚æ— å¯†ç ï¼Œè¯·æ·»åŠ </div>';
            showNotice('åˆ é™¤æˆåŠŸ', 'success');
        }

        // æ ¸å¿ƒï¼šDOMåŠ¨æ€ç”Ÿæˆå¯¼å‡ºHTMLï¼ˆå½»åº•ç»•å¼€å­—ç¬¦ä¸²æ‹¼æ¥ï¼‰
        function createEncryptedDOM(workerUrl, fileId, decryptKey, encryptedBase64) {
            // 1. åˆ›å»ºæ ¹HTMLå…ƒç´ 
            const html = document.createElement('html');
            html.setAttribute('lang', 'zh-CN');

            // 2. åˆ›å»ºheadå…ƒç´ 
            const head = document.createElement('head');
            // meta charset
            const meta = document.createElement('meta');
            meta.setAttribute('charset', 'UTF-8');
            // title
            const title = document.createElement('title');
            title.textContent = 'åŠ å¯†å†…å®¹';
            // styleæ ·å¼
            const style = document.createElement('style');
            style.textContent = `
                body{margin:0;padding:20px;font-family:Arial,sans-serif;background:#f5f7fa;}
                .box{max-width:400px;margin:0 auto;background:white;padding:40px;border-radius:12px;box-shadow:0 2px 15px rgba(0,0,0,0.1);}
                h1{color:#667eea;text-align:center;margin-bottom:30px;}
                .form-group{margin-bottom:20px;}
                label{display:block;margin-bottom:8px;color:#555;}
                input{width:100%;padding:12px;border:1px solid #ddd;border-radius:6px;font-size:14px;}
                button{width:100%;padding:12px;border:none;border-radius:6px;background:#667eea;color:white;font-size:14px;cursor:pointer;}
                .error{margin-top:15px;padding:10px;background:#fef2f2;color:#dc2626;border-radius:6px;font-size:13px;display:none;}
            `;
            head.appendChild(meta);
            head.appendChild(title);
            head.appendChild(style);
            html.appendChild(head);

            // 3. åˆ›å»ºbodyå…ƒç´ 
            const body = document.createElement('body');
            // ç™»å½•æ¡†
            const box = document.createElement('div');
            box.className = 'box';
            // æ ‡é¢˜
            const h1 = document.createElement('h1');
            h1.textContent = 'ğŸ” è¯·è¾“å…¥å¯†ç ';
            // å¯†ç è¾“å…¥ç»„
            const formGroup = document.createElement('div');
            formGroup.className = 'form-group';
            const label = document.createElement('label');
            label.setAttribute('for', 'pwd');
            label.textContent = 'å¯†ç ';
            const input = document.createElement('input');
            input.setAttribute('type', 'password');
            input.setAttribute('id', 'pwd');
            input.setAttribute('placeholder', 'è¾“å…¥è®¿é—®å¯†ç ');
            // éªŒè¯æŒ‰é’®
            const button = document.createElement('button');
            button.setAttribute('onclick', 'checkPassword()');
            button.textContent = 'éªŒè¯è®¿é—®';
            // é”™è¯¯æç¤º
            const error = document.createElement('div');
            error.className = 'error';
            error.setAttribute('id', 'err');
            // ç»„è£…ç™»å½•æ¡†
            formGroup.appendChild(label);
            formGroup.appendChild(input);
            box.appendChild(h1);
            box.appendChild(formGroup);
            box.appendChild(button);
            box.appendChild(error);
            body.appendChild(box);

            // 4. åˆ›å»ºè„šæœ¬å…ƒç´ ï¼ˆæ ¸å¿ƒï¼šç”¨textContenté¿å…è½¬ä¹‰é—®é¢˜ï¼‰
            const script = document.createElement('script');
            script.textContent = `
                // é…ç½®å‚æ•°ï¼ˆç›´æ¥åµŒå…¥ï¼Œæ— å­—ç¬¦ä¸²æ‹¼æ¥ï¼‰
                const config = {
                    workerUrl: "${workerUrl}",
                    fileId: "${fileId}",
                    decryptKey: "${decryptKey}",
                    encryptedBase64: "${encryptedBase64}"
                };

                // éªŒè¯å¯†ç 
                async function checkPassword() {
                    const pwd = document.getElementById('pwd').value.trim();
                    const errEl = document.getElementById('err');
                    if (!pwd) {
                        errEl.textContent = 'è¯·è¾“å…¥å¯†ç ';
                        errEl.style.display = 'block';
                        return;
                    }
                    errEl.style.display = 'none';

                    // åŠ å¯†è¾“å…¥å¯†ç 
                    const encoder = new TextEncoder();
                    const hashBuffer = await crypto.subtle.digest('SHA-256', encoder.encode(pwd));
                    const pwdHash = Array.from(new Uint8Array(hashBuffer))
                        .map(b => b.toString(16).padStart(2, '0'))
                        .join('');

                    try {
                        // éªŒè¯å¯†ç 
                        const res = await fetch(config.workerUrl + '/verify', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                action: 'verify',
                                fileId: config.fileId,
                                passwordHash: pwdHash
                            })
                        });
                        const data = await res.json();

                        if (data.success && data.decryptKey === config.decryptKey) {
                            // è§£å¯†å¹¶æ˜¾ç¤ºåŸå§‹å†…å®¹
                            const key = await crypto.subtle.importKey(
                                'raw',
                                encoder.encode(config.decryptKey),
                                { name: 'AES-CTR' },
                                true,
                                ['decrypt']
                            );
                            // è§£ç Base64
                            const encryptedData = new Uint8Array(
                                atob(config.encryptedBase64).split('').map(c => c.charCodeAt(0))
                            );
                            // è§£å¯†
                            const decryptedData = await crypto.subtle.decrypt(
                                { name: 'AES-CTR', counter: encoder.encode(config.decryptKey.slice(0, 16)), length: 128 },
                                key,
                                encryptedData
                            );
                            // æ˜¾ç¤ºåŸå§‹å†…å®¹
                            const decryptedContent = new TextDecoder().decode(decryptedData);
                            document.open();
                            document.write(decryptedContent);
                            document.close();
                        } else {
                            errEl.textContent = 'å¯†ç é”™è¯¯';
                            errEl.style.display = 'block';
                        }
                    } catch (err) {
                        errEl.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•';
                        errEl.style.display = 'block';
                    }
                }
            `;
            body.appendChild(script);
            html.appendChild(body);

            // 5. æŠŠDOMè½¬æˆå­—ç¬¦ä¸²ï¼ˆæ— ä»»ä½•æ‰‹åŠ¨æ‹¼æ¥ï¼‰
            return new XMLSerializer().serializeToString(html);
        }

        // å¯¼å‡ºåŠ å¯†HTMLï¼ˆç»ˆææ— æ³„æ¼ï¼‰
        async function exportEncryptedHTML() {
            // å‰ç½®æ ¡éªŒ
            if (!targetFileContent) return showNotice('è¯·å…ˆä¸Šä¼ æ–‡ä»¶');
            if (!passwords.length) return showNotice('è¯·æ·»åŠ å¯†ç ');
            if (!workerUrl) return showNotice('è¯·é…ç½®Worker');

            const exportName = document.getElementById('exportName').value.trim() || 'åŠ å¯†æ–‡ä»¶';
            const decryptKey = Math.random().toString(36).substring(2, 18);
            const encoder = new TextEncoder();
            const contentData = encoder.encode(targetFileContent);

            // åŠ å¯†æ–‡ä»¶å†…å®¹
            crypto.subtle.generateKey({ name: 'AES-CTR', length: 256 }, true, ['encrypt', 'decrypt'])
            .then(encryptionKey => {
                return crypto.subtle.encrypt(
                    { name: 'AES-CTR', counter: encoder.encode(decryptKey.slice(0, 16)), length: 128 },
                    encryptionKey,
                    contentData
                );
            })
            .then(encryptedData => {
                // è½¬ä¸ºBase64
                const encryptedBase64 = btoa(String.fromCharCode(...new Uint8Array(encryptedData)));
                
                // æ ¸å¿ƒï¼šç”¨DOMç”Ÿæˆå¯¼å‡ºHTMLï¼Œå½»åº•ç»•å¼€å­—ç¬¦ä¸²æ‹¼æ¥
                const encryptedHTML = createEncryptedDOM(workerUrl, fileId, decryptKey, encryptedBase64);
                
                // ä¸‹è½½æ–‡ä»¶
                const blob = new Blob([encryptedHTML], { type: 'text/html; charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = exportName + '.html';
                document.body.appendChild(a);
                a.click();
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);

                // åŒæ­¥å¯†é’¥åˆ°Worker
                fetch(workerUrl + '/sync-key', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'sync-key', fileId, decryptKey })
                }).catch(() => {});

                showNotice('å¯¼å‡ºæˆåŠŸï¼', 'success');
            });
        }
    </script>
</body>
</html>