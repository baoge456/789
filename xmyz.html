<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTMLå¯†ç ä¿æŠ¤å·¥å…·ï¼ˆå¸¦ç†ŠçŒ«éªŒè¯ï¼‰</title>
    <style>*{margin:0;padding:0;box-sizing:border-box;}body{font-family:Arial,sans-serif;background:#f5f7fa;padding:20px;color:#333;}.container{max-width:800px;margin:0 auto;background:white;border-radius:12px;padding:30px;box-shadow:0 2px 15px rgba(0,0,0,0.1);}h1{color:#667eea;text-align:center;margin-bottom:30px;font-size:24px;}.section{margin-bottom:25px;padding-bottom:20px;border-bottom:1px solid #eee;}h2{color:#444;font-size:18px;margin-bottom:15px;display:flex;align-items:center;gap:8px;}h2::before{content:'';width:4px;height:18px;background:#667eea;border-radius:2px;}.form-group{margin-bottom:15px;}label{display:block;margin-bottom:8px;color:#555;font-weight:600;}input[type="text"],input[type="file"],select{width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:6px;font-size:14px;}button{padding:10px 20px;border:none;border-radius:6px;font-size:14px;font-weight:600;cursor:pointer;}button.primary{background:#667eea;color:white;}button.secondary{background:#eee;color:#333;margin-right:10px;}button:disabled{background:#ccc;cursor:not-allowed;}.file-area{border:2px dashed #ddd;border-radius:6px;padding:25px;text-align:center;margin-bottom:15px;cursor:pointer;}#fileInfo,#testResult{margin-top:10px;padding:10px;background:#f9faff;border-radius:6px;font-size:14px;display:none;}.password-list{margin-top:15px;}.password-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid #eee;}.password-type{padding:3px 8px;border-radius:4px;font-size:12px;}.type-normal{background:#e8f4f8;color:#4299e1;}.type-remember{background:#f0f8fb;color:#38b2ac;}.type-temporary{background:#fdf2f8;color:#9f7aea;}.status-expired{color:#e53e3e;}.status-normal{color:#48bb78;}.notification{position:fixed;top:20px;right:20px;padding:12px 20px;border-radius:6px;color:white;font-size:14px;z-index:9999;transform:translateX(120%);transition:transform 0.3s ease;}.success{background:#48bb78;}.error{background:#e53e3e;}.warning{background:#f59e0b;}.show{transform:translateX(0);}.password-row{display:flex;gap:10px;align-items:center;}select#passwordType{width:150px;}</style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” HTMLå¯†ç ä¿æŠ¤å·¥å…·</h1>
        <div class="section">
            <h2>WorkeråŸŸåé…ç½®</h2>
            <div class="form-group">
                <label for="workerUrl">WorkeråŸŸåï¼ˆå¿…å¡«ï¼‰</label>
                <input type="text" id="workerUrl" placeholder="https://xxx.yourname.workers.dev" value="https://xmyz.baoge666.dpdns.org/" readonly>
            </div>
            <button class="secondary" onclick="testWorker()">æµ‹è¯•è¿æ¥</button>
            <div id="testResult"></div>
        </div>
        <div class="section">
            <h2>ä¸Šä¼ HTMLæ–‡ä»¶</h2>
            <div class="file-area" onclick="document.getElementById('fileInput').click()">
                <div>ğŸ“‚ ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </div>
                <input type="file" id="fileInput" accept=".html,.htm" style="display:none;" onchange="handleFileUpload(event)">
            </div>
            <div id="fileInfo"></div>
        </div>
        <div class="section">
            <h2>å¯†ç è®¾ç½®ï¼ˆä¸‰ç§ç±»å‹ï¼‰</h2>
            <div class="form-group password-row">
                <input type="text" id="passwordInput" placeholder="è¾“å…¥å¯†ç " style="flex:1;">
                <select id="passwordType">
                    <option value="normal">æ™®é€šå¯†ç </option>
                    <option value="remember">è®°ä½å¯†ç </option>
                    <option value="temporary">ä¸´æ—¶å¯†ç ï¼ˆ7å¤©ï¼‰</option>
                </select>
                <button class="primary" onclick="addPassword()">æ·»åŠ å¯†ç </button>
            </div>
            <div class="password-list" id="passwordList">
                <div style="text-align:center;padding:10px;color:#666;">æš‚æ— å¯†ç ï¼Œè¯·æ·»åŠ </div>
            </div>
        </div>
        <div class="section">
            <h2>å¯¼å‡ºåŠ å¯†æ–‡ä»¶</h2>
            <div class="form-group">
                <label for="exportName">å¯¼å‡ºæ–‡ä»¶å</label>
                <input type="text" id="exportName" placeholder="ä¾‹å¦‚ï¼šåŠ å¯†æ–‡ä»¶" value="åŠ å¯†æ–‡ä»¶">
            </div>
            <button class="primary" id="exportBtn" onclick="exportEncryptedHTML()" disabled>å¯¼å‡ºæ–‡ä»¶</button>
        </div>
    </div>
    <div class="notification" id="notification"></div>

    <script>
        // å…¨å±€å˜é‡
        let targetFileContent = '', targetFileName = '', passwords = [], fileId = 'f' + Date.now(), workerUrl = 'https://xmyz.baoge666.dpdns.org/';
        const exportBtn = document.getElementById('exportBtn');

        // é€šçŸ¥å‡½æ•°
        function showNotice(message, type = 'error') {
            const n = document.getElementById('notification');
            n.textContent = message;
            n.className = 'notification ' + type;
            n.classList.add('show');
            setTimeout(() => n.classList.remove('show'), 3000);
        }

        // æµ‹è¯•Workerè¿æ¥
        function testWorker() {
            const tr = document.getElementById('testResult');
            tr.style.display = 'block';
            tr.textContent = 'æµ‹è¯•è¿æ¥ä¸­...';
            fetch(workerUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'test' })
            })
            .then(r => r.json().catch(() => ({ success: false, message: 'å“åº”æ ¼å¼é”™è¯¯' })))
            .then(d => {
                if (d.success) {
                    tr.textContent = 'âœ… è¿æ¥æˆåŠŸ';
                    tr.style.color = '#48bb78';
                    showNotice('è¿æ¥æˆåŠŸ', 'success');
                } else {
                    tr.textContent = 'âŒ å¤±è´¥ï¼š' + d.message;
                    tr.style.color = '#e53e3e';
                }
            })
            .catch(e => {
                tr.textContent = 'âŒ å¤±è´¥ï¼š' + e.message;
                tr.style.color = '#e53e3e';
            });
        }

        // å¤„ç†æ–‡ä»¶ä¸Šä¼ ï¼ˆä¸Šä¼ æˆåŠŸåå¯ç”¨å¯¼å‡ºæŒ‰é’®ï¼‰
        function handleFileUpload(e) {
            const f = e.target.files[0];
            if (!f) return;
            targetFileName = f.name.replace(/\.(html|htm)$/i, '');
            document.getElementById('exportName').value = targetFileName + '_åŠ å¯†';
            const fi = document.getElementById('fileInfo');
            fi.style.display = 'block';
            fi.textContent = 'å·²é€‰æ–‡ä»¶ï¼š' + f.name;
            const r = new FileReader();
            r.onload = () => {
                targetFileContent = r.result;
                exportBtn.disabled = false; // ä¸Šä¼ æˆåŠŸå¯ç”¨å¯¼å‡º
                showNotice('æ–‡ä»¶ä¸Šä¼ æˆåŠŸ', 'success');
            };
            r.onerror = () => showNotice('æ–‡ä»¶ä¸Šä¼ å¤±è´¥');
            r.readAsText(f);
        }

        // å¯†ç ç±»å‹é…ç½®
        const passwordTypeConfig = {
            normal: { text: 'æ™®é€šå¯†ç ', className: 'type-normal' },
            remember: { text: 'è®°ä½å¯†ç ', className: 'type-remember' },
            temporary: { text: 'ä¸´æ—¶å¯†ç ', className: 'type-temporary' }
        };

        // è®¡ç®—ä¸´æ—¶å¯†ç è¿‡æœŸæ—¶é—´ï¼ˆ7å¤©ï¼‰
        function getExpireTime() {
            const now = new Date();
            now.setDate(now.getDate() + 7);
            return now.toLocaleString('zh-CN');
        }

        // æ·»åŠ ä¸‰ç§ç±»å‹å¯†ç 
        async function addPassword() {
            const pwd = document.getElementById('passwordInput').value.trim();
            const type = document.getElementById('passwordType').value;
            if (!pwd) return showNotice('è¯·è¾“å…¥å¯†ç ');
            
            // SHA256åŠ å¯†å¯†ç 
            const encoder = new TextEncoder();
            const hashBuffer = await crypto.subtle.digest('SHA-256', encoder.encode(pwd));
            const passwordHash = Array.from(new Uint8Array(hashBuffer))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
            
            // é¿å…é‡å¤å¯†ç 
            if (passwords.some(item => item.hash === passwordHash)) {
                return showNotice('è¯¥å¯†ç å·²å­˜åœ¨', 'warning');
            }
            
            // è®°å½•å¯†ç ä¿¡æ¯ï¼ˆå«ç±»å‹ã€è¿‡æœŸæ—¶é—´ï¼‰
            const passwordItem = {
                hash: passwordHash,
                type: type,
                expireTime: type === 'temporary' ? getExpireTime() : 'æ°¸ä¹…'
            };
            passwords.push(passwordItem);
            
            // æ›´æ–°å¯†ç åˆ—è¡¨æ˜¾ç¤º
            updatePasswordList();
            document.getElementById('passwordInput').value = '';
            showNotice('å¯†ç æ·»åŠ æˆåŠŸ', 'success');
            
            // åŒæ­¥åˆ°Worker
            if (workerUrl) {
                fetch(workerUrl + '/sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'sync', 
                        fileId, 
                        passwords: passwords.map(item => ({ hash: item.hash, type: item.type, expireTime: item.expireTime }))
                    })
                }).catch(() => showNotice('å¯†ç åŒæ­¥Workerå¤±è´¥', 'warning'));
            }
        }

        // æ›´æ–°å¯†ç åˆ—è¡¨
        function updatePasswordList() {
            const pl = document.getElementById('passwordList');
            if (passwords.length === 0) {
                pl.innerHTML = '<div style="text-align:center;padding:10px;color:#666;">æš‚æ— å¯†ç ï¼Œè¯·æ·»åŠ </div>';
                return;
            }
            pl.innerHTML = passwords.map((item, i) => {
                const config = passwordTypeConfig[item.type];
                const statusText = item.type === 'temporary' && new Date(item.expireTime) < new Date() 
                    ? '<span class="status-expired">å·²è¿‡æœŸ</span>' 
                    : '<span class="status-normal">æœ‰æ•ˆ</span>';
                return `
                    <div class="password-item">
                        <span>å¯†ç  ${i+1}</span>
                        <span class="password-type ${config.className}">${config.text}</span>
                        <span>${item.expireTime}</span>
                        ${statusText}
                        <button class="secondary" style="padding:3px 8px;" onclick="removePassword(${i})">åˆ é™¤</button>
                    </div>
                `;
            }).join('');
        }

        // åˆ é™¤å¯†ç 
        function removePassword(i) {
            passwords.splice(i, 1);
            updatePasswordList();
            showNotice('å¯†ç å·²åˆ é™¤', 'success');
            // åŒæ­¥åˆ°Worker
            if (workerUrl) {
                fetch(workerUrl + '/sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'sync', 
                        fileId, 
                        passwords: passwords.map(item => ({ hash: item.hash, type: item.type, expireTime: item.expireTime }))
                    })
                }).catch(() => {});
            }
        }

        // ç”Ÿæˆ16å­—èŠ‚çš„éšæœºCounterï¼ˆAES-CTRè¦æ±‚ï¼‰
        function generate16ByteCounter() {
            const counter = new Uint8Array(16); // å›ºå®š16å­—èŠ‚
            crypto.getRandomValues(counter); // ç”Ÿæˆéšæœºå€¼
            return btoa(String.fromCharCode(...counter)); // è½¬ä¸ºBase64å­˜å‚¨/ä¼ è¾“
        }

        // ç†ŠçŒ«éªŒè¯é…ç½®ï¼ˆç®€åŒ–DOMç»“æ„ï¼Œç¡®ä¿ç‚¹å‡»æœ‰æ•ˆï¼‰
        function createPandaVerificationHTML() {
            return `
                <!-- ç†ŠçŒ«éªŒè¯æ¨¡å—ï¼ˆç®€åŒ–ç»“æ„ï¼Œç¡®ä¿ç‚¹å‡»ç”Ÿæ•ˆï¼‰ -->
                <div id="pandaVerify" style="text-align:center;margin-bottom:20px;">
                    <h3>ğŸ¼ ç†ŠçŒ«éªŒè¯</h3>
                    <div style="margin:20px auto;width:200px;height:200px;background:#f5f5f5;border-radius:8px;position:relative;">
                        <!-- å·¦çœ¼ï¼šæ·»åŠ idï¼Œç›´æ¥ç»‘å®šäº‹ä»¶ -->
                        <div id="leftEye" style="position:absolute;top:50px;left:50px;width:30px;height:30px;background:#000;border-radius:50%;cursor:pointer;"></div>
                        <!-- å³çœ¼ï¼šæ·»åŠ idï¼Œç›´æ¥ç»‘å®šäº‹ä»¶ -->
                        <div id="rightEye" style="position:absolute;top:50px;left:120px;width:30px;height:30px;background:#000;border-radius:50%;cursor:pointer;"></div>
                        <div style="position:absolute;top:110px;left:85px;width:30px;height:20px;background:#ff6b6b;border-radius:10px;"></div>
                        <div style="position:absolute;bottom:20px;left:50%;transform:translateX(-50%);color:#666;font-size:12px;">ç‚¹å‡»ç†ŠçŒ«çš„ä¸¤åªçœ¼ç›å®ŒæˆéªŒè¯</div>
                    </div>
                    <div id="verifyTip" style="color:#e53e3e;margin-top:10px;display:none;">è¯·å…ˆå®Œæˆç†ŠçŒ«éªŒè¯ï¼</div>
                </div>
            `;
        }

        // DOMåŠ¨æ€ç”Ÿæˆå¯¼å‡ºHTMLï¼ˆä¿®å¤ç†ŠçŒ«éªŒè¯ç‚¹å‡»äº‹ä»¶ï¼‰
        function createEncryptedDOM(workerUrl, fileId, decryptKey, encryptedBase64, counterBase64) {
            const html = document.createElement('html');
            html.setAttribute('lang', 'zh-CN');

            // head
            const head = document.createElement('head');
            const meta = document.createElement('meta');
            meta.setAttribute('charset', 'UTF-8');
            const title = document.createElement('title');
            title.textContent = 'åŠ å¯†å†…å®¹ï¼ˆéœ€éªŒè¯ï¼‰';
            const style = document.createElement('style');
            style.textContent = `
                body{margin:0;padding:20px;font-family:Arial,sans-serif;background:#f5f7fa;}
                .box{max-width:400px;margin:0 auto;background:white;padding:40px;border-radius:12px;box-shadow:0 2px 15px rgba(0,0,0,0.1);}
                h1{color:#667eea;text-align:center;margin-bottom:30px;}
                .form-group{margin-bottom:20px;display:none;}/* åˆå§‹éšè—å¯†ç æ¡† */
                label{display:block;margin-bottom:8px;color:#555;}
                input{width:100%;padding:12px;border:1px solid #ddd;border-radius:6px;font-size:14px;}
                button{width:100%;padding:12px;border:none;border-radius:6px;background:#667eea;color:white;font-size:14px;cursor:pointer;display:none;}/* åˆå§‹éšè—æŒ‰é’® */
                .error{margin-top:15px;padding:10px;background:#fef2f2;color:#dc2626;border-radius:6px;font-size:13px;display:none;}
                /* çœ¼ç›ç‚¹å‡»åçš„æ ·å¼ï¼ˆæ˜æ˜¾åé¦ˆï¼‰ */
                #leftEye.active, #rightEye.active{background:#ffd700;box-shadow:0 0 15px #ffd700;transform:scale(1.2);transition:all 0.3s ease;}
            `;
            head.appendChild(meta);
            head.appendChild(title);
            head.appendChild(style);
            html.appendChild(head);

            // body
            const body = document.createElement('body');
            const box = document.createElement('div');
            box.className = 'box';
            const h1 = document.createElement('h1');
            h1.textContent = 'ğŸ” åŠ å¯†å†…å®¹è®¿é—®';

            // ç†ŠçŒ«éªŒè¯æ¨¡å—
            const pandaVerify = document.createElement('div');
            pandaVerify.innerHTML = createPandaVerificationHTML();
            box.appendChild(h1);
            box.appendChild(pandaVerify);

            // å¯†ç è¾“å…¥ç»„ï¼ˆåˆå§‹éšè—ï¼‰
            const formGroup = document.createElement('div');
            formGroup.className = 'form-group';
            const label = document.createElement('label');
            label.setAttribute('for', 'pwd');
            label.textContent = 'è¾“å…¥è®¿é—®å¯†ç ';
            const input = document.createElement('input');
            input.setAttribute('type', 'password');
            input.setAttribute('id', 'pwd');
            input.setAttribute('placeholder', 'è¾“å…¥æ·»åŠ çš„å¯†ç ');
            // éªŒè¯æŒ‰é’®ï¼ˆåˆå§‹éšè—ï¼‰
            const button = document.createElement('button');
            button.setAttribute('onclick', 'checkPassword()');
            button.textContent = 'éªŒè¯è®¿é—®';
            // é”™è¯¯æç¤º
            const error = document.createElement('div');
            error.className = 'error';
            error.setAttribute('id', 'err');

            // ç»„è£…
            formGroup.appendChild(label);
            formGroup.appendChild(input);
            box.appendChild(formGroup);
            box.appendChild(button);
            box.appendChild(error);
            body.appendChild(box);

            // è„šæœ¬ï¼ˆä¿®å¤ç†ŠçŒ«éªŒè¯ç‚¹å‡»äº‹ä»¶ï¼šç›´æ¥ç”¨idé€‰æ‹©ï¼Œç¡®ä¿ç»‘å®šæˆåŠŸï¼‰
            const script = document.createElement('script');
            script.textContent = `
                const config = {
                    workerUrl: "${workerUrl}",
                    fileId: "${fileId}",
                    decryptKey: "${decryptKey}",
                    encryptedBase64: "${encryptedBase64}",
                    counterBase64: "${counterBase64}"
                };
                let verifyPassed = false;
                // ç›´æ¥é€šè¿‡idè·å–çœ¼ç›å…ƒç´ ï¼ˆé¿å…é€‰æ‹©å™¨å¤±æ•ˆï¼‰
                const leftEye = document.getElementById('leftEye');
                const rightEye = document.getElementById('rightEye');
                const verifyTip = document.getElementById('verifyTip');
                const formGroup = document.querySelector('.form-group');
                const submitBtn = document.querySelector('button');
                let leftClicked = false, rightClicked = false;

                // å·¦çœ¼ç‚¹å‡»äº‹ä»¶ï¼ˆç›´æ¥ç»‘å®šï¼Œç¡®ä¿ç”Ÿæ•ˆï¼‰
                leftEye.onclick = function() {
                    if (!leftClicked) {
                        this.classList.add('active');
                        leftClicked = true;
                        checkVerifyStatus(); // æ£€æŸ¥æ˜¯å¦ä¸¤åªéƒ½ç‚¹å‡»
                    }
                };

                // å³çœ¼ç‚¹å‡»äº‹ä»¶ï¼ˆç›´æ¥ç»‘å®šï¼Œç¡®ä¿ç”Ÿæ•ˆï¼‰
                rightEye.onclick = function() {
                    if (!rightClicked) {
                        this.classList.add('active');
                        rightClicked = true;
                        checkVerifyStatus(); // æ£€æŸ¥æ˜¯å¦ä¸¤åªéƒ½ç‚¹å‡»
                    }
                };

                // æ£€æŸ¥éªŒè¯çŠ¶æ€
                function checkVerifyStatus() {
                    if (leftClicked && rightClicked) {
                        verifyPassed = true;
                        verifyTip.textContent = 'âœ… éªŒè¯é€šè¿‡ï¼';
                        verifyTip.style.color = '#48bb78';
                        verifyTip.style.display = 'block';
                        // æ˜¾ç¤ºå¯†ç æ¡†å’ŒæŒ‰é’®
                        formGroup.style.display = 'block';
                        submitBtn.style.display = 'block';
                    }
                }

                // éªŒè¯å¯†ç +è§£å¯†
                async function checkPassword() {
                    if (!verifyPassed) {
                        verifyTip.style.display = 'block';
                        return;
                    }
                    const pwd = document.getElementById('pwd').value.trim();
                    const errEl = document.getElementById('err');
                    if (!pwd) {
                        errEl.textContent = 'è¯·è¾“å…¥å¯†ç ';
                        errEl.style.display = 'block';
                        return;
                    }
                    errEl.style.display = 'none';

                    // åŠ å¯†è¾“å…¥å¯†ç 
                    const encoder = new TextEncoder();
                    const hashBuffer = await crypto.subtle.digest('SHA-256', encoder.encode(pwd));
                    const pwdHash = Array.from(new Uint8Array(hashBuffer))
                        .map(b => b.toString(16).padStart(2, '0'))
                        .join('');

                    try {
                        const res = await fetch(config.workerUrl + '/verify', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                action: 'verify',
                                fileId: config.fileId,
                                passwordHash: pwdHash
                            })
                        });
                        const data = await res.json();

                        if (data.success && data.decryptKey === config.decryptKey) {
                            // è§£ç Counterï¼ˆ16å­—èŠ‚ï¼‰
                            const counter = new Uint8Array(
                                atob(config.counterBase64).split('').map(c => c.charCodeAt(0))
                            );
                            // å¯¼å…¥AES-256å¯†é’¥
                            const key = await crypto.subtle.importKey(
                                'raw',
                                encoder.encode(config.decryptKey),
                                { name: 'AES-CTR' },
                                true,
                                ['decrypt']
                            );
                            // è§£ç åŠ å¯†å†…å®¹
                            const encryptedData = new Uint8Array(
                                atob(config.encryptedBase64).split('').map(c => c.charCodeAt(0))
                            );
                            // è§£å¯†
                            const decryptedData = await crypto.subtle.decrypt(
                                { name: 'AES-CTR', counter: counter, length: 128 },
                                key,
                                encryptedData
                            );
                            const decryptedContent = new TextDecoder().decode(decryptedData);
                            document.open();
                            document.write(decryptedContent);
                            document.close();
                        } else {
                            errEl.textContent = 'å¯†ç é”™è¯¯';
                            errEl.style.display = 'block';
                        }
                    } catch (err) {
                        errEl.textContent = 'ç½‘ç»œé”™è¯¯æˆ–è§£å¯†å¤±è´¥ï¼š' + err.message;
                        errEl.style.display = 'block';
                    }
                }
            `;
            body.appendChild(script);
            html.appendChild(body);

            return new XMLSerializer().serializeToString(html);
        }

        // å¯¼å‡ºé€»è¾‘
        async function exportEncryptedHTML() {
            // å‰ç½®æ ¡éªŒ
            if (!targetFileContent) return showNotice('è¯·å…ˆä¸Šä¼ æ–‡ä»¶');
            if (!passwords.length) return showNotice('è¯·æ·»åŠ å¯†ç ');
            if (!workerUrl) return showNotice('è¯·é…ç½®Worker');

            const exportName = document.getElementById('exportName').value.trim() || 'åŠ å¯†æ–‡ä»¶';
            const decryptKey = Math.random().toString(36).substring(2, 34); // 32å­—ç¬¦ï¼ˆ32å­—èŠ‚ï¼ŒAES-256ï¼‰
            const counterBase64 = generate16ByteCounter(); // 16å­—èŠ‚Counter
            const encoder = new TextEncoder();
            const contentData = encoder.encode(targetFileContent);
            const counter = new Uint8Array(atob(counterBase64).split('').map(c => c.charCodeAt(0)));

            // æ˜¾ç¤ºåŠ è½½æç¤º
            showNotice('å¯¼å‡ºä¸­...', 'warning');
            exportBtn.disabled = true;

            try {
                // ç”ŸæˆAES-256å¯†é’¥
                const encryptionKey = await crypto.subtle.generateKey(
                    { name: 'AES-CTR', length: 256 },
                    true,
                    ['encrypt', 'decrypt']
                );
                // åŠ å¯†
                const encryptedData = await crypto.subtle.encrypt(
                    { name: 'AES-CTR', counter: counter, length: 128 },
                    encryptionKey,
                    contentData
                );

                // è½¬ä¸ºBase64
                const encryptedBase64 = btoa(String.fromCharCode(...new Uint8Array(encryptedData)));
                
                // ç”ŸæˆHTML
                const encryptedHTML = createEncryptedDOM(workerUrl, fileId, decryptKey, encryptedBase64, counterBase64);
                
                // ä¸‹è½½æ–‡ä»¶
                const blob = new Blob([encryptedHTML], { type: 'text/html; charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = exportName + '.html';
                document.body.appendChild(a);
                a.click();

                // åŒæ­¥å¯†é’¥+Counteråˆ°Worker
                await fetch(workerUrl + '/sync-key', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'sync-key', 
                        fileId, 
                        decryptKey,
                        counterBase64
                    })
                });

                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showNotice('å¯¼å‡ºæˆåŠŸï¼', 'success');
                    exportBtn.disabled = false;
                }, 100);
            } catch (err) {
                showNotice('å¯¼å‡ºå¤±è´¥ï¼š' + err.message);
                exportBtn.disabled = false;
            }
        }
    </script>
</body>
</html>