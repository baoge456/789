<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>书签导航</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .container {
            width: 90%;
            max-width: 800px;
            background-color: #FFFFBB;
            border: 1px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            padding: 20px;
            position: relative;
            margin-bottom: 20px;
        }

        #bookmark-title {
            text-align: center;
            margin-bottom: 10px;
            cursor: pointer;
            user-select: none;
        }

        #group-selector {
            margin-bottom: 10px;
        }

        #management-buttons {
            position: absolute;
            top: 5px;
            left: 5px;
            display: none;
            flex-direction: column;
            align-items: flex-start;
            z-index: 10;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 5px;
            border-radius: 5px;
        }

        #management-buttons div {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        #management-buttons button {
            padding: 2px 5px;
            border: none;
            border-radius: 3px;
            background-color: #5CAF50;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 0.8em;
            margin-left: 5px;
        }

        #management-buttons button:hover {
            background-color: #388E3C;
        }

        #bookmark-list {
            overflow-y: auto;
            max-height: 80vh;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            padding-right: 10px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        #bookmark-list::-webkit-scrollbar {
            display: none;
        }

        .bookmark {
            padding: 10px 20px;
            margin: 5px 0;
            background-color: #FFFFDD;
            border: 1px solid #ddd;
            border-radius: 50px;
            position: relative;
            cursor: pointer;
            text-align: center;
            transition: background-color 0.3s ease, color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .bookmark img {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }

        .bookmark h2 {
            margin: 0;
            font-size: 1.2em;
            color: #5CAF50;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .bookmark h2 a {
            text-decoration: none;
            color: inherit;
            pointer-events: none;
        }

        .bookmark:hover,
        .bookmark.selected {
            background-color: purple;
            color: white;
        }

        .bookmark:hover h2,
        .bookmark.selected h2 {
            color: white;
        }

        .buttons {
            position: absolute;
            top: 5px;
            right: 5px;
            display: none;
            gap: 5px;
        }

        .buttons button {
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            background-color: #5CAF50;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .buttons button:hover {
            background-color: #388E3C;
        }

        footer {
            text-align: center;
            padding: 10px;
            font-size: 0.8em;
            color: #555;
        }

        #file-input {
            display: none;
        }

        #current-user {
            text-align: center;
            margin-top: 10px;
            font-style: italic;
            color: #333;
        }

        #group-selector select {
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #ddd;
            background-color: white;
        }

        dialog {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            padding: 20px;
            max-width: 400px;
            width: 90%;
        }

        dialog::backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }

        dialog div {
            margin-bottom: 10px;
        }

        dialog select {
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ddd;
            background-color: white;
        }

        dialog button {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            background-color: #5CAF50;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        dialog button:hover {
            background-color: #388E3C;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 id="bookmark-title">书签导航</h1>

        <div id="management-buttons">
            <div>
                <span>书签：</span>
                <button onclick="triggerFileInput()">导入</button>
                <button onclick="exportBookmarks()">导出</button>
                <button onclick="showClearOptions()">清空</button>
            </div>
            <div>
                <span>分组：</span>
                <button onclick="addGroup()">添加</button>
                <button onclick="renameGroup()">修改</button>
                <button onclick="deleteGroup()">删除</button>
            </div>
            <input type="file" id="file-input" accept=".json,.txt,.html" onchange="importBookmarksFromFile(this)">
        </div>

        <div id="group-selector">
            <select id="group-select" onchange="loadBookmarks()">
            </select>
        </div>

        <div id="bookmark-list">
        </div>
        <div id="current-user"></div>

        <footer>
        </footer>
    </div>

    <dialog id="addGroupDialog">
        <div>选择要放在哪个分组的下方：</div>
        <select id="insertBeforeGroup">
        </select>
        <button id="confirmAddGroup">确认</button>
    </dialog>

    <script>
        const bookmarksKey = 'bookmarks';
        const groupOrderKey = 'groupOrder';
        const defaultGroupName = '默认分组';
        const defaultBookmarkURL = 'https://www.baidu.com/';
        const longPressDuration = 500;

        let titleLongPressTimer;
        let buttonsVisible = false;
        const managementButtons = document.getElementById('management-buttons');

        const toggleManagementButtons = () => {
            buttonsVisible = !buttonsVisible;
            managementButtons.style.display = buttonsVisible ? 'flex' : 'none';
        };

        // Touch and Mouse Event Handling for Bookmark Title
        let titlePressTimer;
        const bookmarkTitle = document.getElementById('bookmark-title');

        function handleTitleStart(event) {
            titlePressTimer = setTimeout(toggleManagementButtons, longPressDuration);
        }

        function handleTitleEnd() {
            clearTimeout(titlePressTimer);
        }

        bookmarkTitle.addEventListener('mousedown', handleTitleStart);
        bookmarkTitle.addEventListener('mouseup', handleTitleEnd);
        bookmarkTitle.addEventListener('mouseleave', handleTitleEnd);
        bookmarkTitle.addEventListener('touchstart', handleTitleStart);
        bookmarkTitle.addEventListener('touchend', handleTitleEnd);
        bookmarkTitle.addEventListener('touchcancel', handleTitleEnd);

        document.addEventListener('click', (event) => {
            if (!managementButtons.contains(event.target) && event.target.id !== 'bookmark-title') {
                managementButtons.style.display = 'none';
                buttonsVisible = false;
            }
        });

        // 读取书签和分组顺序
        function loadData() {
            let bookmarks = JSON.parse(localStorage.getItem(bookmarksKey)) || {};
            let groupOrder = JSON.parse(localStorage.getItem(groupOrderKey)) || Object.keys(bookmarks);
            groupOrder = groupOrder.filter(g => bookmarks.hasOwnProperty(g));

            if (Object.keys(bookmarks).length === 0 && groupOrder.length === 0) {
                // Initialize with default group and bookmark
                bookmarks = {};
                bookmarks[defaultGroupName] = [{
                    name: '默认书签',
                    url: defaultBookmarkURL
                }];
                groupOrder = [defaultGroupName];
                saveData(bookmarks, groupOrder);
            }

            return {
                bookmarks,
                groupOrder
            };
        }

        // 保存书签和分组顺序
        function saveData(bookmarks, groupOrder) {
            localStorage.setItem(bookmarksKey, JSON.stringify(bookmarks));
            localStorage.setItem(groupOrderKey, JSON.stringify(groupOrder));
        }

        // 加载分组选择框，保证顺序
        function loadGroupSelector() {
            const {
                bookmarks,
                groupOrder
            } = loadData();
            const groupSelect = document.getElementById('group-select');
            groupSelect.innerHTML = '';
            groupOrder.forEach(group => {
                const option = document.createElement('option');
                option.value = group;
                option.textContent = group;
                groupSelect.appendChild(option);
            });

            const selectedGroup = localStorage.getItem('selectedGroup');
            if (selectedGroup && groupOrder.includes(selectedGroup)) {
                groupSelect.value = selectedGroup;
            } else if (groupOrder.length > 0) {
                groupSelect.value = groupOrder[0];
                localStorage.setItem('selectedGroup', groupOrder[0]);
            } else {
                // If no groups exist, create the default one
                bookmarks[defaultGroupName] = [{
                    name: '默认书签',
                    url: defaultBookmarkURL
                }];
                groupOrder = [defaultGroupName];
                saveData(bookmarks, groupOrder);
                groupSelect.innerHTML = `<option value="${defaultGroupName}">${defaultGroupName}</option>`;
                groupSelect.value = defaultGroupName;
                localStorage.setItem('selectedGroup', defaultGroupName);
            }
            loadBookmarks();
        }

        // 加载书签
        function loadBookmarks() {
            const {
                bookmarks
            } = loadData();
            const selectedGroup = document.getElementById('group-select').value;
            localStorage.setItem('selectedGroup', selectedGroup);
            const bookmarkList = document.getElementById('bookmark-list');
            bookmarkList.innerHTML = '';
            if (bookmarks[selectedGroup]) {
                bookmarks[selectedGroup].forEach(bookmark => {
                    createBookmark(bookmark.name, bookmark.url);
                });
            }
        }

        // 创建书签卡片
        function createBookmark(name, url) {
            const bookmarkList = document.getElementById('bookmark-list');
            const bookmarkDiv = document.createElement('div');
            bookmarkDiv.className = 'bookmark';
            bookmarkDiv.setAttribute('data-title', name);
            bookmarkDiv.setAttribute('data-url', url);

            const faviconUrl = `https://www.google.com/s2/favicons?domain=${url}`;

            bookmarkDiv.innerHTML = `
                <img src="${faviconUrl}" alt="${name} Favicon">
                <h2><a href="${url}" target="_blank">${name}</a></h2>
                <div class="buttons">
                    <button onclick="addBookmarkBelow(event)">添加</button>
                    <button onclick="editBookmark(event)">编辑</button>
                    <button onclick="deleteBookmark(event)">删除</button>
                </div>
            `;

            bookmarkList.appendChild(bookmarkDiv);

            let longPressTimer;
            let buttonsVisible = false;
            let preventClick = false;

            function showButtons(bookmark) {
                const buttons = bookmark.querySelector('.buttons');
                buttons.style.display = 'flex';
            }

            function hideButtons(bookmark) {
                const buttons = bookmark.querySelector('.buttons');
                buttons.style.display = 'none';
            }

            function handleLongPressStart(event) {
                preventClick = true;
                longPressTimer = setTimeout(() => {
                    buttonsVisible = !buttonsVisible;
                    const buttons = bookmarkDiv.querySelector('.buttons');
                    if (buttonsVisible) {
                        showButtons(bookmarkDiv);
                        bookmarkDiv.classList.add('selected');
                    } else {
                        hideButtons(bookmarkDiv);
                        bookmarkDiv.classList.remove('selected');
                    }
                }, longPressDuration);
            }

            function handleLongPressEnd() {
                clearTimeout(longPressTimer);
            }

            bookmarkDiv.addEventListener('mousedown', handleLongPressStart);
            bookmarkDiv.addEventListener('mouseup', handleLongPressEnd);
            bookmarkDiv.addEventListener('mouseleave', handleLongPressEnd);
            bookmarkDiv.addEventListener('touchstart', handleLongPressStart);
            bookmarkDiv.addEventListener('touchend', handleLongPressEnd);
            bookmarkDiv.addEventListener('touchcancel', handleLongPressEnd);

            bookmarkDiv.addEventListener('click', function(e) {
                if (preventClick) {
                    e.preventDefault();
                    preventClick = false;
                    return;
                }
                if (!buttonsVisible) {
                    window.open(url, '_blank');
                }
            });
        }

        function addGroup() {
            let newGroupName = prompt("输入新分组名称");
            if (!newGroupName) return;

            let {
                bookmarks,
                groupOrder
            } = loadData();

            if (bookmarks.hasOwnProperty(newGroupName)) {
                alert("分组已存在!");
                return;
            }

            const dialog = document.createElement('dialog');
            const div = document.createElement('div');
            div.style.marginBottom = '10px';
            div.textContent = "选择要放在哪个分组的上方：";

            const select = document.createElement('select');
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = '放在最上方';
            select.appendChild(defaultOption);

            groupOrder.forEach(group => {
                const option = document.createElement('option');
                option.value = group;
                option.textContent = group;
                select.appendChild(option);
            });

            div.appendChild(select);

            const btnConfirm = document.createElement('button');
            btnConfirm.textContent = '确认';
            btnConfirm.style.marginTop = '10px';

            dialog.appendChild(div);
            dialog.appendChild(btnConfirm);
            document.body.appendChild(dialog);
            dialog.showModal();

            btnConfirm.onclick = () => {
                const selectedGroup = select.value;

                bookmarks[newGroupName] = [{
                    name: "默认书签",
                    url: defaultBookmarkURL
                }];

                let insertIndex = 0;
	    if (selectedGroup) {
                    const targetIndex = groupOrder.indexOf(selectedGroup);
                    if (targetIndex >= 0) {
                        insertIndex = targetIndex + 1;
                    }
                }

                groupOrder.splice(insertIndex, 0, newGroupName);

                saveData(bookmarks, groupOrder);
                loadGroupSelector();

                const groupSelect = document.getElementById('group-select');
                groupSelect.value = newGroupName;
                localStorage.setItem('selectedGroup', newGroupName);
                loadBookmarks();

                dialog.close();
                dialog.remove();
            };
        }

        function triggerFileInput() {
            document.getElementById('file-input').click();
        }

        function showClearOptions() {
            const clearType = prompt("选择清空类型：\n1. 删除当前分组\n2. 删除所有书签\n请选择 1 或 2");
            if (clearType === '1') {
                clearBookmarks('current');
            } else if (clearType === '2') {
                clearBookmarks('all');
            } else if (clearType) {
                alert("无效选择，请选择 1 或 2");
            }
        }

        function clearBookmarks(clearType) {
            if (clearType === 'current') {
                const groupName = document.getElementById('group-select').value;
                if (confirm(`确定要删除当前分组 "${groupName}" 吗？删除后将无法恢复！`)) {
                    let {
                        bookmarks,
                        groupOrder
                    } = loadData();
                    delete bookmarks[groupName];

                    const index = groupOrder.indexOf(groupName);
                    if (index > -1) {
                        groupOrder.splice(index, 1);
                    }

                    saveData(bookmarks, groupOrder);
                    loadGroupSelector();
                }
            } else if (clearType === 'all') {
                if (confirm('确定要删除所有书签吗？删除后将无法恢复！')) {
                    localStorage.removeItem(bookmarksKey);
                    localStorage.removeItem(groupOrderKey);
                    // Ensure default group and bookmark are created after clearing all
                    const bookmarks = {};
                    bookmarks[defaultGroupName] = [{
                        name: '默认书签',
                        url: defaultBookmarkURL
                    }];
                    const groupOrder = [defaultGroupName];
                    saveData(bookmarks, groupOrder);
                    loadGroupSelector();
                }
            }
        }

        function renameGroup() {
            const oldGroupName = document.getElementById('group-select').value;
            const newGroupName = prompt("输入新分组名称", oldGroupName);
            if (!newGroupName || newGroupName === oldGroupName) return;

            let {
                bookmarks,
                groupOrder
            } = loadData();

            if (bookmarks.hasOwnProperty(newGroupName)) {
                alert("该分组名称已存在!");
                return;
            }

            bookmarks[newGroupName] = bookmarks[oldGroupName];
            delete bookmarks[oldGroupName];

            const index = groupOrder.indexOf(oldGroupName);
            if (index > -1) {
                groupOrder[index] = newGroupName;
            }

            saveData(bookmarks, groupOrder);
            loadGroupSelector();
        }

        function deleteGroup() {
            const groupName = document.getElementById('group-select').value;
            if (confirm(`确定要删除分组 "${groupName}" 吗？删除后将无法恢复！`)) {
                let {
                    bookmarks,
                    groupOrder
                } = loadData();
                delete bookmarks[groupName];

                const index = groupOrder.indexOf(groupName);
                if (index > -1) {
                    groupOrder.splice(index, 1);
                }

                saveData(bookmarks, groupOrder);
                loadGroupSelector();
            }
        }

        function exportBookmarks() {
            const {
                bookmarks
            } = loadData();
            const jsonStr = JSON.stringify(bookmarks);
            const blob = new Blob([jsonStr], {
                type: 'application/json'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'bookmarks.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importBookmarksFromFile(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const contents = e.target.result;
                    const importedData = JSON.parse(contents);

                    if (importedData && typeof importedData === 'object') {
                        let {
                            bookmarks,
                            groupOrder
                        } = loadData();

                        let importCount = 0; // Track the number of imported bookmarks

                        Object.keys(importedData).forEach(group => {
                            if (!bookmarks[group]) {
                                bookmarks[group] = [];
                                groupOrder.push(group);
                            }
                            importedData[group].forEach(bookmark => {
                                if (!bookmarks[group].find(b => b.name === bookmark.name && b.url === bookmark.url)) {
                                    bookmarks[group].push(bookmark);
                                    importCount++;
                                }
                            });
                        });

                        saveData(bookmarks, groupOrder);
                        loadGroupSelector();

                        alert(`成功导入 ${importCount} 个书签!`);
                    } else {
                        alert('导入的文件格式不正确，应为包含书签数据的 JSON 对象。');
                    }
                } catch (error) {
                    console.error('导入文件时出错:', error);
                    alert('导入文件时出错，请检查文件格式是否正确。');
                }
            };

            reader.onerror = function() {
                alert('读取文件时出错！');
            };

            reader.readAsText(file);
            input.value = '';
        }

        function addBookmarkBelow(event) {
            const bookmarkDiv = event.target.closest('.bookmark');
            const title = bookmarkDiv.getAttribute('data-title');
            const url = bookmarkDiv.getAttribute('data-url');
            // ... (rest of your addBookmarkBelow function)
            const newName = prompt("输入新书签名称", "");
            const newURL = prompt("输入新书签链接", "");

            if (!newName || !newURL) return;

            let {
                bookmarks
            } = loadData();
            const selectedGroup = document.getElementById('group-select').value;

            const newBookmark = {
                name: newName,
                url: newURL
            };
            const bookmarkIndex = Array.from(bookmarkDiv.parentNode.children).indexOf(bookmarkDiv);

            bookmarks[selectedGroup].splice(bookmarkIndex + 1, 0, newBookmark);

            saveData(bookmarks, loadData().groupOrder);
            loadBookmarks();
        }

        function editBookmark(event) {
            const bookmarkDiv = event.target.closest('.bookmark');
            const title = bookmarkDiv.getAttribute('data-title');
            const url = bookmarkDiv.getAttribute('data-url');
            // ... (rest of your editBookmark function)
            const newName = prompt("编辑书签名称", title);
            const newURL = prompt("编辑书签链接", url);

            if (!newName || !newURL) return;

            let {
                bookmarks
            } = loadData();
            const selectedGroup = document.getElementById('group-select').value;

            const bookmarkIndex = bookmarks[selectedGroup].findIndex(bookmark => bookmark.name === title && bookmark.url === url);

            if (bookmarkIndex > -1) {
                bookmarks[selectedGroup][bookmarkIndex] = {
                    name: newName,
                    url: newURL
                };
                saveData(bookmarks, loadData().groupOrder);
                loadBookmarks();
            }
        }

        function deleteBookmark(event) {
            const bookmarkDiv = event.target.closest('.bookmark');
            const title = bookmarkDiv.getAttribute('data-title');
            const url = bookmarkDiv.getAttribute('data-url');
            // ... (rest of your deleteBookmark function)
            if (confirm("确定要删除此书签吗？")) {
                let {
                    bookmarks
                } = loadData();
                const selectedGroup = document.getElementById('group-select').value;

                const bookmarkIndex = bookmarks[selectedGroup].findIndex(bookmark => bookmark.name === title && bookmark.url === url);

                if (bookmarkIndex > -1) {
                    bookmarks[selectedGroup].splice(bookmarkIndex, 1);
                    saveData(bookmarks, loadData().groupOrder);
                    loadBookmarks();
                }
            }
        }

        // Initialization
        loadGroupSelector();
    </script>
</body>

</html>
