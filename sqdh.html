<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>书签导航</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .container {
            width: 90%;
            max-width: 800px;
            background-color: #FFFFBB;
            border: 1px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            padding: 20px;
            position: relative;
            margin-bottom: 20px;
        }

        #bookmark-title {
            text-align: center;
            margin-bottom: 10px;
            cursor: pointer;
            user-select: none;
        }

        #group-selector {
            margin-bottom: 10px;
        }

        #management-buttons {
            position: absolute;
            top: 5px;
            left: 5px;
            display: none;
            flex-direction: column;
            align-items: flex-start;
            z-index: 10;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 5px;
            border-radius: 5px;
        }

        #management-buttons div {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        #management-buttons button {
            padding: 2px 5px;
            border: none;
            border-radius: 3px;
            background-color: #5CAF50;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 0.8em;
            margin-left: 5px;
        }

        #management-buttons button:hover {
            background-color: #388E3C;
        }

        #bookmark-list {
            overflow-y: auto;
            max-height: 80vh;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            padding-right: 10px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        #bookmark-list::-webkit-scrollbar {
            display: none;
        }

        .bookmark {
            padding: 10px 20px;
            margin: 5px 0;
            background-color: #FFFFDD;
            border: 1px solid #ddd;
            border-radius: 50px;
            position: relative;
            cursor: pointer;
            text-align: center;
            transition: background-color 0.3s ease, color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .bookmark img {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }

        .bookmark h2 {
            margin: 0;
            font-size: 1.2em;
            color: #5CAF50;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .bookmark h2 a {
            text-decoration: none;
            color: inherit;
            pointer-events: none;
        }

        .bookmark:hover,
        .bookmark.selected {
            background-color: purple;
            color: white;
        }

        .bookmark:hover h2,
        .bookmark.selected h2 {
            color: white;
        }

        .buttons {
            position: absolute;
            top: 5px;
            right: 5px;
            display: none;
            gap: 5px;
        }

        .buttons button {
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            background-color: #5CAF50;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .buttons button:hover {
            background-color: #388E3C;
        }

        footer {
            text-align: center;
            padding: 10px;
            font-size: 0.8em;
            color: #555;
        }

        #file-input {
            display: none;
        }

        #current-user {
            text-align: center;
            margin-top: 10px;
            font-style: italic;
            color: #333;
        }

        #group-selector select {
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #ddd;
            background-color: white;
        }

        dialog {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            padding: 20px;
            max-width: 400px;
            width: 90%;
        }

        dialog::backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }

        dialog div {
            margin-bottom: 10px;
        }

        dialog select {
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ddd;
            background-color: white;
        }

        dialog button {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            background-color: #5CAF50;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        dialog button:hover {
            background-color: #388E3C;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 id="bookmark-title">书签导航</h1>

        <div id="management-buttons">
            <div>
                <span>书签：</span>
                <button onclick="triggerFileInput()">导入</button>
                <button onclick="exportBookmarks()">导出</button>
                <button onclick="showClearOptions()">清空</button>
            </div>
            <div>
                <span>分组：</span>
                <button onclick="addGroup()">添加</button>
                <button onclick="renameGroup()">修改</button>
                <button onclick="deleteGroup()">删除</button>
            </div>
            <input type="file" id="file-input" accept=".json,.txt,.html" onchange="importBookmarksFromFile(this)">
        </div>

        <div id="group-selector">
            <select id="group-select" onchange="loadBookmarks()">
            </select>
        </div>

        <div id="bookmark-list">
        </div>
        <div id="current-user"></div>

        <footer>
        </footer>
    </div>

    <dialog id="addGroupDialog">
        <div>选择要放在哪个分组的下方：</div>
        <select id="insertBeforeGroup">
        </select>
        <button id="confirmAddGroup">确认</button>
    </dialog>

    <script>
        const bookmarksKey = 'bookmarks';
        const groupOrderKey = 'groupOrder';
        const defaultGroupName = '默认分组';
        const defaultBookmarkURL = 'https://www.baidu.com/';

        let titleLongPressTimer;
        let buttonsVisible = false;
        const managementButtons = document.getElementById('management-buttons');

        const toggleManagementButtons = () => {
            buttonsVisible = !buttonsVisible;
            managementButtons.style.display = buttonsVisible ? 'flex' : 'none';
        };

        //书签标题长按
        document.getElementById('bookmark-title').addEventListener('mousedown', (e) => {
            if (e.button === 0) {
                titleLongPressTimer = setTimeout(toggleManagementButtons, 500);
            }
        });

        document.getElementById('bookmark-title').addEventListener('mouseup', () => {
            clearTimeout(titleLongPressTimer);
        });

        document.getElementById('bookmark-title').addEventListener('mouseleave', () => {
            clearTimeout(titleLongPressTimer);
        });

        document.addEventListener('click', (event) => {
            if (!managementButtons.contains(event.target) && event.target.id !== 'bookmark-title') {
                managementButtons.style.display = 'none';
                buttonsVisible = false;
            }
        });

        // 读取书签和分组顺序
        function loadData() {
            let bookmarks = JSON.parse(localStorage.getItem(bookmarksKey)) || {};
            let groupOrder = JSON.parse(localStorage.getItem(groupOrderKey)) || Object.keys(bookmarks);
            groupOrder = groupOrder.filter(g => bookmarks.hasOwnProperty(g));

            if (Object.keys(bookmarks).length === 0 && groupOrder.length === 0) {
                // Initialize with default group and bookmark
                bookmarks = {};
                bookmarks[defaultGroupName] = [{
                    name: '默认书签',
                    url: defaultBookmarkURL
                }];
                groupOrder = [defaultGroupName];
                saveData(bookmarks, groupOrder);
            }

            return {
                bookmarks,
                groupOrder
            };
        }

        // 保存书签和分组顺序
        function saveData(bookmarks, groupOrder) {
            localStorage.setItem(bookmarksKey, JSON.stringify(bookmarks));
            localStorage.setItem(groupOrderKey, JSON.stringify(groupOrder));
        }

        // 加载分组选择框，保证顺序
        function loadGroupSelector() {
            const {
                bookmarks,
                groupOrder
            } = loadData();
            const groupSelect = document.getElementById('group-select');
            groupSelect.innerHTML = '';
            groupOrder.forEach(group => {
                const option = document.createElement('option');
                option.value = group;
                option.textContent = group;
                groupSelect.appendChild(option);
            });

            const selectedGroup = localStorage.getItem('selectedGroup');
            if (selectedGroup && groupOrder.includes(selectedGroup)) {
                groupSelect.value = selectedGroup;
            } else if (groupOrder.length > 0) {
                groupSelect.value = groupOrder[0];
                localStorage.setItem('selectedGroup', groupOrder[0]);
            } else {
                // If no groups exist, create the default one
                bookmarks[defaultGroupName] = [{
                    name: '默认书签',
                    url: defaultBookmarkURL
                }];
                groupOrder = [defaultGroupName];
                saveData(bookmarks, groupOrder);
                groupSelect.innerHTML = `<option value="${defaultGroupName}">${defaultGroupName}</option>`;
                groupSelect.value = defaultGroupName;
                localStorage.setItem('selectedGroup', defaultGroupName);
            }
            loadBookmarks();
        }

        // 加载书签
        function loadBookmarks() {
            const {
                bookmarks
            } = loadData();
            const selectedGroup = document.getElementById('group-select').value;
            localStorage.setItem('selectedGroup', selectedGroup);
            const bookmarkList = document.getElementById('bookmark-list');
            bookmarkList.innerHTML = '';
            if (bookmarks[selectedGroup]) {
                bookmarks[selectedGroup].forEach(bookmark => {
                    createBookmark(bookmark.name, bookmark.url);
                });
            }
        }

        // 创建书签卡片
        function createBookmark(name, url) {
            const bookmarkList = document.getElementById('bookmark-list');
            const bookmarkDiv = document.createElement('div');
            bookmarkDiv.className = 'bookmark';
            bookmarkDiv.setAttribute('data-title', name);
            bookmarkDiv.setAttribute('data-url', url);

            const faviconUrl = `https://www.google.com/s2/favicons?domain=${url}`;

            bookmarkDiv.innerHTML = `
                <img src="${faviconUrl}" alt="${name} Favicon">
                <h2><a href="${url}" target="_blank">${name}</a></h2>
                <div class="buttons">
                    <button onclick="addBookmarkBelow(event)">添加</button>
                    <button onclick="editBookmark(event)">编辑</button>
                    <button onclick="deleteBookmark(event)">删除</button>
                </div>
            `;

            bookmarkList.appendChild(bookmarkDiv);

            let longPressTimer;
            let buttonsVisible = false;
            let preventClick = false;
            let touchStartTime = 0;

            // 长按显示编辑按钮（触摸设备）
            bookmarkDiv.addEventListener('touchstart', function(e) {
                touchStartTime = Date.now();
                preventClick = false;
                longPressTimer = setTimeout(() => {
                    showBookmarkButtons(bookmarkDiv);
                    preventClick = true;
                }, 500);
            });

            bookmarkDiv.addEventListener('touchend', function(e) {
                clearTimeout(longPressTimer);
                if (Date.now() - touchStartTime < 500) {
                    // 短按，打开链接
                    openBookmarkLink(bookmarkDiv);
                }
            });

            bookmarkDiv.addEventListener('touchmove', function(e) {
                clearTimeout(longPressTimer);
            });

            // 鼠标长按显示编辑按钮（桌面设备）
            bookmarkDiv.addEventListener('mousedown', function(e) {
                if (e.button === 0) {
                    preventClick = false;
                    longPressTimer = setTimeout(() => {
                        showBookmarkButtons(bookmarkDiv);
                        preventClick = true;
                    }, 500);
                }
            });

            bookmarkDiv.addEventListener('mouseup', function(e) {
                clearTimeout(longPressTimer);
            });

            bookmarkDiv.addEventListener('mouseleave', function(e) {
                clearTimeout(longPressTimer);
            });

            //点击打开链接
            bookmarkDiv.addEventListener('click', function(e) {
                if (preventClick) {
                    e.preventDefault();
                    preventClick = false;
                    return;
                }
                openBookmarkLink(bookmarkDiv);
            });

            //公共方法：显示书签按钮
            function showBookmarkButtons(bookmarkDiv) {
                buttonsVisible = true;
                const buttons = bookmarkDiv.querySelector('.buttons');
                buttons.style.display = 'flex';
                bookmarkDiv.classList.add('selected');
            }

            //公共方法：打开书签链接
            function openBookmarkLink(bookmarkDiv) {
                if (!buttonsVisible) {
                    const url = bookmarkDiv.getAttribute('data-url');
                    window.open(url, '_blank');
                } else {
                    hideButtons(bookmarkDiv);
                    bookmarkDiv.classList.remove('selected');
                    buttonsVisible = false;
                }
            }

        }

        function showButtons(bookmark) {
            const buttons = bookmark.querySelector('.buttons');
            buttons.style.display = 'flex';
        }

        function hideButtons(bookmark) {
            const buttons = bookmark.querySelector('.buttons');
            buttons.style.display = 'none';
        }

        function addGroup() {
            let newGroupName = prompt("输入新分组名称");
            if (!newGroupName) return;

            let {
                bookmarks,
                groupOrder
            } = loadData();

            if (bookmarks.hasOwnProperty(newGroupName)) {
                alert("分组已存在!");
                return;
            }

            const addGroupDialog = document.getElementById('addGroupDialog');
            const insertBeforeGroupSelect = document.getElementById('insertBeforeGroup');
            insertBeforeGroupSelect.innerHTML = `<option value="">放在最上方</option>`;
            groupOrder.forEach(group => {
                const option = document.createElement('option');
                option.value = group;
                option.textContent = group;
                insertBeforeGroupSelect.appendChild(option);
            });

            addGroupDialog.showModal();

            const confirmAddGroupButton = document.getElementById('confirmAddGroup');
            confirmAddGroupButton.onclick = () => {
                const selectedGroup = insertBeforeGroupSelect.value;
                let insertIndex = 0; // Insert at the beginning by default
                if (selectedGroup) {
                    insertIndex = groupOrder.indexOf(selectedGroup) + 1;
                }

                bookmarks[newGroupName] = [];
                groupOrder.splice(insertIndex, 0, newGroupName);
                saveData(bookmarks, groupOrder);
                addGroupDialog.close();
                loadGroupSelector();
            };
        }

        function renameGroup() {
            const selectedGroup = document.getElementById('group-select').value;
            let newGroupName = prompt("输入新的分组名称", selectedGroup);
            if (!newGroupName) return;

            let {
                bookmarks,
                groupOrder
            } = loadData();

            if (bookmarks.hasOwnProperty(newGroupName)) {
                alert("分组已存在!");
                return;
            }

            bookmarks[newGroupName] = bookmarks[selectedGroup];
            delete bookmarks[selectedGroup];

            const index = groupOrder.indexOf(selectedGroup);
            groupOrder[index] = newGroupName;
            saveData(bookmarks, groupOrder);

            loadGroupSelector();
        }

        function deleteGroup() {
            const selectedGroup = document.getElementById('group-select').value;
            if (selectedGroup === defaultGroupName) {
                alert("默认分组不能删除!");
                return;
            }
            if (confirm(`确定要删除分组 "${selectedGroup}" 吗?`)) {
                let {
                    bookmarks,
                    groupOrder
                } = loadData();
                delete bookmarks[selectedGroup];
                groupOrder = groupOrder.filter(group => group !== selectedGroup);
                saveData(bookmarks, groupOrder);
                loadGroupSelector();
            }
        }

        function addBookmarkBelow(event) {
            event.stopPropagation();
            const bookmarkDiv = event.target.closest('.bookmark');
            const bookmarkName = bookmarkDiv.getAttribute('data-title');
            const bookmarkURL = bookmarkDiv.getAttribute('data-url');

            let newBookmarkName = prompt("输入新书签名称");
            if (!newBookmarkName) return;
            let newBookmarkURL = prompt("输入新书签链接", 'https://');
            if (!newBookmarkURL) return;

            let {
                bookmarks
            } = loadData();
            const selectedGroup = document.getElementById('group-select').value;
            const bookmarkIndex = Array.from(bookmarkDiv.parentNode.children).indexOf(bookmarkDiv);

            bookmarks[selectedGroup].splice(bookmarkIndex + 1, 0, {
                name: newBookmarkName,
                url: newBookmarkURL
            });
            saveData(bookmarks);
            loadBookmarks();
        }

        function editBookmark(event) {
            event.stopPropagation();
            const bookmarkDiv = event.target.closest('.bookmark');
            const bookmarkName = bookmarkDiv.getAttribute('data-title');
            const bookmarkURL = bookmarkDiv.getAttribute('data-url');

            let newBookmarkName = prompt("修改书签名称", bookmarkName);
            if (!newBookmarkName) return;
            let newBookmarkURL = prompt("修改书签链接", bookmarkURL);
            if (!newBookmarkURL) return;

            let {
                bookmarks
            } = loadData();
            const selectedGroup = document.getElementById('group-select').value;
            const bookmarkIndex = Array.from(bookmarkDiv.parentNode.children).indexOf(bookmarkDiv);

            bookmarks[selectedGroup][bookmarkIndex] = {
                name: newBookmarkName,
                url: newBookmarkURL
            };
            saveData(bookmarks);
            loadBookmarks();
        }

        function deleteBookmark(event) {
            event.stopPropagation();
            const bookmarkDiv = event.target.closest('.bookmark');
            const bookmarkName = bookmarkDiv.getAttribute('data-title');
            const bookmarkURL = bookmarkDiv.getAttribute('data-url');

            if (confirm(`确定要删除书签 "${bookmarkName}" 吗?`)) {
                let {
                    bookmarks
                } = loadData();
                const selectedGroup = document.getElementById('group-select').value;
                const bookmarkIndex = Array.from(bookmarkDiv.parentNode.children).indexOf(bookmarkDiv);

                bookmarks[selectedGroup].splice(bookmarkIndex, 1);
                saveData(bookmarks);
                loadBookmarks();
            }
        }

        function triggerFileInput() {
            document.getElementById('file-input').click();
        }

        function importBookmarksFromFile(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        let importedData = JSON.parse(e.target.result);
                        if (importedData.bookmarks && importedData.groupOrder) {
                            let {
                                bookmarks,
                                groupOrder
                            } = loadData();

                            // 合并分组
                            Object.keys(importedData.bookmarks).forEach(group => {
                                if (bookmarks[group]) {
                                    // 合并书签
                                    bookmarks[group] = [...bookmarks[group], ...importedData.bookmarks[group]];
                                } else {
                                    // 添加新分组
                                    bookmarks[group] = importedData.bookmarks[group];
                                    groupOrder.push(group);
                                }
                            });

                            saveData(bookmarks, groupOrder);
                            loadGroupSelector();
                            alert('导入成功！');
                        } else {
                            alert('导入的数据格式不正确。');
                        }
                    } catch (error) {
                        console.error('导入错误:', error);
                        alert('导入失败，请检查文件格式。');
                    }
                };
                reader.readAsText(file);
            }
        }

        function exportBookmarks() {
            let {
                bookmarks,
                groupOrder
            } = loadData();
            const dataStr = JSON.stringify({
                bookmarks,
                groupOrder
            }, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);

            const exportFileName = 'bookmarks.json';

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileName);
            document.body.appendChild(linkElement);
            linkElement.click();
            document.body.removeChild(linkElement);
        }

        function showClearOptions() {
            if (confirm("确定要清空所有书签和分组吗？")) {
                if (confirm("真的确定吗？此操作不可撤销！")) {
                    localStorage.removeItem(bookmarksKey);
                    localStorage.removeItem(groupOrderKey);
                    loadGroupSelector(); // 重新加载默认分组
                    alert('已清空所有书签和分组。');
                }
            }
        }

        // 初始化加载
        loadGroupSelector();
    </script>
</body>

</html>
