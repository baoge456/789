<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>家庭记账本</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script>
        // ---- 全局 API 配置（如需更换请直接改这里） ----
        // 原 API: https://jizhangben-api.wangsir666998.workers.dev
        // 新 API: https://shujv.baoge.wang   （2025‑08‑01 替换）
        window.API_BASE_URL = 'https://shujv.baoge.wang';
    </script>
    <style>
        /* ……（此处保留您原来的全部 CSS，未作修改）…… */
        /* 为了篇幅，这里省略 3000 行 CSS，直接使用您原来的样式即可 */
    </style>
</head>
<body>
<div id="app">
    <!-- ====================== 认证页面 ====================== -->
    <div v-if="!isAuthenticated" class="auth-container">
        <div class="auth-card">
            <!-- 初始入口 -->
            <div v-if="authFlow === 'initial'">
                <h2 class="auth-title"><i class="fas fa-book-open"></i>家庭记账本</h2>
                <div class="auth-form">
                    <p style="color:#666;margin-bottom:20px;text-align:center;">欢迎使用家庭记账本</p>
                    <div style="background:#f8f9fa;border-radius:8px;padding:15px;margin-bottom:20px;border-left:4px solid #28a745;">
                        <h4 style="margin:0 0 10px 0;color:#28a745;font-size:14px;">
                            <i class="fas fa-shield-alt"></i> 数据安全
                        </h4>
                        <ul style="margin:0;padding-left:20px;font-size:12px;color:#666;">
                            <li>数据通过用户ID隔离存储</li>
                            <li>支持数据导出和备份</li>
                            <li>HTTPS 加密传输保护</li>
                        </ul>
                    </div>

                    <div class="auth-option" @click="startUserAuthFlow">
                        <div class="auth-option-icon"><i class="fas fa-user"></i></div>
                        <div class="auth-option-content">
                            <h3>用户注册/登录</h3>
                            <p>个人账户，数据独立</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 选择注册/登录 -->
            <div v-if="authFlow === 'userAuth'">
                <h2 class="auth-title"><i class="fas fa-book-open"></i>家庭记账本</h2>
                <div class="auth-form">
                    <p style="color:#666;margin-bottom:20px;text-align:center;">请选择操作</p>
                    <button @click="authFlow = 'register'" class="btn btn-primary"><i class="fas fa-user-plus"></i>注册新用户</button>
                    <button @click="authFlow = 'login'" class="btn btn-success"><i class="fas fa-sign-in-alt"></i>用户登录</button>
                    <button @click="authFlow = 'initial'" class="btn btn-outline"><i class="fas fa-arrow-left"></i>返回</button>
                </div>
            </div>

            <!-- 注册 -->
            <div v-if="authFlow === 'register'">
                <h2 class="auth-title"><i class="fas fa-user-plus"></i>注册新用户</h2>
                <div class="auth-form">
                    <div class="form-group">
                        <label>用户名</label>
                        <input type="text" v-model="userForm.username"
                               placeholder="请输入用户名（3-20 位字母数字下划线）">
                        <small style="color:#6c757d;font-size:12px;">
                            用户名长度 3‑20 位，只能包含字母、数字和下划线
                        </small>
                    </div>
                    <div class="form-group"><label>密码</label><input type="password" v-model="userForm.password" placeholder="请输入密码"></div>
                    <div class="form-group"><label>确认密码</label><input type="password" v-model="userForm.confirmPassword" placeholder="请再次输入密码"></div>
                    <div class="form-group"><label>邀请码 *</label><input type="text" v-model="userForm.inviteCode"
                               placeholder="请输入邀请码" @keyup.enter="registerUser"></div>
                    <div v-if="userFormError" class="error-message">{{ userFormError }}</div>
                    <button @click="registerUser" class="btn btn-primary"><i class="fas fa-user-plus"></i>注册</button>
                    <button @click="authFlow = 'userAuth'" class="btn btn-outline"><i class="fas fa-arrow-left"></i>返回</button>
                </div>
            </div>

            <!-- 登录 -->
            <div v-if="authFlow === 'login'">
                <h2 class="auth-title"><i class="fas fa-sign-in-alt"></i>用户登录</h2>
                <div class="auth-form">
                    <div class="form-group"><label>用户名</label><input type="text" v-model="userForm.username"
                               placeholder="请输入用户名"></div>
                    <div class="form-group"><label>密码</label><input type="password" v-model="userForm.password"
                               placeholder="请输入密码" @keyup.enter="loginUser"></div>
                    <div v-if="userFormError" class="error-message">{{ userFormError }}</div>
                    <button @click="loginUser" class="btn btn-success"><i class="fas fa-sign-in-alt"></i>登录</button>
                    <button @click="authFlow = 'userAuth'" class="btn btn-outline"><i class="fas fa-arrow-left"></i>返回</button>
                </div>
            </div>

            <!-- 设置/重置密码 -->
            <div v-if="authFlow === 'setPassword'">
                <h2 class="auth-title"><i class="fas fa-shield-alt"></i>{{ !hasPassword ? '设置密码' : '重置密码' }}</h2>
                <div class="auth-form">
                    <div class="form-group"><label>新密码（至少 6 位）</label><input type="password" v-model="newPassword"
                               placeholder="请输入密码" @keyup.enter="setPassword"></div>
                    <div class="form-group"><label>确认密码</label><input type="password" v-model="confirmPassword"
                               placeholder="请再次输入密码" @keyup.enter="setPassword"></div>
                    <div v-if="passwordMismatch" class="error-message">密码不匹配，请重新输入</div>
                    <button @click="setPassword" class="btn btn-primary"><i class="fas fa-check"></i>{{ !hasPassword ? '设置密码' : '重置密码' }}</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ====================== 主应用 ====================== -->
    <div v-else class="app-container">
        <!-- 顶部 -->
        <div class="header">
            <h1><i class="fas fa-book-open"></i>家庭记账</h1>
            <div class="header-actions">
                <div v-if="isMultiUserMode && currentUser" class="user-info">
                    <span class="user-name"><i class="fas fa-user"></i> {{ currentUser.username }}</span>
                    <button @click="logout" class="btn btn-small btn-outline" title="登出"><i class="fas fa-sign-out-alt"></i></button>
                </div>
                <div class="sync-info" v-if="lastSyncTime"><small>最后同步: {{ lastSyncTime }}</small></div>
            </div>
        </div>

        <!-- 移动端菜单切换按钮 -->
        <button class="menu-toggle" @click="toggleMenu"><i class="fas fa-bars"></i> {{ menuOpen ? '收起菜单' : '打开菜单' }}</button>

        <!-- 导航 -->
        <div :class="['nav-tabs', {show: menuOpen}]">
            <button v-for="tab in tabs" :key="tab.id"
                    @click="activeTab = tab.id; menuOpen = false"
                    :class="['nav-tab', {active: activeTab===tab.id}]">
                <i :class="tab.icon"></i> {{ tab.name }}
            </button>
        </div>

        <!-- 内容 -->
        <div class="content">
            <!-- ======== 概览页（保留原有结构） ======== -->
            <div v-if="activeTab === 'overview'" class="overview-page">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                    <h2 style="margin:0;font-size:1.5rem;"><i class="fas fa-chart-pie"></i>财务概览</h2>
                </div>

                <div class="overview-grid">
                    <div class="overview-card income"><h3>本月收入</h3><div class="amount">¥{{ monthlyIncome.toFixed(2) }}</div><div class="subtitle">{{ incomeStats.length }} 个分类</div></div>
                    <div class="overview-card expense"><h3>本月支出</h3><div class="amount">¥{{ monthlyExpense.toFixed(2) }}</div><div class="subtitle">{{ expenseStats.length }} 个分类</div></div>
                    <div class="overview-card balance"><h3>本月结余</h3><div class="amount">¥{{ monthlyBalance.toFixed(2) }}</div><div class="subtitle">{{ monthlyBalance >= 0 ? '盈余' : '亏损' }}</div></div>
                    <div class="overview-card" :class="{negative: netAssets < 0}"><h3>净资产</h3><div class="amount">¥{{ netAssets.toFixed(2) }}</div><div class="subtitle">{{ netAssets >= 0 ? '资产-负债' : '负债-资产' }}</div></div>
                </div>

                <!-- 最近记录 -->
                <div class="records-container">
                    <h3 style="margin-bottom:12px;font-size:1.1rem;">
                        <i class="fas fa-clock"></i> 最近记录
                        <button @click="toggleRecentRecordsHint" class="hint-toggle-btn" title="详细信息"><i class="fas fa-info-circle"></i></button>
                        <small v-if="showRecentRecordsHint" class="hint-text">滚动查看最近 10 条数据，全部数据请到记录菜单下查询</small>
                    </h3>
                    <div class="recent-records-scroll">
                        <table class="recent-records-table">
                            <thead><tr><th>日期</th><th>类型</th><th>金额</th><th>分类/账户</th><th>描述</th></tr></thead>
                            <tbody>
                                <tr v-for="record in recentRecords" :key="record.id">
                                    <td>{{ record.date }}</td>
                                    <td>
                                        <span v-if="record.type==='income'" class="amount-income"><i class="fas fa-arrow-up"></i> 收入</span>
                                        <span v-else-if="record.type==='expense'" class="amount-expense"><i class="fas fa-arrow-down"></i> 支出</span>
                                        <span v-else class="amount-transfer"><i class="fas fa-exchange-alt"></i> 转账</span>
                                    </td>
                                    <td><span :class="'amount-'+record.type">¥{{ record.amount.toFixed(2) }}</span></td>
                                    <td>
                                        <div v-if="record.type !== 'transfer'">
                                            <div style="font-size:11px;">{{ getCategoryName(record.category) }}</div>
                                            <small style="color:#666;font-size:10px;">{{ getAccountName(record.account) }}</small>
                                        </div>
                                        <div v-else>
                                            <div style="font-size:11px;">{{ getAccountName(record.fromAccount) }} → {{ getAccountName(record.toAccount) }}</div>
                                        </div>
                                    </td>
                                    <td><span v-if="record.description" style="font-size:10px;color:#666;">{{ record.description }}</span><span v-else style="color:#ccc;font-size:10px;">-</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ==================== 其余页面（保持原结构） ==================== -->
            <!-- 为了篇幅，这里省略收入、支出、转账、记录、分类、账户、统计、设置等页面的 HTML。 -->
            <!-- 请直接把您原来的那几段代码（从 v-if="activeTab === 'income'" 开始一直到页面结束）粘在这里，**不要改动**。 -->
        </div>
    </div>
</div>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                // ---------- 基础配置 ----------
                apiBaseUrl: window.API_BASE_URL || 'https://shujv.baoge.wang',
                menuOpen: false,

                // ---------- 认证 ----------
                isAuthenticated: false,
                authFlow: 'initial',               // initial / userAuth / register / login / setPassword
                isMultiUserMode: false,
                currentUser: null,
                userToken: null,
                hasVerifiedAuthCode: false,        // ← 新增
                // 登录/注册表单
                userForm: { username: '', password: '', confirmPassword: '', inviteCode: '' },
                userFormError: '',
                // 密码设置
                newPassword: '',
                confirmPassword: '',
                passwordMismatch: false,

                // ---------- 数据 ----------
                records: [],
                categories: [],
                accounts: [],

                // ---------- 表单 ----------
                incomeForm: { amount: '', date: '', category: '', account: '', description: '' },
                expenseForm: { amount: '', date: '', category: '', account: '', description: '' },
                transferForm: { fromAccount: '', toAccount: '', amount: '', date: '', description: '' },
                categoryForm: { name: '', type: 'expense', parentId: null, isEditing: false, editingId: null },
                accountForm: { name: '', type: 'asset' },

                // ---------- UI 状态 ----------
                activeTab: 'overview',
                tabs: [
                    {id: 'overview', name: '概览', icon: 'fas fa-chart-pie'},
                    {id: 'income',   name: '收入', icon: 'fas fa-plus-circle'},
                    {id: 'expense',  name: '支出', icon: 'fas fa-minus-circle'},
                    {id: 'transfer', name: '转账', icon: 'fas fa-exchange-alt'},
                    {id: 'records',  name: '记录', icon: 'fas fa-list'},
                    {id: 'analysis', name: '统计', icon: 'fas fa-chart-bar'},
                    {id: 'categories', name: '分类', icon: 'fas fa-tags'},
                    {id: 'accounts', name: '账户', icon: 'fas fa-university'},
                    {id: 'settings', name: '设置', icon: 'fas fa-cog'}
                ],
                searchKeyword: '',
                recordFilter: 'all',
                currentPage: 1,
                pageSize: 20,

                // ---------- 统计/分析 ----------
                editingRecord: null,
                analysisForm: {
                    startDate: '',
                    endDate: '',
                    type: 'all',
                    category: '',
                    account: '',
                    groupBy: 'month',
                    reportType: 'summary'
                },
                reportTypes: [
                    {id: 'summary', name: '汇总报表', icon: 'fas fa-table'},
                    {id: 'detail',  name: '明细报表', icon: 'fas fa-list-alt'},
                    {id: 'chart',   name: '图表分析', icon: 'fas fa-chart-line'}
                ],
                groupByOptions: [
                    {id: 'month',    name: '按月分组',    icon: 'fas fa-calendar-alt'},
                    {id: 'quarter',  name: '按季度分组',  icon: 'fas fa-calendar-week'},
                    {id: 'year',     name: '按年分组',    icon: 'fas fa-calendar'},
                    {id: 'category', name: '按分类分组',  icon: 'fas fa-tags'},
                    {id: 'account',  name: '按账户分组',  icon: 'fas fa-university'}
                ],
                reportData: null,
                chartData: null,
                advancedAnalysis: {
                    showTrend: false,
                    showComparison: false,
                    comparisonPeriod: 'previous',
                    trendPeriods: 6
                },
                showAdvancedAnalysis: false,
                showRecentRecordsHint: false,
                quickFilter: ''
            };
        },

        computed: {
            // ---------- 认证 ----------
            hasPassword() {
                return localStorage.getItem('accountingPassword') !== null;
            },

            // ---------- 账户余额 ----------
            accountBalances() {
                const bal = {};
                this.accounts.forEach(a => bal[a.id] = a.initialBalance || 0);
                this.records.forEach(r => {
                    if (r.type === 'income') bal[r.account] = (bal[r.account] || 0) + r.amount;
                    else if (r.type === 'expense') bal[r.account] = (bal[r.account] || 0) - r.amount;
                    else if (r.type === 'transfer') {
                        bal[r.fromAccount] = (bal[r.fromAccount] || 0) - r.amount;
                        bal[r.toAccount]   = (bal[r.toAccount]   || 0) + r.amount;
                    }
                });
                return bal;
            },

            assetAccounts()   { return this.accounts.filter(a => a.type === 'asset'); },
            liabilityAccounts(){ return this.accounts.filter(a => a.type === 'liability'); },

            // ---------- 统计 ----------
            netAssets() {
                const assets = this.assetAccounts.reduce((s,a)=>s+(this.accountBalances[a.id]||0),0);
                const liabilities = this.liabilityAccounts.reduce((s,a)=>s+(this.accountBalances[a.id]||0),0);
                return assets - liabilities;
            },

            monthlyIncome() {
                const cur = new Date().toISOString().slice(0,7);
                return this.records.filter(r=>r.type==='income' && r.date.startsWith(cur))
                                   .reduce((s,r)=>s+r.amount,0);
            },

            monthlyExpense() {
                const cur = new Date().toISOString().slice(0,7);
                return this.records.filter(r=>r.type==='expense' && r.date.startsWith(cur))
                                   .reduce((s,r)=>s+r.amount,0);
            },

            monthlyBalance() { return this.monthlyIncome - this.monthlyExpense; },

            // ---------- 分类筛选 ----------
            incomeCategories() {
                const all = this.categories.filter(c=>c.type==='income');
                return all.filter(c=>c.parentId || !this.categories.some(sc=>sc.parentId===c.id));
            },

            expenseCategories() {
                const all = this.categories.filter(c=>c.type==='expense');
                return all.filter(c=>c.parentId || !this.categories.some(sc=>sc.parentId===c.id));
            },

            // ---------- 分类统计 ----------
            incomeStats() {
                const cur = new Date().toISOString().slice(0,7);
                const map = {};
                this.records.filter(r=>r.type==='income' && r.date.startsWith(cur)).forEach(r=>{
                    if (!map[r.category]) map[r.category]={category:r.category,categoryName:this.getCategoryName(r.category),amount:0};
                    map[r.category].amount += r.amount;
                });
                return Object.values(map).sort((a,b)=>b.amount-a.amount);
            },

            expenseStats() {
                const cur = new Date().toISOString().slice(0,7);
                const map = {};
                this.records.filter(r=>r.type==='expense' && r.date.startsWith(cur)).forEach(r=>{
                    if (!map[r.category]) map[r.category]={category:r.category,categoryName:this.getCategoryName(r.category),amount:0};
                    map[r.category].amount += r.amount;
                });
                return Object.values(map).sort((a,b)=>b.amount-a.amount);
            },

            // ---------- 最近记录 ----------
            recentRecords() {
                return [...this.records].sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,10);
            },

            // ---------- 记录过滤 & 分页 ----------
            filteredRecords() {
                let list = this.records;

                if (this.recordFilter !== 'all')
                    list = list.filter(r=>r.type===this.recordFilter);

                if (this.searchKeyword) {
                    const kw = this.searchKeyword.toLowerCase();
                    list = list.filter(r=>{
                        return (r.description && r.description.toLowerCase().includes(kw)) ||
                               this.getCategoryName(r.category).toLowerCase().includes(kw) ||
                               this.getAccountName(r.account).toLowerCase().includes(kw) ||
                               (r.fromAccount && this.getAccountName(r.fromAccount).toLowerCase().includes(kw)) ||
                               (r.toAccount && this.getAccountName(r.toAccount).toLowerCase().includes(kw));
                    });
                }

                return list.sort((a,b)=>new Date(b.date)-new Date(a.date));
            },

            totalPages() { return Math.ceil(this.filteredRecords.length / this.pageSize); },

            paginatedRecords() {
                const start = (this.currentPage-1)*this.pageSize;
                return this.filteredRecords.slice(start, start+this.pageSize);
            },

            visiblePages() {
                const pages = [];
                const start = Math.max(1, this.currentPage-2);
                const end   = Math.min(this.totalPages, this.currentPage+2);
                for (let i=start;i<=end;i++) pages.push(i);
                return pages;
            }
        },

        methods: {
            // --------------------------------------------------- 通用请求封装 ---------------------------------------------------
            async request(path, options = {}) {
                const headers = options.headers || {};
                if (this.isMultiUserMode && this.userToken) {
                    headers['Authorization'] = `Bearer ${this.userToken}`;
                }
                options.headers = headers;
                const resp = await fetch(`${this.apiBaseUrl}${path}`, options);
                if (!resp.ok) {
                    const txt = await resp.text();
                    throw new Error(`请求 ${path} 失败：${resp.status} ${txt}`);
                }
                return resp;
            },

            // --------------------------------------------------- 菜单 ---------------------------------------------------
            toggleMenu() { this.menuOpen = !this.menuOpen; },

            // --------------------------------------------------- 密码 ---------------------------------------------------
            async setPassword() {
                if (this.newPassword.length < 6) {
                    alert('密码长度至少 6 位');
                    return;
                }
                if (this.newPassword !== this.confirmPassword) {
                    this.passwordMismatch = true;
                    setTimeout(() => this.passwordMismatch = false, 9998);
                    return;
                }
                // SHA‑256 + Base64
                const enc = new TextEncoder();
                const data = enc.encode(this.newPassword);
                const hash = await crypto.subtle.digest('SHA-256', data);
                const hashStr = btoa(String.fromCharCode(...new Uint8Array(hash)));
                localStorage.setItem('accountingPassword', hashStr);

                if (!this.hasVerifiedAuthCode) {
                    this.isAuthenticated = true;
                    this.startSession();
                    alert('密码设置成功！');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    this.authFlow = 'initial';
                    alert('密码重置成功！');
                    setTimeout(() => location.reload(), 1000);
                }
            },

            // --------------------------------------------------- 登录/注册 ---------------------------------------------------
            startUserAuthFlow() {
                this.authFlow = 'userAuth';
                this.isMultiUserMode = true;
                this.userFormError = '';
            },

            async registerUser() {
                if (!this.userForm.username || !this.userForm.password || !this.userForm.inviteCode) {
                    this.userFormError = '请填写完整信息（包括邀请码）';
                    return;
                }
                if (this.userForm.password !== this.userForm.confirmPassword) {
                    this.userFormError = '两次输入的密码不一致';
                    return;
                }
                if (this.userForm.password.length < 6) {
                    this.userFormError = '密码长度至少 6 位';
                    return;
                }
                const forbidden = ['admin','administrator','root','system','master'];
                if (forbidden.includes(this.userForm.username.toLowerCase())) {
                    this.userFormError = '该用户名已被占用';
                    return;
                }

                try {
                    const resp = await this.request('/api/auth/register', {
                        method: 'POST',
                        body: JSON.stringify({
                            username: this.userForm.username,
                            password: this.userForm.password,
                            inviteCode: this.userForm.inviteCode
                        })
                    });
                    const result = await resp.json();

                    // 注册成功直接登录
                    this.currentUser = result.user;
                    this.userToken   = result.token;
                    this.isAuthenticated = true;
                    this.isMultiUserMode = true;

                    localStorage.setItem('userToken', this.userToken);
                    localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                    localStorage.setItem('isMultiUserMode', 'true');

                    this.startSession();
                    this.showMessage('注册成功！', 'success');

                    // 清空表单
                    this.userFormError = '';
                    this.userForm = { username:'', password:'', confirmPassword:'', inviteCode:'' };
                } catch (e) {
                    console.error(e);
                    this.userFormError = e.message || '注册失败';
                }
            },

            async loginUser() {
                if (!this.userForm.username || !this.userForm.password) {
                    this.userFormError = '请填写完整信息';
                    return;
                }
                if (this.userForm.username.toLowerCase() === 'admin') {
                    this.userFormError = '该用户不存在';
                    return;
                }

                try {
                    const resp = await this.request('/api/auth/login', {
                        method: 'POST',
                        body: JSON.stringify({
                            username: this.userForm.username,
                            password: this.userForm.password
                        })
                    });
                    const result = await resp.json();

                    this.currentUser = result.user;
                    this.userToken   = result.token;
                    this.isAuthenticated = true;
                    this.isMultiUserMode = true;

                    localStorage.setItem('userToken', this.userToken);
                    localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                    localStorage.setItem('isMultiUserMode', 'true');

                    this.startSession();
                    this.showMessage('登录成功！', 'success');

                    this.userFormError = '';
                    this.userForm = { username:'', password:'', confirmPassword:'', inviteCode:'' };
                } catch (e) {
                    console.error(e);
                    this.userFormError = e.message || '登录失败';
                }
            },

            // --------------------------------------------------- 唯一的登出 ---------------------------------------------------
            logout() {
                // 清除所有登录相关信息
                this.currentUser = null;
                this.userToken   = null;
                this.isMultiUserMode = false;
                localStorage.removeItem('userToken');
                localStorage.removeItem('currentUser');
                localStorage.removeItem('isMultiUserMode');

                this.isAuthenticated = false;
                this.clearSession();
                this.authFlow = 'initial';
                this.showMessage('已安全登出', 'info');
            },

            // --------------------------------------------------- 会话 ---------------------------------------------------
            startSession() { sessionStorage.setItem('isAuthenticated', 'true'); },
            clearSession(){ sessionStorage.removeItem('isAuthenticated'); },

            // --------------------------------------------------- 通用工具 ---------------------------------------------------
            getCurrentDate() {
                const now = new Date();
                const y = now.getFullYear();
                const m = String(now.getMonth()+1).padStart(2,'0');
                const d = String(now.getDate()).padStart(2,'0');
                return `${y}-${m}-${d}`;
            },

            // --------------------------------------------------- 数据同步 ---------------------------------------------------
            async syncData() {
                if (this.isSyncing) return;
                this.isSyncing = true;
                try {
                    await this.saveAllData();          // 先推送本地改动
                    await this.refreshAllData();       // 再拉取最新数据
                    this.lastSyncTime = new Date().toLocaleString();
                    this.showMessage('数据已同步', 'success');
                } catch (e) {
                    console.error(e);
                    this.showMessage('数据同步失败，请重试', 'error');
                } finally {
                    this.isSyncing = false;
                }
            },

            async autoSync() {
                try {
                    await this.saveAllData();
                    this.lastSyncTime = new Date().toLocaleString();
                } catch (e) {
                    console.error('自动同步失败', e);
                }
            },

            async saveAllData() {
                const payload = {
                    records: this.records,
                    categories: this.categories,
                    accounts: this.accounts
                };
                await this.request('/api/data', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify(payload)
                });
            },

            async refreshAllData() {
                const resp = await this.request('/api/data');
                const data = await resp.json();
                this.records    = data.records    || [];
                this.categories = data.categories || [];
                this.accounts   = data.accounts   || [];

                // 若后端返回空数组，使用默认数据（只在第一次没有任何数据时执行）
                if (this.categories.length === 0) this.initDefaultCategories();
                if (this.accounts.length   === 0) this.initDefaultAccounts();
            },

            // --------------------------------------------------- 消息提示 ---------------------------------------------------
            showMessage(msg, type='info') {
                const el = document.createElement('div');
                el.className = `message message-${type}`;
                el.textContent = msg;
                el.style.cssText = `
                    position:fixed;top:20px;right:20px;padding:12px 20px;
                    border-radius:8px;color:#fff;font-weight:500;z-index:10000;
                    background:${type==='success'?'#27ae60':type==='error'?'#e74c3c':'#3498db'};
                    animation:slideIn .3s ease;
                `;
                document.body.appendChild(el);
                setTimeout(()=>el && el.parentNode && el.parentNode.removeChild(el), 9998);
            },

            // --------------------------------------------------- 收入/支出/转账 ---------------------------------------------------
            async addIncome() {
                if (!this.incomeForm.amount || !this.incomeForm.category || !this.incomeForm.account) {
                    alert('请填写完整信息');
                    return;
                }
                const rec = {
                    id: Date.now(),
                    type: 'income',
                    amount: parseFloat(this.incomeForm.amount),
                    date: this.incomeForm.date,
                    category: parseInt(this.incomeForm.category),
                    account: parseInt(this.incomeForm.account),
                    description: this.incomeForm.description || ''
                };
                this.records.push(rec);
                await this.saveAllData();
                await this.autoSync();
                this.incomeForm = { amount:'', date:this.getCurrentDate(), category:'', account:'', description:'' };
                alert('收入记录添加成功');
            },

            async addExpense() {
                if (!this.expenseForm.amount || !this.expenseForm.category || !this.expenseForm.account) {
                    alert('请填写完整信息');
                    return;
                }
                const rec = {
                    id: Date.now(),
                    type: 'expense',
                    amount: parseFloat(this.expenseForm.amount),
                    date: this.expenseForm.date,
                    category: parseInt(this.expenseForm.category),
                    account: parseInt(this.expenseForm.account),
                    description: this.expenseForm.description || ''
                };
                this.records.push(rec);
                await this.saveAllData();
                await this.autoSync();
                this.expenseForm = { amount:'', date:this.getCurrentDate(), category:'', account:'', description:'' };
                alert('支出记录添加成功');
            },

            async addTransfer() {
                if (!this.transferForm.fromAccount || !this.transferForm.toAccount || !this.transferForm.amount) {
                    alert('请填写完整信息');
                    return;
                }
                if (this.transferForm.fromAccount === this.transferForm.toAccount) {
                    alert('转出账户和转入账户不能相同');
                    return;
                }
                const rec = {
                    id: Date.now(),
                    type: 'transfer',
                    amount: parseFloat(this.transferForm.amount),
                    date: this.transferForm.date,
                    fromAccount: parseInt(this.transferForm.fromAccount),
                    toAccount: parseInt(this.transferForm.toAccount),
                    description: this.transferForm.description || ''
                };
                this.records.push(rec);
                await this.saveAllData();
                await this.autoSync();
                this.transferForm = { fromAccount:'', toAccount:'', amount:'', date:this.getCurrentDate(), description:'' };
                alert('转账记录添加成功');
            },

            // --------------------------------------------------- 分类管理 ---------------------------------------------------
            async addCategory() {
                if (!this.categoryForm.name) {
                    alert('请输入分类名称');
                    return;
                }
                if (this.categoryForm.isEditing) {
                    await this.saveEditedCategory();
                    return;
                }
                const cat = {
                    id: Date.now(),
                    name: this.categoryForm.name,
                    type: this.categoryForm.type,
                    parentId: this.categoryForm.parentId ? parseInt(this.categoryForm.parentId) : null
                };
                this.categories.push(cat);
                await this.saveAllData();
                await this.autoSync();
                this.categoryForm = { name:'', type:'expense', parentId:null, isEditing:false, editingId:null };
                alert('分类添加成功');
            },

            getParentCategories(type) {
                return this.categories.filter(c => c.type===type && !c.parentId);
            },

            getTopLevelCategories(type) {
                return this.categories.filter(c => c.type===type && !c.parentId);
            },

            getSubCategories(parentId) {
                return this.categories.filter(c => c.parentId===parentId);
            },

            async editCategory(cat) {
                this.categoryForm = {
                    name: cat.name,
                    type: cat.type,
                    parentId: cat.parentId || null,
                    isEditing: true,
                    editingId: cat.id
                };
                // 聚焦（保持原来的体验）
                setTimeout(()=>{ const el=document.querySelector('input[placeholder="请输入分类名称"]'); el && el.focus(); },100);
            },

            async saveEditedCategory() {
                if (!this.categoryForm.name) { alert('请输入分类名称'); return; }
                const idx = this.categories.findIndex(c=>c.id===this.categoryForm.editingId);
                if (idx===-1) return;
                this.categories[idx] = {
                    ...this.categories[idx],
                    name: this.categoryForm.name,
                    type: this.categoryForm.type,
                    parentId: this.categoryForm.parentId ? parseInt(this.categoryForm.parentId) : null
                };
                await this.saveAllData();
                await this.autoSync();
                this.categoryForm = { name:'', type:'expense', parentId:null, isEditing:false, editingId:null };
                alert('分类修改成功');
            },

            async deleteCategory(id) {
                // 1）检查是否有记录使用此分类
                const hasRec = this.records.some(r=>r.category===id);
                if (hasRec) {
                    alert('该分类下还有记录，无法删除。您可以编辑分类名称，但不能删除有记录的分类。');
                    return;
                }
                // 2）检查子分类
                const subCats = this.categories.filter(c=>c.parentId===id);
                if (subCats.length) {
                    // 子分类中若还有记录，就不能直接删
                    const subHasRec = subCats.some(sc=>this.records.some(r=>r.category===sc.id));
                    if (subHasRec) {
                        alert('子分类中还有记录，无法删除。请先处理子分类的记录。');
                        return;
                    }
                    if (!confirm('该分类下有子分类，删除将同时删除所有子分类，确定继续吗？')) return;
                    this.categories = this.categories.filter(c=>c.id!==id && c.parentId!==id);
                } else {
                    if (!confirm('确定要删除这个分类吗？')) return;
                    this.categories = this.categories.filter(c=>c.id!==id);
                }
                await this.saveAllData();
                alert('分类删除成功');
            },

            // --------------------------------------------------- 账户管理 ---------------------------------------------------
            async addAccount() {
                if (!this.accountForm.name) { alert('请输入账户名称'); return; }
                const acc = {
                    id: Date.now(),
                    name: this.accountForm.name,
                    type: this.accountForm.type,
                    initialBalance: 0
                };
                this.accounts.push(acc);
                await this.saveAllData();
                await this.autoSync();
                this.accountForm = { name:'', type:'asset' };
                alert('账户添加成功');
            },

            async deleteAccount(id) {
                const hasRec = this.records.some(r=> r.account===id || r.fromAccount===id || r.toAccount===id );
                if (hasRec) { alert('该账户下还有记录，无法删除'); return; }
                if (!confirm('确定要删除这个账户吗？')) return;
                this.accounts = this.accounts.filter(a=>a.id!==id);
                await this.saveAllData();
            },

            async setAccountBalance(account) {
                const cur = this.accountBalances[account.id] || 0;
                const input = prompt(`设置 ${account.name} 的余额：\n当前余额：¥${cur.toFixed(2)}`, cur.toFixed(2));
                if (input===null || isNaN(input)) return;
                const target = parseFloat(input);
                const diff = target - cur;
                if (diff===0) return;
                const rec = {
                    id: Date.now(),
                    type: diff>0 ? 'income' : 'expense',
                    amount: Math.abs(diff),
                    date: this.getCurrentDate(),
                    category: diff>0 ? 4 : 12,   // 其他收入 / 其他支出
                    account: account.id,
                    description: `余额调整 - ${account.name}`
                };
                this.records.push(rec);
                await this.saveAllData();
                await this.autoSync();
                alert(`${account.name} 余额已调整为 ¥${target.toFixed(2)}`);
            },

            async setInitialBalance(account) {
                const input = prompt(`设置 ${account.name} 的初始余额：`, account.initialBalance || '0');
                if (input===null || isNaN(input)) return;
                account.initialBalance = parseFloat(input);
                await this.saveAllData();
                alert(`${account.name} 初始余额已设置为 ¥${account.initialBalance.toFixed(2)}`);
            },

            // --------------------------------------------------- 记录管理 ---------------------------------------------------
            editRecord(record) { this.editingRecord = { ...record }; },

            async saveEditedRecord() {
                if (!this.editingRecord) return;
                if (!this.editingRecord.amount || !this.editingRecord.date) {
                    alert('金额和日期为必填项');
                    return;
                }
                if (this.editingRecord.type !== 'transfer') {
                    if (!this.editingRecord.category || !this.editingRecord.account) {
                        alert('分类和账户为必填项');
                        return;
                    }
                } else {
                    if (!this.editingRecord.fromAccount || !this.editingRecord.toAccount) {
                        alert('转出账户和转入账户为必填项');
                        return;
                    }
                }
                const idx = this.records.findIndex(r=>r.id===this.editingRecord.id);
                if (idx!==-1) {
                    this.records.splice(idx,1,{...this.editingRecord});
                    await this.saveAllData();
                    await this.autoSync();
                    this.editingRecord = null;
                    alert('记录已更新');
                }
            },

            cancelEdit() { this.editingRecord = null; },

            handleEditTypeChange() {
                if (this.editingRecord.type === 'transfer') {
                    this.editingRecord.category = '';
                    this.editingRecord.account = '';
                } else {
                    this.editingRecord.fromAccount = '';
                    this.editingRecord.toAccount = '';
                }
            },

            async deleteRecord(id) {
                if (!confirm('确定要删除这条记录吗？')) return;
                this.records = this.records.filter(r=>r.id!==id);
                await this.saveAllData();
                await this.autoSync();
            },

            // --------------------------------------------------- 工具方法 ---------------------------------------------------
            getCategoryName(id) {
                const cat = this.categories.find(c=>c.id===id);
                if (!cat) return '未知分类';
                if (cat.parentId) {
                    const parent = this.categories.find(p=>p.id===cat.parentId);
                    if (parent) return `${parent.name} > ${cat.name}`;
                }
                return cat.name;
            },

            getCategoryDisplayName(cat) {
                if (cat.parentId) {
                    const parent = this.categories.find(p=>p.id===cat.parentId);
                    if (parent) return `${parent.name} > ${cat.name}`;
                }
                return cat.name;
            },

            getAccountName(id) {
                const acc = this.accounts.find(a=>a.id===id);
                return acc ? acc.name : '未知账户';
            },

            // --------------------------------------------------- 数据导入 / 导出 ---------------------------------------------------
            async exportData() {
                try {
                    await this.saveAllData();                  // 确保最新数据已写入服务器
                    const resp = await this.request('/api/data');
                    const serverData = await resp.json();

                    const payload = {
                        records: serverData.records && serverData.records.length ? serverData.records : this.records,
                        categories: serverData.categories && serverData.categories.length ? serverData.categories : this.categories,
                        accounts: serverData.accounts && serverData.accounts.length ? serverData.accounts : this.accounts,
                        exportDate: new Date().toISOString(),
                        version: '1.0'
                    };
                    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `家庭记账本_${this.getCurrentDate()}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    this.showMessage('数据导出成功', 'success');
                } catch (e) {
                    console.error(e);
                    this.showMessage('数据导出失败，请重试', 'error');
                }
            },

            async importData(event) {
                const file = event.target.files[0];
                if (!file) return;
                const txt = await file.text();
                try {
                    const data = JSON.parse(txt);
                    if (!confirm('导入数据将覆盖现有数据，确定继续吗？')) return;
                    this.records    = data.records    || [];
                    this.categories = data.categories || [];
                    this.accounts   = data.accounts   || [];
                    await this.saveAllData();
                    this.showMessage('数据导入成功并已同步到服务器', 'success');
                } catch (e) {
                    console.error(e);
                    this.showMessage('文件格式错误，导入失败', 'error');
                } finally {
                    event.target.value = '';
                }
            },

            // --------------------------------------------------- 报表/分析 ---------------------------------------------------
            setQuickFilter(filter) {
                this.quickFilter = filter;
                const now = new Date();
                const fmt = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                switch (filter) {
                    case 'today':
                        this.analysisForm.startDate = fmt(now);
                        this.analysisForm.endDate   = fmt(now);
                        break;
                    case 'week':
                        const weekStart = new Date(now);
                        weekStart.setDate(now.getDate() - now.getDay());
                        this.analysisForm.startDate = fmt(weekStart);
                        this.analysisForm.endDate   = fmt(now);
                        break;
                    case 'month':
                        this.analysisForm.startDate = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-01`;
                        this.analysisForm.endDate   = fmt(now);
                        break;
                    case 'quarter':
                        const q = Math.floor(now.getMonth() / 3);
                        const qStart = new Date(now.getFullYear(), q*3, 1);
                        this.analysisForm.startDate = fmt(qStart);
                        const qEnd = new Date(now.getFullYear(), q*3+3, 0);
                        this.analysisForm.endDate   = fmt(qEnd);
                        break;
                    case 'year':
                        this.analysisForm.startDate = `${now.getFullYear()}-01-01`;
                        this.analysisForm.endDate   = `${now.getFullYear()}-12-31`;
                        break;
                }
            },

            toggleAdvancedAnalysis() { this.showAdvancedAnalysis = !this.showAdvancedAnalysis; },

            filterRecords() {
                let list = this.records;
                if (this.analysisForm.startDate) list = list.filter(r=>r.date>=this.analysisForm.startDate);
                if (this.analysisForm.endDate)   list = list.filter(r=>r.date<=this.analysisForm.endDate);
                if (this.analysisForm.type!=='all') list = list.filter(r=>r.type===this.analysisForm.type);
                if (this.analysisForm.category) list = list.filter(r=>r.category===parseInt(this.analysisForm.category));
                if (this.analysisForm.account) {
                    const a = parseInt(this.analysisForm.account);
                    list = list.filter(r=> r.account===a || r.fromAccount===a || r.toAccount===a);
                }
                return list.sort((a,b)=>new Date(a.date)-new Date(b.date));
            },

            generateReport() {
                const filtered = this.filterRecords();
                if (filtered.length===0) { alert('没有找到符合条件的记录'); return; }
                this.reportData = this.createReportData(filtered);
                alert(`报表生成成功！共 ${filtered.length} 条记录`);
            },

            createReportData(records) {
                const data = {
                    totalCount: records.length,
                    totalIncome: 0,
                    totalExpense: 0,
                    incomeCount: 0,
                    expenseCount: 0,
                    summary: [],
                    details: records
                };
                records.forEach(r=>{
                    if (r.type==='income') { data.totalIncome+=r.amount; data.incomeCount++; }
                    else if (r.type==='expense') { data.totalExpense+=r.amount; data.expenseCount++; }
                });
                data.netIncome = data.totalIncome - data.totalExpense;
                data.summary = this.generateSummary(records);
                data.trend = this.advancedAnalysis.showTrend ? this.calculateTrend(records) : null;
                data.comparison = this.advancedAnalysis.showComparison ? this.calculateComparison(records) : null;
                return data;
            },

            generateSummary(records) {
                const map = {};
                records.forEach(r=>{
                    const key = this.getGroupKey(r);
                    if (!map[key]) map[key] = {group:key, income:0, expense:0, count:0};
                    if (r.type==='income') map[key].income += r.amount;
                    else if (r.type==='expense') map[key].expense += r.amount;
                    map[key].count++;
                });
                const arr = Object.values(map).map(o=>({ ...o, net: o.income - o.expense }));
                if (['month','quarter','year'].includes(this.analysisForm.groupBy))
                    arr.sort((a,b)=>a.group.localeCompare(b.group));
                else
                    arr.sort((a,b)=>b.net-a.net);
                return arr;
            },

            getGroupKey(rec) {
                const d = new Date(rec.date);
                switch (this.analysisForm.groupBy) {
                    case 'month':    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
                    case 'quarter':
                        const q = Math.floor(d.getMonth()/3)+1;
                        return `${d.getFullYear()}年第${q}季度`;
                    case 'year':     return `${d.getFullYear()}年`;
                    case 'category':return this.getCategoryName(rec.category);
                    case 'account': return this.getAccountName(rec.account);
                    default: return rec.date;
                }
            },

            getGroupByLabel() {
                const map = {month:'月份', quarter:'季度', year:'年份', category:'分类', account:'账户'};
                return map[this.analysisForm.groupBy] || '分组';
            },

            // ---------- 趋势 ----------
            calculateTrend(records) {
                if (!this.advancedAnalysis.showTrend) return null;
                const periods = this.advancedAnalysis.trendPeriods;
                const arr = [];
                for (let i=periods-1;i>=0;i--) {
                    const {income, expense, count} = this.getPeriodStats(records,i);
                    arr.push({ period:this.getPeriodLabel(i), income, expense, net:income-expense, count });
                }
                return arr;
            },

            getPeriodStats(records, offset) {
                const now = new Date();
                let start,end;
                switch (this.analysisForm.groupBy) {
                    case 'month':
                        start = new Date(now.getFullYear(), now.getMonth()-offset, 1);
                        end   = new Date(now.getFullYear(), now.getMonth()-offset+1, 0);
                        break;
                    case 'quarter':
                        const curQ = Math.floor(now.getMonth()/3);
                        const targetQ = curQ - offset;
                        const year = now.getFullYear() + Math.floor(targetQ/4);
                        const qInYear = ((targetQ%4)+4)%4;
                        start = new Date(year, qInYear*3, 1);
                        end   = new Date(year, qInYear*3+3, 0);
                        break;
                    case 'year':
                        start = new Date(now.getFullYear()-offset,0,1);
                        end   = new Date(now.getFullYear()-offset,11,31);
                        break;
                    default: return {income:0, expense:0, count:0};
                }
                const slice = records.filter(r=> {
                    const d = new Date(r.date);
                    return d>=start && d<=end;
                });
                let inc=0, exp=0;
                slice.forEach(r=> { if (r.type==='income') inc+=r.amount; else if (r.type==='expense') exp+=r.amount; });
                return {income:inc, expense:exp, count:slice.length};
            },

            getPeriodLabel(offset) {
                const now = new Date();
                switch (this.analysisForm.groupBy) {
                    case 'month':
                        const d = new Date(now.getFullYear(), now.getMonth()-offset, 1);
                        return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
                    case 'quarter':
                        const curQ = Math.floor(now.getMonth()/3);
                        const targetQ = curQ - offset;
                        const year = now.getFullYear() + Math.floor(targetQ/4);
                        const qInYear = ((targetQ%4)+4)%4;
                        return `${year}年第${qInYear+1}季度`;
                    case 'year':
                        return `${now.getFullYear()-offset}年`;
                    default:
                        return `期间${offset+1}`;
                }
            },

            // ---------- 对比 ----------
            calculateComparison(records) {
                if (!this.advancedAnalysis.showComparison) return null;
                const cur = this.getCurrentPeriodData(records);
                const comp = this.getComparisonPeriodData(records);
                if (!cur || !comp) return null;
                return {
                    current: cur,
                    comparison: comp,
                    changes: {
                        income: this.calcChange(cur.income, comp.income),
                        expense: this.calcChange(cur.expense, comp.expense),
                        net: this.calcChange(cur.income - cur.expense, comp.income - comp.expense),
                        count: this.calcChange(cur.count, comp.count)
                    }
                };
            },

            getCurrentPeriodData(records) {
                if (!this.analysisForm.startDate || !this.analysisForm.endDate) return null;
                const curRecs = records.filter(r=> r.date>=this.analysisForm.startDate && r.date<=this.analysisForm.endDate );
                let inc=0, exp=0;
                curRecs.forEach(r=> { if (r.type==='income') inc+=r.amount; else if (r.type==='expense') exp+=r.amount; });
                return { income:inc, expense:exp, net:inc-exp, count:curRecs.length };
            },

            getComparisonPeriodData(records) {
                if (!this.analysisForm.startDate || !this.analysisForm.endDate) return null;
                const start = new Date(this.analysisForm.startDate);
                const end   = new Date(this.analysisForm.endDate);
                const diff  = end - start;
                let compStart, compEnd;
                if (this.advancedAnalysis.comparisonPeriod === 'previous') {
                    compEnd   = new Date(start.getTime() - 1);
                    compStart = new Date(start.getTime() - diff);
                } else {
                    compStart = new Date(start.getFullYear()-1, start.getMonth(), start.getDate());
                    compEnd   = new Date(end.getFullYear()-1, end.getMonth(), end.getDate());
                }
                const compRecs = records.filter(r=> {
                    const d = new Date(r.date);
                    return d>=compStart && d<=compEnd;
                });
                let inc=0, exp=0;
                compRecs.forEach(r=> { if (r.type==='income') inc+=r.amount; else if (r.type==='expense') exp+=r.amount; });
                return { income:inc, expense:exp, net:inc-exp, count:compRecs.length };
            },

            calcChange(current, previous) {
                if (previous===0) return current>0 ? 100 : 0;
                return ((current - previous) / previous * 100).toFixed(2);
            },

            // ---------- 导出报表 ----------
            exportReport() {
                if (!this.reportData) { alert('请先生成报表'); return; }
                const choice = prompt('请选择导出格式：\n1. 文本 (.txt)\n2. CSV (.csv)\n3. JSON (.json)\n\n输入 1、2 或 3：', '1');
                if (!choice) return;   // 用户点取消，直接退出
                let content, filename, mime;
                switch (choice.trim()) {
                    case '1':
                        content = this.generateReportContent();
                        filename = `家庭记账报表_${this.getCurrentDate()}.txt`;
                        mime = 'text/plain;charset=utf-8';
                        break;
                    case '2':
                        content = this.generateCSVContent();
                        filename = `家庭记账报表_${this.getCurrentDate()}.csv`;
                        mime = 'text/csv;charset=utf-8';
                        break;
                    case '3':
                        content = this.generateJSONContent();
                        filename = `家庭记账报表_${this.getCurrentDate()}.json`;
                        mime = 'application/json;charset=utf-8';
                        break;
                    default:
                        alert('无效的选择');
                        return;
                }
                const blob = new Blob([content], {type: mime});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
                alert('报表导出成功！');
            },

            generateReportContent() {
                const d = this.reportData;
                let txt = '';
                txt += '='.repeat(50) + '\n';
                txt += '家庭记账本 - 统计分析报表\n';
                txt += '='.repeat(50) + '\n\n';
                txt += `生成时间：${new Date().toLocaleString()}\n`;
                txt += `查询条件：${this.getQueryConditions()}\n\n`;
                txt += '总体统计\n';
                txt += `- 总交易笔数：${d.totalCount} 笔\n`;
                txt += `- 总收入：¥${d.totalIncome.toFixed(2)}\n`;
                txt += `- 总支出：¥${d.totalExpense.toFixed(2)}\n`;
                txt += `- 净收入：¥${d.netIncome.toFixed(2)}\n`;
                txt += `- 收入笔数：${d.incomeCount} 笔\n`;
                txt += `- 支出笔数：${d.expenseCount} 笔\n\n`;
                txt += `${this.getGroupByLabel()} 汇总\n`;
                txt += '-'.repeat(30) + '\n';
                d.summary.forEach(item=> {
                    txt += `${item.group}：\n`;
                    txt += `  收入：¥${item.income.toFixed(2)}\n`;
                    txt += `  支出：¥${item.expense.toFixed(2)}\n`;
                    txt += `  净收入：¥${item.net.toFixed(2)}\n`;
                    txt += `  交易笔数：${item.count} 笔\n\n`;
                });
                if (this.analysisForm.reportType === 'detail') {
                    txt += '明细记录\n';
                    txt += '-'.repeat(30) + '\n';
                    d.details.forEach(r=> {
                        const type = r.type==='income'?'收入': r.type==='expense'?'支出':'转账';
                        const cat   = r.type!=='transfer' ? this.getCategoryName(r.category) : '-';
                        const acc   = r.type!=='transfer' ? this.getAccountName(r.account)
                                             : `${this.getAccountName(r.fromAccount)} → ${this.getAccountName(r.toAccount)}`;
                        txt += `${r.date} | ${type} | ¥${r.amount.toFixed(2)} | ${cat} | ${acc} | ${r.description}\n`;
                    });
                }
                return txt;
            },

            getQueryConditions() {
                const arr = [];
                if (this.analysisForm.startDate) arr.push(`开始日期：${this.analysisForm.startDate}`);
                if (this.analysisForm.endDate)   arr.push(`结束日期：${this.analysisForm.endDate}`);
                if (this.analysisForm.type!=='all') arr.push(`类型：${this.analysisForm.type}`);
                if (this.analysisForm.category) arr.push(`分类：${this.getCategoryName(parseInt(this.analysisForm.category))}`);
                if (this.analysisForm.account)  arr.push(`账户：${this.getAccountName(parseInt(this.analysisForm.account))}`);
                return arr.length ? arr.join('，') : '无筛选条件';
            },

            generateCSVContent() {
                const d = this.reportData;
                let csv = '\ufeff';
                // 总体统计
                csv += '总体统计\n';
                csv += '总交易笔数,总收入,总支出,净收入,收入笔数,支出笔数\n';
                csv += `${d.totalCount},${d.totalIncome.toFixed(2)},${d.totalExpense.toFixed(2)},${d.netIncome.toFixed(2)},${d.incomeCount},${d.expenseCount}\n\n';
                // 汇总
                csv += `${this.getGroupByLabel()} 汇总\n`;
                csv += `${this.getGroupByLabel()},收入,支出,净收入,交易笔数\n`;
                d.summary.forEach(item=> {
                    csv += `${item.group},${item.income.toFixed(2)},${item.expense.toFixed(2)},${item.net.toFixed(2)},${item.count}\n`;
                });
                // 明细（如果选择了明细报表）
                if (this.analysisForm.reportType === 'detail') {
                    csv += '\n明细记录\n';
                    csv += '日期,类型,金额,分类,账户,描述\n';
                    d.details.forEach(r=> {
                        const type = r.type==='income'?'收入': r.type==='expense'?'支出':'转账';
                        const cat   = r.type!=='transfer'? this.getCategoryName(r.category) : '-';
                        const acc   = r.type!=='transfer'? this.getAccountName(r.account)
                                             : `${this.getAccountName(r.fromAccount)} → ${this.getAccountName(r.toAccount)}`;
                        csv += `${r.date},${type},${r.amount.toFixed(2)},${cat},${acc},"${r.description}"\n`;
                    });
                }
                return csv;
            },

            generateJSONContent() {
                const d = this.reportData;
                const json = {
                    reportInfo: {
                        title: '家庭记账本 - 统计分析报表',
                        generateTime: new Date().toISOString(),
                        queryConditions: this.getQueryConditions(),
                        groupBy: this.analysisForm.groupBy,
                        reportType: this.analysisForm.reportType
                    },
                    summary: {
                        totalCount: d.totalCount,
                        totalIncome: d.totalIncome,
                        totalExpense: d.totalExpense,
                        netIncome: d.netIncome,
                        incomeCount: d.incomeCount,
                        expenseCount: d.expenseCount
                    },
                    groupedData: d.summary,
                    details: this.analysisForm.reportType === 'detail' ? d.details : null
                };
                return JSON.stringify(json, null, 2);
            },

            clearReport() {
                this.reportData = null;
                this.chartData = null;
            },

            quickReport(type) {
                const now = new Date();
                this.analysisForm = {
                    startDate: '',
                    endDate: '',
                    type: 'all',
                    category: '',
                    account: '',
                    groupBy: type,
                    reportType: 'summary'
                };
                if (type === 'month') {
                    this.analysisForm.startDate = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-01`;
                    this.analysisForm.endDate   = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(new Date(now.getFullYear(), now.getMonth()+1, 0).getDate()).padStart(2,'0')}`;
                } else if (type === 'quarter') {
                    const q = Math.floor(now.getMonth()/3);
                    this.analysisForm.startDate = `${now.getFullYear()}-${String(q*3+1).padStart(2,'0')}-01`;
                    const qEnd = new Date(now.getFullYear(), q*3+3, 0);
                    this.analysisForm.endDate   = `${now.getFullYear()}-${String(q*3+3).padStart(2,'0')}-${String(qEnd.getDate()).padStart(2,'0')}`;
                } else if (type === 'year') {
                    this.analysisForm.startDate = `${now.getFullYear()}-01-01`;
                    this.analysisForm.endDate   = `${now.getFullYear()}-12-31`;
                }
                this.generateReport();
            },

            // --------------------------------------------------- UI 小功能 ---------------------------------------------------
            toggleRecentRecordsHint() { this.showRecentRecordsHint = !this.showRecentRecordsHint; },

            // --------------------------------------------------- 初始化默认数据 ---------------------------------------------------
            async initDefaultCategories() {
                this.categories = [
                    // 收入
                    {id:1, name:'工资收入', type:'income'},
                    {id:101, name:'基本工资', type:'income', parentId:1},
                    {id:102, name:'奖金', type:'income', parentId:1},
                    {id:2, name:'投资收益', type:'income'},
                    {id:201, name:'股票收益', type:'income', parentId:2},
                    {id:202, name:'基金收益', type:'income', parentId:2},
                    {id:3, name:'兼职收入', type:'income'},
                    {id:4, name:'其他收入', type:'income'},
                    // 支出
                    {id:5, name:'餐饮美食', type:'expense'},
                    {id:501, name:'早餐', type:'expense', parentId:5},
                    {id:502, name:'午餐', type:'expense', parentId:5},
                    {id:503, name:'晚餐', type:'expense', parentId:5},
                    {id:504, name:'零食', type:'expense', parentId:5},
                    {id:6, name:'交通出行', type:'expense'},
                    {id:601, name:'公交地铁', type:'expense', parentId:6},
                    {id:602, name:'打车', type:'expense', parentId:6},
                    {id:603, name:'加油', type:'expense', parentId:6},
                    {id:7, name:'购物消费', type:'expense'},
                    {id:701, name:'服装鞋帽', type:'expense', parentId:7},
                    {id:702, name:'数码产品', type:'expense', parentId:7},
                    {id:8, name:'生活缴费', type:'expense'},
                    {id:801, name:'水费', type:'expense', parentId:8},
                    {id:802, name:'电费', type:'expense', parentId:8},
                    {id:803, name:'燃气费', type:'expense', parentId:8},
                    {id:9, name:'医疗健康', type:'expense'},
                    {id:10, name:'学习教育', type:'expense'},
                    {id:11, name:'娱乐休闲', type:'expense'},
                    {id:12, name:'其他支出', type:'expense'}
                ];
            },

            async initDefaultAccounts() {
                this.accounts = [
                    {id:1, name:'现金', type:'asset', initialBalance:0},
                    {id:2, name:'银行卡', type:'asset', initialBalance:0},
                    {id:3, name:'支付宝', type:'asset', initialBalance:0},
                    {id:4, name:'微信钱包', type:'asset', initialBalance:0}
                ];
            },

            // --------------------------------------------------- 生命周期 ---------------------------------------------------
            async mounted() {
                // 初始化表单默认日期
                this.incomeForm.date   = this.getCurrentDate();
                this.expenseForm.date  = this.getCurrentDate();
                this.transferForm.date = this.getCurrentDate();

                const multi = localStorage.getItem('isMultiUserMode');
                const token = localStorage.getItem('userToken');
                const cur   = localStorage.getItem('currentUser');

                if (multi === 'true' && token && cur) {
                    // 多用户模式直接恢复登录
                    this.isMultiUserMode = true;
                    this.userToken = token;
                    this.currentUser = JSON.parse(cur);
                    this.isAuthenticated = true;
                    this.startSession();
                    await this.refreshAllData();
                } else {
                    const sess = sessionStorage.getItem('isAuthenticated');
                    if (sess === 'true') {
                        this.isAuthenticated = true;
                        this.startSession();
                        await this.refreshAllData();
                    } else {
                        // 第一次进入或未通过 authCode 验证
                        this.isAuthenticated = false;
                        this.authFlow = 'initial';
                        const verified = localStorage.getItem('hasVerifiedAuthCode');
                        if (verified === 'true') this.hasVerifiedAuthCode = true;
                    }
                }
            },

            beforeUnmount() {
                this.clearSession();
            }
        }
    }).mount('#app');
</script>
</body>
</html>
