<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Node.js 音乐播放器部署教程：GitHub + Replit + Cloudflare R2</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 960px;
            margin: 20px auto;
            background-color: #ffffff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        h1, h2, h3 {
            color: #0056b3;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
            margin-top: 30px;
        }
        h1 {
            text-align: center;
            font-size: 2.5em;
            color: #004085;
            border-bottom: 3px solid #004085;
            padding-bottom: 15px;
            margin-bottom: 40px;
        }
        h2 {
            font-size: 1.8em;
            color: #0056b3;
        }
        h3 {
            font-size: 1.4em;
            color: #0069d9;
        }
        p {
            margin-bottom: 15px;
        }
        ul {
            list-style-type: disc;
            margin-left: 20px;
            margin-bottom: 15px;
        }
        ol {
            list-style-type: decimal;
            margin-left: 20px;
            margin-bottom: 15px;
        }
        li {
            margin-bottom: 8px;
        }
        a {
            color: #007bff;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        code {
            background-color: #e9ecef;
            padding: 2px 4px;
            border-radius: 4px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
            color: #c7254e;
        }
        pre {
            background-color: #282c34;
            color: #abb2bf;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            margin-bottom: 20px;
            font-family: 'Fira Code', 'Courier New', Courier, monospace;
            font-size: 0.9em;
            line-height: 1.5;
        }
        pre code {
            background-color: transparent;
            color: inherit;
            padding: 0;
            border-radius: 0;
            font-size: 1em;
        }
        .note {
            background-color: #e7f3ff;
            border-left: 5px solid #007bff;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .warning {
            background-color: #fff3cd;
            border-left: 5px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            color: #856404;
        }
        .code-filename {
            font-weight: bold;
            color: #007bff;
            margin-top: 15px;
            margin-bottom: 5px;
            display: block;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .container {
                margin: 10px auto;
                padding: 20px;
            }
            h1 {
                font-size: 2em;
            }
            h2 {
                font-size: 1.5em;
            }
            h3 {
                font-size: 1.2em;
            }
        }
        @media (max-width: 480px) {
            body {
                padding: 5px;
            }
            .container {
                padding: 15px;
            }
            h1 {
                font-size: 1.8em;
            }
            h2 {
                font-size: 1.3em;
            }
            h3 {
                font-size: 1.1em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Node.js 音乐播放器部署教程</h1>
        <p>本教程将指导您如何将一个基于 Node.js Express 的音乐播放器应用部署到 Replit，并使用 Cloudflare R2 存储音乐文件。整个流程包括将代码推送到 GitHub，配置 Cloudflare R2，以及在 Replit 上托管您的应用。</p>

        <div class="note">
            <strong>核心思想：</strong>
            <ul>
                <li><strong>GitHub:</strong> 作为代码版本控制和 Replit 的代码源。</li>
                <li><strong>Cloudflare R2:</strong> 提供免费且高性能的对象存储，用于存放音乐文件。</li>
                <li><strong>Replit:</strong> 提供免费的 Node.js 应用托管环境，运行您的后端逻辑。</li>
            </ul>
        </div>

        <h2>第一步：准备工作</h2>
        <p>在开始之前，请确保您拥有以下资源和工具：</p>
        <ul>
            <li><strong>Node.js 环境:</strong> 您的本地开发环境需要安装 Node.js 和 npm。</li>
            <li><strong>Git:</strong> 用于版本控制和与 GitHub 交互。</li>
            <li><strong>GitHub 账号:</strong> 如果没有，请前往 <a href="https://github.com/" target="_blank">github.com</a> 注册。</li>
            <li><strong>Cloudflare 账号:</strong> 如果没有，请前往 <a href="https://www.cloudflare.com/" target="_blank">cloudflare.com</a> 注册。</li>
            <li><strong>Replit 账号:</strong> 如果没有，请前往 <a href="https://replit.com/" target="_blank">replit.com</a> 注册。</li>
            <li><strong>您的 Node.js 音乐播放器代码:</strong> 假设您已经有一个基础的 Node.js Express 应用。我们将提供一个示例代码，您可以在此基础上修改。</li>
        </ul>

        <h2>第二步：将代码推送到 GitHub</h2>
        <p>首先，我们需要将您的音乐播放器代码整理好，并推送到一个 GitHub 仓库。这将作为 Replit 导入代码的来源。</p>

        <h3>2.1 创建项目文件夹并初始化 Git</h3>
        <p>在您的本地计算机上，创建一个新的文件夹，例如 <code>my-music-player</code>，然后进入该文件夹并初始化 Git 仓库：</p>
        <pre><code>mkdir my-music-player
cd my-music-player
git init</code></pre>

        <h3>2.2 创建 Node.js 项目文件</h3>
        <p>在 <code>my-music-player</code> 文件夹中，创建以下文件：</p>

        <span class="code-filename">package.json</span>
        <pre><code>{
  "name": "r2-music-player",
  "version": "1.0.0",
  "description": "A simple music player backend using Node.js and Cloudflare R2.",
  "main": "app.js",
  "scripts": {
    "start": "node app.js"
  },
  "dependencies": {
    "@aws-sdk/client-s3": "^3.x.x",
    "express": "^4.18.2"
  },
  "author": "",
  "license": "ISC"
}</code></pre>

        <span class="code-filename">app.js (后端逻辑，稍后会详细修改)</span>
        <pre><code>const express = require('express');
const path = require('path');
// 暂时不导入 R2 SDK，稍后在 Replit 步骤中修改
const app = express();

// 允许跨域请求 (CORS) - 如果您的前端在不同域名，这是必需的
app.use((req, res, next) => {
  res.header('Access-Control-Allow-Origin', '*'); // 允许所有域名访问，生产环境请限制为您的前端域名
  res.header('Access-Control-Allow-Headers', 'Origin, X-Requested-With, Content-Type, Accept');
  next();
});

// 音乐文件大小格式化函数
function formatFileSize(bytes) {
  const units = ['B', 'KB', 'MB', 'GB'];
  let size = bytes;
  let unitIndex = 0;

  while (size >= 1024 && unitIndex < units.length - 1) {
    size /= 1024;
    unitIndex++;
  }

  return `${size.toFixed(2)}${units[unitIndex]}`;
}

// 模拟的音乐列表 API (将被 R2 真实数据替换)
app.get('/api/music/list', (req, res) => {
    res.json({
        total: 1,
        data: [{
            filename: "placeholder.mp3",
            url: "https://example.com/placeholder.mp3", // 占位符 URL
            size: formatFileSize(1024 * 1024 * 5), // 5MB
            extension: "MP3",
            lastModified: new Date().toLocaleString()
        }]
    });
});

// 如果您的前端需要静态文件 (例如 index.html, CSS, JS)，可以这样提供
// 创建一个 'public' 文件夹，并将您的前端文件放入其中
app.use(express.static('public'));

// 根路由，可以指向您的前端页面
app.get('/', (req, res) => {
  res.sendFile(path.join(__dirname, 'public', 'index.html'));
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`Music player listening on port ${PORT}`);
});
</code></pre>

        <p>为了有一个简单的前端界面来测试，创建一个 <code>public</code> 文件夹，并在其中创建 <code>index.html</code>：</p>
        <pre><code>mkdir public</code></pre>

        <span class="code-filename">public/index.html (前端界面)</span>
        <pre><code>&lt;!DOCTYPE html&gt;
&lt;html lang="zh-CN"&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
    &lt;title&gt;R2 音乐播放器&lt;/title&gt;
    &lt;style&gt;
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        h1 { color: #0056b3; }
        ul { list-style: none; padding: 0; }
        li { background-color: #fff; margin-bottom: 10px; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        li strong { color: #007bff; margin-bottom: 5px; }
        li span { font-size: 0.9em; color: #666; }
        audio { width: 100%; margin-top: 10px; }
        .loading { text-align: center; font-style: italic; color: #888; }
        @media (max-width: 600px) {
            body { margin: 10px; }
            li { padding: 10px; }
        }
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;我的 R2 音乐播放器&lt;/h1&gt;
    &lt;div id="music-list"&gt;
        &lt;p class="loading"&gt;正在加载音乐列表...&lt;/p&gt;
    &lt;/div&gt;

    &lt;script&gt;
        async function fetchMusic() {
            const musicListDiv = document.getElementById('music-list');
            try {
                // 请求后端 API 获取音乐列表
                const response = await fetch('/api/music/list');
                const data = await response.json();

                if (data.total === 0) {
                    musicListDiv.innerHTML = '&lt;p&gt;没有找到音乐文件。&lt;/p&gt;';
                    return;
                }

                const ul = document.createElement('ul');
                data.data.forEach(music => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        &lt;strong&gt;${music.filename}&lt;/strong&gt;
                        &lt;span&gt;大小: ${music.size} | 格式: ${music.extension}&lt;/span&gt;
                        &lt;audio controls&gt;
                            &lt;source src="${music.url}" type="audio/${music.extension.toLowerCase()}"&gt;
                            您的浏览器不支持音频播放。
                        &lt;/audio&gt;
                    `;
                    ul.appendChild(li);
                });
                musicListDiv.innerHTML = '';
                musicListDiv.appendChild(ul);

            } catch (error) {
                console.error('Error fetching music list:', error);
                musicListDiv.innerHTML = '&lt;p style="color: red;"&gt;加载音乐列表失败，请检查后端服务。&lt;/p&gt;';
            }
        }

        fetchMusic();
    &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>

        <h3>2.3 添加到 Git 并提交</h3>
        <pre><code>git add .
git commit -m "Initial commit: basic music player setup"</code></pre>

        <h3>2.4 在 GitHub 上创建仓库</h3>
        <ol>
            <li>登录您的 GitHub 账号。</li>
            <li>点击右上角的 <code>+</code> 号，选择 <strong>"New repository"</strong> (新建仓库)。</li>
            <li>输入一个仓库名称，例如 <code>r2-music-player</code>。</li>
            <li>选择 <strong>"Public"</strong> (公开) 或 <strong>"Private"</strong> (私有)。</li>
            <li><strong>不要</strong>勾选 "Add a README file"、"Add .gitignore" 或 "Choose a license"，因为我们已经有了本地文件。</li>
            <li>点击 <strong>"Create repository"</strong>。</li>
        </ol>

        <h3>2.5 将本地代码推送到 GitHub</h3>
        <p>在 GitHub 仓库创建成功后，您会看到一个页面，其中包含将现有本地仓库推送到 GitHub 的说明。复制其中的命令，通常是这样的：</p>
        <pre><code>git remote add origin https://github.com/您的用户名/r2-music-player.git
git branch -M main
git push -u origin main</code></pre>
        <p>将 <code>您的用户名</code> 替换为您的 GitHub 用户名。</p>

        <h2>第三步：Cloudflare R2 配置</h2>
        <p>现在，我们需要在 Cloudflare 中设置 R2 存储桶来存放您的音乐文件。</p>

        <h3>3.1 创建 R2 存储桶</h3>
        <ol>
            <li>登录 <a href="https://dash.cloudflare.com/" target="_blank">Cloudflare Dashboard</a>。</li>
            <li>在左侧导航栏，点击 <strong>"R2"</strong>。</li>
            <li>点击 <strong>"Create bucket"</strong> (创建存储桶)。</li>
            <li>输入一个唯一的 <strong>Bucket name</strong> (存储桶名称)，例如 <code>my-music-player-bucket</code>。</li>
            <li>选择一个 <strong>Location</strong> (位置)，通常选择 <code>Automatic</code> 即可。</li>
            <li>点击 <strong>"Create bucket"</strong>。</li>
        </ol>

        <h3>3.2 配置 R2 API Token (用于 Replit 访问)</h3>
        <p>这是让您的 Replit 应用能够访问 R2 的关键一步。请仔细按照以下步骤操作：</p>
        <ol>
            <li>在 Cloudflare Dashboard 左侧导航栏，点击 <strong>"R2"</strong>。</li>
            <li>在 R2 页面，点击 <strong>"Manage R2 API Tokens"</strong> (管理 R2 API Token)。</li>
            <li>点击 <strong>"Create API Token"</strong> (创建 API Token)。</li>
            <li>在弹出的配置页面，设置以下参数：
                <ul>
                    <li><strong>Token Name (Token 名称):</strong> 输入一个描述性的名称，例如 <code>replit-music-player-access</code>。</li>
                    <li><strong>Permissions (权限):</strong>
                        <ul>
                            <li>在 "R2" 服务下，选择 <strong>"Edit"</strong> (编辑) 权限。这允许您的应用列出、读取、上传和删除文件。对于音乐播放器，理论上只需要 "Read"，但 "Edit" 更通用。</li>
                            <li>在 "Bucket Permissions" (存储桶权限) 部分，选择 <strong>"Specific buckets"</strong> (特定存储桶)。</li>
                            <li>在下拉菜单中，选择您刚刚创建的存储桶 (例如 <code>my-music-player-bucket</code>)。这确保了 Token 只能访问这一个存储桶。</li>
                        </ul>
                    </li>
                    <li><strong>TTL (Time To Live) / Expiration (过期时间):</strong> 对于本教程，您可以选择 <strong>"Never"</strong> (永不)。在生产环境中，建议设置过期时间并定期轮换。</li>
                    <li><strong>Client IP Address Filtering (客户端 IP 地址过滤):</strong> <strong>请勿填写任何 IP 地址。</strong> Replit 应用的 IP 是动态的，填写会阻止其访问。</li>
                </ul>
            </li>
            <li>点击 <strong>"Create API Token"</strong>。</li>
            <li><div class="warning"><strong>极其重要！</strong> Cloudflare 会显示您的 <strong>Access Key ID</strong> 和 <strong>Secret Access Key</strong>。<strong>请立即复制并安全保存这两个值！</strong> 它们只会显示一次，丢失后需要重新生成。</div></li>
            <li>同时，在 Cloudflare Dashboard 的 R2 页面或 "Manage R2 API Tokens" 页面，找到您的 <strong>"Account ID"</strong> (账户 ID)。这个 ID 也是连接 R2 所必需的。请复制并保存这个 ID。</li>
        </ol>

        <h3>3.3 上传音乐文件到 R2</h3>
        <p>您可以通过 Cloudflare Dashboard 上传音乐文件：</p>
        <ol>
            <li>在 Cloudflare Dashboard 左侧导航栏，点击 <strong>"R2"</strong>。</li>
            <li>点击您创建的存储桶 (例如 <code>my-music-player-bucket</code>)。</li>
            <li>点击 <strong>"Upload"</strong> 按钮，然后选择您的音乐文件进行上传。</li>
            <li><strong>建议:</strong> 为了方便管理，您可以在 R2 中创建一个虚拟文件夹，例如 <code>music/</code>，然后将所有音乐文件上传到这个文件夹下。在上传时，您可以直接在文件名中包含路径，例如 <code>music/song1.mp3</code>。</li>
        </ol>

        <h3>3.4 配置 R2 公共访问</h3>
        <p>为了让浏览器能够直接播放 R2 上的音乐文件，您需要配置 R2 存储桶的公共访问。</p>
        <ol>
            <li>在 Cloudflare Dashboard 左侧导航栏，点击 <strong>"R2"</strong>。</li>
            <li>点击您创建的存储桶 (例如 <code>my-music-player-bucket</code>)。</li>
            <li>点击 <strong>"Settings"</strong> (设置) 选项卡。</li>
            <li>向下滚动到 <strong>"Public Access"</strong> (公共访问) 部分。</li>
            <li>点击 <strong>"Connect Domain"</strong> (连接域)。</li>
            <li>勾选 <strong>"Enable R2.dev subdomain"</strong> (启用 R2.dev 子域)。</li>
            <li>启用后，您会看到一个类似于 <code>https://pub-xxxxxxxxxxxxxxxxxxxxxxxx.r2.dev</code> 的公共 URL。<strong>请复制并保存这个 URL。</strong> 您的音乐文件将通过这个 URL 访问，例如 <code>https://pub-xxxxxxxxxxxxxxxxxxxxxxxx.r2.dev/music/song1.mp3</code>。</li>
        </ol>

        <h2>第四步：Replit 托管应用</h2>
        <p>现在我们将在 Replit 上导入您的 GitHub 仓库，并配置它以连接到 Cloudflare R2。</p>

        <h3>4.1 从 GitHub 导入仓库到 Replit</h3>
        <ol>
            <li>登录 <a href="https://replit.com/" target="_blank">replit.com</a>。</li>
            <li>点击左侧导航栏的 <strong>"+ Create Repl"</strong>。</li>
            <li>选择 <strong>"Import from GitHub"</strong> 选项卡。</li>
            <li>如果您尚未连接 GitHub 账号，请按照提示连接。</li>
            <li>在 "GitHub URL" 字段中，粘贴您 GitHub 仓库的 URL (例如 <code>https://github.com/您的用户名/r2-music-player.git</code>)。</li>
            <li>Replit 会自动检测为 Node.js 项目。</li>
            <li>点击 <strong>"Import from GitHub"</strong>。</li>
        </ol>

        <h3>4.2 配置 Replit 环境变量 (Secrets)</h3>
        <p>为了安全地存储 R2 凭证，我们将使用 Replit 的 Secrets 功能。</p>
        <ol>
            <li>在 Replit 界面左侧导航栏，点击 <strong>"Secrets"</strong> (锁图标)。</li>
            <li>点击 <strong>"New Secret"</strong>。</li>
            <li>逐一添加以下环境变量，并填入您在 <strong>步骤 3.2</strong> 和 <strong>步骤 3.4</strong> 中保存的值：
                <ul>
                    <li><strong>Key:</strong> <code>R2_ACCESS_KEY_ID</code>, <strong>Value:</strong> [您的 R2 Access Key ID]</li>
                    <li><strong>Key:</strong> <code>R2_SECRET_ACCESS_KEY</code>, <strong>Value:</strong> [您的 R2 Secret Access Key]</li>
                    <li><strong>Key:</strong> <code>R2_BUCKET_NAME</code>, <strong>Value:</strong> [您的 R2 存储桶名称，例如 <code>my-music-player-bucket</code>]</li>
                    <li><strong>Key:</strong> <code>R2_ACCOUNT_ID</code>, <strong>Value:</strong> [您的 Cloudflare Account ID]</li>
                    <li><strong>Key:</strong> <code>R2_PUBLIC_URL</code>, <strong>Value:</strong> [您的 R2 公共访问 URL，例如 <code>https://pub-xxxxxxxxxxxxxxxxxxxxxxxx.r2.dev</code>]</li>
                </ul>
            </li>
        </ol>

        <h3>4.3 修改 <code>app.js</code> 以与 R2 交互</h3>
        <p>现在，我们将修改 Replit 中的 <code>app.js</code> 文件，使其能够真正地从 Cloudflare R2 获取音乐列表。</p>
        <p>在 Replit 的文件编辑器中打开 <code>app.js</code>，将其内容替换为以下代码：</p>

        <span class="code-filename">app.js (已修改为 R2 交互)</span>
        <pre><code>const express = require('express');
const path = require('path');
const { S3Client, ListObjectsV2Command } = require('@aws-sdk/client-s3'); // 导入 S3 客户端和命令
const app = express();

// 从环境变量获取 R2 配置
const R2_ACCESS_KEY_ID = process.env.R2_ACCESS_KEY_ID;
const R2_SECRET_ACCESS_KEY = process.env.R2_SECRET_ACCESS_KEY;
const R2_BUCKET_NAME = process.env.R2_BUCKET_NAME;
const R2_ACCOUNT_ID = process.env.R2_ACCOUNT_ID;
const R2_PUBLIC_URL = process.env.R2_PUBLIC_URL; // R2 公共访问 URL

// 验证环境变量
if (!R2_ACCESS_KEY_ID || !R2_SECRET_ACCESS_KEY || !R2_BUCKET_NAME || !R2_ACCOUNT_ID || !R2_PUBLIC_URL) {
  console.error("Error: Missing R2 environment variables. Please check Replit Secrets.");
  process.exit(1); // 退出应用
}

// 初始化 S3 客户端，指向 Cloudflare R2 endpoint
const R2 = new S3Client({
  region: "auto", // R2 不需要特定 region，使用 "auto"
  endpoint: `https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com`, // R2 的 S3 兼容 endpoint
  credentials: {
    accessKeyId: R2_ACCESS_KEY_ID,
    secretAccessKey: R2_SECRET_ACCESS_KEY,
  },
});

// 音乐文件大小格式化函数
function formatFileSize(bytes) {
  const units = ['B', 'KB', 'MB', 'GB'];
  let size = bytes;
  let unitIndex = 0;

  while (size >= 1024 && unitIndex < units.length - 1) {
    size /= 1024;
    unitIndex++;
  }

  return `${size.toFixed(2)}${units[unitIndex]}`;
}

// 允许跨域请求 (CORS) - 如果您的前端在不同域名，这是必需的
app.use((req, res, next) => {
  res.header('Access-Control-Allow-Origin', '*'); // 允许所有域名访问，生产环境请限制为您的前端域名
  res.header('Access-Control-Allow-Headers', 'Origin, X-Requested-With, Content-Type, Accept');
  next();
});

// 获取音乐列表 API (现在从 R2 获取)
app.get('/api/music/list', async (req, res) => {
  try {
    // 列出 R2 存储桶中的对象
    const command = new ListObjectsV2Command({
      Bucket: R2_BUCKET_NAME,
      Prefix: 'music/', // 如果您将音乐文件放在 'music/' 虚拟文件夹下，请保持此设置
                          // 如果您的文件直接在根目录，请将此行删除或设置为 ''
    });
    const { Contents } = await R2.send(command);

    if (!Contents) {
      return res.json({ total: 0, data: [] });
    }

    const musicFiles = Contents.filter(obj => {
      // 过滤掉文件夹本身 (如果 Prefix 是 'music/'，会有一个 'music/' 的对象)
      if (obj.Key === 'music/') return false;
      // 筛选支持的音频格式
      const ext = path.extname(obj.Key).toLowerCase();
      return ['.mp3', '.wav', '.flac', '.m4a'].includes(ext);
    });

    const musicList = await Promise.all(musicFiles.map(async obj => {
      // obj.Key 是文件的完整路径，例如 'music/song1.mp3'
      const filename = path.basename(obj.Key); // 提取文件名 'song1.mp3'

      // R2 的 ListObjectsV2Command 已经返回了 Size 和 LastModified
      const size = obj.Size;
      const lastModified = obj.LastModified;

      // 构建音乐文件的公共 URL
      // 注意：R2_PUBLIC_URL 应该以 / 结尾，或者确保拼接时正确
      const fileUrl = `${R2_PUBLIC_URL}/${obj.Key}`;

      return {
        filename: filename,
        url: fileUrl,
        size: formatFileSize(size),
        extension: path.extname(obj.Key).slice(1).toUpperCase(),
        lastModified: lastModified.toLocaleString(),
      };
    }));

    res.json({
      total: musicList.length,
      data: musicList,
    });
  } catch (error) {
    console.error("Error getting music list from R2:", error);
    res.status(500).json({
      error: 'Get music list failed',
      details: error.message,
    });
  }
});

// 提供静态前端文件 (public/index.html)
app.use(express.static('public'));

// 根路由，指向前端页面
app.get('/', (req, res) => {
  res.sendFile(path.join(__dirname, 'public', 'index.html'));
});

// 监听端口
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`Music player listening on port ${PORT}`);
  console.log(`R2 Bucket: ${R2_BUCKET_NAME}`);
  console.log(`R2 Public URL: ${R2_PUBLIC_URL}`);
});
</code></pre>

        <h3>4.4 运行和测试您的 Replit 应用</h3>
        <ol>
            <li>在 Replit 界面顶部，点击绿色的 <strong>"Run"</strong> 按钮。</li>
            <li>Replit 会自动安装 <code>package.json</code> 中列出的依赖 (<code>express</code> 和 <code>@aws-sdk/client-s3</code>)。</li>
            <li>应用启动后，Replit 右侧的 Webview 窗口会显示您的前端界面 (<code>public/index.html</code>)。</li>
            <li>您应该能看到音乐列表从 R2 加载并显示出来，并且可以直接播放。</li>
            <li>您也可以通过 Replit 提供的公共 URL (例如 <code>https://r2-music-player.您的用户名.repl.co/api/music/list</code>) 访问您的 API，查看返回的 JSON 数据。</li>
        </ol>

        <h2>第五步：总结与注意事项</h2>
        <p>恭喜您！您已经成功地将 Node.js 音乐播放器应用部署到了 Replit，并利用 Cloudflare R2 存储和提供了音乐文件。</p>

        <h3>优势回顾：</h3>
        <ul>
            <li><strong>经济高效:</strong> Replit 和 Cloudflare R2 都提供慷慨的免费层级，非常适合个人项目和学习。</li>
            <li><strong>全球分发:</strong> Cloudflare R2 利用 Cloudflare 的全球网络，为您的音乐文件提供快速的访问速度。</li>
            <li><strong>易于部署:</strong> Replit 提供了便捷的部署流程，与 GitHub 集成良好。</li>
            <li><strong>可扩展性:</strong> 这种架构将计算（Replit）和存储（R2）分离，使得各自可以独立扩展。</li>
        </ul>

        <h3>注意事项：</h3>
        <ul>
            <li><strong>Replit 免费层级限制:</strong> Replit 免费层级的 Repl 会在一段时间不活跃后进入休眠状态。当有新请求时，它会重新唤醒，这可能导致第一次请求响应较慢。如果您需要持续运行，可以考虑升级 Replit 计划或使用 Replit Deployments。</li>
            <li><strong>R2 API Token 安全:</strong> 务必妥善保管您的 R2 Access Key ID 和 Secret Access Key。不要将其硬编码到代码中，始终使用环境变量。</li>
            <li><strong>CORS 配置:</strong> 在生产环境中，<code>Access-Control-Allow-Origin: '*'</code> 是不安全的。您应该将其限制为您的前端应用的域名。</li>
            <li><strong>错误处理和日志:</strong> 生产应用需要更健壮的错误处理和日志记录机制。</li>
            <li><strong>前端优化:</strong> 本教程的前端只是一个示例，您可以根据需要使用 React, Vue, Angular 等框架构建更丰富的前端界面。</li>
        </ul>

        <p>希望这个详细的教程对您有所帮助！</p>
    </div>
</body>
</html>
