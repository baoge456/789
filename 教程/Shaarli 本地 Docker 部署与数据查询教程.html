<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shaarli 本地 Docker 部署与数据查询教程</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: auto;
            background: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        h1, h2, h3 {
            color: #2c3e50;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-top: 30px;
        }
        h1 {
            text-align: center;
            font-size: 2.5em;
            color: #007bff;
            border-bottom: 3px solid #007bff;
        }
        h2 {
            font-size: 1.8em;
        }
        h3 {
            font-size: 1.4em;
            color: #34495e;
        }
        code {
            background-color: #eef;
            padding: 2px 4px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            color: #c7254e;
        }
        pre {
            background-color: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
            margin-bottom: 20px;
        }
        pre code {
            background-color: transparent;
            color: inherit;
            padding: 0;
            border-radius: 0;
        }
        ul {
            list-style-type: disc;
            margin-left: 20px;
        }
        ol {
            list-style-type: decimal;
            margin-left: 20px;
        }
        a {
            color: #007bff;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        .note {
            background-color: #e6f7ff;
            border-left: 5px solid #2196f3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
            color: #333;
        }
        .warning {
            background-color: #fff3e0;
            border-left: 5px solid #ff9800;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Shaarli 本地 Docker 部署与数据查询教程</h1>

        <p>本教程将指导您如何在本地使用 Docker Compose 部署 Shaarli 书签管理工具，并详细说明其数据存储位置以及如何查询这些数据。</p>

        <div class="note">
            <strong>重要提示：</strong> 根据您之前的配置，Shaarli 的核心数据（书签、用户、标签等）存储在 <strong>TiDB Cloud</strong>，而辅助文件（缓存、本地配置、证书）存储在您的本地 Docker Volumes 中。本教程将重点介绍如何查询这两个位置的数据。
        </div>

        <h2>1. 前提条件</h2>
        <ul>
            <li>已安装 <a href="https://www.docker.com/products/docker-desktop/" target="_blank">Docker Desktop</a> (推荐使用 WSL 2 后端)。</li>
            <li>已安装 <a href="https://git-scm.com/downloads" target="_blank">Git</a>。</li>
            <li>拥有一个 <a href="https://cloud.tidb.com/" target="_blank">TiDB Cloud</a> 账户和已创建的集群，并获取了连接信息（主机、端口、用户名、密码、数据库名）。</li>
            <li>您的 <code>docker-compose.yml</code> 文件和 <code>.env</code> 文件已准备就绪。</li>
        </ul>

        <h2>2. 准备本地环境</h2>

        <h3>2.1. 克隆或创建项目目录</h3>
        <p>如果您有一个包含 <code>docker-compose.yml</code> 和 <code>.env</code> 文件的项目仓库，请克隆它。否则，请手动创建这些文件。</p>
        <pre><code>git clone your-repo-url
cd your-project-directory # 进入您的项目目录</code></pre>

        <h3>2.2. 创建 <code>.env</code> 文件</h3>
        <p>在项目根目录下创建一个名为 <code>.env</code> 的文件，并填入您的 TiDB Cloud 连接信息。请确保这些信息与您的 TiDB Cloud 控制台显示的一致。</p>
        <pre><code># .env 文件内容
TIDB_HOST=gateway01.ap-northeast-1.prod.aws.tidbcloud.com
TIDB_PORT=4000
TIDB_USER=36pxtF5dSC3b8as.root
TIDB_PASSWORD=6MOwYPnRQWscyHlV
TIDB_DATABASE=test
TIDB_SSL_CA_PATH=/etc/ssl/certs/tidb_ca.pem # 容器内部的路径，实际文件在本地 shaarli-certs volume 中
</code></pre>
        <div class="warning">
            <strong>安全警告：</strong> <code>.env</code> 文件包含敏感信息（如数据库密码），请勿将其提交到公共代码仓库！
        </div>

        <h3>2.3. 下载 TiDB CA 证书</h3>
        <p>为了安全连接 TiDB Cloud，您需要下载其 CA 证书。</p>
        <ol>
            <li>登录 <a href="https://cloud.tidb.com/" target="_blank">TiDB Cloud 控制台</a>。</li>
            <li>导航到您的集群详情页。</li>
            <li>在 "Connect" 选项卡中，找到 "SSL Certificate" 部分。</li>
            <li>下载 <code>tidb_ca.pem</code> 文件。</li>
            <li>将下载的 <code>tidb_ca.pem</code> 文件放置在您的项目根目录下。</li>
        </ol>

        <h3>2.4. <code>docker-compose.yml</code> 文件</h3>
        <p>确保您的 <code>docker-compose.yml</code> 文件内容如下（或类似）：</p>
        <pre><code># docker-compose.yml
version: '3.8'

volumes:
  shaarli-cache:
  shaarli-data:
  shaarli-certs:

services:
  shaarli:
    image: shaarli/shaarli:latest
    container_name: shaarli-app
    ports:
      - "8000:80" # 将容器的 80 端口映射到本地的 8000 端口
    environment:
      SHAARLI_DATABASE_TYPE: mysql
      SHAARLI_DATABASE_HOST: ${TIDB_HOST}
      SHAARLI_DATABASE_PORT: ${TIDB_PORT}
      SHAARLI_DATABASE_USERNAME: ${TIDB_USER}
      SHAARLI_DATABASE_PASSWORD: ${TIDB_PASSWORD}
      SHAARLI_DATABASE_NAME: ${TIDB_DATABASE}
      SHAARLI_DATABASE_SSL_CA: ${TIDB_SSL_CA_PATH}
      SHAARLI_DATABASE_SSL_VERIFY_SERVER_CERT: true
      SHAARLI_UPDATE_CHECK: "false" # 禁用自动更新检查，可选
      TZ: Asia/Shanghai # 设置时区
    volumes:
      - shaarli-cache:/var/www/shaarli/cache
      - shaarli-data:/var/www/shaarli/data
      - shaarli-certs:/etc/ssl/certs # 挂载证书 volume
      - ./tidb_ca.pem:/shaarli-certs/tidb_ca.pem:ro # 将本地证书文件挂载到容器内部的特定位置
    # command: ["php", "-S", "0.0.0.0:80", "-t", "public"] # 如果需要自定义启动命令
    restart: unless-stopped
    depends_on:
      - shaarli-certs-init # 依赖证书初始化服务
  
  shaarli-certs-init:
    image: alpine/git # 使用一个轻量级镜像来复制证书
    container_name: shaarli-certs-initializer
    volumes:
      - shaarli-certs:/target-certs
      - ./tidb_ca.pem:/source-certs/tidb_ca.pem:ro # 将本地证书文件挂载到此容器
    command: sh -c "cp /source-certs/tidb_ca.pem /target-certs/tidb_ca.pem && chmod 644 /target-certs/tidb_ca.pem"
    # 确保这个服务在 shaarli 之前运行，以保证证书就绪
    # 注意：这种方式在某些情况下可能不是最佳实践，但对于简单的文件复制有效。
    # 更好的方式是直接在 shaarli 服务的 volumes 中映射本地文件，如上面的 shaarli 服务所示。
    # 为了简化和避免重复，这里我们直接在 shaarli 服务中映射本地证书文件。
    # 因此，`shaarli-certs-init` 服务可以被移除，并直接在 `shaarli` 服务的 `volumes` 中使用：
    # - ./tidb_ca.pem:/etc/ssl/certs/tidb_ca.pem:ro
    # 考虑到之前的配置，我们保留了 shaarli-certs volume，但直接映射文件更简单。
    # 让我们修改 shaarli 服务，直接映射文件，并移除 shaarli-certs-init 服务以简化。
    # 修正后的 shaarli 服务 volumes 将直接映射本地 tidb_ca.pem 到容器内部 /etc/ssl/certs/tidb_ca.pem。
    # 这样 shaarli-certs volume 就不再需要，或者可以用于其他用途。
    # 为了保持与之前配置的一致性，我们假设 tidb_ca.pem 最终会存在于 /etc/ssl/certs/tidb_ca.pem。
    # 最简单的做法是直接在 shaarli 服务中映射：
    # - ./tidb_ca.pem:/etc/ssl/certs/tidb_ca.pem:ro
    # 并且将 SHAARLI_DATABASE_SSL_CA 设置为 /etc/ssl/certs/tidb_ca.pem
    # 鉴于您之前的配置，`shaarli-certs` volume 是存在的，且 `SHAARLI_DATABASE_SSL_CA` 指向 `/etc/ssl/certs/tidb_ca.pem`。
    # 那么，最直接且保持一致的做法是：
    # 1. 将 `tidb_ca.pem` 放在项目根目录。
    # 2. 在 `shaarli` 服务的 `volumes` 中添加 `- ./tidb_ca.pem:/etc/ssl/certs/tidb_ca.pem:ro`。
    # 3. 移除 `shaarli-certs` volume 和 `shaarli-certs-init` 服务，因为直接映射文件更简单且避免了初始化服务的复杂性。
    # 让我们更新 `docker-compose.yml` 以反映这个更简洁的配置。

# 修正后的 docker-compose.yml (更简洁，直接映射证书文件)
version: '3.8'

volumes:
  shaarli-cache:
  shaarli-data:

services:
  shaarli:
    image: shaarli/shaarli:latest
    container_name: shaarli-app
    ports:
      - "8000:80"
    environment:
      SHAARLI_DATABASE_TYPE: mysql
      SHAARLI_DATABASE_HOST: ${TIDB_HOST}
      SHAARLI_DATABASE_PORT: ${TIDB_PORT}
      SHAARLI_DATABASE_USERNAME: ${TIDB_USER}
      SHAARLI_DATABASE_PASSWORD: ${TIDB_PASSWORD}
      SHAARLI_DATABASE_NAME: ${TIDB_DATABASE}
      SHAARLI_DATABASE_SSL_CA: /etc/ssl/certs/tidb_ca.pem # 容器内部的证书路径
      SHAARLI_DATABASE_SSL_VERIFY_SERVER_CERT: true
      SHAARLI_UPDATE_CHECK: "false"
      TZ: Asia/Shanghai
    volumes:
      - shaarli-cache:/var/www/shaarli/cache
      - shaarli-data:/var/www/shaarli/data
      - ./tidb_ca.pem:/etc/ssl/certs/tidb_ca.pem:ro # 直接将本地证书文件映射到容器内部
    restart: unless-stopped
</code></pre>

        <h2>3. 部署 Shaarli 应用</h2>

        <h3>3.1. 启动 Docker Compose</h3>
        <p>在您的项目根目录下，运行以下命令启动 Shaarli 容器：</p>
        <pre><code>docker-compose up -d</code></pre>
        <p><code>-d</code> 参数表示在后台运行容器。</p>

        <h3>3.2. 验证容器状态</h3>
        <p>您可以检查容器是否正在运行：</p>
        <pre><code>docker-compose ps</code></pre>
        <p>您应该看到 <code>shaarli-app</code> 容器的状态为 <code>Up</code>。</p>

        <h2>4. 访问 Shaarli 应用并添加书签</h2>

        <h3>4.1. 访问 Shaarli</h3>
        <p>在您的浏览器中访问： <a href="http://localhost:8000" target="_blank">http://localhost:8000</a></p>
        <p>如果是首次运行，您可能需要进行初始设置，包括创建管理员用户等。</p>

        <h3>4.2. 添加书签</h3>
        <p>登录后，尝试添加一些书签（链接），并为其添加标签和描述。</p>

        <h2>5. 查询数据</h2>

        <div class="note">
            再次强调：Shaarli 的核心数据（书签、用户、标签等）存储在 TiDB Cloud，而辅助文件（缓存、本地配置）存储在本地 Docker Volumes。
        </div>

        <h3>5.1. 查询本地 Docker Volumes (辅助文件)</h3>
        <p>这些 volumes 存储了 Shaarli 的缓存文件、本地配置和一些用户上传的文件（如果 Shaarli 配置支持）。<strong>它们不包含您的书签数据。</strong></p>

        <h4>5.1.1. 查看 Docker Volumes 列表</h4>
        <pre><code>docker volume ls</code></pre>
        <p>您会看到 <code>your-project-directory_shaarli-cache</code> 和 <code>your-project-directory_shaarli-data</code> 等 volumes。</p>

        <h4>5.1.2. 检查 Volume 详情</h4>
        <p>您可以检查某个 volume 的详细信息，包括它的挂载点：</p>
        <pre><code>docker volume inspect your-project-directory_shaarli-cache</code></pre>
        <p>输出中的 <code>Mountpoint</code> 字段会显示该 volume 在 Docker 宿主机（例如 WSL 2 VM 内部）的物理存储路径。</p>

        <h4>5.1.3. 访问 Volume 内容 (不推荐直接操作)</h4>
        <p>直接访问 Docker Volumes 的内容通常不推荐，因为它们由 Docker 管理，并且在 Windows 上，它们位于 WSL 2 虚拟机的文件系统中，而不是您的 Windows 文件系统。但如果您需要查看，可以通过创建一个临时容器来挂载并浏览：</p>
        <pre><code>docker run --rm -v your-project-directory_shaarli-cache:/mnt alpine ls /mnt</code></pre>
        <p>这会创建一个临时的 Alpine 容器，将 <code>shaarli-cache</code> volume 挂载到 <code>/mnt</code>，然后列出 <code>/mnt</code> 目录下的内容。</p>

        <h3>5.2. 查询 TiDB Cloud (核心数据 - 书签信息)</h3>
        <p>这是您的书签、标签、用户等核心数据实际存储的地方。</p>

        <h4>5.2.1. 方法一：使用 TiDB Cloud 控制台的 SQL Editor (推荐)</h4>
        <ol>
            <li>登录 <a href="https://cloud.tidb.com/" target="_blank">TiDB Cloud 控制台</a>。</li>
            <li>在左侧导航栏选择 "Clusters"，然后点击您正在使用的集群。</li>
            <li>在集群详情页中，点击 "Connect" 选项卡，然后选择 "SQL Editor"。</li>
            <li>在 SQL Editor 中，您可能需要再次输入您的数据库用户名 (<code>${TIDB_USER}</code>) 和密码 (<code>${TIDB_PASSWORD}</code>)。确保选择了正确的数据库 (<code>${TIDB_DATABASE}</code>，默认为 <code>test</code>)。</li>
            <li><strong>查询书签信息：</strong> Shaarli 的书签通常存储在名为 <code>entries</code> 的表中。</li>
            <pre><code>-- 查看所有表
SHOW TABLES;

-- 查询所有书签
SELECT * FROM entries;

-- 查询特定书签的 URL 和标题
SELECT url, title, description FROM entries WHERE private = 0;

-- 查询标签信息
SELECT * FROM tags;

-- 查询用户信息
SELECT * FROM users;
</code></pre>
        </ol>

        <h4>5.2.2. 方法二：使用 MySQL 命令行客户端</h4>
        <p>如果您在本地安装了 MySQL 客户端，可以通过命令行连接到 TiDB Cloud。</p>
        <ol>
            <li>确保您已下载 <code>tidb_ca.pem</code> 证书文件并知道其路径。</li>
            <li>打开命令行终端，执行以下命令连接到 TiDB Cloud：</li>
            <pre><code>mysql -h ${TIDB_HOST} -P ${TIDB_PORT} -u ${TIDB_USER} -p -D ${TIDB_DATABASE} --ssl-mode=VERIFY_IDENTITY --ssl-ca=/path/to/your/tidb_ca.pem</code></pre>
            <p>替换 <code>/path/to/your/tidb_ca.pem</code> 为您本地 <code>tidb_ca.pem</code> 文件的实际路径。系统会提示您输入密码。</p>
            <li>连接成功后，您可以执行与 SQL Editor 中相同的 SQL 查询命令。</li>
        </ol>

        <h4>5.2.3. 方法三：使用 GUI 数据库管理工具 (如 DBeaver)</h4>
        <p>像 <a href="https://dbeaver.io/" target="_blank">DBeaver</a> 这样的工具提供了更友好的图形界面来浏览和查询数据。</p>
        <ol>
            <li>下载并安装 DBeaver。</li>
            <li>新建数据库连接：
                <ul>
                    <li>选择 "MySQL" 驱动。</li>
                    <li><strong>Host:</strong> <code>${TIDB_HOST}</code></li>
                    <li><strong>Port:</strong> <code>${TIDB_PORT}</code></li>
                    <li><strong>Database:</strong> <code>${TIDB_DATABASE}</code></li>
                    <li><strong>User:</strong> <code>${TIDB_USER}</code></li>
                    <li><strong>Password:</strong> <code>${TIDB_PASSWORD}</code></li>
                    <li><strong>SSL 设置：</strong> 在连接配置中找到 SSL/TLS 选项，选择 "Require SSL" 或 "Verify CA"，并指定您下载的 <code>tidb_ca.pem</code> 文件作为 CA 证书。</li>
                </ul>
            </li>
            <li>连接成功后，您可以在左侧导航栏中展开 <code>${TIDB_DATABASE}</code> 数据库，查看其中的表，并右键点击表名选择 "View Data" 来查看内容。</li>
        </ol>

        <h2>6. 故障排除</h2>
        <ul>
            <li><strong>容器无法启动：</strong> 检查 <code>docker-compose logs shaarli-app</code> 查看日志输出，寻找错误信息。</li>
            <li><strong>Shaarli 无法连接数据库：</strong> 检查 <code>.env</code> 文件中的 TiDB Cloud 连接信息是否正确，包括主机、端口、用户名、密码和数据库名。确保 <code>tidb_ca.pem</code> 文件存在且路径正确。</li>
            <li><strong>端口冲突：</strong> 如果 8000 端口已被占用，修改 <code>docker-compose.yml</code> 中 <code>ports: - "8000:80"</code> 的第一个数字为其他未占用的端口，例如 <code>- "8080:80"</code>。</li>
        </ul>

        <p>希望这个教程能帮助您顺利部署和管理您的 Shaarli 应用！</p>
    </div>
</body>
</html>