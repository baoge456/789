<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firefly III 部署教程</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 20px;
            text-align: center;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .section {
            background: white;
            padding: 30px;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .section h2 {
            color: #667eea;
            margin-bottom: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .section h3 {
            color: #555;
            margin: 20px 0 10px 0;
        }
        
        .code-block {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .code-block pre {
            margin: 0;
            white-space: pre-wrap;
        }
        
        .step {
            background: #e8f4fd;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 5px 5px 0;
        }
        
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-left: 4px solid #fdcb6e;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 5px 5px 0;
        }
        
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 5px 5px 0;
        }
        
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-left: 4px solid #17a2b8;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 5px 5px 0;
        }
        
        .danger {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-left: 4px solid #dc3545;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 5px 5px 0;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        .table th, .table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        
        .table th {
            background: #667eea;
            color: white;
        }
        
        .table tr:nth-child(even) {
            background: #f2f2f2;
        }
        
        .btn {
            display: inline-block;
            padding: 10px 20px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            margin: 5px;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #5a6fd8;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .toc {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 30px;
        }
        
        .toc h3 {
            margin-bottom: 15px;
            color: #667eea;
        }
        
        .toc ul {
            list-style: none;
        }
        
        .toc li {
            margin: 8px 0;
        }
        
        .toc a {
            color: #333;
            text-decoration: none;
            padding: 5px 10px;
            border-radius: 3px;
            transition: background 0.3s;
        }
        
        .toc a:hover {
            background: #667eea;
            color: white;
        }
        
        .highlight {
            background: #fff3cd;
            padding: 2px 5px;
            border-radius: 3px;
            font-weight: bold;
        }
        
        .copy-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 10px;
        }
        
        .copy-btn:hover {
            background: #218838;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1> Firefly III 部署教程</h1>
            <p>开源个人财务管理系统的完整部署指南</p>
        </div>

        <div class="toc">
            <h3>📋 目录</h3>
            <ul>
                <li><a href="#intro">1. 系统介绍</a></li>
                <li><a href="#prerequisites">2. 环境要求</a></li>
                <li><a href="#app-key">3. APP_KEY 获取方法</a></li>
                <li><a href="#installation">4. 安装步骤</a></li>
                <li><a href="#configuration">5. 配置说明</a></li>
                <li><a href="#usage">6. 使用指南</a></li>
                <li><a href="#maintenance">7. 维护管理</a></li>
                <li><a href="#troubleshooting">8. 故障排除</a></li>
            </ul>
        </div>

        <div class="section" id="intro">
            <h2>1. 系统介绍</h2>
            <p>Firefly III 是一个免费、开源的个人财务管理工具，具有以下特点：</p>
            <ul>
                <li>📊 完整的财务跟踪和管理</li>
                <li> 多账户支持（银行、现金、投资等）</li>
                <li>📈 详细的报表和分析</li>
                <li>🔄 自动导入银行交易记录</li>
                <li>📱 响应式设计，支持移动端</li>
                <li>🔒 数据安全，本地存储</li>
                <li>🌐 多语言支持</li>
            </ul>
        </div>

        <div class="section" id="prerequisites">
            <h2>2. 环境要求</h2>
            
            <h3>系统要求</h3>
            <table class="table">
                <tr>
                    <th>项目</th>
                    <th>最低要求</th>
                    <th>推荐配置</th>
                </tr>
                <tr>
                    <td>操作系统</td>
                    <td>Windows 10 / Linux / macOS</td>
                    <td>Windows 11 / Ubuntu 20.04+</td>
                </tr>
                <tr>
                    <td>内存</td>
                    <td>2GB RAM</td>
                    <td>4GB+ RAM</td>
                </tr>
                <tr>
                    <td>存储空间</td>
                    <td>1GB 可用空间</td>
                    <td>5GB+ 可用空间</td>
                </tr>
                <tr>
                    <td>网络</td>
                    <td>本地网络访问</td>
                    <td>稳定的网络连接</td>
                </tr>
            </table>

            <h3>必需软件</h3>
            <div class="step">
                <strong>Docker Desktop</strong>
                <ul>
                    <li>Windows: <a href="https://www.docker.com/products/docker-desktop" target="_blank">下载 Docker Desktop for Windows</a></li>
                    <li>macOS: <a href="https://www.docker.com/products/docker-desktop" target="_blank">下载 Docker Desktop for Mac</a></li>
                    <li>Linux: 安装 Docker Engine</li>
                </ul>
            </div>

            <div class="info">
                <strong>💡 提示：</strong> 确保Docker Desktop已启动并正常运行。
            </div>
        </div>

        <div class="section" id="app-key">
            <h2>3. APP_KEY 获取方法</h2>
            
            <div class="danger">
                <strong>⚠️ 重要提醒：</strong> APP_KEY 是 Firefly III 的核心安全密钥，用于加密敏感数据。请妥善保管，不要泄露给他人。
            </div>

            <h3>方法一：Windows PowerShell 生成（推荐）</h3>
            <div class="step">
                <strong>步骤：</strong>
                <ol>
                    <li>打开 PowerShell（以管理员身份运行）</li>
                    <li>执行以下命令生成 APP_KEY：</li>
                </ol>
            </div>

            <div class="code-block">
                <pre>$rng = New-Object System.Security.Cryptography.RNGCryptoServiceProvider
$bytes = New-Object byte[] 32
$rng.GetBytes($bytes)
$key = [System.Convert]::ToBase64String($bytes)
Write-Host "base64:$key"</pre>
            </div>

            <div class="success">
                <strong>✅ 输出示例：</strong>
                <code>base64:GOQP81YK/Gf+b53APGN4D2dkFWHkPthNgQdLJHx8+ew=</code>
            </div>

            <h3>方法二：使用在线生成器</h3>
            <div class="info">
                <strong>在线工具：</strong>
                <ul>
                    <li><a href="https://www.base64encode.org/" target="_blank">Base64 编码器</a></li>
                    <li><a href="https://www.random.org/strings/" target="_blank">随机字符串生成器</a></li>
                </ul>
            </div>

            <div class="step">
                <strong>手动生成步骤：</strong>
                <ol>
                    <li>生成32位随机字符串</li>
                    <li>使用Base64编码</li>
                    <li>添加 "base64:" 前缀</li>
                </ol>
            </div>

            <div class="code-block">
                <pre># 示例：手动生成的APP_KEY格式
base64:YourRandom32CharacterStringHere1234567890abcdef=</pre>
            </div>

            <h3>方法三：使用 PHP 脚本生成</h3>
            <div class="code-block">
                <pre># 创建 generate-key.php 文件
&lt;?php
$key = base64_encode(random_bytes(32));
echo "base64:" . $key . "\n";
?&gt;

# 执行脚本
php generate-key.php</pre>
            </div>

            <h3>方法四：使用 OpenSSL 命令（Linux/macOS）</h3>
            <div class="code-block">
                <pre># Linux/macOS 命令
openssl rand -base64 32</pre>
            </div>

            <h3>验证 APP_KEY 格式</h3>
            <div class="warning">
                <strong>格式要求：</strong>
                <ul>
                    <li>必须以 "base64:" 开头</li>
                    <li>后面跟随32字节的Base64编码字符串</li>
                    <li>总长度约为44个字符</li>
                </ul>
            </div>

            <div class="code-block">
                <pre># 正确的APP_KEY格式示例
base64:GOQP81YK/Gf+b53APGN4D2dkFWHkPthNgQdLJHx8+ew=
base64:YourGeneratedKeyHere1234567890abcdef=
base64:AnotherRandomKeyExample9876543210zyxwvu=</pre>
            </div>

            <h3>在 Docker Compose 中使用 APP_KEY</h3>
            <div class="code-block">
                <pre>version: '3.8'

services:
  fireflyiii:
    image: fireflyiii/core:latest
    container_name: fireflyiii
    restart: unless-stopped
    environment:
      - APP_KEY=base64:GOQP81YK/Gf+b53APGN4D2dkFWHkPthNgQdLJHx8+ew=  # 替换为您的APP_KEY
      - DB_HOST=db
      - DB_DATABASE=firefly
      - DB_USERNAME=firefly
      - DB_PASSWORD=firefly
      - TZ=Asia/Shanghai
      - TRUSTED_PROXIES=**
    ports:
      - "8081:8080"
    depends_on:
      - db

  db:
    image: mariadb:10.6
    container_name: fireflydb
    restart: unless-stopped
    environment:
      - MYSQL_RANDOM_ROOT_PASSWORD=yes
      - MYSQL_DATABASE=firefly
      - MYSQL_USER=firefly
      - MYSQL_PASSWORD=firefly
    volumes:
      - ./mysql-data:/var/lib/mysql

volumes:
  mysql-data:</pre>
            </div>

            <h3>APP_KEY 安全建议</h3>
            <div class="danger">
                <strong>🔒 安全注意事项：</strong>
                <ul>
                    <li>每个部署环境使用唯一的 APP_KEY</li>
                    <li>不要在代码仓库中提交真实的 APP_KEY</li>
                    <li>定期更换 APP_KEY（需要重新加密数据）</li>
                    <li>备份 APP_KEY 到安全位置</li>
                    <li>使用环境变量或配置文件存储</li>
                </ul>
            </div>

            <h3>更换 APP_KEY</h3>
            <div class="warning">
                <strong>⚠️ 注意：</strong> 更换 APP_KEY 会导致已加密的数据无法解密，需要重新设置。
            </div>

            <div class="code-block">
                <pre># 1. 停止服务
docker-compose down

# 2. 备份数据（重要！）
tar -czf firefly-backup-$(date +%Y%m%d).tar.gz mysql-data/

# 3. 修改 docker-compose.yml 中的 APP_KEY

# 4. 重新启动服务
docker-compose up -d

# 5. 重新初始化数据库
docker-compose exec fireflyiii php artisan migrate:fresh --seed</pre>
            </div>
        </div>

        <div class="section" id="installation">
            <h2>4. 安装步骤</h2>

            <h3>步骤1：创建项目目录</h3>
            <div class="code-block">
                <pre># 创建项目目录
mkdir C:\Users\wangs\firefly-iii
cd C:\Users\wangs\firefly-iii</pre>
            </div>

            <h3>步骤2：生成 APP_KEY</h3>
            <div class="code-block">
                <pre># 在 PowerShell 中执行
$rng = New-Object System.Security.Cryptography.RNGCryptoServiceProvider
$bytes = New-Object byte[] 32
$rng.GetBytes($bytes)
$key = [System.Convert]::ToBase64String($bytes)
Write-Host "base64:$key"</pre>
            </div>

            <h3>步骤3：创建Docker配置文件</h3>
            <div class="code-block">
                <pre># 创建 docker-compose.yml 文件，使用生成的 APP_KEY
version: '3.8'

services:
  fireflyiii:
    image: fireflyiii/core:latest
    container_name: fireflyiii
    restart: unless-stopped
    environment:
      - APP_KEY=base64:GOQP81YK/Gf+b53APGN4D2dkFWHkPthNgQdLJHx8+ew=  # 替换为您的APP_KEY
      - DB_HOST=db
      - DB_DATABASE=firefly
      - DB_USERNAME=firefly
      - DB_PASSWORD=firefly
      - TZ=Asia/Shanghai
      - TRUSTED_PROXIES=**
    ports:
      - "8081:8080"
    depends_on:
      - db

  db:
    image: mariadb:10.6
    container_name: fireflydb
    restart: unless-stopped
    environment:
      - MYSQL_RANDOM_ROOT_PASSWORD=yes
      - MYSQL_DATABASE=firefly
      - MYSQL_USER=firefly
      - MYSQL_PASSWORD=firefly
    volumes:
      - ./mysql-data:/var/lib/mysql

volumes:
  mysql-data:</pre>
            </div>

            <h3>步骤4：启动服务</h3>
            <div class="code-block">
                <pre># 在项目目录中执行
docker-compose up -d</pre>
            </div>

            <div class="success">
                <strong>✅ 成功！</strong> Firefly III 已成功启动，访问地址：<a href="http://localhost:8081" target="_blank">http://localhost:8081</a>
            </div>
        </div>

        <div class="section" id="configuration">
            <h2>5. 配置说明</h2>

            <h3>环境变量说明</h3>
            <table class="table">
                <tr>
                    <th>变量名</th>
                    <th>说明</th>
                    <th>默认值</th>
                    <th>是否必需</th>
                </tr>
                <tr>
                    <td>APP_KEY</td>
                    <td>应用加密密钥</td>
                    <td>无</td>
                    <td><span class="highlight">必需</span></td>
                </tr>
                <tr>
                    <td>DB_HOST</td>
                    <td>数据库主机</td>
                    <td>db</td>
                    <td>必需</td>
                </tr>
                <tr>
                    <td>DB_DATABASE</td>
                    <td>数据库名称</td>
                    <td>firefly</td>
                    <td>必需</td>
                </tr>
                <tr>
                    <td>DB_USERNAME</td>
                    <td>数据库用户名</td>
                    <td>firefly</td>
                    <td>必需</td>
                </tr>
                <tr>
                    <td>DB_PASSWORD</td>
                    <td>数据库密码</td>
                    <td>firefly</td>
                    <td>必需</td>
                </tr>
                <tr>
                    <td>TZ</td>
                    <td>时区设置</td>
                    <td>Asia/Shanghai</td>
                    <td>可选</td>
                </tr>
                <tr>
                    <td>TRUSTED_PROXIES</td>
                    <td>信任的代理服务器</td>
                    <td>**</td>
                    <td>可选</td>
                </tr>
            </table>

            <h3>端口配置</h3>
            <div class="info">
                <strong>当前配置：</strong> 外部端口 8081 映射到容器内部端口 8080
            </div>

            <div class="code-block">
                <pre># 如需修改端口，编辑 docker-compose.yml 中的 ports 配置
ports:
  - "8082:8080"  # 改为 8082 端口</pre>
            </div>

            <h3>数据持久化</h3>
            <div class="step">
                <strong>数据存储位置：</strong> <code>C:\Users\wangs\firefly-iii\mysql-data</code>
                <ul>
                    <li>数据库文件自动保存在此目录</li>
                    <li>容器重启后数据不会丢失</li>
                    <li>建议定期备份此目录</li>
                </ul>
            </div>
        </div>

        <div class="section" id="usage">
            <h2>6. 使用指南</h2>

            <h3>首次访问</h3>
            <div class="step">
                <ol>
                    <li>打开浏览器访问：<a href="http://localhost:8081" target="_blank">http://localhost:8081</a></li>
                    <li>等待页面加载完成（首次启动可能需要几分钟）</li>
                    <li>按照向导完成初始设置</li>
                    <li>创建管理员账户</li>
                </ol>
            </div>

            <h3>基本功能</h3>
            <table class="table">
                <tr>
                    <th>功能模块</th>
                    <th>说明</th>
                </tr>
                <tr>
                    <td>📊 仪表板</td>
                    <td>查看财务概览和统计信息</td>
                </tr>
                <tr>
                    <td>💰 账户</td>
                    <td>管理银行账户、现金账户等</td>
                </tr>
                <tr>
                    <td>📝 交易</td>
                    <td>记录收入、支出和转账</td>
                </tr>
                <tr>
                    <td>🏷️ 分类</td>
                    <td>设置交易分类和标签</td>
                </tr>
                <tr>
                    <td>📈 报表</td>
                    <td>生成详细的财务报表</td>
                </tr>
                <tr>
                    <td>⚙️ 设置</td>
                    <td>系统配置和用户管理</td>
                </tr>
            </table>

            <h3>数据导入</h3>
            <div class="info">
                <strong>支持的文件格式：</strong>
                <ul>
                    <li>CSV 文件</li>
                    <li>QIF 文件</li>
                    <li>OFX 文件</li>
                </ul>
            </div>
        </div>

        <div class="section" id="maintenance">
            <h2>7. 维护管理</h2>

            <h3>常用命令</h3>
            <div class="code-block">
                <pre># 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f fireflyiii

# 停止服务
docker-compose down

# 重启服务
docker-compose restart

# 更新到最新版本
docker-compose pull
docker-compose up -d

# 备份数据
tar -czf firefly-backup-$(date +%Y%m%d).tar.gz mysql-data/

# 恢复数据
tar -xzf firefly-backup-20231201.tar.gz</pre>
            </div>

            <h3>数据备份</h3>
            <div class="warning">
                <strong>⚠️ 重要：</strong> 定期备份数据目录，防止数据丢失。
            </div>

            <div class="step">
                <strong>备份步骤：</strong>
                <ol>
                    <li>停止服务：<code>docker-compose down</code></li>
                    <li>备份数据目录：<code>mysql-data/</code></li>
                    <li>重启服务：<code>docker-compose up -d</code></li>
                </ol>
            </div>

            <h3>性能优化</h3>
            <div class="info">
                <strong>优化建议：</strong>
                <ul>
                    <li>定期清理日志文件</li>
                    <li>监控磁盘空间使用</li>
                    <li>设置自动备份脚本</li>
                    <li>定期更新到最新版本</li>
                </ul>
            </div>
        </div>

        <div class="section" id="troubleshooting">
            <h2>8. 故障排除</h2>

            <h3>常见问题</h3>
            
            <h4>问题1：APP_KEY 相关错误</h4>
            <div class="step">
                <strong>错误信息：</strong> "No application encryption key has been specified"
                <br><strong>解决方案：</strong>
                <ol>
                    <li>检查 docker-compose.yml 中的 APP_KEY 是否正确设置</li>
                    <li>重新生成 APP_KEY：使用 PowerShell 命令</li>
                    <li>更新配置文件并重启服务</li>
                </ol>
            </div>

            <h4>问题2：无法访问网站</h4>
            <div class="step">
                <strong>解决方案：</strong>
                <ol>
                    <li>检查Docker是否运行：<code>docker --version</code></li>
                    <li>检查容器状态：<code>docker-compose ps</code></li>
                    <li>查看错误日志：<code>docker-compose logs fireflyiii</code></li>
                    <li>检查端口是否被占用</li>
                </ol>
            </div>

            <h4>问题3：数据库连接失败</h4>
            <div class="step">
                <strong>解决方案：</strong>
                <ol>
                    <li>检查数据库容器状态</li>
                    <li>查看数据库日志：<code>docker-compose logs db</code></li>
                    <li>重启数据库服务：<code>docker-compose restart db</code></li>
                    <li>检查数据目录权限</li>
                </ol>
            </div>

            <h4>问题4：数据丢失</h4>
            <div class="warning">
                <strong>紧急处理：</strong>
                <ol>
                    <li>立即停止服务</li>
                    <li>检查数据目录是否存在</li>
                    <li>从备份恢复数据</li>
                    <li>联系技术支持</li>
                </ol>
            </div>

            <h3>日志分析</h3>
            <div class="code-block">
                <pre># 查看实时日志
docker-compose logs -f

# 查看特定服务的日志
docker-compose logs fireflyiii
docker-compose logs db

# 查看最近的日志
docker-compose logs --tail=100 fireflyiii</pre>
            </div>

            <h3>重置系统</h3>
            <div class="danger">
                <strong>⚠️ 危险操作：</strong> 这将删除所有数据！
            </div>
            <div class="code-block">
                <pre># 完全重置（删除所有数据）
docker-compose down -v
rm -rf mysql-data/
docker-compose up -d</pre>
            </div>
        </div>

        <div class="section">
            <h2>📞 技术支持</h2>
            <p>如果您在使用过程中遇到问题，可以：</p>
            <ul>
                <li>📖 查看 <a href="https://docs.firefly-iii.org/" target="_blank">官方文档</a></li>
                <li>💬 访问 <a href="https://github.com/firefly-iii/firefly-iii" target="_blank">GitHub 项目</a></li>
                <li>🔧 查看 <a href="https://github.com/firefly-iii/firefly-iii/issues" target="_blank">问题反馈</a></li>
            </ul>
        </div>

        <div class="section">
            <h2>🎉 恭喜！</h2>
            <p>您已成功部署 Firefly III 个人财务管理系统！</p>
            <p>现在可以开始管理您的个人财务了。</p>
            <div style="text-align: center; margin-top: 30px;">
                <a href="http://localhost:8081" class="btn" target="_blank"> 立即访问 Firefly III</a>
            </div>
        </div>
    </div>

    <script>
        // 复制代码功能
        function copyCode(element) {
            const codeBlock = element.previousElementSibling;
            const text = codeBlock.textContent;
            
            navigator.clipboard.writeText(text).then(function() {
                const btn = element;
                const originalText = btn.textContent;
                btn.textContent = '已复制！';
                btn.style.background = '#28a745';
                
                setTimeout(function() {
                    btn.textContent = originalText;
                    btn.style.background = '#28a745';
                }, 2000);
            }).catch(function(err) {
                console.error('复制失败: ', err);
                alert('复制失败，请手动复制');
            });
        }
        
        // 为所有代码块添加复制按钮
        document.addEventListener('DOMContentLoaded', function() {
            const codeBlocks = document.querySelectorAll('.code-block');
            codeBlocks.forEach(function(block) {
                const copyBtn = document.createElement('button');
                copyBtn.className = 'copy-btn';
                copyBtn.textContent = '复制';
                copyBtn.onclick = function() { copyCode(this); };
                block.appendChild(copyBtn);
            });
        });
    </script>
</body>
</html>