<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>D-File</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/axios/1.1.3/axios.min.js"></script>
    <script src="https://unpkg.com/js-base64"></script>
    <link rel="shortcut icon" type="image/x-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAMxJREFUOE+t06FuAkEQxvH/FxpegUoeovXUoOobJLapRDaw2T1b21qwoNGUB8BW45jwDmQJENIj3F2vd0wyZjL7m2QmK2qGar7nCLSGsadIF2hfgOLTvGZFQ47A/Xt0iFFG45jI5Kp+x9acfg71v4Dc4YKHTdDqDHSAQ2ZFzKkvLdH3LyDegGYqixcsvHkt0sDiXxcRz+Y1rw7AiwVN6wB9CxpXB8SreX1VByIDS/RRBxhaonACXGyzYwo8lrzEmgZP5rS+zWcqOTWzbQ96PEURUT++WAAAAABJRU5ErkJggg==" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { padding: 20px 0 10px; background: #000; color: #fff; }
        body { font-size: 16px; max-width: 80%; margin: 0 auto; }
        h2 { margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #333; }
        .back { display: inline-block; border: 1px solid #ff9000; padding: 4px 12px; font-size: 15px; cursor: pointer; margin-left: 20px; background: #ff9000; color: #000; border-radius: 3px; transition: all 0.2s; }
        .back:hover { background: #000; color: #ff9000; }
        input.back { cursor: auto; background: #1b1b1b; border: 1px solid #333; color: #fff; }
        .file_list li { line-height: 40px; border-bottom: 1px solid #333; display: flex; align-items: center; padding: 6px 0; }
        .file_list li a { color: #fff; text-decoration: none; flex-grow: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .file_list li i { border: 1px solid #ff9000; padding: 4px 12px; cursor: pointer; margin-left: 10px; background: #ff9000; color: #000; border-radius: 3px; transition: all 0.2s; }
        .file_list li i:hover { background: #000; color: #ff9000; }
        @media screen and (max-width: 700px) {
            .file_list li span { display: none !important; }
            body { max-width: 95%; }
            .back.ftr { display: none; }
            input#search { display: inline-block; margin-top: 10px; }
            button { margin-top: 6px; }
        }
        input, button {
            background-color: #1b1b1b;
            border-radius: 3px;
            border-color:#333;
            color:#fff;
            padding-left :10px;
            padding-right :10px;
            line-height :26px;
            outline:none;
            transition : all .2s;
        }
        input::placeholder {
            color:#999;
        }
        input[type="text"] {
            min-width :280px;
            margin-top :6px;
        }
    </style>
</head>
<body>
    <p style="margin-bottom:20px;">版本号：20250101-1 <span class="tip">测试延迟请在根目录上传<b>init.jpg</b>(50kb以内)</span></p>
    
    <h4>根域名：<input type="text" value="" id="rootdm" /></h4>
    
    <div id="btn-wrap">
        <button onclick="updateRepo()">设置Repo</button>
        <button onclick="updateToken()">设置Token</button>
    </div>

    <h2>当前目录：<i id="repo"></i>
        <span onclick="addDir()" class="back">新建目录</span>
        <span onclick="document.getElementById('file').click()" class="back">上传文件</span>
        <div id="batch-operations" style="display:inline-block;margin-left:10px;">
            <span onclick="batchDelete()" class="back">批量删除</span>
            <span onclick="batchMove()" class="back">批量移动</span>
            <span onclick="batchCopy()" class="back">批量复制</span>
            <span onclick="shareFiles()" class="back">批量分享</span>
            <span id="selected-count" style="margin-left:10px;color:#ff9000;"></span>
        </div>
        <span onclick="dirBack()" class="back">←返回</span>
        <span onclick="refresh()" class="back ftr">刷新</span>
        <input type="text" class="back ftr" id="search" placeholder="关键词搜索, 回车确认" onkeyup="search(event)" />
    </h2>

    <div id="file_wrap">
        <ul class="file_list" id="file_list">加载中...</ul>
    </div>

    <input type="file" id="file" class="filepond" name="filepond" style="display:none;" />

    <!-- Loading Indicator -->
    <div id="loading" class="hide">处理中...</div>

    <!-- Dropzone for file upload -->
    <div class="dropzone">
        拖拽文件到此处上传 或 点击选择文件
        <input type="file" id="fileInput" multiple style="display:none;" />
    </div>

    <!-- Preview Modal -->
    <div class="preview-modal">
        <div class="preview-close">×</div>
        <div class="preview-content"></div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" style="display:none;">
        <div class="context-menu-item" data-action="preview">预览</div>
        <div class="context-menu-item" data-action="copy">复制</div>
        <div class="context-menu-item" data-action="move">移动</div>
        <div class="context-menu-item" data-action="share">分享</div>
        <div class="context-menu-item" data-action="delete">删除</div>
    </div>

    <script>
        window.baseRepo = localStorage.getItem("GIT_REPO") || "dhjz/file";
        window.baseToken = localStorage.getItem("GIT_TOKEN") || "";
        
        if (!baseToken) alert("请先设置仓库和token");

        function initFileList(searchVal = '') {
            let rootdm = document.getElementById("rootdm").value || "";
            let tempList = window.fileList;

            if (searchVal && searchVal.trim()) {
                tempList = window.fileList.filter(item => item.name.includes(searchVal.trim()));
            }

            document.getElementById("file_list").innerHTML = tempList.map(item => `
                <li class="${item.ftype}" data-id="${item.sha}">
                    <a target="_blank" href="${rootdm}${item.path}">${item.name}</a>
                    <span class='sha'>${item.sha}</span>
                    <span class='size'>${getUnit(item.size)}</span> 
                    <i onclick='delOne("${item.path}", "${item.sha}")'>删除</i> 
                </li>`).join("");

            document.getElementById("repo").innerHTML = baseRepo + "/" + (paths.length ? paths[paths.length - 1] : "");
        }

       // 初始化根目录
       if (baseToken) getDir("", true);

       function getDir(path, isRoot) {
           if (!path && !isRoot) return;
           showLoading();
           getContent(path + "?t="+new Date().getTime()).then(data => {
               window.fileList = (data || []).filter(d => d.name != "init.jpg").map(item => {
                   item.ftype = getType(item.name);
                   return item;
               });
               initFileList();
           });
       }

       function addDir() {
           const val = prompt("请输入新建目录名称, 基于根目录, 不以/开头", "");
           if (val) putDir(val);
       }

       function dirBack() {
           if (!paths.length) return alert("已经是根目录了!");
           paths.pop();
           getDir(paths.length ? paths[paths.length - 1] : "", true);
       }

       function refresh() {
           getDir(paths.length ? paths[paths.length - 1] : "", true);
       }

       function search(e) {
           if (e.keyCode === 13) initFileList(document.getElementById("search").value);
       }

       function delOne(path, sha) {
           if (path === "index.html") return alert("主页index.html不能被删除!");
           if (confirm(`是否确认删除该文件:${path}`)) delFile(path, sha);
       }

       document.getElementById("file").addEventListener("input", (e) => {
           const file = e.target.files[0];
           if (file) putFile(file.name, file);
           document.getElementById("file").value = "";
       });

       function updateRepo() {
           const val = prompt("请输入仓库 {owner}/{repo}", localStorage.getItem("GIT_REPO") || "dhjz/file");
           if (val) localStorage.setItem("GIT_REPO", val);
       }

       function updateToken() {
           const val = prompt("请输入token", localStorage.getItem("GIT_TOKEN") || "");
           if (val) localStorage.setItem("GIT_TOKEN", val);
       }

       function getType(val) {
           if (/\.(jpg|jpeg|png|gif)$/i.test(val)) return "img";
           if (/\.(mp4|avi|mov|wmv|flv)$/i.test(val)) return "video";
           if (/\.(mp3|wav|wma|aac)$/i.test(val)) return "music";
           if (/\.(doc|docx)$/i.test(val)) return "doc";
           if (/\.(xls|xlsx)$/i.test(val)) return "xls";
           if (/\.(ppt|pptx)$/i.test(val)) return "ppt";
           if (/\.(pdf)$/i.test(val)) return "pdf";
           return "other";
       }

       // 显示加载指示器
       function showLoading() {
           document.getElementById('loading').classList.remove('hide');
       }

       // 隐藏加载指示器
       function hideLoading() {
           document.getElementById('loading').classList.add('hide');
       }

       // 获取单位
       function getUnit(size) {
           if(size >=1024*1024) return (size / (1024 * 1024)).toFixed(2) + ' MB';
           else if(size >=1024) return (size / 1024).toFixed(2) + ' KB';
           else return size + ' B';
       }

   </script>

   <!-- 添加其他必要的功能实现 -->

</body>
</html>
