<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç½‘ç«™å›¾æ ‡æŠ“å–å·¥å…·ï¼ˆä¿®å¤ç‰ˆï¼‰</title>
    <style>
        /* ä¿®å¤é¢æ¿æ ·å¼ */
        .container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 20px;
            font-family: 'Segoe UI', sans-serif;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        #urlInput {
            flex: 1;
            padding: 12px;
            border: 2px solid #007bff;
            border-radius: 6px;
            font-size: 16px;
        }

        #fetchButton {
            padding: 12px 24px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s;
        }

        #fetchButton:hover {
            background: #0056b3;
        }

        .result-container {
            margin-top: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .icon-preview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .icon-item {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .icon-item:hover {
            transform: translateY(-3px);
        }

        .error {
            color: #dc3545;
            margin-top: 10px;
            padding: 10px;
            background: #ffeaea;
            border-radius: 4px;
        }

        .loading {
            display: none;
            color: #6c757d;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="color: #2c3e50; text-align: center;">ç½‘ç«™å›¾æ ‡æŠ“å–å·¥å…·</h1>
        <div class="input-group">
            <input type="url" id="urlInput" placeholder="è¾“å…¥ç½‘ç«™åœ°å€ (å¦‚: example.com)">
            <button id="fetchButton">è·å–å›¾æ ‡</button>
        </div>
        <div class="loading">ğŸ” æ­£åœ¨æœç´¢å›¾æ ‡...</div>
        <div class="result-container" id="resultContainer">
            <h3 style="margin-top: 0;">æ‰¾åˆ°ä»¥ä¸‹å›¾æ ‡ï¼š</h3>
            <div class="icon-preview" id="iconContainer"></div>
        </div>
        <div class="error" id="errorMessage"></div>
    </div>

    <script>
        // ä½¿ç”¨å¯é çš„CORSä»£ç†
        const CORS_PROXY = 'https://corsproxy.io/?';
        
        // å¢å¼ºçš„APIç«¯ç‚¹åˆ—è¡¨
        const API_ENDPOINTS = [
            url => `${CORS_PROXY}https://www.google.com/s2/favicons?domain=${url}&sz=256`,
            url => `${CORS_PROXY}https://t2.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&url=${url}&size=256`,
            url => `${CORS_PROXY}${url}/favicon.ico`,
            url => `${CORS_PROXY}${url}/apple-touch-icon.png`
        ];

        // é…ç½®è¯·æ±‚å‚æ•°
        const FETCH_CONFIG = {
            timeout: 8000,
            headers: {
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
            }
        };

        async function fetchFavicon(originalUrl) {
            try {
                // åˆå§‹åŒ–çŠ¶æ€
                const resultContainer = document.getElementById('resultContainer');
                const errorMessage = document.getElementById('errorMessage');
                const loading = document.querySelector('.loading');
                
                loading.style.display = 'block';
                resultContainer.style.display = 'none';
                errorMessage.textContent = '';

                // æ ‡å‡†åŒ–URL
                const url = originalUrl.startsWith('http') ? originalUrl : `https://${originalUrl}`;
                const { protocol, hostname } = new URL(url);
                const baseUrl = `${protocol}//${hostname}`;

                // å°è¯•å¤šä¸ªAPIæº
                const apiPromises = API_ENDPOINTS.map(endpoint => 
                    fetch(endpoint(baseUrl), FETCH_CONFIG)
                        .then(res => res.ok ? res.blob() : Promise.reject())
                        .catch(() => null)
                );

                const apiResults = await Promise.all(apiPromises);
                const validIcons = apiResults.filter(Boolean);

                // å¦‚æœAPIæœªæ‰¾åˆ°ï¼Œè§£æé¡µé¢
                if (validIcons.length === 0) {
                    const pageResponse = await fetch(`${CORS_PROXY}${baseUrl}`, FETCH_CONFIG);
                    const html = await pageResponse.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');

                    // æ‰©å±•å›¾æ ‡å‘ç°è§„åˆ™
                    const iconSources = [
                        ...doc.querySelectorAll('link[rel*="icon"]'),
                        ...doc.querySelectorAll('meta[property="og:image"]'),
                        ...doc.querySelectorAll('meta[name="twitter:image"]'),
                        ...doc.querySelectorAll('img[alt*="logo"]')
                    ];

                    // æ·»åŠ å¸¸è§é»˜è®¤è·¯å¾„
                    const defaultPaths = [
                        '/favicon.ico',
                        '/apple-touch-icon.png',
                        '/logo.png',
                        '/img/logo.png',
                        '/static/favicon.ico'
                    ];

                    defaultPaths.forEach(path => {
                        const fakeElement = document.createElement('link');
                        fakeElement.href = path;
                        iconSources.push(fakeElement);
                    });

                    // å¤„ç†æ‰¾åˆ°çš„å›¾æ ‡
                    iconSources.forEach(source => {
                        let iconUrl = source.href || source.content;
                        if (!iconUrl) return;

                        // è½¬æ¢ä¸ºç»å¯¹URL
                        try {
                            iconUrl = new URL(iconUrl, baseUrl).href;
                        } catch {
                            iconUrl = `${baseUrl}${iconUrl.startsWith('/') ? '' : '/'}${iconUrl}`;
                        }
                        
                        displayIcon(iconUrl);
                    });

                    if (iconSources.length === 0) {
                        throw new Error('æœªæ‰¾åˆ°ä»»ä½•å›¾æ ‡èµ„æº');
                    }
                } else {
                    validIcons.forEach(blob => {
                        const url = URL.createObjectURL(blob);
                        displayIcon(url);
                    });
                }

                resultContainer.style.display = 'block';

            } catch (error) {
                document.querySelector('#errorMessage').textContent = 
                    `è·å–å¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}`;
            } finally {
                loading.style.display = 'none';
            }
        }

        function displayIcon(url) {
            const container = document.getElementById('iconContainer');
            
            // é¿å…é‡å¤æ˜¾ç¤º
            if ([...container.children].some(item => item.querySelector('a').href === url)) return;

            const item = document.createElement('div');
            item.className = 'icon-item';
            item.innerHTML = `
                <img src="${url}" 
                     alt="ç½‘ç«™å›¾æ ‡" 
                     style="width:64px;height:64px;object-fit:contain;">
                <div style="margin-top:10px;">
                    <a href="${url}" 
                       target="_blank" 
                       style="word-break:break-all;font-size:12px;">
                       ${new URL(url).pathname.split('/').pop()}
                    </a>
                </div>
            `;
            container.appendChild(item);
        }

        // äº‹ä»¶ç»‘å®š
        document.getElementById('fetchButton').addEventListener('click', () => {
            const url = document.getElementById('urlInput').value.trim();
            if (!url) return showError('è¯·è¾“å…¥ç½‘ç«™åœ°å€');
            
            document.getElementById('iconContainer').innerHTML = '';
            fetchFavicon(url);
        });

        document.getElementById('urlInput').addEventListener('keypress', e => {
            if (e.key === 'Enter') document.getElementById('fetchButton').click();
        });

        function showError(msg) {
            document.getElementById('errorMessage').textContent = msg;
            document.getElementById('resultContainer').style.display = 'none';
        }
    </script>
</body>
</html>