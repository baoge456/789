<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>购销存记录</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background: #f8fafc; }
    .container { background: #f0f8ff; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); padding: 20px 10px 30px 10px; }
    .search-form .form-control, .search-form .form-select { height: 32px; font-size: 0.95rem; }
    .search-form .btn { padding: 2px 12px; font-size: 0.95rem; }
    .table th { background: #e9ecef; color: #333; }
    .table td, .table th { vertical-align: middle !important; }
    .pagination { flex-wrap: wrap; }
    @media (max-width: 768px) {
      .container { padding: 5px 2px 20px 2px; }
      .table-responsive { font-size: 0.95rem; }
      .nav-tabs .nav-link { font-size: 1rem; padding: 6px 8px; }
    }
    .btn-primary { background-color: #0d6efd; border-color: #0d6efd; }
    .btn-outline-primary { border-color: #0d6efd; color: #0d6efd; }
    .btn-outline-danger { min-width: 48px; }
    .card { backdrop-filter: blur(10px); background-color: rgba(255, 255, 255, 0.85); }
    #analysisChartContainer { position: relative; height: 300px; }
  </style>
</head>
<body>
<div class="container my-3">
  <h2 class="mb-3 text-center">购销存记录（本地版）</h2>
  <div class="mb-3 d-flex flex-wrap gap-2">
    <button class="btn btn-secondary btn-sm" onclick="exportAll()">导出全部数据</button>
    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importAll(event)">
    <button class="btn btn-secondary btn-sm" onclick="document.getElementById('importFile').click()">导入数据</button>
    <button class="btn btn-warning btn-sm" onclick="archiveOldData()">归档一年以前数据</button>
  </div>
  <ul class="nav nav-tabs" id="mainTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="product-tab" data-bs-toggle="tab" data-bs-target="#product" type="button" role="tab">商品管理</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="purchase-tab" data-bs-toggle="tab" data-bs-target="#purchase" type="button" role="tab">采购管理</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="sale-tab" data-bs-toggle="tab" data-bs-target="#sale" type="button" role="tab">销售管理</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="stock-tab" data-bs-toggle="tab" data-bs-target="#stock" type="button" role="tab">库存查询</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="analysis-tab" data-bs-toggle="tab" data-bs-target="#analysis" type="button" role="tab">数据分析</button>
    </li>
  </ul>
  <div class="tab-content mt-3" id="mainTabsContent">
    <!-- 商品管理 -->
    <div class="tab-pane fade show active" id="product" role="tabpanel">
      <form class="row g-2 mb-2 search-form" id="productSearchForm" onsubmit="searchProduct(event)">
        <div class="col-6 col-md-2"><input type="text" class="form-control" id="searchProductId" placeholder="编号"></div>
        <div class="col-6 col-md-2"><input type="text" class="form-control" id="searchProductName" placeholder="名称"></div>
        <div class="col-6 col-md-2"><input type="text" class="form-control" id="searchProductSpec" placeholder="规格"></div>
        <div class="col-6 col-md-2"><button class="btn btn-outline-primary" type="submit">检索</button></div>
        <div class="col-6 col-md-2"><button class="btn btn-outline-secondary" type="button" onclick="resetProductSearch()">重置</button></div>
      </form>
      <form id="productForm" class="row g-2 mb-2 align-items-end">
        <input type="hidden" id="productEditMode">
        <div class="col-6 col-md-2"><input type="text" class="form-control" id="productId" placeholder="商品编号" required></div>
        <div class="col-6 col-md-3"><input type="text" class="form-control" id="productName" placeholder="商品名称" required></div>
        <div class="col-6 col-md-2"><input type="text" class="form-control" id="productSpec" placeholder="规格" required></div>
        <div class="col-6 col-md-2"><input type="text" class="form-control" id="productUnit" placeholder="单位" required></div>
        <div class="col-6 col-md-2"><input type="number" class="form-control" id="productPrice" placeholder="建议零售价" min="0" step="0.01" required></div>
        <div class="col-12 col-md-1"><button type="submit" class="btn btn-primary w-100">保存</button></div>
      </form>
      <div class="table-responsive">
        <table class="table table-bordered table-sm align-middle">
          <thead>
            <tr>
              <th onclick="sortProduct('id')" style="cursor:pointer">编号</th>
              <th onclick="sortProduct('name')" style="cursor:pointer">名称</th>
              <th onclick="sortProduct('spec')" style="cursor:pointer">规格</th>
              <th onclick="sortProduct('unit')" style="cursor:pointer">单位</th>
              <th onclick="sortProduct('price')" style="cursor:pointer">建议零售价</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="productTableBody"></tbody>
        </table>
      </div>
      <div id="productPagination" class="mt-2"></div>
    </div>
    <!-- 采购管理 -->
    <div class="tab-pane fade" id="purchase" role="tabpanel">
       <form class="row g-2 mb-2 search-form" id="purchaseSearchForm" onsubmit="searchPurchase(event)">
        <div class="col-6 col-md-2"><input type="text" class="form-control" id="searchPurchaseProduct" placeholder="商品"></div>
        <div class="col-6 col-md-2"><input type="text" class="form-control" id="searchPurchaseSupplier" placeholder="供应商"></div>
        <div class="col-6 col-md-2"><input type="date" class="form-control" id="searchPurchaseDate" placeholder="日期"></div>
        <div class="col-6 col-md-1"><button class="btn btn-outline-primary" type="submit">检索</button></div>
        <div class="col-6 col-md-1"><button class="btn btn-outline-secondary" type="button" onclick="resetPurchaseSearch()">重置</button></div>
      </form>
      <form id="purchaseForm" class="row g-2 mb-2 align-items-end">
        <input type="hidden" id="purchaseEditId">
        <div class="col-6 col-md-3"><select class="form-select" id="purchaseProduct" required></select></div>
        <div class="col-6 col-md-2"><input type="text" class="form-control" id="purchaseSupplier" placeholder="供应商" required></div>
        <div class="col-6 col-md-2"><input type="number" class="form-control" id="purchaseQty" placeholder="采购数量" min="1" required></div>
        <div class="col-6 col-md-2"><input type="number" class="form-control" id="purchasePrice" placeholder="采购单价" min="0" step="0.01" required></div>
        <div class="col-6 col-md-2"><input type="date" class="form-control" id="purchaseDate" required></div>
        <div class="col-12 col-md-1"><button type="submit" class="btn btn-primary w-100">保存</button></div>
      </form>
      <div class="table-responsive">
        <table class="table table-bordered table-sm align-middle">
          <thead>
            <tr>
              <th onclick="sortPurchase('id')" style="cursor:pointer">记录ID</th>
              <th>商品</th>
              <th onclick="sortPurchase('supplier')" style="cursor:pointer">供应商</th>
              <th onclick="sortPurchase('qty')" style="cursor:pointer">数量</th>
              <th onclick="sortPurchase('price')" style="cursor:pointer">单价</th>
              <th onclick="sortPurchase('date')" style="cursor:pointer">日期</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="purchaseTableBody"></tbody>
        </table>
      </div>
      <div id="purchasePagination" class="mt-2"></div>
    </div>
    <!-- 销售管理 -->
    <div class="tab-pane fade" id="sale" role="tabpanel">
      <form class="row g-2 mb-2 search-form" id="saleSearchForm" onsubmit="searchSale(event)">
        <div class="col-6 col-md-2"><input type="text" class="form-control" id="searchSaleProduct" placeholder="商品"></div>
        <div class="col-6 col-md-2"><input type="text" class="form-control" id="searchSaleCustomer" placeholder="客户"></div>
        <div class="col-6 col-md-2"><input type="date" class="form-control" id="searchSaleDate" placeholder="日期"></div>
        <div class="col-6 col-md-1"><button class="btn btn-outline-primary" type="submit">检索</button></div>
        <div class="col-6 col-md-1"><button class="btn btn-outline-secondary" type="button" onclick="resetSaleSearch()">重置</button></div>
      </form>
      <form id="saleForm" class="row g-2 mb-2 align-items-end">
        <input type="hidden" id="saleEditId">
        <div class="col-6 col-md-3"><select class="form-select" id="saleProduct" required></select></div>
        <div class="col-6 col-md-2"><input type="text" class="form-control" id="saleCustomer" placeholder="客户" required></div>
        <div class="col-6 col-md-2"><input type="number" class="form-control" id="saleQty" placeholder="销售数量" min="1" required></div>
        <div class="col-6 col-md-2"><input type="number" class="form-control" id="salePrice" placeholder="销售单价" min="0" step="0.01" required></div>
        <div class="col-6 col-md-2"><input type="date" class="form-control" id="saleDate" required></div>
        <div class="col-12 col-md-1"><button type="submit" class="btn btn-primary w-100">保存</button></div>
      </form>
      <div class="table-responsive">
        <table class="table table-bordered table-sm align-middle">
          <thead>
            <tr>
              <th onclick="sortSale('id')" style="cursor:pointer">记录ID</th>
              <th>商品</th>
              <th onclick="sortSale('customer')" style="cursor:pointer">客户</th>
              <th onclick="sortSale('qty')" style="cursor:pointer">数量</th>
              <th onclick="sortSale('price')" style="cursor:pointer">单价</th>
              <th onclick="sortSale('date')" style="cursor:pointer">日期</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="saleTableBody"></tbody>
        </table>
      </div>
      <div id="salePagination" class="mt-2"></div>
    </div>
    <!-- 库存查询 -->
    <div class="tab-pane fade" id="stock" role="tabpanel">
      <form class="row g-2 mb-2 search-form" id="stockSearchForm" onsubmit="searchStock(event)">
        <div class="col-6 col-md-2"><input type="text" class="form-control" id="searchStockName" placeholder="名称"></div>
        <div class="col-6 col-md-2"><input type="text" class="form-control" id="searchStockSpec" placeholder="规格"></div>
        <div class="col-6 col-md-2"><input type="number" class="form-control" id="searchStockMin" placeholder="最小库存"></div>
        <div class="col-6 col-md-2"><input type="number" class="form-control" id="searchStockMax" placeholder="最大库存"></div>
        <div class="col-6 col-md-1"><button class="btn btn-outline-primary" type="submit">检索</button></div>
        <div class="col-6 col-md-1"><button class="btn btn-outline-secondary" type="button" onclick="resetStockSearch()">重置</button></div>
      </form>
      <div class="table-responsive">
        <table class="table table-bordered table-sm align-middle">
          <thead>
            <tr>
              <th onclick="sortStock('id')" style="cursor:pointer">编号</th>
              <th onclick="sortStock('name')" style="cursor:pointer">名称</th>
              <th onclick="sortStock('spec')" style="cursor:pointer">规格</th>
              <th onclick="sortStock('unit')" style="cursor:pointer">单位</th>
              <th onclick="sortStock('price')" style="cursor:pointer">建议零售价</th>
              <th>入库</th>
              <th>出库</th>
              <th onclick="sortStock('stock')" style="cursor:pointer">库存</th>
            </tr>
          </thead>
          <tbody id="stockTableBody"></tbody>
        </table>
      </div>
      <div id="stockPagination" class="mt-2"></div>
    </div>
    <!-- 数据分析 -->
    <div class="tab-pane fade" id="analysis" role="tabpanel">
      <div class="row mb-3 g-3">
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-body text-center">
                    <h5 class="card-title">总采购额</h5>
                    <p class="card-text fs-4" id="totalPurchaseAmount">0</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-body text-center">
                    <h5 class="card-title">总销售额</h5>
                    <p class="card-text fs-4" id="totalSaleAmount">0</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-body text-center">
                    <h5 class="card-title">总利润</h5>
                    <p class="card-text fs-4" id="totalProfit">0</p>
                </div>
            </div>
        </div>
      </div>

      <div class="card mb-3">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="card-title mb-0">可视化分析</h5>
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-primary active" id="showPieChartBtn" onclick="showChart('pie')">销售贡献</button>
                    <button type="button" class="btn btn-outline-primary" id="showBarChartBtn" onclick="showChart('bar')">月度趋势</button>
                </div>
            </div>
            <div id="analysisChartContainer">
                <canvas id="analysisChart"></canvas>
            </div>
        </div>
      </div>
      
      <h4 class="mt-4">商品分析详情</h4>
      <div class="table-responsive">
        <table class="table table-bordered table-sm">
          <thead>
            <tr>
              <th onclick="sortAnalysis('name')" style="cursor:pointer">商品名称</th>
              <th onclick="sortAnalysis('totalPurchaseQty')" style="cursor:pointer">总采购数</th>
              <th onclick="sortAnalysis('avgPurchasePrice')" style="cursor:pointer">平均采购价</th>
              <th onclick="sortAnalysis('totalSaleQty')" style="cursor:pointer">总销售数</th>
              <th onclick="sortAnalysis('avgSalePrice')" style="cursor:pointer">平均销售价</th>
              <th onclick="sortAnalysis('grossProfitMargin')" style="cursor:pointer">毛利率</th>
              <th onclick="sortAnalysis('stock')" style="cursor:pointer">当前库存</th>
              <th onclick="sortAnalysis('salesRank')" style="cursor:pointer">畅销排名</th>
            </tr>
          </thead>
          <tbody id="analysisTableBody"></tbody>
        </table>
      </div>
    </div>
  </div> <!-- tab-content -->
</div> <!-- container -->
<script>
// ========== 数据模型与存储 ==========
let products = JSON.parse(localStorage.getItem('products') || '[]');
let purchases = JSON.parse(localStorage.getItem('purchases') || '[]');
let sales = JSON.parse(localStorage.getItem('sales') || '[]');
let analysisChart = null; // 用于存储Chart.js实例

function saveAll() {
  localStorage.setItem('products', JSON.stringify(products));
  localStorage.setItem('purchases', JSON.stringify(purchases));
  localStorage.setItem('sales', JSON.stringify(sales));
}
function genId(prefix) {
  return prefix + '-' + Date.now() + '-' + Math.floor(Math.random()*10000);
}
function findProductById(pid) {
  return products.find(p => p.id === pid);
}

// ========== 商品管理 ==========
let productSearchResult = null, productPage = 1, productPageSize = 10, productSortKey = 'name', productSortAsc = true;

function renderProductTable() {
  const tbody = document.getElementById('productTableBody');
  tbody.innerHTML = '';
  let data = productSearchResult || products;
  data = [...data].sort((a, b) => {
    let v1 = a[productSortKey], v2 = b[productSortKey];
    if (typeof v1 === 'string') v1 = v1.toLowerCase();
    if (typeof v2 === 'string') v2 = v2.toLowerCase();
    if (v1 < v2) return productSortAsc ? -1 : 1;
    if (v1 > v2) return productSortAsc ? 1 : -1;
    return 0;
  });
  const total = data.length, pageCount = Math.ceil(total / productPageSize);
  if (productPage > pageCount) productPage = pageCount || 1;
  const start = (productPage - 1) * productPageSize;
  const pageData = data.slice(start, start + productPageSize);
  for (const p of pageData) {
    tbody.innerHTML += `
      <tr>
        <td>${p.id}</td>
        <td>${p.name}</td>
        <td>${p.spec}</td>
        <td>${p.unit}</td>
        <td>${p.price}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary" onclick="editProduct('${p.id}')">编辑</button>
          <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct('${p.id}')">删除</button>
        </td>
      </tr>
    `;
  }
  document.getElementById('productPagination').innerHTML = renderPagination(productPage, pageCount, 'product');
}
function resetProductForm() {
    document.getElementById('productForm').reset();
    document.getElementById('productEditMode').value = '';
    const idInput = document.getElementById('productId');
    idInput.readOnly = false;
    idInput.classList.remove('is-valid', 'is-invalid');
}
function resetProductSearch() {
  document.getElementById('productSearchForm').reset();
  productSearchResult = null;
  productPage = 1;
  renderProductTable();
}
function searchProduct(e) {
  e.preventDefault();
  const id = document.getElementById('searchProductId').value.trim();
  const name = document.getElementById('searchProductName').value.trim();
  const spec = document.getElementById('searchProductSpec').value.trim();
  productSearchResult = products.filter(p =>
    (!id || p.id.includes(id)) &&
    (!name || p.name.includes(name)) &&
    (!spec || p.spec.includes(spec))
  );
  productPage = 1;
  renderProductTable();
}
function editProduct(id) {
  const p = products.find(x => x.id === id);
  if (!p) return;
  resetProductForm();
  document.getElementById('productEditMode').value = 'edit';
  const idInput = document.getElementById('productId');
  idInput.value = p.id;
  idInput.readOnly = true; // 编辑时编号不可修改
  document.getElementById('productName').value = p.name;
  document.getElementById('productSpec').value = p.spec;
  document.getElementById('productUnit').value = p.unit;
  document.getElementById('productPrice').value = p.price;
}
function deleteProduct(id) {
  if (!confirm(`确定要删除商品【${id}】吗？这将一并删除所有相关的采购和销售记录。`)) return;
  products = products.filter(x => x.id !== id);
  purchases = purchases.filter(x => x.productId !== id);
  sales = sales.filter(x => x.productId !== id);
  saveAll();
  updateAllRender();
}
document.getElementById('productForm').onsubmit = function(e) {
  e.preventDefault();
  const isEditMode = document.getElementById('productEditMode').value === 'edit';
  const id = document.getElementById('productId').value.trim();
  const name = document.getElementById('productName').value.trim();
  const spec = document.getElementById('productSpec').value.trim();
  const unit = document.getElementById('productUnit').value.trim();
  const price = Number(document.getElementById('productPrice').value);
  
  if (!id || !name || !spec || !unit || isNaN(price)) return alert('请填写完整信息');

  if (isEditMode) {
    const p = products.find(x => x.id === id);
    if (p) Object.assign(p, { name, spec, unit, price });
  } else {
    if (products.some(p => p.id === id)) {
        alert(`商品编号【${id}】已存在，请使用其他编号。`);
        return;
    }
    products.push({ id, name, spec, unit, price });
  }
  saveAll();
  resetProductForm();
  updateAllRender();
};
window.editProduct = editProduct;
window.deleteProduct = deleteProduct;
window.sortProduct = sortProduct;
window.productPageTo = productPageTo;
window.resetProductSearch = resetProductSearch;

// ========== 采购与销售通用 ==========
function renderPurchaseProductOptions() {
  const sel = document.getElementById('purchaseProduct');
  sel.innerHTML = products.map(p => `<option value="${p.id}">${p.name} (${p.spec})</option>`).join('') || '<option>请先添加商品</option>';
}
function renderSaleProductOptions() {
  const sel = document.getElementById('saleProduct');
  sel.innerHTML = products.map(p => `<option value="${p.id}">${p.name} (${p.spec})</option>`).join('') || '<option>请先添加商品</option>';
}

// ========== 采购管理 ==========
let purchaseSearchResult = null, purchasePage = 1, purchasePageSize = 10, purchaseSortKey = 'date', purchaseSortAsc = false;
function renderPurchaseTable() {
  const tbody = document.getElementById('purchaseTableBody');
  tbody.innerHTML = '';
  let data = purchaseSearchResult || purchases;
  data = [...data].sort((a, b) => {
    let v1 = a[purchaseSortKey], v2 = b[purchaseSortKey];
    if (purchaseSortKey === 'date') { v1 = new Date(v1); v2 = new Date(v2); }
    if (typeof v1 === 'string') v1 = v1.toLowerCase(); if (typeof v2 === 'string') v2 = v2.toLowerCase();
    if (v1 < v2) return purchaseSortAsc ? -1 : 1; if (v1 > v2) return purchaseSortAsc ? 1 : -1;
    return 0;
  });
  const total = data.length, pageCount = Math.ceil(total / purchasePageSize);
  if (purchasePage > pageCount) purchasePage = pageCount || 1;
  const start = (purchasePage - 1) * purchasePageSize;
  const pageData = data.slice(start, start + purchasePageSize);
  for (const p of pageData) {
    const prod = findProductById(p.productId) || {};
    tbody.innerHTML += `
      <tr>
        <td>${p.id}</td>
        <td>${prod.name || '商品已删除'} ${prod.spec || ''}</td>
        <td>${p.supplier || ''}</td>
        <td>${p.qty}</td>
        <td>${p.price}</td>
        <td>${p.date}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary" onclick="editPurchase('${p.id}')">编辑</button>
          <button class="btn btn-sm btn-outline-danger" onclick="deletePurchase('${p.id}')">删除</button>
        </td>
      </tr>
    `;
  }
  document.getElementById('purchasePagination').innerHTML = renderPagination(purchasePage, pageCount, 'purchase');
}
function resetPurchaseSearch() {
  document.getElementById('purchaseSearchForm').reset();
  purchaseSearchResult = null;
  purchasePage = 1;
  renderPurchaseTable();
}
function searchPurchase(e) {
  e.preventDefault();
  const prod = document.getElementById('searchPurchaseProduct').value.trim();
  const supplier = document.getElementById('searchPurchaseSupplier').value.trim();
  const date = document.getElementById('searchPurchaseDate').value.trim();
  purchaseSearchResult = purchases.filter(p => {
    const prodName = (findProductById(p.productId)?.name || '');
    return (!prod || prodName.includes(prod)) &&
      (!supplier || (p.supplier || '').includes(supplier)) &&
      (!date || p.date === date);
  });
  purchasePage = 1;
  renderPurchaseTable();
}
function editPurchase(id) {
  const p = purchases.find(x => x.id === id);
  if (!p) return;
  document.getElementById('purchaseEditId').value = p.id;
  document.getElementById('purchaseProduct').value = p.productId;
  document.getElementById('purchaseSupplier').value = p.supplier;
  document.getElementById('purchaseQty').value = p.qty;
  document.getElementById('purchasePrice').value = p.price;
  document.getElementById('purchaseDate').value = p.date;
}
function deletePurchase(id) {
  if (!confirm('确定要删除该采购记录吗？')) return;
  purchases = purchases.filter(x => x.id !== id);
  saveAll();
  updateAllRender();
}
document.getElementById('purchaseForm').onsubmit = function(e) {
  e.preventDefault();
  const id = document.getElementById('purchaseEditId').value;
  const productId = document.getElementById('purchaseProduct').value;
  const supplier = document.getElementById('purchaseSupplier').value.trim();
  const qty = Number(document.getElementById('purchaseQty').value);
  const price = Number(document.getElementById('purchasePrice').value);
  const date = document.getElementById('purchaseDate').value;
  if (!productId || !supplier || isNaN(qty) || isNaN(price) || !date) return alert('请填写完整信息');
  if (id) {
    const p = purchases.find(x => x.id === id);
    if (p) Object.assign(p, { productId, supplier, qty, price, date });
  } else {
    purchases.push({ id: genId('pur'), productId, supplier, qty, price, date });
  }
  saveAll();
  this.reset();
  document.getElementById('purchaseEditId').value = '';
  updateAllRender();
};
window.editPurchase = editPurchase;
window.deletePurchase = deletePurchase;
window.sortPurchase = sortPurchase;
window.purchasePageTo = purchasePageTo;
window.resetPurchaseSearch = resetPurchaseSearch;

// ========== 销售管理 ==========
let saleSearchResult = null, salePage = 1, salePageSize = 10, saleSortKey = 'date', saleSortAsc = false;
function renderSaleTable() {
  const tbody = document.getElementById('saleTableBody');
  tbody.innerHTML = '';
  let data = saleSearchResult || sales;
  data = [...data].sort((a, b) => {
    let v1 = a[saleSortKey], v2 = b[saleSortKey];
    if (saleSortKey === 'date') { v1 = new Date(v1); v2 = new Date(v2); }
    if (typeof v1 === 'string') v1 = v1.toLowerCase(); if (typeof v2 === 'string') v2 = v2.toLowerCase();
    if (v1 < v2) return saleSortAsc ? -1 : 1; if (v1 > v2) return saleSortAsc ? 1 : -1;
    return 0;
  });
  const total = data.length, pageCount = Math.ceil(total / salePageSize);
  if (salePage > pageCount) salePage = pageCount || 1;
  const start = (salePage - 1) * salePageSize;
  const pageData = data.slice(start, start + salePageSize);
  for (const s of pageData) {
    const prod = findProductById(s.productId) || {};
    tbody.innerHTML += `
      <tr>
        <td>${s.id}</td>
        <td>${prod.name || '商品已删除'} ${prod.spec || ''}</td>
        <td>${s.customer || ''}</td>
        <td>${s.qty}</td>
        <td>${s.price}</td>
        <td>${s.date}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary" onclick="editSale('${s.id}')">编辑</button>
          <button class="btn btn-sm btn-outline-danger" onclick="deleteSale('${s.id}')">删除</button>
        </td>
      </tr>
    `;
  }
  document.getElementById('salePagination').innerHTML = renderPagination(salePage, pageCount, 'sale');
}
function resetSaleSearch() {
  document.getElementById('saleSearchForm').reset();
  saleSearchResult = null;
  salePage = 1;
  renderSaleTable();
}
function searchSale(e) {
  e.preventDefault();
  const prod = document.getElementById('searchSaleProduct').value.trim();
  const customer = document.getElementById('searchSaleCustomer').value.trim();
  const date = document.getElementById('searchSaleDate').value.trim();
  saleSearchResult = sales.filter(s => {
    const prodName = (findProductById(s.productId)?.name || '');
    return (!prod || prodName.includes(prod)) &&
      (!customer || (s.customer || '').includes(customer)) &&
      (!date || s.date === date);
  });
  salePage = 1;
  renderSaleTable();
}
function editSale(id) {
  const s = sales.find(x => x.id === id);
  if (!s) return;
  document.getElementById('saleEditId').value = s.id;
  document.getElementById('saleProduct').value = s.productId;
  document.getElementById('saleCustomer').value = s.customer;
  document.getElementById('saleQty').value = s.qty;
  document.getElementById('salePrice').value = s.price;
  document.getElementById('saleDate').value = s.date;
}
function deleteSale(id) {
  if (!confirm('确定要删除该销售记录吗？')) return;
  sales = sales.filter(x => x.id !== id);
  saveAll();
  updateAllRender();
}
document.getElementById('saleForm').onsubmit = function(e) {
  e.preventDefault();
  const id = document.getElementById('saleEditId').value;
  const productId = document.getElementById('saleProduct').value;
  const customer = document.getElementById('saleCustomer').value.trim();
  const qty = Number(document.getElementById('saleQty').value);
  const price = Number(document.getElementById('salePrice').value);
  const date = document.getElementById('saleDate').value;
  if (!productId || !customer || isNaN(qty) || isNaN(price) || !date) return alert('请填写完整信息');
  if (id) {
    const s = sales.find(x => x.id === id);
    if (s) Object.assign(s, { productId, customer, qty, price, date });
  } else {
    sales.push({ id: genId('sale'), productId, customer, qty, price, date });
  }
  saveAll();
  this.reset();
  document.getElementById('saleEditId').value = '';
  updateAllRender();
};
window.editSale = editSale;
window.deleteSale = deleteSale;
window.sortSale = sortSale;
window.salePageTo = salePageTo;
window.resetSaleSearch = resetSaleSearch;

// ========== 库存统计与渲染 ==========
function calcStock() {
  const stockMap = {};
  products.forEach(p => stockMap[p.id] = { ...p, stock: 0, inQty: 0, outQty: 0 });
  purchases.forEach(p => {
    if (stockMap[p.productId]) {
      stockMap[p.productId].inQty += Number(p.qty);
      stockMap[p.productId].stock += Number(p.qty);
    }
  });
  sales.forEach(s => {
    if (stockMap[s.productId]) {
      stockMap[s.productId].outQty += Number(s.qty);
      stockMap[s.productId].stock -= Number(s.qty);
    }
  });
  return Object.values(stockMap);
}
let stockSearchResult = null, stockPage = 1, stockPageSize = 10, stockSortKey = 'name', stockSortAsc = true;
function renderStockTable() {
  const tbody = document.getElementById('stockTableBody');
  tbody.innerHTML = '';
  let data = stockSearchResult || calcStock();
  data = [...data].sort((a, b) => {
    let v1 = a[stockSortKey], v2 = b[stockSortKey];
    if (typeof v1 === 'string') v1 = v1.toLowerCase(); if (typeof v2 === 'string') v2 = v2.toLowerCase();
    if (v1 < v2) return stockSortAsc ? -1 : 1; if (v1 > v2) return stockSortAsc ? 1 : -1;
    return 0;
  });
  const total = data.length, pageCount = Math.ceil(total / stockPageSize);
  if (stockPage > pageCount) stockPage = pageCount || 1;
  const start = (stockPage - 1) * stockPageSize;
  const pageData = data.slice(start, start + stockPageSize);
  for (const s of pageData) {
    tbody.innerHTML += `
      <tr>
        <td>${s.id}</td>
        <td>${s.name}</td>
        <td>${s.spec}</td>
        <td>${s.unit}</td>
        <td>${s.price}</td>
        <td>${s.inQty}</td>
        <td>${s.outQty}</td>
        <td>${s.stock}</td>
      </tr>
    `;
  }
  document.getElementById('stockPagination').innerHTML = renderPagination(stockPage, pageCount, 'stock');
}
function resetStockSearch() {
  document.getElementById('stockSearchForm').reset();
  stockSearchResult = null;
  stockPage = 1;
  renderStockTable();
}
function searchStock(e) {
  e.preventDefault();
  const name = document.getElementById('searchStockName').value.trim();
  const spec = document.getElementById('searchStockSpec').value.trim();
  const minStock = document.getElementById('searchStockMin').value.trim();
  const maxStock = document.getElementById('searchStockMax').value.trim();
  stockSearchResult = calcStock().filter(s =>
    (!name || s.name.includes(name)) &&
    (!spec || s.spec.includes(spec)) &&
    (!minStock || s.stock >= Number(minStock)) &&
    (!maxStock || s.stock <= Number(maxStock))
  );
  stockPage = 1;
  renderStockTable();
}
window.sortStock = sortStock;
window.stockPageTo = stockPageTo;
window.resetStockSearch = resetStockSearch;

// ========== 分页控件渲染 ==========
function renderPagination(page, pageCount, type) {
  if (pageCount <= 1) return '';
  let html = `<nav><ul class="pagination pagination-sm mb-0">`;
  html += `<li class="page-item${page === 1 ? ' disabled' : ''}"><a class="page-link" href="#" onclick="${type}PageTo(${page - 1});return false;">«</a></li>`;
  for (let i = 1; i <= pageCount; i++) {
    if (i === 1 || i === pageCount || Math.abs(i - page) <= 1) {
      html += `<li class="page-item${i === page ? ' active' : ''}"><a class="page-link" href="#" onclick="${type}PageTo(${i});return false;">${i}</a></li>`;
    } else if (i === page - 2 || i === page + 2) {
      html += `<li class="page-item disabled"><span class="page-link">…</span></li>`;
    }
  }
  html += `<li class="page-item${page === pageCount ? ' disabled' : ''}"><a class="page-link" href="#" onclick="${type}PageTo(${page + 1});return false;">»</a></li>`;
  html += `</ul></nav>`;
  return html;
}
function productPageTo(p) { productPage = p; renderProductTable(); }
function purchasePageTo(p) { purchasePage = p; renderPurchaseTable(); }
function salePageTo(p) { salePage = p; renderSaleTable(); }
function stockPageTo(p) { stockPage = p; renderStockTable(); }

function sortGeneric(state, key) {
    if (state.key === key) {
        state.asc = !state.asc;
    } else {
        state.key = key;
        state.asc = true;
    }
}
function sortProduct(key) { sortGeneric({key: productSortKey, asc: productSortAsc}, key); productSortKey = key; renderProductTable(); }
function sortPurchase(key) { sortGeneric({key: purchaseSortKey, asc: purchaseSortAsc}, key); purchaseSortKey = key; renderPurchaseTable(); }
function sortSale(key) { sortGeneric({key: saleSortKey, asc: saleSortAsc}, key); saleSortKey = key; renderSaleTable(); }
function sortStock(key) { sortGeneric({key: stockSortKey, asc: stockSortAsc}, key); stockSortKey = key; renderStockTable(); }

// ========== 数据分析 ==========
let analysisData = [];
let analysisSortKey = 'salesRank', analysisSortAsc = true;
let currentChartType = 'pie';

function calculateAnalysisData() {
  const analysisMap = {};
  products.forEach(p => {
    analysisMap[p.id] = { ...p, totalPurchaseQty: 0, totalPurchaseAmount: 0, totalSaleQty: 0, totalSaleAmount: 0 };
  });
  purchases.forEach(p => {
    if (analysisMap[p.productId]) {
      analysisMap[p.productId].totalPurchaseQty += Number(p.qty);
      analysisMap[p.productId].totalPurchaseAmount += Number(p.qty) * Number(p.price);
    }
  });
  sales.forEach(s => {
    if (analysisMap[s.productId]) {
      analysisMap[s.productId].totalSaleQty += Number(s.qty);
      analysisMap[s.productId].totalSaleAmount += Number(s.qty) * Number(s.price);
    }
  });
  const analysisResult = Object.values(analysisMap).map(item => {
    const avgPurchasePrice = item.totalPurchaseQty > 0 ? item.totalPurchaseAmount / item.totalPurchaseQty : 0;
    const avgSalePrice = item.totalSaleQty > 0 ? item.totalSaleAmount / item.totalSaleQty : 0;
    const grossProfitMargin = avgSalePrice > 0 ? ((avgSalePrice - avgPurchasePrice) / avgSalePrice) * 100 : 0;
    return { ...item, avgPurchasePrice: avgPurchasePrice.toFixed(2), avgSalePrice: avgSalePrice.toFixed(2), grossProfitMargin: grossProfitMargin.toFixed(2), stock: item.totalPurchaseQty - item.totalSaleQty };
  });
  analysisResult.sort((a, b) => b.totalSaleQty - a.totalSaleQty);
  analysisResult.forEach((d, index) => d.salesRank = index + 1);
  return analysisResult;
}

function renderAnalysis() {
  analysisData = calculateAnalysisData();
  const productAvgPurchasePrice = analysisData.reduce((acc, item) => {
    acc[item.id] = parseFloat(item.avgPurchasePrice); return acc;
  }, {});

  const totalPurchaseAmount = purchases.reduce((sum, p) => sum + Number(p.qty) * Number(p.price), 0);
  const totalSaleAmount = sales.reduce((sum, s) => sum + Number(s.qty) * Number(s.price), 0);
  const totalCostOfGoodsSold = sales.reduce((sum, s) => sum + Number(s.qty) * (productAvgPurchasePrice[s.productId] || 0), 0);
  const totalProfit = totalSaleAmount - totalCostOfGoodsSold;
  
  document.getElementById('totalPurchaseAmount').textContent = '¥ ' + totalPurchaseAmount.toFixed(2);
  document.getElementById('totalSaleAmount').textContent = '¥ ' + totalSaleAmount.toFixed(2);
  document.getElementById('totalProfit').textContent = '¥ ' + totalProfit.toFixed(2);

  renderAnalysisTable();
  showChart(currentChartType);
}

function renderAnalysisTable() {
    const tbody = document.getElementById('analysisTableBody');
    tbody.innerHTML = '';
    const sortedData = [...analysisData].sort((a, b) => {
        let v1 = a[analysisSortKey], v2 = b[analysisSortKey];
        if (['name'].includes(analysisSortKey)) {
             v1 = (v1 || '').toLowerCase(); v2 = (v2 || '').toLowerCase();
        } else {
            v1 = Number(v1); v2 = Number(v2);
        }
        if (v1 < v2) return analysisSortAsc ? -1 : 1; if (v1 > v2) return analysisSortAsc ? 1 : -1;
        return 0;
    });
    for (const item of sortedData) {
        tbody.innerHTML += `
            <tr>
                <td>${item.name} (${item.spec})</td>
                <td>${item.totalPurchaseQty}</td>
                <td>${item.avgPurchasePrice}</td>
                <td>${item.totalSaleQty}</td>
                <td>${item.avgSalePrice}</td>
                <td>${item.grossProfitMargin}%</td>
                <td>${item.stock}</td>
                <td>${item.salesRank}</td>
            </tr>
        `;
    }
}
function sortAnalysis(key) {
    if (analysisSortKey === key) analysisSortAsc = !analysisSortAsc;
    else { analysisSortKey = key; analysisSortAsc = true; }
    renderAnalysisTable();
}
window.sortAnalysis = sortAnalysis;
window.showChart = showChart;

function showChart(type) {
    currentChartType = type;
    document.getElementById('showPieChartBtn').classList.toggle('active', type === 'pie');
    document.getElementById('showBarChartBtn').classList.toggle('active', type === 'bar');
    const ctx = document.getElementById('analysisChart').getContext('2d');
    if (analysisChart) analysisChart.destroy();

    if (type === 'pie') {
        const pieData = analysisData.filter(d => d.totalSaleAmount > 0);
        analysisChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: pieData.map(d => d.name),
                datasets: [{
                    data: pieData.map(d => d.totalSaleAmount),
                    backgroundColor: ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff', '#ff9f40', '#c9cbcf'],
                    borderColor: '#fff',
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, position: 'right' } } }
        });
    } else if (type === 'bar') {
        const productAvgPurchasePrice = analysisData.reduce((acc, item) => {
            acc[item.id] = parseFloat(item.avgPurchasePrice); return acc;
        }, {});
        
        const last6Months = [...Array(6)].map((_, i) => {
            const d = new Date();
            d.setMonth(d.getMonth() - i);
            return d.getFullYear() + '-' + ('0' + (d.getMonth() + 1)).slice(-2);
        }).reverse();
        
        const monthlyData = last6Months.map(month => {
            const monthlyPurchases = purchases.filter(p => p.date.startsWith(month)).reduce((sum, p) => sum + p.qty * p.price, 0);
            
            const monthlySalesRecords = sales.filter(s => s.date.startsWith(month));
            const monthlySaleAmount = monthlySalesRecords.reduce((sum, s) => sum + s.qty * s.price, 0);
            const monthlyCostOfGoodsSold = monthlySalesRecords.reduce((sum, s) => sum + Number(s.qty) * (productAvgPurchasePrice[s.productId] || 0), 0);
            const monthlyProfit = monthlySaleAmount - monthlyCostOfGoodsSold;

            return { month, purchases: monthlyPurchases, sales: monthlySaleAmount, profit: monthlyProfit };
        });

        analysisChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: monthlyData.map(d => d.month),
                datasets: [
                    {
                        label: '采购额',
                        data: monthlyData.map(d => d.purchases),
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                    },
                    {
                        label: '销售额',
                        data: monthlyData.map(d => d.sales),
                        backgroundColor: 'rgba(255, 99, 132, 0.7)',
                    },
                    {
                        label: '月利润',
                        data: monthlyData.map(d => d.profit),
                        borderColor: '#4bc0c0',
                        backgroundColor: '#4bc0c0',
                        tension: 0.1,
                        fill: false,
                        type: 'line'
                    }
                ]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                scales: { 
                    y: { 
                        beginAtZero: true 
                    } 
                }, 
                plugins: { 
                    legend: { 
                        display: true, 
                        position: 'top' 
                    } 
                } 
            }
        });
    }
}

// ========== 数据导入导出与归档 ==========
function exportAll() {
  const data = { products, purchases, sales };
  const ts = new Date().toISOString().replace(/[-:T]/g, '').slice(0, 14);
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `购销存数据_${ts}.json`;
  a.click();
}
function importAll(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    let data;
    try { data = JSON.parse(e.target.result); } catch { return alert('文件格式错误'); }
    if (typeof data.products === 'undefined' || typeof data.purchases === 'undefined' || typeof data.sales === 'undefined') return alert('数据结构不正确，必须包含products, purchases, sales数组');
    if (confirm('导入数据时请选择“确定”覆盖，或“取消”追加。\n覆盖：将完全替换现有数据。\n追加：将新增数据，ID相同的数据不会被覆盖。')) {
      products = data.products || []; purchases = data.purchases || []; sales = data.sales || [];
    } else {
      const existingPids = new Set(products.map(p=>p.id)); (data.products||[]).forEach(p=>{if(!existingPids.has(p.id))products.push(p);});
      const existingPuids = new Set(purchases.map(p=>p.id)); (data.purchases||[]).forEach(p=>{if(!existingPuids.has(p.id))purchases.push(p);});
      const existingSids = new Set(sales.map(s=>s.id)); (data.sales||[]).forEach(s=>{if(!existingSids.has(s.id))sales.push(s);});
    }
    saveAll();
    updateAllRender();
    alert('导入成功！');
  };
  reader.readAsText(file);
  event.target.value = '';
}
function archiveOldData() {
  const yearAgo = new Date();
  yearAgo.setFullYear(yearAgo.getFullYear() - 1);
  const oldPurchases = purchases.filter(p => new Date(p.date) < yearAgo);
  const oldSales = sales.filter(s => new Date(s.date) < yearAgo);
  if (!oldPurchases.length && !oldSales.length) return alert('没有可归档的数据（一年以前的记录）');
  if (!confirm(`将归档 ${oldPurchases.length} 条采购记录和 ${oldSales.length} 条销售记录。归档后数据将从当前应用中移除并下载为文件。确定吗？`)) return;
  const archiveData = { purchases: oldPurchases, sales: oldSales };
  const ts = new Date().toISOString().replace(/[-:T]/g, '').slice(0, 14);
  const blob = new Blob([JSON.stringify(archiveData, null, 2)], { type: 'application/json' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `归档数据_${ts}.json`; a.click();
  purchases = purchases.filter(p => new Date(p.date) >= yearAgo);
  sales = sales.filter(s => new Date(s.date) >= yearAgo);
  saveAll();
  updateAllRender();
  alert('归档并清理完成！');
}

// ========== 页面初始化 ==========
function updateAllRender() {
  renderProductTable();
  renderPurchaseProductOptions();
  renderSaleProductOptions();
  renderPurchaseTable();
  renderSaleTable();
  renderStockTable();
  if (document.getElementById('analysis-tab').classList.contains('active')) {
    renderAnalysis();
  }
}
document.addEventListener('DOMContentLoaded', function() {
  updateAllRender();
  document.getElementById('analysis-tab').addEventListener('shown.bs.tab', renderAnalysis);
});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>