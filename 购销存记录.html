<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>购销存记录</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <style>
    .search-form .form-control, .search-form .form-select { height: 32px; font-size: 0.95rem; }
    .search-form .btn { padding: 2px 12px; font-size: 0.95rem; }
    .table td, .table th { vertical-align: middle !important; }
  </style>
</head>
<body>
<div class="container my-4">
  <h2 class="mb-4">购销存记录（本地版）</h2>
  <div class="mb-3">
    <button class="btn btn-secondary btn-sm" onclick="exportAll()">导出全部数据</button>
    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importAll(event)">
    <button class="btn btn-secondary btn-sm" onclick="document.getElementById('importFile').click()">导入数据</button>
  </div>
  <ul class="nav nav-tabs" id="mainTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="product-tab" data-bs-toggle="tab" data-bs-target="#product" type="button" role="tab">商品管理</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="purchase-tab" data-bs-toggle="tab" data-bs-target="#purchase" type="button" role="tab">采购管理</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="sale-tab" data-bs-toggle="tab" data-bs-target="#sale" type="button" role="tab">销售管理</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="stock-tab" data-bs-toggle="tab" data-bs-target="#stock" type="button" role="tab">库存查询</button>
    </li>
  </ul>
  <div class="tab-content mt-3" id="mainTabsContent">
    <!-- 商品管理 -->
    <div class="tab-pane fade show active" id="product" role="tabpanel">
      <form class="row g-2 mb-2 search-form" id="productSearchForm" onsubmit="searchProduct(event)">
        <div class="col-md-2"><input type="text" class="form-control" id="searchProductName" placeholder="名称"></div>
        <div class="col-md-2"><input type="text" class="form-control" id="searchProductSpec" placeholder="规格"></div>
        <div class="col-md-2"><input type="text" class="form-control" id="searchProductUnit" placeholder="单位"></div>
        <div class="col-md-2"><input type="number" class="form-control" id="searchProductPrice" placeholder="单价"></div>
        <div class="col-md-2"><button class="btn btn-outline-primary" type="submit">检索</button></div>
        <div class="col-md-2"><button class="btn btn-outline-secondary" type="button" onclick="resetProductSearch()">重置</button></div>
      </form>
      <div class="mb-3">
        <form id="productForm" class="row g-2">
          <input type="hidden" id="productEditId">
          <div class="col-md-3">
            <input type="text" class="form-control" id="productName" placeholder="商品名称" required>
          </div>
          <div class="col-md-2">
            <input type="text" class="form-control" id="productSpec" placeholder="规格" required>
          </div>
          <div class="col-md-2">
            <input type="text" class="form-control" id="productUnit" placeholder="单位" required>
          </div>
          <div class="col-md-2">
            <input type="number" class="form-control" id="productPrice" placeholder="单价" min="0" step="0.01" required>
          </div>
          <div class="col-md-2">
            <button type="submit" class="btn btn-primary" id="productSubmitBtn">添加商品</button>
            <button type="button" class="btn btn-secondary d-none" id="productCancelBtn" onclick="resetProductForm()">取消编辑</button>
          </div>
        </form>
      </div>
      <table class="table table-bordered table-sm align-middle">
        <thead>
          <tr>
            <th>商品编号</th>
            <th>名称</th>
            <th>规格</th>
            <th>单位</th>
            <th>单价</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="productTableBody"></tbody>
      </table>
    </div>
    <!-- 采购管理 -->
    <div class="tab-pane fade" id="purchase" role="tabpanel">
      <form class="row g-2 mb-2 search-form" id="purchaseSearchForm" onsubmit="searchPurchase(event)">
        <div class="col-md-2"><input type="text" class="form-control" id="searchPurchaseProduct" placeholder="商品"></div>
        <div class="col-md-2"><input type="text" class="form-control" id="searchPurchaseSupplier" placeholder="供应商"></div>
        <div class="col-md-2"><input type="number" class="form-control" id="searchPurchaseQty" placeholder="数量"></div>
        <div class="col-md-2"><input type="number" class="form-control" id="searchPurchasePrice" placeholder="单价"></div>
        <div class="col-md-2"><input type="text" class="form-control" id="searchPurchaseDate" placeholder="日期"></div>
        <div class="col-md-1"><button class="btn btn-outline-primary" type="submit">检索</button></div>
        <div class="col-md-1"><button class="btn btn-outline-secondary" type="button" onclick="resetPurchaseSearch()">重置</button></div>
      </form>
      <div class="mb-3">
        <form id="purchaseForm" class="row g-2">
          <input type="hidden" id="purchaseEditId">
          <div class="col-md-3">
            <select class="form-select" id="purchaseProduct" required></select>
          </div>
          <div class="col-md-2">
            <input type="number" class="form-control" id="purchaseQty" placeholder="采购数量" min="1" required>
          </div>
          <div class="col-md-2">
            <input type="number" class="form-control" id="purchasePrice" placeholder="采购单价" min="0" step="0.01" required>
          </div>
          <div class="col-md-3">
            <input type="text" class="form-control" id="purchaseSupplier" placeholder="供应商" required>
          </div>
          <div class="col-md-2">
            <button type="submit" class="btn btn-success" id="purchaseSubmitBtn">录入采购</button>
            <button type="button" class="btn btn-secondary d-none" id="purchaseCancelBtn" onclick="resetPurchaseForm()">取消编辑</button>
          </div>
        </form>
      </div>
      <table class="table table-bordered table-sm align-middle">
        <thead>
          <tr>
            <th>采购单号</th>
            <th>商品</th>
            <th>数量</th>
            <th>单价</th>
            <th>金额</th>
            <th>供应商</th>
            <th>日期</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="purchaseTableBody"></tbody>
      </table>
    </div>
    <!-- 销售管理 -->
    <div class="tab-pane fade" id="sale" role="tabpanel">
      <form class="row g-2 mb-2 search-form" id="saleSearchForm" onsubmit="searchSale(event)">
        <div class="col-md-2"><input type="text" class="form-control" id="searchSaleProduct" placeholder="商品"></div>
        <div class="col-md-2"><input type="text" class="form-control" id="searchSaleCustomer" placeholder="客户"></div>
        <div class="col-md-2"><input type="number" class="form-control" id="searchSaleQty" placeholder="数量"></div>
        <div class="col-md-2"><input type="number" class="form-control" id="searchSalePrice" placeholder="单价"></div>
        <div class="col-md-2"><input type="text" class="form-control" id="searchSaleDate" placeholder="日期"></div>
        <div class="col-md-1"><button class="btn btn-outline-primary" type="submit">检索</button></div>
        <div class="col-md-1"><button class="btn btn-outline-secondary" type="button" onclick="resetSaleSearch()">重置</button></div>
      </form>
      <div class="mb-3">
        <form id="saleForm" class="row g-2">
          <input type="hidden" id="saleEditId">
          <div class="col-md-3">
            <select class="form-select" id="saleProduct" required></select>
          </div>
          <div class="col-md-2">
            <input type="number" class="form-control" id="saleQty" placeholder="销售数量" min="1" required>
          </div>
          <div class="col-md-2">
            <input type="number" class="form-control" id="salePrice" placeholder="销售单价" min="0" step="0.01" required>
          </div>
          <div class="col-md-3">
            <input type="text" class="form-control" id="saleCustomer" placeholder="客户" required>
          </div>
          <div class="col-md-2">
            <button type="submit" class="btn btn-danger" id="saleSubmitBtn">录入销售</button>
            <button type="button" class="btn btn-secondary d-none" id="saleCancelBtn" onclick="resetSaleForm()">取消编辑</button>
          </div>
        </form>
      </div>
      <table class="table table-bordered table-sm align-middle">
        <thead>
          <tr>
            <th>销售单号</th>
            <th>商品</th>
            <th>数量</th>
            <th>单价</th>
            <th>金额</th>
            <th>客户</th>
            <th>日期</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="saleTableBody"></tbody>
      </table>
    </div>
    <!-- 库存查询 -->
    <div class="tab-pane fade" id="stock" role="tabpanel">
      <form class="row g-2 mb-2 search-form" id="stockSearchForm" onsubmit="searchStock(event)">
        <div class="col-md-2"><input type="text" class="form-control" id="searchStockProduct" placeholder="商品"></div>
        <div class="col-md-2"><input type="text" class="form-control" id="searchStockSpec" placeholder="规格"></div>
        <div class="col-md-2"><input type="text" class="form-control" id="searchStockUnit" placeholder="单位"></div>
        <div class="col-md-2"><input type="number" class="form-control" id="searchStockPrice" placeholder="单价"></div>
        <div class="col-md-2"><input type="number" class="form-control" id="searchStockQty" placeholder="库存"></div>
        <div class="col-md-1"><button class="btn btn-outline-primary" type="submit">检索</button></div>
        <div class="col-md-1"><button class="btn btn-outline-secondary" type="button" onclick="resetStockSearch()">重置</button></div>
      </form>
      <table class="table table-bordered table-sm align-middle">
        <thead>
          <tr>
            <th>商品编号</th>
            <th>名称</th>
            <th>规格</th>
            <th>单位</th>
            <th>单价</th>
            <th>当前库存</th>
          </tr>
        </thead>
        <tbody id="stockTableBody"></tbody>
      </table>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
let products = JSON.parse(localStorage.getItem('products') || '[]');
let purchases = JSON.parse(localStorage.getItem('purchases') || '[]');
let sales = JSON.parse(localStorage.getItem('sales') || '[]');

// 工具函数
function saveAll() {
  localStorage.setItem('products', JSON.stringify(products));
  localStorage.setItem('purchases', JSON.stringify(purchases));
  localStorage.setItem('sales', JSON.stringify(sales));
}
function genId(prefix) {
  return prefix + '-' + Date.now() + '-' + Math.floor(Math.random()*10000);
}
function findProductById(pid) {
  return products.find(p => p.id === pid);
}
// 商品管理
let productSearchResult = null;
function renderProductTable() {
  const tbody = document.getElementById('productTableBody');
  tbody.innerHTML = '';
  const data = productSearchResult || products;
  data.forEach(p => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${p.id}</td>
      <td>${p.name}</td>
      <td>${p.spec}</td>
      <td>${p.unit}</td>
      <td>${p.price}</td>
      <td>
        <button class="btn btn-sm btn-warning me-1" onclick="editProduct('${p.id}')">编辑</button>
        <button class="btn btn-sm btn-danger" onclick="deleteProduct('${p.id}')">删除</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
  renderProductSelects();
  renderStockTable();
}
function renderProductSelects() {
  const purchaseSel = document.getElementById('purchaseProduct');
  const saleSel = document.getElementById('saleProduct');
  purchaseSel.innerHTML = '';
  saleSel.innerHTML = '';
  products.forEach(p => {
    const opt1 = document.createElement('option');
    opt1.value = p.id;
    opt1.textContent = `${p.name}（${p.spec}）`;
    purchaseSel.appendChild(opt1);
    const opt2 = opt1.cloneNode(true);
    saleSel.appendChild(opt2);
  });
}
function deleteProduct(pid) {
  if (!confirm('确定要删除该商品吗？')) return;
  products = products.filter(p => p.id !== pid);
  saveAll();
  renderProductTable();
}
function editProduct(pid) {
  const p = findProductById(pid);
  if (!p) return;
  document.getElementById('productEditId').value = p.id;
  document.getElementById('productName').value = p.name;
  document.getElementById('productSpec').value = p.spec;
  document.getElementById('productUnit').value = p.unit;
  document.getElementById('productPrice').value = p.price;
  document.getElementById('productSubmitBtn').textContent = '保存修改';
  document.getElementById('productCancelBtn').classList.remove('d-none');
}
function resetProductForm() {
  document.getElementById('productForm').reset();
  document.getElementById('productEditId').value = '';
  document.getElementById('productSubmitBtn').textContent = '添加商品';
  document.getElementById('productCancelBtn').classList.add('d-none');
}
document.getElementById('productForm').onsubmit = function(e) {
  e.preventDefault();
  const id = document.getElementById('productEditId').value;
  const name = document.getElementById('productName').value.trim();
  const spec = document.getElementById('productSpec').value.trim();
  const unit = document.getElementById('productUnit').value.trim();
  const price = parseFloat(document.getElementById('productPrice').value);
  if (!name || !spec || !unit || isNaN(price)) return alert('请填写完整');
  if (id) {
    const p = findProductById(id);
    if (p) {
      p.name = name;
      p.spec = spec;
      p.unit = unit;
      p.price = price;
    }
  } else {
    products.push({id: genId('P'), name, spec, unit, price});
  }
  saveAll();
  this.reset();
  resetProductForm();
  renderProductTable();
};

// 商品检索
function searchProduct(e) {
  e.preventDefault();
  const name = document.getElementById('searchProductName').value.trim();
  const spec = document.getElementById('searchProductSpec').value.trim();
  const unit = document.getElementById('searchProductUnit').value.trim();
  const price = document.getElementById('searchProductPrice').value.trim();
  productSearchResult = products.filter(p =>
    (name === '' || p.name.includes(name)) &&
    (spec === '' || p.spec.includes(spec)) &&
    (unit === '' || p.unit.includes(unit)) &&
    (price === '' || Number(p.price) == Number(price))
  );
  renderProductTable();
}
function resetProductSearch() {
  document.getElementById('productSearchForm').reset();
  productSearchResult = null;
  renderProductTable();
}
// 采购管理
let purchaseSearchResult = null;
function renderPurchaseTable() {
  const tbody = document.getElementById('purchaseTableBody');
  tbody.innerHTML = '';
  const data = purchaseSearchResult || purchases;
  data.forEach(p => {
    const prod = findProductById(p.productId);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${p.id}</td>
      <td>${prod ? prod.name : '已删除'}</td>
      <td>${p.qty}</td>
      <td>${p.price}</td>
      <td>${(p.qty * p.price).toFixed(2)}</td>
      <td>${p.supplier}</td>
      <td>${p.date}</td>
      <td>
        <button class="btn btn-sm btn-warning me-1" onclick="editPurchase('${p.id}')">编辑</button>
        <button class="btn btn-sm btn-danger" onclick="deletePurchase('${p.id}')">删除</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
  renderStockTable();
}
function deletePurchase(id) {
  if (!confirm('确定要删除该采购单吗？')) return;
  purchases = purchases.filter(p => p.id !== id);
  saveAll();
  renderPurchaseTable();
}
function editPurchase(id) {
  const p = purchases.find(x => x.id === id);
  if (!p) return;
  document.getElementById('purchaseEditId').value = p.id;
  document.getElementById('purchaseProduct').value = p.productId;
  document.getElementById('purchaseQty').value = p.qty;
  document.getElementById('purchasePrice').value = p.price;
  document.getElementById('purchaseSupplier').value = p.supplier;
  document.getElementById('purchaseSubmitBtn').textContent = '保存修改';
  document.getElementById('purchaseCancelBtn').classList.remove('d-none');
}
function resetPurchaseForm() {
  document.getElementById('purchaseForm').reset();
  document.getElementById('purchaseEditId').value = '';
  document.getElementById('purchaseSubmitBtn').textContent = '录入采购';
  document.getElementById('purchaseCancelBtn').classList.add('d-none');
}
document.getElementById('purchaseForm').onsubmit = function(e) {
  e.preventDefault();
  const id = document.getElementById('purchaseEditId').value;
  const productId = document.getElementById('purchaseProduct').value;
  const qty = parseFloat(document.getElementById('purchaseQty').value);
  const price = parseFloat(document.getElementById('purchasePrice').value);
  const supplier = document.getElementById('purchaseSupplier').value.trim();
  if (!productId || isNaN(qty) || isNaN(price) || !supplier) return alert('请填写完整');
  if (id) {
    const p = purchases.find(x => x.id === id);
    if (p) {
      p.productId = productId;
      p.qty = qty;
      p.price = price;
      p.supplier = supplier;
    }
  } else {
    purchases.push({
      id: genId('CGRK'),
      productId, qty, price, supplier,
      date: new Date().toLocaleDateString()
    });
  }
  saveAll();
  this.reset();
  resetPurchaseForm();
  renderPurchaseTable();
};

// 采购检索
function searchPurchase(e) {
  e.preventDefault();
  const pname = document.getElementById('searchPurchaseProduct').value.trim();
  const supplier = document.getElementById('searchPurchaseSupplier').value.trim();
  const qty = document.getElementById('searchPurchaseQty').value.trim();
  const price = document.getElementById('searchPurchasePrice').value.trim();
  const date = document.getElementById('searchPurchaseDate').value.trim();
  purchaseSearchResult = purchases.filter(p => {
    const prod = findProductById(p.productId);
    return (
      (pname === '' || (prod && prod.name.includes(pname))) &&
      (supplier === '' || p.supplier.includes(supplier)) &&
      (qty === '' || Number(p.qty) == Number(qty)) &&
      (price === '' || Number(p.price) == Number(price)) &&
      (date === '' || p.date.includes(date))
    );
  });
  renderPurchaseTable();
}
function resetPurchaseSearch() {
  document.getElementById('purchaseSearchForm').reset();
  purchaseSearchResult = null;
  renderPurchaseTable();
}
// 销售管理
let saleSearchResult = null;
function renderSaleTable() {
  const tbody = document.getElementById('saleTableBody');
  tbody.innerHTML = '';
  const data = saleSearchResult || sales;
  data.forEach(s => {
    const prod = findProductById(s.productId);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${s.id}</td>
      <td>${prod ? prod.name : '已删除'}</td>
      <td>${s.qty}</td>
      <td>${s.price}</td>
      <td>${(s.qty * s.price).toFixed(2)}</td>
      <td>${s.customer}</td>
      <td>${s.date}</td>
      <td>
        <button class="btn btn-sm btn-warning me-1" onclick="editSale('${s.id}')">编辑</button>
        <button class="btn btn-sm btn-danger" onclick="deleteSale('${s.id}')">删除</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
  renderStockTable();
}
function deleteSale(id) {
  if (!confirm('确定要删除该销售单吗？')) return;
  sales = sales.filter(s => s.id !== id);
  saveAll();
  renderSaleTable();
}
function editSale(id) {
  const s = sales.find(x => x.id === id);
  if (!s) return;
  document.getElementById('saleEditId').value = s.id;
  document.getElementById('saleProduct').value = s.productId;
  document.getElementById('saleQty').value = s.qty;
  document.getElementById('salePrice').value = s.price;
  document.getElementById('saleCustomer').value = s.customer;
  document.getElementById('saleSubmitBtn').textContent = '保存修改';
  document.getElementById('saleCancelBtn').classList.remove('d-none');
}
function resetSaleForm() {
  document.getElementById('saleForm').reset();
  document.getElementById('saleEditId').value = '';
  document.getElementById('saleSubmitBtn').textContent = '录入销售';
  document.getElementById('saleCancelBtn').classList.add('d-none');
}
document.getElementById('saleForm').onsubmit = function(e) {
  e.preventDefault();
  const id = document.getElementById('saleEditId').value;
  const productId = document.getElementById('saleProduct').value;
  const qty = parseFloat(document.getElementById('saleQty').value);
  const price = parseFloat(document.getElementById('salePrice').value);
  const customer = document.getElementById('saleCustomer').value.trim();
  if (!productId || isNaN(qty) || isNaN(price) || !customer) return alert('请填写完整');
  if (qty > calcStock(productId) && (!id || sales.find(x => x.id === id).qty !== qty)) return alert('库存不足，当前库存：' + calcStock(productId));
  if (id) {
    const s = sales.find(x => x.id === id);
    if (s) {
      s.productId = productId;
      s.qty = qty;
      s.price = price;
      s.customer = customer;
    }
  } else {
    sales.push({
      id: genId('XSCK'),
      productId, qty, price, customer,
      date: new Date().toLocaleDateString()
    });
  }
  saveAll();
  this.reset();
  resetSaleForm();
  renderSaleTable();
};

// 销售检索
function searchSale(e) {
  e.preventDefault();
  const pname = document.getElementById('searchSaleProduct').value.trim();
  const customer = document.getElementById('searchSaleCustomer').value.trim();
  const qty = document.getElementById('searchSaleQty').value.trim();
  const price = document.getElementById('searchSalePrice').value.trim();
  const date = document.getElementById('searchSaleDate').value.trim();
  saleSearchResult = sales.filter(s => {
    const prod = findProductById(s.productId);
    return (
      (pname === '' || (prod && prod.name.includes(pname))) &&
      (customer === '' || s.customer.includes(customer)) &&
      (qty === '' || Number(s.qty) == Number(qty)) &&
      (price === '' || Number(s.price) == Number(price)) &&
      (date === '' || s.date.includes(date))
    );
  });
  renderSaleTable();
}
function resetSaleSearch() {
  document.getElementById('saleSearchForm').reset();
  saleSearchResult = null;
  renderSaleTable();
}
// 库存管理
let stockSearchResult = null;
function calcStock(productId) {
  const inQty = purchases.filter(p => p.productId === productId).reduce((a, b) => a + b.qty, 0);
  const outQty = sales.filter(s => s.productId === productId).reduce((a, b) => a + b.qty, 0);
  return inQty - outQty;
}
function renderStockTable() {
  const tbody = document.getElementById('stockTableBody');
  tbody.innerHTML = '';
  const data = stockSearchResult || products;
  data.forEach(p => {
    const stock = calcStock(p.id);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${p.id}</td>
      <td>${p.name}</td>
      <td>${p.spec}</td>
      <td>${p.unit}</td>
      <td>${p.price}</td>
      <td>${stock}</td>
    `;
    tbody.appendChild(tr);
  });
}
// 库存检索
function searchStock(e) {
  e.preventDefault();
  const pname = document.getElementById('searchStockProduct').value.trim();
  const spec = document.getElementById('searchStockSpec').value.trim();
  const unit = document.getElementById('searchStockUnit').value.trim();
  const price = document.getElementById('searchStockPrice').value.trim();
  const qty = document.getElementById('searchStockQty').value.trim();
  stockSearchResult = products.filter(p => {
    const stock = calcStock(p.id);
    return (
      (pname === '' || p.name.includes(pname)) &&
      (spec === '' || p.spec.includes(spec)) &&
      (unit === '' || p.unit.includes(unit)) &&
      (price === '' || Number(p.price) == Number(price)) &&
      (qty === '' || stock == Number(qty))
    );
  });
  renderStockTable();
}
function resetStockSearch() {
  document.getElementById('stockSearchForm').reset();
  stockSearchResult = null;
  renderStockTable();
}

// 导出导入
function exportAll() {
  const data = { products, purchases, sales };
  const ts = new Date().toISOString().replace(/[-:T]/g,'').slice(0,14);
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `gouxiaocun_data_${ts}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
function importAll(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if (data.products && data.purchases && data.sales) {
        const mode = prompt('请选择导入方式：1-覆盖导入，2-追加导入', '2');
        if (mode === '1') {
          products = data.products;
          purchases = data.purchases;
          sales = data.sales;
        } else if (mode === '2') {
          products = products.concat(data.products.filter(np => !products.some(p => p.id === np.id)));
          purchases = purchases.concat(data.purchases.filter(np => !purchases.some(p => p.id === np.id)));
          sales = sales.concat(data.sales.filter(ns => !sales.some(s => s.id === ns.id)));
        } else {
          alert('导入已取消');
          return;
        }
        saveAll();
        renderProductTable();
        renderPurchaseTable();
        renderSaleTable();
        renderStockTable();
        alert('导入成功！');
      } else {
        alert('文件格式不正确');
      }
    } catch (err) {
      alert('导入失败：' + err.message);
    }
  };
  reader.readAsText(file);
}

// 初始化
renderProductTable();
renderPurchaseTable();
renderSaleTable();
renderStockTable();

</script>
</body>
</html>