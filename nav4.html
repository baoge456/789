<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>网址导航</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <style>
    body {
      background: #f5f6fa;
      font-family: 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;
    }
    .container-main {
      max-width: 1200px;
      margin: 40px auto;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.08);
      display: flex;
      /* min-height: 700px; */ /* Removed to allow dynamic height */
      overflow: hidden;
      position: relative; /* For proper footer positioning if main-content needs to scroll */
    }
    .sidebar {
      width: 220px;
      background: #22223b;
      color: #fff;
      padding: 32px 0 0 0;
      /* min-height: 700px; */ /* Removed to allow dynamic height */
      flex-shrink: 0;
    }
    .sidebar h2 {
      font-size: 1.5rem;
      text-align: center;
      margin-bottom: 2rem;
      letter-spacing: 2px;
      padding: 10px 0; /* Add padding for the background */
      background-color: rgba(123, 104, 238, 0.3); /* 更明显的半透明板岩蓝背景 */
      border-radius: 8px; /* Slightly rounded corners */
      margin: 0 15px 2rem 15px; /* Adjust margin to fit background */
      box-shadow: 0 2px 8px rgba(0,0,0,0.1); /* Subtle shadow */
    }
    .sidebar ul {
      list-style: none;
      padding: 0;
    }
    .sidebar li {
      padding: 12px 32px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .sidebar li:hover, .sidebar li.active {
      background: #7B68EE; /* 亮丽的板岩蓝悬浮色 */
    }
    .main-content {
      flex: 1;
      padding: 40px 48px;
      overflow-y: auto;
      position: relative; /* Added for footer positioning */
      padding-bottom: 120px; /* Adjusted to give more space for the footer */
    }
    .search-bar {
      display: flex;
      margin-bottom: 32px;
      gap: 12px;
    }
    .search-bar input {
      flex: 1;
      border-radius: 8px;
      border: 1px solid #ddd;
      padding: 10px 16px;
      font-size: 1rem;
    }
    .search-bar select {
      border-radius: 8px;
      border: 1px solid #ddd;
      padding: 10px 16px;
      font-size: 1rem;
      background: #fff;
    }
    .card-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); /* Adjusted for 4+ columns */
      gap: 16px; /* Reduced gap for compactness */
    }
    .site-card {
      background: var(--group-bg-color);
      background-image: linear-gradient(45deg, rgba(255,255,255,0.05) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.05) 50%, rgba(255,255,255,0.05) 75%, transparent 75%, transparent);
      background-size: 20px 20px;
      border-radius: 25px; /* 半高，实现横向椭圆效果 */
      height: 50px; /* 固定高度以形成横向椭圆 */
      padding: 8px 15px; /* 调整内边距 */
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      display: flex;
      align-items: center; /* 垂直居中内容 */
      justify-content: center; /* 确保名称居中 */
      transition: all 0.2s ease-in-out;
      text-decoration: none;
      position: relative;
      overflow: hidden; /* 防止内容溢出 */
      cursor: pointer; /* 鼠标悬停时显示手型光标 */
    }
    .site-card:hover, .site-card:active {
      box-shadow: 0 8px 24px rgba(75, 0, 130, 0.3);
      transform: translateY(-3px);
      background: #4B0082; /* 深紫色悬浮色 */
      background-image: linear-gradient(45deg, rgba(255,255,255,0.08) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.08) 50%, rgba(255,255,255,0.08) 75%, transparent 75%, transparent);
      background-size: 20px 20px;
    }
    /* 移除了 .site-card .site-icon */
    .site-card-content {
      flex: 1; /* 占据剩余空间 */
      display: flex;
      flex-direction: column;
      align-items: center; /* 垂直居中内容 */
      justify-content: center; /* 水平居中内容 */
      min-width: 0; /* 允许文本溢出省略 */
      margin-bottom: 0; /* 移除底部外边距 */
      text-align: center; /* 确保文本本身居中 */
    }
    .site-card .title {
      font-weight: 700;
      font-size: 0.95rem; /* Adjusted for smaller size */
      margin-bottom: 0; /* 移除外边距 */
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--group-text-color); /* 使用动态文本颜色 */
      line-height: 1.2; /* 调整行高 */
    }

    .footer {
      position: absolute; /* 绝对定位到 main-content 底部 */
      bottom: 0;
      left: 0;
      right: 0;
      padding: 15px;
      background: #fff;
      border-top: 1px solid #eee;
      z-index: 10;
    }

    /* Admin Panel Styles */
    .admin-container {
        display: flex;
        flex-direction: column;
        height: 80vh;
        overflow-y: auto;
    }
    .admin-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
        flex-wrap: wrap;
    }
    .admin-header h2 {
        margin-bottom: 0;
    }
    .admin-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    .admin-section {
        margin-bottom: 20px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    .admin-section h3 {
        font-size: 1.2rem;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px dashed #eee;
    }
    .admin-group-list {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        overflow-x: auto;
        padding-bottom: 10px;
    }
    .admin-group-item {
        white-space: nowrap;
        padding: 8px 15px;
        border: 1px solid #007bff;
        border-radius: 20px;
        cursor: pointer;
        background-color: #e9f5ff;
        color: #007bff;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 5px;
        flex-shrink: 0;
    }
    .admin-group-item.active {
        background-color: #007bff;
        color: #fff;
    }
    .admin-group-item button {
        background: none;
        border: none;
        color: inherit;
        font-size: 0.9em;
        margin-left: 5px;
        cursor: pointer;
    }
    .admin-group-item button:hover {
        opacity: 0.8;
    }

    .admin-table-container {
        flex: 1;
        overflow-x: auto;
    }
    .admin-table {
        min-width: 800px;
    }

    .admin-table th, .admin-table td {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        vertical-align: middle;
    }

    /* Form styling */
    .form-group label {
        font-weight: 600;
        margin-bottom: 5px;
    }
    .form-group input, .form-group textarea, .form-group select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    /* Responsive adjustments */
    @media (max-width: 992px) {
      .card-list {
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      }
      .sidebar {
        width: 180px;
        padding: 20px 0 0 0;
      }
      .main-content {
        padding: 30px 30px;
        padding-bottom: 110px; /* Adjusted for smaller screens */
      }
    }

    @media (max-width: 768px) {
      .container-main {
        flex-direction: column;
        margin: 20px auto;
        border-radius: 8px;
      }
      .sidebar {
        width: 100%;
        /* min-height: unset; */ /* Removed to allow dynamic height */
        display: flex;
        flex-direction: row;
        overflow-x: auto;
        padding: 15px 0;
        border-radius: 8px 8px 0 0;
      }
      .sidebar h2 { display: none; }
      .sidebar ul {
        display: flex;
        margin: 0;
        padding: 0 10px;
      }
      .sidebar li {
        padding: 8px 15px;
        white-space: nowrap;
      }
      .main-content {
        padding: 20px;
        padding-bottom: 100px; /* Adjusted for even smaller screens */
      }
      .site-card {
        height: 45px; /* Further reduce height for small screens */
        border-radius: 22.5px;
        padding: 6px 12px;
      }
      .site-card .title {
        font-size: 0.9rem;
      }
      .admin-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 15px;
      }
      .admin-actions {
          width: 100%;
          justify-content: center;
      }
      .admin-group-list {
          flex-wrap: wrap;
          justify-content: center;
      }
    }

    @media (max-width: 480px) {
      .card-list {
        grid-template-columns: 1fr;
      }
      .search-bar {
        flex-direction: column;
      }
      .admin-section {
          padding: 15px;
      }
    }
  </style>
</head>
<body>

  <div class="container-main" id="app">
    <!-- 左侧分类导航 -->
    <nav class="sidebar" id="sidebar">
      <h2>书签导航</h2>
      <ul id="categoryList">
        <!-- 分类JS渲染 -->
      </ul>
    </nav>

    <!-- 右侧内容区 -->
    <main class="main-content" id="mainContent">
      <!-- 搜索栏 -->
      <form class="search-bar" onsubmit="searchSite(event)">
        <input type="text" id="searchInput" placeholder="输入关键词搜索站点...">
        <select id="engineSelect">
          <option value="https://www.baidu.com/s?wd=">百度</option>
          <option value="https://www.bing.com/search?q=">必应</option>
          <option value="https://www.google.com/search?q=">谷歌</option>
          <option value="https://www.sogou.com/web?query=">搜狗</option>
        </select>
        <button type="submit" class="btn btn-primary">搜索</button>
      </form>

      <!-- 书签列表 -->
      <div id="bookmarkList" class="card-list">
        <!-- 书签JS渲染 -->
      </div>

      <!-- 底部信息 -->
      <div class="footer text-center text-muted mt-4">
        <p>&copy; 2025网址导航. All Rights Reserved.</p>
        <p>已稳定运行 <span id="runtime">0 天 0 小时 0 分 0 秒</span></p>
        <button class="btn btn-link mt-2" onclick="location.hash = '#admin'">进入管理后台</button>
      </div>
    </main>

    <!-- 管理后台 -->
    <div class="main-content d-none" id="adminPanel">
        <div class="admin-container">
            <div class="admin-header">
                <h2>书签管理后台</h2>
                <div class="admin-actions">
                    <button class="btn btn-success" onclick="exportBookmarks(true)">导出全部书签</button>
                    <button class="btn btn-primary" onclick="exportBookmarks(false)">导出当前分组书签</button>
                    <input type="file" id="importBookmarksFile" accept=".json" class="d-none" onchange="importBookmarks(event)">
                    <button class="btn btn-info" onclick="document.getElementById('importBookmarksFile').click()">导入书签</button>
                    <button class="btn btn-success" onclick="location.hash = ''">返回前台</button>
                </div>
            </div>

            <div class="admin-section">
                <h3>添加分组</h3>
                <form id="addGroupForm" class="row g-3" onsubmit="handleNewGroup(event)">
                    <div class="col-md-8">
                        <input type="text" class="form-control" id="newGroupName" placeholder="新分组名称" required>
                    </div>
                    <div class="col-md-4">
                        <button type="submit" class="btn btn-primary w-100">添加分组</button>
                    </div>
                </form>
            </div>

            <div class="admin-section">
                <h3>书签列表管理</h3>
                <div class="admin-group-list" id="adminGroupList">
                    <!-- 管理后台分组列表JS渲染 -->
                </div>

                <form id="bookmarkForm" class="row g-3 mb-4" onsubmit="handleSaveBookmark(event)">
                    <input type="hidden" id="bookmarkId">
                    <div class="col-md-6">
                        <label for="bookmarkName" class="form-label">名称</label>
                        <input type="text" class="form-control" id="bookmarkName" required>
                    </div>
                    <div class="col-md-6">
                        <label for="bookmarkUrl" class="form-label">URL</label>
                        <input type="url" class="form-control" id="bookmarkUrl" onblur="fetchFavicon()" required>
                    </div>
                    <div class="col-md-6">
                        <label for="bookmarkFavicon" class="form-label">图标URL</label>
                        <input type="url" class="form-control" id="bookmarkFavicon">
                    </div>
                    <div class="col-md-6">
                        <label for="bookmarkGroup" class="form-label">分组</label>
                        <select class="form-select" id="bookmarkGroup" required>
                            <!-- 分组选项JS渲染 -->
                        </select>
                    </div>
                    <!-- 移除了描述输入字段 -->
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">保存书签</button>
                        <button type="button" class="btn btn-secondary" onclick="resetBookmarkForm()">取消</button>
                    </div>
                </form>

                <div class="admin-table-container">
                    <table class="table table-bordered table-striped admin-table">
                        <thead>
                            <tr>
                                <th style="width: 150px;">名称</th>
                                <th style="width: 250px;">URL</th>
                                <th style="width: 100px;">分组</th>
                                <th style="width: 120px;">操作</th>
                            </tr>
                        </thead>
                        <tbody id="adminBookmarkTableBody">
                            <!-- 管理后台书签列表JS渲染 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
  </div>
    <script>
    // 定义书签数据结构
    let bookmarksData = {
      "常用推荐": [
        { id: Date.now() + 1, name: "宝哥导航站", url: "https://dhz.baoge.wang/", favicon: "https://favicon.im/https://dhz.baoge.wang/" },
        { id: Date.now() + 2, name: "泰安本地宝", url: "https://m.ta.bendibao.com/", favicon: "https://favicon.im/https://m.ta.bendibao.com/" },
      ],
      "新闻资讯": [
        { id: Date.now() + 3, name: "全网热点", url: "https://hot.ailake.cn/hot/1", favicon: "https://favicon.im/https://hot.ailake.cn/hot/1" },
        { id: Date.now() + 4, name: "今日热榜", url: "https://tophub.today/", favicon: "https://tophub.today/favicon.ico" },
      ],
      "搜索引擎": [
        { id: Date.now() + 5, name: "百度", url: "https://www.baidu.com/", favicon: "https://www.baidu.com/favicon.ico" },
        { id: Date.now() + 6, name: "谷歌", url: "https://www.google.com/", favicon: "https://www.google.com/favicon.ico" },
      ]
    };

    let currentCategory = localStorage.getItem('currentCategory') || "常用推荐"; // 从localStorage加载当前分类
    let adminSelectedGroup = ""; // 管理后台当前选中的分组
    const ADMIN_PASSWORD = "baoge888"; // 设置管理后台密码，请修改为你的密码
    // Define a color palette for groups with associated text colors for contrast
    // `main`: 主背景色
    // `hover`: 鼠标悬停时的背景色
    // `text`: 对应背景色下，确保书签名称清晰可见的字体颜色
    const groupColors = [
        { main: '#FF6347', hover: '#4B0082', text: '#fff' }, // Tomato Red - White text
        { main: '#3CB371', hover: '#4B0082', text: '#fff' }, // MediumSeaGreen - White text
        { main: '#4169E1', hover: '#4B0082', text: '#fff' }, // RoyalBlue - White text
        { main: '#FFA500', hover: '#4B0082', text: '#333' }, // Orange - Dark text
        { main: '#8A2BE2', hover: '#4B0082', text: '#fff' }, // BlueViolet - White text
        { main: '#FF69B4', hover: '#4B0082', text: '#fff' }, // HotPink - White text
        { main: '#00CED1', hover: '#4B0082', text: '#333' }, // DarkTurquoise - Dark text
        { main: '#ADFF2F', hover: '#4B0082', text: '#333' }, // GreenYellow - Dark text
        { main: '#FFD700', hover: '#4B0082', text: '#333' }, // Gold - Dark text
        { main: '#DAA520', hover: '#4B0082', text: '#fff' }, // Goldenrod - White text
        { main: '#CD5C5C', hover: '#4B0082', text: '#fff' }, // IndianRed - White text
        { main: '#6495ED', hover: '#4B0082', text: '#fff' }, // CornflowerBlue - White text
    ];
    let colorMap = {}; // To store group name to color mapping

    // --- 数据持久化与初始化 ---
    function loadBookmarks() {
      const storedData = localStorage.getItem('bookmarksData');
      if (storedData) {
        bookmarksData = JSON.parse(storedData);
      }
      // 确保每个书签都有一个唯一的ID，并移除旧的desc字段
      for (const group in bookmarksData) {
        bookmarksData[group] = bookmarksData[group].map(bookmark => {
          if (!bookmark.id) {
            bookmark.id = Date.now() + Math.random();
          }
          // Remove description if it exists
          if (bookmark.hasOwnProperty('desc')) {
            delete bookmark.desc;
          }
          return bookmark;
        });
      }
    }

    function saveBookmarks() {
      localStorage.setItem('bookmarksData', JSON.stringify(bookmarksData));
    }

    function saveCurrentCategory() {
      localStorage.setItem('currentCategory', currentCategory);
    }

    // --- 前台渲染函数 ---
    function renderCategories() {
      const categoryList = document.getElementById('categoryList');
      categoryList.innerHTML = '';
      const categories = Object.keys(bookmarksData);

      // 如果当前分类不存在，则默认选中第一个
      if (!categories.includes(currentCategory) && categories.length > 0) {
        currentCategory = categories[0];
        saveCurrentCategory();
      } else if (categories.length === 0) {
        currentCategory = ""; // 如果没有分组，则清空当前分类
        saveCurrentCategory();
      }


      categories.forEach(category => {
        const li = document.createElement('li');
        li.textContent = category;
        li.dataset.category = category;
        if (category === currentCategory) {
          li.classList.add('active');
        }
        li.addEventListener('click', () => {
          currentCategory = category;
          saveCurrentCategory(); // 保存当前分类
          renderCategories();
          renderBookmarks(currentCategory);
        });
        categoryList.appendChild(li);
      });
    }

    function renderBookmarks(category) {
      const bookmarkList = document.getElementById('bookmarkList');
      bookmarkList.innerHTML = '';

      const bookmarks = bookmarksData[category] || [];

      if (bookmarks.length === 0) {
        bookmarkList.innerHTML = `<p class="text-center text-muted">该分类下暂无书签。</p>`;
        return;
      }

      // Assign a unique color to the category if not already assigned
      if (!colorMap[category]) {
        const existingColors = Object.values(colorMap).map(c => c.main);
        let availableColor = groupColors.find(color => !existingColors.includes(color.main));
        if (!availableColor) {
            // If all predefined colors are used, cycle through them
            availableColor = groupColors[Object.keys(colorMap).length % groupColors.length];
        }
        colorMap[category] = availableColor;
      }
      const categoryColor = colorMap[category];


      bookmarks.forEach(bookmark => {
        const card = document.createElement('div');
        card.classList.add('site-card');
        card.setAttribute('data-group', category); // Add data attribute for group
        card.style.setProperty('--group-bg-color', categoryColor.main);
        card.style.setProperty('--group-hover-color', categoryColor.hover);
        card.style.setProperty('--group-text-color', categoryColor.text); // Set text color CSS variable
        card.innerHTML = `
          <div class="site-card-content">
            <div class="title">${bookmark.name}</div>
          </div>
        `;
        card.addEventListener('click', () => {
          window.open(bookmark.url, '_blank');
        });
        bookmarkList.appendChild(card);
      });
    }

    function searchSite(event) {
      event.preventDefault();
      const searchInput = document.getElementById('searchInput');
      const engineSelect = document.getElementById('engineSelect');
      const query = searchInput.value.trim();
      const engineUrl = engineSelect.value;

      if (query) {
        window.open(engineUrl + encodeURIComponent(query), '_blank');
      }
    }

    // --- 运行时间计算 ---
    function updateRunTime() {
      const startTime = new Date('2025-06-13T00:00:00'); // 你可以设置一个实际的开始时间
      const now = new Date();
      const diff = now.getTime() - startTime.getTime();

      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((diff % (1000 * 60)) / 1000);

      document.getElementById('runtime').textContent = `${days} 天 ${hours} 小时 ${minutes} 分 ${seconds} 秒`;
    }

    // --- 管理后台渲染函数 ---
    function renderAdminPanel() {
        const adminGroupList = document.getElementById('adminGroupList');
        adminGroupList.innerHTML = '';
        const groups = Object.keys(bookmarksData);

        // 如果管理后台没有选中分组或选中分组被删除，则默认选中第一个
        if (!adminSelectedGroup || !groups.includes(adminSelectedGroup)) {
            adminSelectedGroup = groups.length > 0 ? groups[0] : "";
        }

        groups.forEach(group => {
            const groupItem = document.createElement('div');
            groupItem.classList.add('admin-group-item');
            if (group === adminSelectedGroup) {
                groupItem.classList.add('active');
            }
            groupItem.innerHTML = `
                <span>${group}</span>
                <button onclick="editGroup('${group}')">编辑</button>
                <button onclick="deleteGroup('${group}')">删除</button>
            `;
            groupItem.addEventListener('click', (e) => {
                if (!e.target.closest('button')) { // Only change group if not clicking a button
                    adminSelectedGroup = group;
                    renderAdminPanel(); // Re-render to update active state and bookmarks
                }
            });
            adminGroupList.appendChild(groupItem);
        });

        renderAdminBookmarksTable(adminSelectedGroup);
        populateGroupSelect();
        resetBookmarkForm(); // 确保表单在重新渲染时重置
    }

    function renderAdminBookmarksTable(groupName) {
        const adminBookmarkTableBody = document.getElementById('adminBookmarkTableBody');
        adminBookmarkTableBody.innerHTML = '';

        const bookmarks = bookmarksData[groupName] || [];

        if (bookmarks.length === 0) {
            adminBookmarkTableBody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">该分组下暂无书签。</td></tr>`;
            return;
        }

        bookmarks.forEach(bookmark => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><a href="#" onclick="editBookmark('${bookmark.id}', '${groupName}'); event.preventDefault();">${bookmark.name}</a></td>
                <td><a href="${bookmark.url}" target="_blank">${bookmark.url}</a></td>
                <td>${groupName}</td>
                <td>
                    <button class="btn btn-sm btn-warning me-1" onclick="editBookmark('${bookmark.id}', '${groupName}')">编辑</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteBookmark('${bookmark.id}', '${groupName}')">删除</button>
                </td>
            `;
            adminBookmarkTableBody.appendChild(tr);
        });
    }

    function populateGroupSelect() {
        const bookmarkGroupSelect = document.getElementById('bookmarkGroup');
        bookmarkGroupSelect.innerHTML = '';
        Object.keys(bookmarksData).forEach(group => {
            const option = document.createElement('option');
            option.value = group;
            option.textContent = group;
            bookmarkGroupSelect.appendChild(option);
        });
    }

    // --- 管理后台操作逻辑 ---
    function handleNewGroup(event) {
        event.preventDefault();
        const newGroupNameInput = document.getElementById('newGroupName');
        const newGroupName = newGroupNameInput.value.trim();

        if (newGroupName && !bookmarksData[newGroupName]) {
            bookmarksData[newGroupName] = [];
            saveBookmarks();
            newGroupNameInput.value = '';
            adminSelectedGroup = newGroupName; // 自动选中新添加的分组
            renderAdminPanel();
            renderCategories(); // 更新前台分类
        } else if (bookmarksData[newGroupName]) {
            alert('分组名称已存在！');
        }
    }

    function editGroup(oldGroupName) {
        const newGroupName = prompt(`请输入新的分组名称（原名称: ${oldGroupName}）:`);
        if (newGroupName && newGroupName.trim() !== oldGroupName && !bookmarksData[newGroupName.trim()]) {
            const trimmedNewName = newGroupName.trim();
            // Update currentCategory if it was the old group
            if (currentCategory === oldGroupName) {
                currentCategory = trimmedNewName;
                saveCurrentCategory();
            }
            // Update adminSelectedGroup if it was the old group
            if (adminSelectedGroup === oldGroupName) {
                adminSelectedGroup = trimmedNewName;
            }

            bookmarksData[trimmedNewName] = bookmarksData[oldGroupName];
            delete bookmarksData[oldGroupName];
            saveBookmarks();
            renderAdminPanel();
            renderCategories(); // 更新前台分类
            renderBookmarks(currentCategory); // 更新前台书签
        } else if (newGroupName && newGroupName.trim() === oldGroupName) {
            // No change, do nothing
        } else if (newGroupName && bookmarksData[newGroupName.trim()]) {
            alert('新的分组名称已存在！');
        }
    }

    function deleteGroup(groupToDelete) {
        if (Object.keys(bookmarksData).length === 1) {
            alert('不能删除最后一个分组！');
            return;
        }

        if (confirm(`确定要删除分组 "${groupToDelete}" 吗？该分组下的所有书签将被一同删除。`)) {
            delete bookmarksData[groupToDelete]; // Directly delete the group and its bookmarks
            saveBookmarks();

            const remainingGroups = Object.keys(bookmarksData);
            let newSelectedGroup = "";
            if (remainingGroups.length > 0) {
                newSelectedGroup = remainingGroups[0];
            }

            // Adjust currentCategory if the deleted group was selected
            if (currentCategory === groupToDelete || !remainingGroups.includes(currentCategory)) {
                currentCategory = newSelectedGroup;
                saveCurrentCategory();
            }
            adminSelectedGroup = newSelectedGroup; // Select the new first group in admin panel

            renderAdminPanel();
            renderCategories(); // Update front-end categories
            renderBookmarks(currentCategory); // Re-render front-end bookmarks
        }
    }

    function fetchFavicon() {
        const bookmarkUrlInput = document.getElementById('bookmarkUrl');
        const bookmarkFaviconInput = document.getElementById('bookmarkFavicon');
        const url = bookmarkUrlInput.value.trim();

        if (url) {
            const faviconServiceUrl = `https://favicon.im/${url}`;
            bookmarkFaviconInput.value = faviconServiceUrl;

            const img = new Image();
            img.src = faviconServiceUrl;
            img.onerror = () => {
                console.warn(`Failed to load favicon from ${faviconServiceUrl}, falling back to default.`);
                bookmarkFaviconInput.value = 'https://www.google.com/s2/favicons?domain=default';
            };
        }
    }

    function handleSaveBookmark(event) {
        event.preventDefault();
        const id = document.getElementById('bookmarkId').value;
        const name = document.getElementById('bookmarkName').value.trim();
        const url = document.getElementById('bookmarkUrl').value.trim();
        const favicon = document.getElementById('bookmarkFavicon').value.trim();
        const group = document.getElementById('bookmarkGroup').value;

        if (!name || !url || !group) {
            alert('名称、URL 和分组是必填项！');
            return;
        }

        if (id) {
            // 编辑现有书签
            let found = false;
            for (const grp in bookmarksData) {
                bookmarksData[grp] = bookmarksData[grp].filter(b => {
                    if (b.id == id) {
                        if (grp === group) { // Still in the same group
                            b.name = name;
                            b.url = url;
                            b.favicon = favicon;
                            found = true;
                        } else { // Moved to a different group, remove from current
                            found = true;
                            return false;
                        }
                    }
                    return true;
                });
            }
            if (found && !bookmarksData[group].some(b => b.id == id)) { // If bookmark was moved to a new group
                bookmarksData[group].push({ id: parseFloat(id), name, url, favicon });
            }
        } else {
            // 添加新书签
            if (!bookmarksData[group]) {
                bookmarksData[group] = [];
            }
            bookmarksData[group].push({ id: Date.now() + Math.random(), name, url, favicon });
        }
        saveBookmarks();
        resetBookmarkForm();
        renderAdminPanel();
        renderBookmarks(currentCategory); // Update front-end
        renderCategories(); // Update front-end categories if new group added
    }

    function editBookmark(id, groupName) {
        let bookmarkToEdit = null;
        if (bookmarksData[groupName]) {
            bookmarkToEdit = bookmarksData[groupName].find(b => b.id == id);
        }

        if (bookmarkToEdit) {
            document.getElementById('bookmarkId').value = bookmarkToEdit.id;
            document.getElementById('bookmarkName').value = bookmarkToEdit.name;
            document.getElementById('bookmarkUrl').value = bookmarkToEdit.url;
            document.getElementById('bookmarkFavicon').value = bookmarkToEdit.favicon;
            document.getElementById('bookmarkGroup').value = groupName;
        }
    }

    function deleteBookmark(id, groupName) {
        if (confirm('确定要删除此书签吗？')) {
            if (bookmarksData[groupName]) {
                bookmarksData[groupName] = bookmarksData[groupName].filter(bookmark => bookmark.id != id);
                saveBookmarks();
                renderAdminPanel();
                renderBookmarks(currentCategory); // Update front-end
            }
        }
    }

    function resetBookmarkForm() {
        document.getElementById('bookmarkForm').reset();
        document.getElementById('bookmarkId').value = '';
        // Reset to current admin group, or the first available group if adminSelectedGroup is empty
        document.getElementById('bookmarkGroup').value = adminSelectedGroup || Object.keys(bookmarksData)[0];
    }

    function exportBookmarks(exportAll) {
        let dataToExport = {};
        let filename;

        if (exportAll) {
            Object.keys(bookmarksData).forEach(groupName => {
                dataToExport[groupName] = bookmarksData[groupName].map(bookmark => ({
                    name: bookmark.name,
                    url: bookmark.url,
                    favicon: bookmark.favicon
                }));
            });
            filename = "all_bookmarks.json";
        } else {
            if (adminSelectedGroup && bookmarksData[adminSelectedGroup]) {
                dataToExport[adminSelectedGroup] = bookmarksData[adminSelectedGroup].map(bookmark => ({
                    name: bookmark.name,
                    url: bookmark.url,
                    favicon: bookmark.favicon
                }));
                filename = `${adminSelectedGroup}_bookmarks.json`;
            } else {
                alert("请选择一个分组或该分组下没有书签可导出。");
                return;
            }
        }

        const dataStr = JSON.stringify(dataToExport, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function importBookmarks(event) {
        const file = event.target.files[0];
        if (!file) {
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedRawData = JSON.parse(e.target.result);
                let processedImportedData = {}; // Normalized structure for imported data

                // Heuristic to handle various JSON structures
                if (Array.isArray(importedRawData)) {
                    // Assume it's an array of bookmarks, put into "未分组" or a default group
                    processedImportedData["未分组"] = importedRawData.map(item => ({
                        id: item.id || Date.now() + Math.random(),
                        name: item.name || item.title || '未知名称',
                        url: item.url || item.link || 'http://unknown.com',
                        favicon: item.favicon || `https://favicon.im/${item.url || item.link || 'http://unknown.com'}`,
                    })).filter(b => b.name && b.url); // Filter out invalid entries
                } else if (typeof importedRawData === 'object' && importedRawData !== null) {
                    // Assume it's an object where keys are group names
                    for (const groupName in importedRawData) {
                        if (Array.isArray(importedRawData[groupName])) {
                            processedImportedData[groupName] = importedRawData[groupName].map(item => ({
                                id: item.id || Date.now() + Math.random(),
                                name: item.name || item.title || '未知名称',
                                url: item.url || item.link || 'http://unknown.com',
                                favicon: item.favicon || `https://favicon.im/${item.url || item.link || 'http://unknown.com'}`,
                            })).filter(b => b.name && b.url); // Filter out invalid entries
                        } else if (typeof importedRawData[groupName] === 'object' && importedRawData[groupName] !== null) {
                            // Handle cases where group is an object but contains bookmark info directly (e.g., single bookmark file)
                            // This heuristic assumes if a group-level object has 'name' and 'url', it's a single bookmark.
                            if (importedRawData[groupName].name && importedRawData[groupName].url) {
                                processedImportedData[groupName] = [{
                                    id: importedRawData[groupName].id || Date.now() + Math.random(),
                                    name: importedRawData[groupName].name || importedRawData[groupName].title || '未知名称',
                                    url: importedRawData[groupName].url || importedRawData[groupName].link || 'http://unknown.com',
                                    favicon: importedRawData[groupName].favicon || `https://favicon.im/${importedRawData[groupName].url || importedRawData[groupName].link || 'http://unknown.com'}`,
                                }];
                            }
                        }
                    }
                }

                if (Object.keys(processedImportedData).length === 0) {
                    alert('导入的JSON文件不包含有效的书签数据。请确保文件包含书签名称和URL。');
                    return;
                }

                const importOption = prompt("选择导入方式：\n1. 覆盖现有书签 (输入 '1')\n2. 添加到现有书签 (输入 '2')\n\n注意：导入将尝试从文件名或URL中获取favicon，如果缺失将使用默认。", "2");

                if (importOption === '1') {
                    if (confirm('确定要覆盖现有书签数据吗？此操作不可撤销！')) {
                        bookmarksData = processedImportedData;
                        saveBookmarks();
                        colorMap = {}; // Clear colorMap and re-initialize it for new groups
                        const firstGroup = Object.keys(bookmarksData)[0];
                        if (firstGroup) {
                            currentCategory = firstGroup;
                            adminSelectedGroup = firstGroup;
                        } else {
                            currentCategory = "";
                            adminSelectedGroup = "";
                        }
                        saveCurrentCategory();
                        alert('书签导入成功（已覆盖）！');
                        handleHashChange();
                    }
                } else if (importOption === '2') {
                    for (const groupName in processedImportedData) {
                        if (!bookmarksData[groupName]) {
                            bookmarksData[groupName] = []; // Create new group if it doesn\'t exist
                        }
                        // Append new bookmarks, ensuring no duplicate URLs when appending within a group
                        processedImportedData[groupName].forEach(newBookmark => {
                            const exists = bookmarksData[groupName].some(b => b.url === newBookmark.url);
                            if (!exists) {
                                bookmarksData[groupName].push(newBookmark);
                            } else {
                                console.log(`Bookmark with URL ${newBookmark.url} already exists in group ${groupName}, skipping.`);
                            }
                        });
                    }
                    saveBookmarks();
                    alert('书签导入成功（已追加）！');
                    handleHashChange();
                } else {
                    alert('导入操作已取消。');
                }

            } catch (e) {
                alert('导入文件失败，请确保是有效的JSON文件。错误信息: ' + e.message);
                console.error('导入错误:', e);
            }
        };
        reader.readAsText(file);
        event.target.value = ''; // Clear file input
    }


    // --- 路由处理 ---
    function handleHashChange() {
      const mainContent = document.getElementById('mainContent');
      const adminPanel = document.getElementById('adminPanel');

      if (window.location.hash === '#admin') {
        const password = prompt("请输入管理后台密码:");
        if (password === ADMIN_PASSWORD) {
          mainContent.classList.add('d-none');
          adminPanel.classList.remove('d-none');
          renderAdminPanel();
        } else {
          alert("密码错误，无法进入管理后台。");
          window.location.hash = ''; // Redirect back to main page
        }
      } else {
        mainContent.classList.remove('d-none');
        adminPanel.classList.add('d-none');
        renderCategories();
        renderBookmarks(currentCategory);
      }
    }

    // --- 初始化 ---
    document.addEventListener('DOMContentLoaded', () => {
      loadBookmarks();
      // Ensure currentCategory is valid after loading bookmarks and save it
      const categories = Object.keys(bookmarksData);
      if (!categories.includes(currentCategory) && categories.length > 0) {
        currentCategory = categories[0];
        saveCurrentCategory();
      } else if (categories.length === 0) {
        currentCategory = "";
        saveCurrentCategory();
      }

      // Initialize color map on load
      Object.keys(bookmarksData).forEach(group => {
        if (!colorMap[group]) {
            const existingColors = Object.values(colorMap).map(c => c.main);
            let availableColor = groupColors.find(color => !existingColors.includes(color.main));
            if (!availableColor) {
                availableColor = groupColors[Object.keys(colorMap).length % groupColors.length];
            }
            colorMap[group] = availableColor;
        }
      });


      updateRunTime();
      setInterval(updateRunTime, 1000); // 每秒更新运行时间
      handleHashChange(); // 根据初始URL哈希渲染页面
      window.addEventListener('hashchange', handleHashChange); // 监听哈希变化
    });
  </script>
</body>
</html>